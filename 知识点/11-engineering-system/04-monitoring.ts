/**
 * ============================================================
 * ğŸ“š ç›‘æ§å‘Šè­¦ä½“ç³»
 * ============================================================
 *
 * é¢è¯•è€ƒå¯Ÿé‡ç‚¹ï¼š
 * 1. é”™è¯¯ç›‘æ§
 * 2. æ€§èƒ½ç›‘æ§
 * 3. ç”¨æˆ·è¡Œä¸ºç›‘æ§
 * 4. å‘Šè­¦æœºåˆ¶
 */

// ============================================================
// 1. ç›‘æ§ä½“ç³»æ¦‚è§ˆ
// ============================================================

/**
 * ğŸ“Š å‰ç«¯ç›‘æ§ä½“ç³»
 *
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                      å‰ç«¯ç›‘æ§ä½“ç³»                               â”‚
 * â”‚                                                                 â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
 * â”‚  â”‚                    æ•°æ®é‡‡é›†å±‚                            â”‚   â”‚
 * â”‚  â”‚  é”™è¯¯ç›‘æ§ â”‚ æ€§èƒ½ç›‘æ§ â”‚ ç”¨æˆ·è¡Œä¸º â”‚ è‡ªå®šä¹‰åŸ‹ç‚¹              â”‚   â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
 * â”‚                          â”‚                                      â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
 * â”‚  â”‚                    æ•°æ®ä¸ŠæŠ¥å±‚                            â”‚   â”‚
 * â”‚  â”‚  æ‰¹é‡ä¸ŠæŠ¥ â”‚ é‡‡æ · â”‚ å‹ç¼© â”‚ ç¦»çº¿å­˜å‚¨                        â”‚   â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
 * â”‚                          â”‚                                      â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
 * â”‚  â”‚                    æ•°æ®å¤„ç†å±‚                            â”‚   â”‚
 * â”‚  â”‚  æ¸…æ´— â”‚ èšåˆ â”‚ å­˜å‚¨ â”‚ åˆ†æ                               â”‚   â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
 * â”‚                          â”‚                                      â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
 * â”‚  â”‚                    å¯è§†åŒ–ä¸å‘Šè­¦                          â”‚   â”‚
 * â”‚  â”‚  Dashboard â”‚ å‘Šè­¦è§„åˆ™ â”‚ é€šçŸ¥æ¸ é“                         â”‚   â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

// ============================================================
// 2. é”™è¯¯ç›‘æ§
// ============================================================

/**
 * ğŸ“Š é”™è¯¯ç±»å‹
 *
 * - JS è¿è¡Œæ—¶é”™è¯¯
 * - Promise æœªæ•è·é”™è¯¯
 * - èµ„æºåŠ è½½é”™è¯¯
 * - æ¥å£é”™è¯¯
 * - æ¡†æ¶é”™è¯¯ï¼ˆReact Error Boundaryï¼‰
 */

// é”™è¯¯ç›‘æ§ SDK
class ErrorMonitor {
  private queue: ErrorEvent[] = [];
  private config: MonitorConfig;

  constructor(config: MonitorConfig) {
    this.config = config;
    this.init();
  }

  private init() {
    // 1. JS è¿è¡Œæ—¶é”™è¯¯
    window.addEventListener('error', (event) => {
      if (event.target && (event.target as HTMLElement).tagName) {
        // èµ„æºåŠ è½½é”™è¯¯
        this.report({
          type: 'resource',
          message: `Failed to load ${(event.target as HTMLElement).tagName}`,
          url: (event.target as HTMLImageElement).src || (event.target as HTMLScriptElement).href,
        });
      } else {
        // JS é”™è¯¯
        this.report({
          type: 'javascript',
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          stack: event.error?.stack,
        });
      }
    }, true);

    // 2. Promise æœªæ•è·é”™è¯¯
    window.addEventListener('unhandledrejection', (event) => {
      this.report({
        type: 'promise',
        message: event.reason?.message || String(event.reason),
        stack: event.reason?.stack,
      });
    });

    // 3. æ¡†æ¶é”™è¯¯è¾¹ç•Œ
    this.setupReactErrorBoundary();
  }

  private setupReactErrorBoundary() {
    // é€šè¿‡ ErrorBoundary ç»„ä»¶æ•è·
  }

  private report(error: ErrorEvent) {
    // æ·»åŠ å…¬å…±ä¿¡æ¯
    const enrichedError = {
      ...error,
      timestamp: Date.now(),
      url: location.href,
      userAgent: navigator.userAgent,
      userId: this.config.userId,
      sessionId: this.config.sessionId,
    };

    this.queue.push(enrichedError);
    this.flush();
  }

  private flush() {
    if (this.queue.length === 0) return;

    // ä½¿ç”¨ sendBeacon ç¡®ä¿æ•°æ®å‘é€
    const data = JSON.stringify(this.queue);
    if (navigator.sendBeacon) {
      navigator.sendBeacon(this.config.reportUrl, data);
    } else {
      fetch(this.config.reportUrl, {
        method: 'POST',
        body: data,
        keepalive: true,
      });
    }

    this.queue = [];
  }
}

interface ErrorEvent {
  type: string;
  message: string;
  filename?: string;
  lineno?: number;
  colno?: number;
  stack?: string;
  url?: string;
  timestamp?: number;
  userAgent?: string;
  userId?: string;
  sessionId?: string;
}

interface MonitorConfig {
  reportUrl: string;
  userId?: string;
  sessionId?: string;
}

// ============================================================
// 3. æ€§èƒ½ç›‘æ§
// ============================================================

/**
 * ğŸ“Š æ€§èƒ½æŒ‡æ ‡é‡‡é›†
 *
 * Core Web Vitalsï¼š
 * - LCPï¼ˆLargest Contentful Paintï¼‰
 * - FIDï¼ˆFirst Input Delayï¼‰
 * - CLSï¼ˆCumulative Layout Shiftï¼‰
 *
 * å…¶ä»–æŒ‡æ ‡ï¼š
 * - FCPï¼ˆFirst Contentful Paintï¼‰
 * - TTFBï¼ˆTime to First Byteï¼‰
 * - èµ„æºåŠ è½½æ—¶é—´
 */

class PerformanceMonitor {
  private metrics: Record<string, number> = {};

  constructor() {
    this.observeWebVitals();
    this.observeResources();
  }

  private observeWebVitals() {
    // LCP
    const lcpObserver = new PerformanceObserver((list) => {
      const entries = list.getEntries();
      const lastEntry = entries[entries.length - 1];
      this.metrics.LCP = lastEntry.startTime;
    });
    lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });

    // FID
    const fidObserver = new PerformanceObserver((list) => {
      const entry = list.getEntries()[0] as PerformanceEventTiming;
      this.metrics.FID = entry.processingStart - entry.startTime;
    });
    fidObserver.observe({ type: 'first-input', buffered: true });

    // CLS
    let clsValue = 0;
    const clsObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries() as any[]) {
        if (!entry.hadRecentInput) {
          clsValue += entry.value;
        }
      }
      this.metrics.CLS = clsValue;
    });
    clsObserver.observe({ type: 'layout-shift', buffered: true });

    // FCP
    const fcpObserver = new PerformanceObserver((list) => {
      const entry = list.getEntries().find(e => e.name === 'first-contentful-paint');
      if (entry) {
        this.metrics.FCP = entry.startTime;
      }
    });
    fcpObserver.observe({ type: 'paint', buffered: true });
  }

  private observeResources() {
    const resourceObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries() as PerformanceResourceTiming[]) {
        // èµ„æºåŠ è½½æ…¢äº 3s çš„è®°å½•
        if (entry.duration > 3000) {
          this.reportSlowResource({
            name: entry.name,
            duration: entry.duration,
            type: entry.initiatorType,
          });
        }
      }
    });
    resourceObserver.observe({ type: 'resource', buffered: true });
  }

  private reportSlowResource(resource: { name: string; duration: number; type: string }) {
    console.log('Slow resource:', resource);
    // ä¸ŠæŠ¥æ…¢èµ„æº
  }

  getMetrics() {
    return this.metrics;
  }
}

// web-vitals åº“çš„ä½¿ç”¨
const webVitalsExample = `
import { onCLS, onFID, onLCP, onFCP, onTTFB } from 'web-vitals';

function sendToAnalytics(metric) {
  const body = JSON.stringify({
    name: metric.name,
    value: metric.value,
    id: metric.id,
    delta: metric.delta,
  });

  navigator.sendBeacon('/analytics', body);
}

onCLS(sendToAnalytics);
onFID(sendToAnalytics);
onLCP(sendToAnalytics);
onFCP(sendToAnalytics);
onTTFB(sendToAnalytics);
`;

// ============================================================
// 4. ç”¨æˆ·è¡Œä¸ºç›‘æ§
// ============================================================

/**
 * ğŸ“Š è¡Œä¸ºé‡‡é›†ç±»å‹
 *
 * - é¡µé¢è®¿é—®ï¼ˆPV/UVï¼‰
 * - ç‚¹å‡»äº‹ä»¶
 * - æ»šåŠ¨æ·±åº¦
 * - åœç•™æ—¶é•¿
 * - ç”¨æˆ·è·¯å¾„
 */

class BehaviorMonitor {
  private sessionId: string;
  private events: BehaviorEvent[] = [];

  constructor() {
    this.sessionId = this.generateSessionId();
    this.init();
  }

  private generateSessionId() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }

  private init() {
    // é¡µé¢è®¿é—®
    this.trackPageView();

    // ç‚¹å‡»äº‹ä»¶
    document.addEventListener('click', this.handleClick.bind(this), true);

    // é¡µé¢ç¦»å¼€
    window.addEventListener('beforeunload', () => {
      this.trackPageLeave();
      this.flush();
    });

    // å®šæ—¶ä¸ŠæŠ¥
    setInterval(() => this.flush(), 30000);
  }

  private trackPageView() {
    this.track('pageview', {
      url: location.href,
      referrer: document.referrer,
      title: document.title,
    });
  }

  private handleClick(event: MouseEvent) {
    const target = event.target as HTMLElement;

    // æå–ç‚¹å‡»ä¿¡æ¯
    const data = {
      tagName: target.tagName,
      className: target.className,
      id: target.id,
      text: target.innerText?.slice(0, 50),
      xpath: this.getXPath(target),
      x: event.clientX,
      y: event.clientY,
    };

    this.track('click', data);
  }

  private trackPageLeave() {
    this.track('pageleave', {
      url: location.href,
      duration: performance.now(),
    });
  }

  private getXPath(element: HTMLElement): string {
    const paths: string[] = [];
    let current: HTMLElement | null = element;

    while (current && current.nodeType === Node.ELEMENT_NODE) {
      let index = 1;
      let sibling = current.previousElementSibling;

      while (sibling) {
        if (sibling.tagName === current.tagName) {
          index++;
        }
        sibling = sibling.previousElementSibling;
      }

      paths.unshift(`${current.tagName.toLowerCase()}[${index}]`);
      current = current.parentElement;
    }

    return `/${paths.join('/')}`;
  }

  track(eventType: string, data: Record<string, any>) {
    this.events.push({
      type: eventType,
      data,
      timestamp: Date.now(),
      sessionId: this.sessionId,
      url: location.href,
    });
  }

  private flush() {
    if (this.events.length === 0) return;

    const data = JSON.stringify(this.events);
    navigator.sendBeacon('/api/behavior', data);
    this.events = [];
  }
}

interface BehaviorEvent {
  type: string;
  data: Record<string, any>;
  timestamp: number;
  sessionId: string;
  url: string;
}

// ============================================================
// 5. å‘Šè­¦æœºåˆ¶
// ============================================================

/**
 * ğŸ“Š å‘Šè­¦é…ç½®
 */

const alertConfigExample = `
// å‘Šè­¦è§„åˆ™é…ç½®
const alertRules = [
  {
    name: 'JS é”™è¯¯ç‡å‘Šè­¦',
    metric: 'js_error_rate',
    condition: 'gt',
    threshold: 0.01, // é”™è¯¯ç‡è¶…è¿‡ 1%
    window: '5m',     // 5 åˆ†é’Ÿçª—å£
    severity: 'critical',
    channels: ['slack', 'email', 'phone'],
  },
  {
    name: 'API é”™è¯¯ç‡å‘Šè­¦',
    metric: 'api_error_rate',
    condition: 'gt',
    threshold: 0.05,
    window: '5m',
    severity: 'warning',
    channels: ['slack', 'email'],
  },
  {
    name: 'LCP æ€§èƒ½å‘Šè­¦',
    metric: 'lcp_p95',
    condition: 'gt',
    threshold: 2500, // 2.5s
    window: '1h',
    severity: 'warning',
    channels: ['slack'],
  },
];

// å‘Šè­¦é€šçŸ¥æ¨¡æ¿
const alertTemplate = {
  slack: {
    blocks: [
      {
        type: 'header',
        text: { type: 'plain_text', text: 'ğŸš¨ å‰ç«¯å‘Šè­¦' },
      },
      {
        type: 'section',
        fields: [
          { type: 'mrkdwn', text: '*å‘Šè­¦åç§°:*\\n{{name}}' },
          { type: 'mrkdwn', text: '*ä¸¥é‡ç¨‹åº¦:*\\n{{severity}}' },
          { type: 'mrkdwn', text: '*å½“å‰å€¼:*\\n{{value}}' },
          { type: 'mrkdwn', text: '*é˜ˆå€¼:*\\n{{threshold}}' },
        ],
      },
    ],
  },
};
`;

// ============================================================
// 6. ç›‘æ§å¹³å°é€‰å‹
// ============================================================

/**
 * ğŸ“Š ç›‘æ§å¹³å°å¯¹æ¯”
 *
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ å¹³å°            â”‚ ç‰¹ç‚¹                                           â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ Sentry          â”‚ é”™è¯¯ç›‘æ§é¦–é€‰ï¼ŒSource Map æ”¯æŒå¥½                 â”‚
 * â”‚ Datadog         â”‚ å…¨æ ˆç›‘æ§ï¼ŒAPM èƒ½åŠ›å¼º                            â”‚
 * â”‚ New Relic       â”‚ ä¼ä¸šçº§ï¼ŒåŠŸèƒ½å…¨é¢                               â”‚
 * â”‚ é˜¿é‡Œäº‘ ARMS     â”‚ å›½å†…é¦–é€‰ï¼Œæ¥å…¥ç®€å•                              â”‚
 * â”‚ è‡ªå»ºæ–¹æ¡ˆ        â”‚ å®šåˆ¶åŒ–ï¼Œä½†ç»´æŠ¤æˆæœ¬é«˜                            â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

// Sentry æ¥å…¥
const sentrySetupExample = `
import * as Sentry from '@sentry/react';

Sentry.init({
  dsn: 'https://xxx@sentry.io/xxx',
  integrations: [
    new Sentry.BrowserTracing(),
    new Sentry.Replay(),
  ],
  tracesSampleRate: 0.1, // 10% æ€§èƒ½é‡‡æ ·
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
  environment: process.env.NODE_ENV,
  release: process.env.VERSION,
});

// React Error Boundary
const App = () => (
  <Sentry.ErrorBoundary fallback={<ErrorFallback />}>
    <MyApp />
  </Sentry.ErrorBoundary>
);
`;

// ============================================================
// 7. âš ï¸ æ³¨æ„äº‹é¡¹ï¼ˆæ˜“é”™ç‚¹ï¼‰
// ============================================================

/**
 * âš ï¸ å¸¸è§é—®é¢˜
 *
 * 1. æ•°æ®é‡‡é›†è¿‡å¤š
 *    - å½±å“æ€§èƒ½
 *    - é‡‡æ ·å’Œèšåˆ
 *
 * 2. å‘Šè­¦é£æš´
 *    - é˜ˆå€¼è®¾ç½®ä¸åˆç†
 *    - å‘Šè­¦èšåˆå’Œæ”¶æ•›
 *
 * 3. Source Map æ³„éœ²
 *    - ç”Ÿäº§ç¯å¢ƒä¸ä¸Šä¼ 
 *    - æˆ–é™åˆ¶è®¿é—®æƒé™
 *
 * 4. éšç§åˆè§„
 *    - ä¸é‡‡é›†æ•æ„Ÿä¿¡æ¯
 *    - ç¬¦åˆ GDPR
 */

// ============================================================
// 8. ğŸ’¡ é¢è¯•è¿½é—®
// ============================================================

/**
 * ğŸ’¡ æ·±åº¦è¿½é—®
 *
 * Q1: å¦‚ä½•ç›‘æ§ JS é”™è¯¯ï¼Ÿ
 * A:
 *    - window.onerror
 *    - addEventListener('error')
 *    - unhandledrejection
 *    - React Error Boundary
 *
 * Q2: ä»€ä¹ˆæ˜¯ Core Web Vitalsï¼Ÿ
 * A:
 *    - LCPï¼šæœ€å¤§å†…å®¹ç»˜åˆ¶ < 2.5s
 *    - FIDï¼šé¦–æ¬¡è¾“å…¥å»¶è¿Ÿ < 100ms
 *    - CLSï¼šç´¯è®¡å¸ƒå±€åç§» < 0.1
 *
 * Q3: å¦‚ä½•è®¾è®¡å‘Šè­¦ç­–ç•¥ï¼Ÿ
 * A:
 *    - åˆ†çº§ï¼ˆP0-P3ï¼‰
 *    - åˆ†æ¸ é“ï¼ˆç”µè¯/çŸ­ä¿¡/é‚®ä»¶ï¼‰
 *    - èšåˆæ”¶æ•›
 *    - å€¼ç­æœºåˆ¶
 *
 * Q4: å¦‚ä½•ä¿è¯æ•°æ®ä¸ŠæŠ¥å¯é æ€§ï¼Ÿ
 * A:
 *    - navigator.sendBeacon
 *    - ç¦»çº¿å­˜å‚¨
 *    - é‡è¯•æœºåˆ¶
 */

export {
  ErrorMonitor,
  PerformanceMonitor,
  BehaviorMonitor,
  webVitalsExample,
  alertConfigExample,
  sentrySetupExample,
};

