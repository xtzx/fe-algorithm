/**
 * ============================================================
 * ğŸ“š äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰
 * ============================================================
 *
 * é¢è¯•è€ƒå¯Ÿé‡ç‚¹ï¼š
 * 1. äº‹ä»¶å¾ªç¯çš„æœºåˆ¶
 * 2. å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„åŒºåˆ«
 * 3. å¸¸è§å¼‚æ­¥ä»»åŠ¡çš„åˆ†ç±»
 * 4. ç»å…¸è¾“å‡ºé¡ºåºé¢˜
 */

// ============================================================
// 1. ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶å¾ªç¯ï¼Ÿ
// ============================================================

/**
 * ğŸ“– JavaScript æ˜¯å•çº¿ç¨‹çš„
 *
 * åŸå› ï¼šJavaScript æœ€åˆæ˜¯ä¸ºæµè§ˆå™¨è®¾è®¡çš„ï¼Œç”¨äºæ“ä½œ DOMã€‚
 * å¦‚æœå¤šçº¿ç¨‹åŒæ—¶æ“ä½œ DOMï¼Œä¼šå¯¼è‡´å†²çªã€‚
 *
 * å•çº¿ç¨‹çš„é—®é¢˜ï¼šå¦‚æœæ‰§è¡Œè€—æ—¶æ“ä½œï¼Œä¼šé˜»å¡åç»­ä»£ç ã€‚
 * è§£å†³æ–¹æ¡ˆï¼šäº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰å®ç°å¼‚æ­¥éé˜»å¡ã€‚
 *
 * ğŸ“Š å•çº¿ç¨‹ + å¼‚æ­¥ = äº‹ä»¶å¾ªç¯
 */

// ============================================================
// 2. äº‹ä»¶å¾ªç¯æœºåˆ¶
// ============================================================

/**
 * ğŸ“Š æµè§ˆå™¨äº‹ä»¶å¾ªç¯æ¨¡å‹
 *
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                         è°ƒç”¨æ ˆ (Call Stack)                   â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
 * â”‚  â”‚  æ‰§è¡ŒåŒæ­¥ä»£ç                                             â”‚ â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
 * â”‚                              â”‚                               â”‚
 * â”‚                              â–¼                               â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
 * â”‚  â”‚  å¾®ä»»åŠ¡é˜Ÿåˆ— (Microtask Queue)                           â”‚ â”‚
 * â”‚  â”‚  Promise.then, MutationObserver, queueMicrotask         â”‚ â”‚
 * â”‚  â”‚  ã€åŒæ­¥ä»£ç æ‰§è¡Œå®Œåï¼Œæ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡ã€‘                      â”‚ â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
 * â”‚                              â”‚                               â”‚
 * â”‚                              â–¼                               â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
 * â”‚  â”‚  æ¸²æŸ“æ›´æ–° (å¯èƒ½æ‰§è¡Œ)                                     â”‚ â”‚
 * â”‚  â”‚  requestAnimationFrame â†’ æ ·å¼è®¡ç®— â†’ å¸ƒå±€ â†’ ç»˜åˆ¶          â”‚ â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
 * â”‚                              â”‚                               â”‚
 * â”‚                              â–¼                               â”‚
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
 * â”‚  â”‚  å®ä»»åŠ¡é˜Ÿåˆ— (Macrotask Queue)                           â”‚ â”‚
 * â”‚  â”‚  setTimeout, setInterval, I/O, UI æ¸²æŸ“, requestIdleCallbackâ”‚
 * â”‚  â”‚  ã€ä»é˜Ÿåˆ—ä¸­å–ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œã€‘                             â”‚ â”‚
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
 * â”‚                              â”‚                               â”‚
 * â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º å¾ªç¯               â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

// ============================================================
// 3. å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡
// ============================================================

/**
 * ğŸ“Š å®ä»»åŠ¡ï¼ˆMacrotaskï¼‰
 *
 * - scriptï¼ˆæ•´ä½“ä»£ç ï¼‰
 * - setTimeout / setInterval
 * - setImmediateï¼ˆNode.jsï¼‰
 * - I/O
 * - UI æ¸²æŸ“
 * - requestAnimationFrame
 * - MessageChannel
 *
 * ğŸ“Š å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰
 *
 * - Promise.then / catch / finally
 * - async/awaitï¼ˆawait åçš„ä»£ç ï¼‰
 * - MutationObserver
 * - queueMicrotask
 * - process.nextTickï¼ˆNode.jsï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰
 *
 * ğŸ’¡ å…³é”®åŒºåˆ«ï¼š
 * - å¾®ä»»åŠ¡åœ¨å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œåç«‹å³æ‰§è¡Œ
 * - å¾®ä»»åŠ¡é˜Ÿåˆ—ä¼šè¢«å®Œå…¨æ¸…ç©ºåæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡
 * - å¾®ä»»åŠ¡ä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡
 */

// ============================================================
// 4. æ‰§è¡Œé¡ºåºç¤ºä¾‹
// ============================================================

// ç¤ºä¾‹ 1ï¼šåŸºç¡€
console.log('1'); // åŒæ­¥

setTimeout(() => {
  console.log('2'); // å®ä»»åŠ¡
}, 0);

Promise.resolve().then(() => {
  console.log('3'); // å¾®ä»»åŠ¡
});

console.log('4'); // åŒæ­¥

// è¾“å‡ºï¼š1, 4, 3, 2

// ç¤ºä¾‹ 2ï¼šå¾®ä»»åŠ¡ä¸­äº§ç”Ÿå¾®ä»»åŠ¡
console.log('start');

setTimeout(() => {
  console.log('timeout');
}, 0);

Promise.resolve()
  .then(() => {
    console.log('promise1');
    Promise.resolve().then(() => {
      console.log('promise2');
    });
  })
  .then(() => {
    console.log('promise3');
  });

console.log('end');

// è¾“å‡ºï¼šstart, end, promise1, promise2, promise3, timeout
// è§£æï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—ä¼šè¢«å®Œå…¨æ¸…ç©ºåæ‰æ‰§è¡Œå®ä»»åŠ¡

// ============================================================
// 5. async/await ä¸äº‹ä»¶å¾ªç¯
// ============================================================

/**
 * ğŸ“– async/await çš„æœ¬è´¨
 *
 * async å‡½æ•°è¿”å› Promise
 * await ç›¸å½“äº Promise.thenï¼Œä¼šè®©å‡ºæ‰§è¡Œæƒ
 *
 * await expression ç­‰ä»·äºï¼š
 * Promise.resolve(expression).then(result => {
 *   // await åé¢çš„ä»£ç 
 * })
 */

async function async1() {
  console.log('async1 start');
  await async2(); // ç›¸å½“äº Promise.resolve(async2()).then(...)
  console.log('async1 end'); // è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
}

async function async2() {
  console.log('async2');
}

console.log('script start');

setTimeout(() => {
  console.log('setTimeout');
}, 0);

async1();

new Promise((resolve) => {
  console.log('promise1');
  resolve(undefined);
}).then(() => {
  console.log('promise2');
});

console.log('script end');

/**
 * è¾“å‡ºé¡ºåºï¼š
 * 1. script startï¼ˆåŒæ­¥ï¼‰
 * 2. async1 startï¼ˆåŒæ­¥ï¼Œè¿›å…¥ async1ï¼‰
 * 3. async2ï¼ˆåŒæ­¥ï¼Œæ‰§è¡Œ async2ï¼‰
 * 4. promise1ï¼ˆåŒæ­¥ï¼ŒPromise æ„é€ å‡½æ•°ï¼‰
 * 5. script endï¼ˆåŒæ­¥ï¼‰
 * 6. async1 endï¼ˆå¾®ä»»åŠ¡ï¼‰
 * 7. promise2ï¼ˆå¾®ä»»åŠ¡ï¼‰
 * 8. setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰
 */

// ============================================================
// 6. requestAnimationFrame
// ============================================================

/**
 * ğŸ“– requestAnimationFrame (rAF)
 *
 * - åœ¨æµè§ˆå™¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨
 * - é€šå¸¸æ¯ç§’ 60 æ¬¡ï¼ˆ16.67ms ä¸€æ¬¡ï¼‰
 * - æ¯” setTimeout æ›´é€‚åˆåšåŠ¨ç”»
 *
 * æ‰§è¡Œæ—¶æœºï¼š
 * - åœ¨å¾®ä»»åŠ¡ä¹‹åï¼Œå®ä»»åŠ¡ä¹‹å‰
 * - åœ¨æ¸²æŸ“ä¹‹å‰æ‰§è¡Œ
 *
 * æ³¨æ„ï¼šrAF çš„å›è°ƒæ˜¯åœ¨æ‰€æœ‰å¾®ä»»åŠ¡æ‰§è¡Œå®Œä¹‹åã€æ¸²æŸ“ä¹‹å‰æ‰§è¡Œ
 */

// åŠ¨ç”»ç¤ºä¾‹
function animate(element: HTMLElement) {
  let start: number;

  function step(timestamp: number) {
    if (!start) start = timestamp;
    const progress = timestamp - start;

    element.style.transform = `translateX(${Math.min(progress / 10, 200)}px)`;

    if (progress < 2000) {
      requestAnimationFrame(step);
    }
  }

  requestAnimationFrame(step);
}

// ============================================================
// 7. requestIdleCallback
// ============================================================

/**
 * ğŸ“– requestIdleCallback (rIC)
 *
 * - åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œ
 * - é€‚åˆæ‰§è¡Œä¸ç´§æ€¥çš„ä»»åŠ¡
 * - React Fiber çš„è°ƒåº¦å€Ÿé‰´äº†è¿™ä¸ªæ€æƒ³
 *
 * æ‰§è¡Œæ—¶æœºï¼š
 * - åœ¨ä¸€å¸§çš„æ¸²æŸ“å®Œæˆåï¼Œå¦‚æœè¿˜æœ‰å‰©ä½™æ—¶é—´
 * - æˆ–è€…è®¾ç½®äº† timeout åå¼ºåˆ¶æ‰§è¡Œ
 */

// ç¤ºä¾‹
if (typeof requestIdleCallback !== 'undefined') {
  requestIdleCallback(
    (deadline) => {
      // deadline.timeRemaining() è¿”å›å½“å‰å¸§å‰©ä½™æ—¶é—´
      while (deadline.timeRemaining() > 0) {
        // æ‰§è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡
        console.log('Idle work');
      }
    },
    { timeout: 1000 } // æœ€å¤šç­‰ 1 ç§’
  );
}

// ============================================================
// 8. Node.js äº‹ä»¶å¾ªç¯
// ============================================================

/**
 * ğŸ“Š Node.js äº‹ä»¶å¾ªç¯ï¼ˆä¸åŒäºæµè§ˆå™¨ï¼‰
 *
 *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”Œâ”€>â”‚           timers          â”‚  setTimeout, setInterval
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  â”‚     pending callbacks     â”‚  I/O å›è°ƒ
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  â”‚       idle, prepare       â”‚  å†…éƒ¨ä½¿ç”¨
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  â”‚           poll            â”‚  è·å–æ–°çš„ I/O äº‹ä»¶
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  â”‚           check           â”‚  setImmediate
 * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â””â”€â”€â”¤      close callbacks      â”‚  socket.on('close')
 *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * æ¯ä¸ªé˜¶æ®µä¹‹é—´éƒ½ä¼šæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—
 * process.nextTick ä¼˜å…ˆçº§é«˜äºå…¶ä»–å¾®ä»»åŠ¡
 */

// Node.js ç¤ºä¾‹
// setTimeout(() => {
//   console.log('timeout');
// }, 0);

// setImmediate(() => {
//   console.log('immediate');
// });

// è¾“å‡ºé¡ºåºä¸ç¡®å®šï¼ˆå–å†³äºäº‹ä»¶å¾ªç¯è¿›å…¥æ—¶æœºï¼‰

// ä½†åœ¨ I/O å›è°ƒä¸­ï¼ŒsetImmediate æ€»æ˜¯å…ˆæ‰§è¡Œ
// const fs = require('fs');
// fs.readFile(__filename, () => {
//   setTimeout(() => console.log('timeout'), 0);
//   setImmediate(() => console.log('immediate'));
// });
// è¾“å‡ºï¼šimmediate, timeout

// ============================================================
// 9. é«˜é¢‘é¢è¯•é¢˜
// ============================================================

/**
 * é¢˜ç›® 1ï¼šç»å…¸è¾“å‡ºé¡ºåº
 */
console.log('1');

setTimeout(function () {
  console.log('2');
  new Promise(function (resolve) {
    console.log('3');
    resolve(undefined);
  }).then(function () {
    console.log('4');
  });
}, 0);

new Promise(function (resolve) {
  console.log('5');
  resolve(undefined);
}).then(function () {
  console.log('6');
});

setTimeout(function () {
  console.log('7');
  new Promise(function (resolve) {
    console.log('8');
    resolve(undefined);
  }).then(function () {
    console.log('9');
  });
}, 0);

console.log('10');

/**
 * è¾“å‡ºï¼š1, 5, 10, 6, 2, 3, 4, 7, 8, 9
 *
 * è§£æï¼š
 * 1. åŒæ­¥ä»£ç ï¼š1, 5, 10
 * 2. å¾®ä»»åŠ¡ï¼š6
 * 3. ç¬¬ä¸€ä¸ªå®ä»»åŠ¡ï¼š2, 3
 * 4. å¾®ä»»åŠ¡ï¼š4
 * 5. ç¬¬äºŒä¸ªå®ä»»åŠ¡ï¼š7, 8
 * 6. å¾®ä»»åŠ¡ï¼š9
 */

/**
 * é¢˜ç›® 2ï¼šasync/await è¾“å‡ºé¡ºåº
 */
async function async3() {
  console.log('async3 start');
  await async4();
  console.log('async3 end');
  await async5();
  console.log('async3 final');
}

async function async4() {
  console.log('async4');
}

async function async5() {
  console.log('async5');
}

console.log('script start');
async3();
console.log('script end');

/**
 * è¾“å‡ºï¼š
 * script start
 * async3 start
 * async4
 * script end
 * async3 end
 * async5
 * async3 final
 */

/**
 * é¢˜ç›® 3ï¼šPromise é“¾å¼è°ƒç”¨
 */
Promise.resolve()
  .then(() => {
    console.log(0);
    return Promise.resolve(4);
  })
  .then((res) => {
    console.log(res);
  });

Promise.resolve()
  .then(() => {
    console.log(1);
  })
  .then(() => {
    console.log(2);
  })
  .then(() => {
    console.log(3);
  })
  .then(() => {
    console.log(5);
  })
  .then(() => {
    console.log(6);
  });

/**
 * è¾“å‡ºï¼š0, 1, 2, 3, 4, 5, 6
 *
 * è§£æï¼š
 * - return Promise.resolve(4) ä¼šäº§ç”Ÿé¢å¤–çš„å¾®ä»»åŠ¡
 * - V8 å¼•æ“å¯¹ Promise è¿”å› Promise æœ‰ç‰¹æ®Šå¤„ç†
 * - ç›¸å½“äºé¢å¤–æ·»åŠ äº†ä¸¤ä¸ªå¾®ä»»åŠ¡
 */

// ============================================================
// 10. å®æˆ˜åº”ç”¨
// ============================================================

// 10.1 å®ç°å¾®ä»»åŠ¡
function nextTick(callback: () => void) {
  if (typeof queueMicrotask === 'function') {
    queueMicrotask(callback);
  } else if (typeof Promise !== 'undefined') {
    Promise.resolve().then(callback);
  } else if (typeof MutationObserver !== 'undefined') {
    // MutationObserver å®ç°ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
    const observer = new MutationObserver(callback);
    const textNode = document.createTextNode('');
    observer.observe(textNode, { characterData: true });
    textNode.data = '1';
  } else {
    // é™çº§åˆ°å®ä»»åŠ¡
    setTimeout(callback, 0);
  }
}

// 10.2 å®ç°æ—¶é—´åˆ‡ç‰‡ï¼ˆé¿å…é•¿ä»»åŠ¡é˜»å¡ï¼‰
function timeSlice(tasks: (() => void)[], yieldTime = 5) {
  const queue = [...tasks];

  function runTask() {
    const start = performance.now();

    // åœ¨ä¸€ä¸ªæ—¶é—´ç‰‡å†…å°½å¯èƒ½æ‰§è¡Œå¤šä¸ªä»»åŠ¡
    while (queue.length > 0 && performance.now() - start < yieldTime) {
      const task = queue.shift();
      task?.();
    }

    // è¿˜æœ‰ä»»åŠ¡ï¼Œè®©å‡ºä¸»çº¿ç¨‹
    if (queue.length > 0) {
      // ä½¿ç”¨ MessageChannel åˆ›å»ºå®ä»»åŠ¡
      const channel = new MessageChannel();
      channel.port1.onmessage = runTask;
      channel.port2.postMessage(null);
    }
  }

  runTask();
}

// 10.3 åˆ¤æ–­æ˜¯å¦åœ¨ä¸»çº¿ç¨‹
function isMainThread(): boolean {
  return typeof window !== 'undefined' && typeof window.document !== 'undefined';
}

export { nextTick, timeSlice, isMainThread };

