/**
 * ============================================================
 * ğŸ“š Phase 10: Suspense & å¼‚æ­¥æ¸²æŸ“ & é”™è¯¯è¾¹ç•Œ - Part 3: Throw Promise ä¸è§£å†³æµç¨‹
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-reconciler/src/ReactFiberThrow.new.js (throwException)
 * - packages/react-reconciler/src/ReactFiberWorkLoop.new.js (handleError, pingSuspendedRoot)
 * - packages/react-reconciler/src/ReactFiberUnwindWork.new.js
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š2-3 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­
 */

// ============================================================
// Part 1: throwException - å¤„ç† thrown å€¼çš„å…¥å£
// ============================================================

/**
 * ğŸ“Š throwException å‡½æ•°
 */

const throwExceptionFunction = `
ğŸ“Š throwException - å¤„ç† thrown å€¼çš„å…¥å£

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberThrow.new.js (Line 405)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function throwException(
  root: FiberRoot,
  returnFiber: Fiber,        // æŠ›å‡ºå¼‚å¸¸çš„ç»„ä»¶çš„çˆ¶ Fiber
  sourceFiber: Fiber,        // æŠ›å‡ºå¼‚å¸¸çš„ç»„ä»¶ Fiber
  value: mixed,              // æŠ›å‡ºçš„å€¼ï¼ˆå¯èƒ½æ˜¯ Promise æˆ– Errorï¼‰
  rootRenderLanes: Lanes,
) {
  // 1. æ ‡è®° sourceFiber ä¸ºæœªå®Œæˆ
  sourceFiber.flags |= Incomplete;

  // 2. åˆ¤æ–­æŠ›å‡ºçš„æ˜¯ Promise è¿˜æ˜¯ Error
  if (
    value !== null &&
    typeof value === 'object' &&
    typeof value.then === 'function'  // â­ æ£€æŸ¥æ˜¯å¦æœ‰ .then æ–¹æ³•
  ) {
    // â­ æ˜¯ Promise (Wakeable)ï¼Œèµ° Suspense å¤„ç†æµç¨‹
    const wakeable: Wakeable = value;

    // é‡ç½®æŒ‚èµ·ç»„ä»¶çš„çŠ¶æ€
    resetSuspendedComponent(sourceFiber, rootRenderLanes);

    // æ‰¾åˆ°æœ€è¿‘çš„ Suspense è¾¹ç•Œ
    const suspenseBoundary = getNearestSuspenseBoundaryToCapture(returnFiber);

    if (suspenseBoundary !== null) {
      // æ ‡è®°è¾¹ç•Œéœ€è¦æ•è·
      markSuspenseBoundaryShouldCapture(suspenseBoundary, ...);

      // æ³¨å†Œé‡è¯•ç›‘å¬å™¨ï¼ˆPromise resolve æ—¶è§¦å‘ï¼‰
      attachRetryListener(suspenseBoundary, root, wakeable, rootRenderLanes);

      return;
    }
    // ... æ²¡æœ‰ Suspense è¾¹ç•Œçš„å¤„ç†
  } else {
    // â­ æ˜¯ Errorï¼Œèµ°é”™è¯¯è¾¹ç•Œå¤„ç†æµç¨‹
    // æ‰¾åˆ°æœ€è¿‘çš„é”™è¯¯è¾¹ç•Œ
    // ... åç»­åœ¨ Part 4 è¯¦è§£
  }
}


å…³é”®ç†è§£
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   React å¦‚ä½•åŒºåˆ† Promise å’Œ Errorï¼Ÿ                                         â”‚
â”‚                                                                             â”‚
â”‚   typeof value.then === 'function'                                          â”‚
â”‚                                                                             â”‚
â”‚   â€¢ true â†’ Promise (æˆ– thenable)ï¼Œèµ° Suspense æµç¨‹                         â”‚
â”‚   â€¢ false â†’ Errorï¼Œèµ° ErrorBoundary æµç¨‹                                   â”‚
â”‚                                                                             â”‚
â”‚   è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç»„ä»¶å¯ä»¥é€šè¿‡ throw Promise æ¥"æŒ‚èµ·"                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 2: å®Œæ•´çš„æŒ‚èµ·å¤„ç†æµç¨‹
// ============================================================

/**
 * ğŸ“Š Throw Promise å®Œæ•´æµç¨‹
 */

const throwPromiseFlow = `
ğŸ“Š Throw Promise çš„å®Œæ•´å¤„ç†æµç¨‹

æ—¶é—´çº¿ï¼šä» throw Promise åˆ°æ˜¾ç¤º fallback
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 1: ç»„ä»¶æŠ›å‡º Promise                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚                                                                             â”‚
â”‚   function MyComponent() {                                                  â”‚
â”‚     const data = fetchData();  // å¦‚æœæœªå°±ç»ªï¼Œä¼š throw Promise             â”‚
â”‚     return <div>{data}</div>;                                               â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â”‚   // æˆ–è€… React.lazy                                                        â”‚
â”‚   const LazyComp = React.lazy(() => import('./Component'));                 â”‚
â”‚   // é¦–æ¬¡æ¸²æŸ“æ—¶ä¼š throw ä¸€ä¸ªåŠ è½½æ¨¡å—çš„ Promise                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 2: renderRootSync/Concurrent ä¸­æ•è·å¼‚å¸¸                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚                                                                             â”‚
â”‚   // ReactFiberWorkLoop.new.js                                              â”‚
â”‚   try {                                                                     â”‚
â”‚     workLoopSync() / workLoopConcurrent();                                  â”‚
â”‚   } catch (thrownValue) {                                                   â”‚
â”‚     handleError(root, thrownValue);  // â­ æ•è·å¹¶å¤„ç†                       â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 3: throwException å¤„ç† Promise                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚                                                                             â”‚
â”‚   // ReactFiberThrow.new.js                                                 â”‚
â”‚   throwException(root, returnFiber, sourceFiber, thrownValue, lanes);       â”‚
â”‚                                                                             â”‚
â”‚   å†…éƒ¨æµç¨‹:                                                                 â”‚
â”‚   1. æ£€æµ‹ value.then â†’ ç¡®è®¤æ˜¯ Promise                                       â”‚
â”‚   2. getNearestSuspenseBoundaryToCapture â†’ æ‰¾åˆ° Suspense è¾¹ç•Œ              â”‚
â”‚   3. markSuspenseBoundaryShouldCapture â†’ è®¾ç½® ShouldCapture æ ‡è®°           â”‚
â”‚   4. attachRetryListener â†’ æ³¨å†Œ Promise.then å›è°ƒ                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 4: Unwind é˜¶æ®µï¼ˆå›æº¯å¤„ç†ï¼‰                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                             â”‚
â”‚   // ä»æŠ›å‡ºå¼‚å¸¸çš„ Fiber å¼€å§‹å‘ä¸Šå›æº¯                                        â”‚
â”‚   // æ‰¾åˆ°æœ‰ ShouldCapture æ ‡è®°çš„ Suspense è¾¹ç•Œ                              â”‚
â”‚                                                                             â”‚
â”‚   function completeUnitOfWork(unitOfWork) {                                 â”‚
â”‚     // ...                                                                  â”‚
â”‚     if ((unitOfWork.flags & Incomplete) !== NoFlags) {                      â”‚
â”‚       // ç»„ä»¶æœªå®Œæˆï¼Œè¿›å…¥ unwind æµç¨‹                                       â”‚
â”‚       const next = unwindWork(unitOfWork, ...);                             â”‚
â”‚       if (next !== null) {                                                  â”‚
â”‚         // â­ è¿”å› Suspense è¾¹ç•Œï¼Œå‡†å¤‡é‡æ–°æ¸²æŸ“                              â”‚
â”‚         workInProgress = next;                                              â”‚
â”‚         return;                                                             â”‚
â”‚       }                                                                     â”‚
â”‚     }                                                                       â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â”‚   unwindWork ä¸­å¯¹ SuspenseComponent çš„å¤„ç†:                                 â”‚
â”‚   â€¢ æ£€æŸ¥ ShouldCapture æ ‡è®°                                                 â”‚
â”‚   â€¢ æ¸…é™¤ ShouldCaptureï¼Œè®¾ç½® DidCapture                                     â”‚
â”‚   â€¢ è¿”å› Suspense Fiberï¼Œè®© WorkLoop ä»è¿™é‡Œé‡æ–°å¼€å§‹                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 5: é‡æ–° beginWork(Suspense)ï¼Œæ¸²æŸ“ fallback                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚                                                                             â”‚
â”‚   // ReactFiberBeginWork.new.js                                             â”‚
â”‚   function updateSuspenseComponent(current, workInProgress, renderLanes) {  â”‚
â”‚     const didSuspend = (workInProgress.flags & DidCapture) !== NoFlags;     â”‚
â”‚                                                                             â”‚
â”‚     if (didSuspend) {                                                       â”‚
â”‚       // â­ æœ‰ DidCapture æ ‡è®°ï¼Œæ¸²æŸ“ fallback                               â”‚
â”‚       workInProgress.flags &= ~DidCapture;  // æ¸…é™¤æ ‡è®°                     â”‚
â”‚                                                                             â”‚
â”‚       // æ¸²æŸ“ fallback å†…å®¹                                                 â”‚
â”‚       const fallbackFragment = mountSuspenseFallbackChildren(...);          â”‚
â”‚       return fallbackFragment;                                              â”‚
â”‚     } else {                                                                â”‚
â”‚       // æ­£å¸¸æ¸²æŸ“ children                                                  â”‚
â”‚       const primaryChildren = mountSuspensePrimaryChildren(...);            â”‚
â”‚       return primaryChildren;                                               â”‚
â”‚     }                                                                       â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 6: Commit é˜¶æ®µ - æ˜¾ç¤º fallback                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚                                                                             â”‚
â”‚   â€¢ ä¸»å†…å®¹å¯¹åº”çš„ DOM è¢«éšè—æˆ–ç§»é™¤                                           â”‚
â”‚   â€¢ fallback å¯¹åº”çš„ DOM è¢«æ’å…¥/æ˜¾ç¤º                                         â”‚
â”‚   â€¢ ç”¨æˆ·çœ‹åˆ° Loading çŠ¶æ€                                                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 3: Promise Resolve åçš„é‡è¯•æµç¨‹
// ============================================================

/**
 * ğŸ“Š Promise Resolve åçš„é‡è¯•
 */

const promiseResolveAndRetry = `
ğŸ“Š Promise Resolve åçš„é‡è¯•æµç¨‹

attachRetryListener - æ³¨å†Œé‡è¯•ç›‘å¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æºç ä½ç½®: ReactFiberThrow.new.js (Line 206-231)

function attachRetryListener(
  suspenseBoundary: Fiber,
  root: FiberRoot,
  wakeable: Wakeable,
  lanes: Lanes,
) {
  // å°† Promise å­˜å‚¨åˆ° Suspense è¾¹ç•Œçš„ updateQueue
  const wakeables: Set<Wakeable> | null = suspenseBoundary.updateQueue;
  if (wakeables === null) {
    const updateQueue = new Set();
    updateQueue.add(wakeable);
    suspenseBoundary.updateQueue = updateQueue;
  } else {
    wakeables.add(wakeable);
  }
}


attachPingListener - æ³¨å†Œ ping ç›‘å¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æºç ä½ç½®: ReactFiberThrow.new.js (Line 166-204)

function attachPingListener(root: FiberRoot, wakeable: Wakeable, lanes: Lanes) {
  // åœ¨ root.pingCache ä¸­å­˜å‚¨ (wakeable â†’ lanes) çš„æ˜ å°„
  let pingCache = root.pingCache;
  // ...

  // â­ æ ¸å¿ƒï¼šåœ¨ Promise ä¸Šæ³¨å†Œ .then å›è°ƒ
  const ping = pingSuspendedRoot.bind(null, root, wakeable, lanes);
  wakeable.then(ping, ping);  // resolve æˆ– reject éƒ½ä¼šè§¦å‘ ping
}


pingSuspendedRoot - è§¦å‘é‡æ–°æ¸²æŸ“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æºç ä½ç½®: ReactFiberWorkLoop.new.js

export function pingSuspendedRoot(
  root: FiberRoot,
  wakeable: Wakeable,
  pingedLanes: Lanes,
) {
  // æ£€æŸ¥è¿™ä¸ª wakeable æ˜¯å¦ä»ç„¶ç›¸å…³
  const pingCache = root.pingCache;
  if (pingCache !== null) {
    // ä» cache ä¸­ç§»é™¤
    pingCache.delete(wakeable);
  }

  // â­ æ ¸å¿ƒï¼šè°ƒåº¦ä¸€ä¸ªæ–°çš„æ›´æ–°
  // åˆå¹¶ lanesï¼Œè§¦å‘é‡æ–°æ¸²æŸ“
  markRootPinged(root, pingedLanes, eventTime);

  // å¦‚æœå½“å‰æ­£åœ¨æ¸²æŸ“è¿™ä¸ª rootï¼Œå¯èƒ½éœ€è¦ä¸­æ–­å¹¶é‡å¯
  if (workInProgressRoot === root && ...) {
    // å‡†å¤‡é‡æ–°ä»å¤´å¼€å§‹æ¸²æŸ“
    prepareFreshStack(root, NoLanes);
  }

  // è°ƒåº¦æ–°çš„æ¸²æŸ“ä»»åŠ¡
  ensureRootIsScheduled(root, eventTime);
}


å®Œæ•´çš„é‡è¯•æ—¶é—´çº¿
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Promise resolve åçš„æµç¨‹:                                                 â”‚
â”‚                                                                             â”‚
â”‚   æ—¶é—´ â†’                                                                    â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚                                                                             â”‚
â”‚   T0: ç»„ä»¶ throw Promise                                                    â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â””â”€â”€ attachPingListener â†’ wakeable.then(ping, ping)                   â”‚
â”‚                                                                             â”‚
â”‚   T1: æ˜¾ç¤º fallback                                                         â”‚
â”‚                                                                             â”‚
â”‚   T2: Promise resolveï¼                                                     â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â””â”€â”€ ping å›è°ƒè¢«è°ƒç”¨                                                   â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â””â”€â”€ pingSuspendedRoot                                             â”‚
â”‚               â”‚                                                             â”‚
â”‚               â””â”€â”€ ensureRootIsScheduled â†’ è°ƒåº¦æ–°æ¸²æŸ“                        â”‚
â”‚                                                                             â”‚
â”‚   T3: æ–°çš„æ¸²æŸ“å¼€å§‹                                                          â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â””â”€â”€ ç»„ä»¶å†æ¬¡æ‰§è¡Œ                                                      â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â””â”€â”€ è¿™æ¬¡æ•°æ®å°±ç»ªï¼Œä¸å† throw                                      â”‚
â”‚               â”‚                                                             â”‚
â”‚               â””â”€â”€ æ­£å¸¸è¿”å› JSX                                              â”‚
â”‚                                                                             â”‚
â”‚   T4: Commit é˜¶æ®µ                                                           â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â””â”€â”€ fallback è¢«ç§»é™¤/éšè—                                              â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â””â”€â”€ çœŸå®å†…å®¹è¢«æ˜¾ç¤º                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 4: æ¡ˆä¾‹åˆ†æ - React.lazy + Suspense
// ============================================================

/**
 * ğŸ“Š æ¡ˆä¾‹ A: React.lazy + Suspense
 */

const lazyAndSuspenseCase = `
ğŸ“Š æ¡ˆä¾‹ A: React.lazy + Suspense

ç¤ºä¾‹ä»£ç 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// HeavyComponent.js
export default function HeavyComponent() {
  return <div>Heavy Content Loaded!</div>;
}

// App.js
const LazyComponent = React.lazy(() => import('./HeavyComponent'));

function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <LazyComponent />
    </Suspense>
  );
}


React.lazy çš„å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// packages/react/src/ReactLazy.js
function lazy(ctor) {
  return {
    $$typeof: REACT_LAZY_TYPE,
    _payload: {
      _status: Uninitialized,  // -1
      _result: ctor,           // import() å‡½æ•°
    },
    _init: lazyInitializer,
  };
}

function lazyInitializer(payload) {
  if (payload._status === Uninitialized) {
    const ctor = payload._result;
    const thenable = ctor();  // è°ƒç”¨ import()ï¼Œè¿”å› Promise

    payload._status = Pending;
    payload._result = thenable;

    thenable.then(
      moduleObject => {
        payload._status = Resolved;
        payload._result = moduleObject.default;  // ç»„ä»¶
      },
      error => {
        payload._status = Rejected;
        payload._result = error;
      }
    );
  }

  if (payload._status === Resolved) {
    return payload._result;  // è¿”å›ç»„ä»¶
  } else {
    throw payload._result;   // â­ throw Promiseï¼
  }
}


é¦–æ¬¡æ¸²æŸ“çš„è¯¦ç»†æµç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   1. beginWork(Suspense)                                                    â”‚
â”‚      â€¢ memoizedState === nullï¼Œæ²¡æœ‰ DidCapture                              â”‚
â”‚      â€¢ å‡†å¤‡æ¸²æŸ“ children (LazyComponent)                                    â”‚
â”‚                                                                             â”‚
â”‚   2. beginWork(LazyComponent)                                               â”‚
â”‚      â€¢ è°ƒç”¨ lazyInitializer                                                 â”‚
â”‚      â€¢ _status === Uninitializedï¼Œè°ƒç”¨ import()                             â”‚
â”‚      â€¢ _status å˜æˆ Pending                                                 â”‚
â”‚      â€¢ â­ throw payload._result (Promise)                                   â”‚
â”‚                                                                             â”‚
â”‚   3. WorkLoop catch                                                         â”‚
â”‚      â€¢ handleError(root, thrownValue)                                       â”‚
â”‚      â€¢ throwException(...)                                                  â”‚
â”‚                                                                             â”‚
â”‚   4. throwException                                                         â”‚
â”‚      â€¢ value.then å­˜åœ¨ â†’ æ˜¯ Promise                                         â”‚
â”‚      â€¢ getNearestSuspenseBoundaryToCapture â†’ æ‰¾åˆ° Suspense                  â”‚
â”‚      â€¢ suspenseBoundary.flags |= ShouldCapture                              â”‚
â”‚      â€¢ attachPingListener â†’ promise.then(ping, ping)                       â”‚
â”‚                                                                             â”‚
â”‚   5. Unwind                                                                 â”‚
â”‚      â€¢ completeUnitOfWork æ£€æµ‹åˆ° Incomplete                                 â”‚
â”‚      â€¢ unwindWork(SuspenseComponent)                                        â”‚
â”‚      â€¢ æ¸…é™¤ ShouldCaptureï¼Œè®¾ç½® DidCapture                                  â”‚
â”‚      â€¢ è¿”å› Suspense Fiber                                                  â”‚
â”‚                                                                             â”‚
â”‚   6. é‡æ–° beginWork(Suspense)                                               â”‚
â”‚      â€¢ æ£€æµ‹åˆ° DidCapture                                                    â”‚
â”‚      â€¢ æ¸²æŸ“ fallback: <div>Loading...</div>                                 â”‚
â”‚                                                                             â”‚
â”‚   7. Commit                                                                 â”‚
â”‚      â€¢ ç”¨æˆ·çœ‹åˆ° "Loading..."                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ¨¡å—åŠ è½½å®Œæˆå
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   1. Promise resolve                                                        â”‚
â”‚      â€¢ lazyInitializer ä¸­çš„ thenable.then è¢«è°ƒç”¨                            â”‚
â”‚      â€¢ payload._status = Resolved                                           â”‚
â”‚      â€¢ payload._result = HeavyComponent                                     â”‚
â”‚                                                                             â”‚
â”‚   2. ping å›è°ƒè§¦å‘                                                          â”‚
â”‚      â€¢ pingSuspendedRoot(root, wakeable, lanes)                            â”‚
â”‚      â€¢ ensureRootIsScheduled â†’ è°ƒåº¦æ–°æ¸²æŸ“                                   â”‚
â”‚                                                                             â”‚
â”‚   3. æ–°çš„æ¸²æŸ“                                                               â”‚
â”‚      â€¢ beginWork(Suspense): æ²¡æœ‰ DidCaptureï¼Œæ¸²æŸ“ children                  â”‚
â”‚      â€¢ beginWork(LazyComponent)                                             â”‚
â”‚        - lazyInitializer: _status === Resolved                              â”‚
â”‚        - è¿”å› HeavyComponent                                                â”‚
â”‚      â€¢ æ­£å¸¸æ¸²æŸ“å®Œæˆ                                                         â”‚
â”‚                                                                             â”‚
â”‚   4. Commit                                                                 â”‚
â”‚      â€¢ fallback DOM è¢«ç§»é™¤                                                  â”‚
â”‚      â€¢ HeavyComponent çš„ DOM è¢«æ˜¾ç¤º                                         â”‚
â”‚      â€¢ ç”¨æˆ·çœ‹åˆ° "Heavy Content Loaded!"                                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 5: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 3 é¢è¯•è¦ç‚¹

Q1: React å¦‚ä½•åˆ¤æ–­ throw çš„æ˜¯ Promise è¿˜æ˜¯ Errorï¼Ÿ
A: é€šè¿‡æ£€æŸ¥ typeof value.then === 'function'ï¼š
   - æœ‰ .then æ–¹æ³• â†’ Promiseï¼Œèµ° Suspense æµç¨‹
   - æ²¡æœ‰ â†’ Errorï¼Œèµ° ErrorBoundary æµç¨‹

Q2: throw Promise åçš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ
A: 1. WorkLoop catch æ•è·å¼‚å¸¸
   2. throwException å¤„ç†ï¼š
      - æ‰¾åˆ°æœ€è¿‘çš„ Suspense è¾¹ç•Œ
      - æ ‡è®° ShouldCapture
      - æ³¨å†Œ Promise.then å›è°ƒ
   3. Unwind é˜¶æ®µï¼šShouldCapture â†’ DidCapture
   4. é‡æ–° beginWork(Suspense)ï¼šæ¸²æŸ“ fallback
   5. Commitï¼šæ˜¾ç¤º fallback

Q3: Promise resolve åå¦‚ä½•è§¦å‘é‡æ–°æ¸²æŸ“ï¼Ÿ
A: 1. Promise resolve æ—¶ï¼Œping å›è°ƒè¢«è°ƒç”¨
   2. pingSuspendedRoot æ‰§è¡Œï¼š
      - markRootPinged æ ‡è®° lanes
      - ensureRootIsScheduled è°ƒåº¦æ–°æ¸²æŸ“
   3. æ–°çš„æ¸²æŸ“ä¸­ï¼Œç»„ä»¶ä¸å† throwï¼Œæ­£å¸¸è¿”å›
   4. Commit åæ˜¾ç¤ºçœŸå®å†…å®¹

Q4: React.lazy çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
A: 1. lazy è¿”å›ä¸€ä¸ªç‰¹æ®Šå¯¹è±¡ï¼ŒåŒ…å« _payload å’Œ _init
   2. é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œ_init (lazyInitializer) è¢«è°ƒç”¨
   3. è°ƒç”¨ import()ï¼ŒçŠ¶æ€å˜ä¸º Pendingï¼Œthrow Promise
   4. æ¨¡å—åŠ è½½å®Œæˆåï¼ŒçŠ¶æ€å˜ä¸º Resolved
   5. ä¸‹æ¬¡æ¸²æŸ“æ—¶ï¼Œç›´æ¥è¿”å›ç»„ä»¶

Q5: Suspense è¾¹ç•Œæ˜¯å¦‚ä½•è¢«æ‰¾åˆ°çš„ï¼Ÿ
A: getNearestSuspenseBoundaryToCaptureï¼š
   - ä» returnFiber å¼€å§‹å‘ä¸Šéå†
   - æ‰¾åˆ°ç¬¬ä¸€ä¸ª tag === SuspenseComponent çš„ Fiber
   - åŒæ—¶é€šè¿‡ shouldCaptureSuspense æ£€æŸ¥æ˜¯å¦åº”è¯¥æ•è·

Q6: updateQueue åœ¨ Suspense ä¸Šå­˜å‚¨ä»€ä¹ˆï¼Ÿ
A: å­˜å‚¨æŒ‚èµ·çš„ Wakeable (Promise) é›†åˆã€‚
   è¿™äº› Promise resolve æ—¶ï¼Œä¼šè§¦å‘"é‡è¯•"æ¸²æŸ“ã€‚
   åœ¨ retryTimedOutBoundary ç­‰å‡½æ•°ä¸­è¢«ä½¿ç”¨ã€‚
`;

export {
  throwExceptionFunction,
  throwPromiseFlow,
  promiseResolveAndRetry,
  lazyAndSuspenseCase,
  interviewPoints,
};

