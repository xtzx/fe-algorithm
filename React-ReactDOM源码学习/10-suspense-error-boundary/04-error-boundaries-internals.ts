/**
 * ============================================================
 * ğŸ“š Phase 10: Suspense & å¼‚æ­¥æ¸²æŸ“ & é”™è¯¯è¾¹ç•Œ - Part 4: é”™è¯¯è¾¹ç•Œå†…éƒ¨åŸç†
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-reconciler/src/ReactFiberThrow.new.js
 * - packages/react-reconciler/src/ReactFiberUnwindWork.new.js
 * - packages/react-reconciler/src/ReactFiberCommitWork.new.js
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š2-3 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­
 */

// ============================================================
// Part 1: ä»€ä¹ˆæ˜¯é”™è¯¯è¾¹ç•Œï¼ˆErrorBoundaryï¼‰
// ============================================================

/**
 * ğŸ“Š ErrorBoundary æ¦‚è¿°
 */

const errorBoundaryOverview = `
ğŸ“Š ä»€ä¹ˆæ˜¯é”™è¯¯è¾¹ç•Œï¼ˆErrorBoundaryï¼‰

å®šä¹‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é”™è¯¯è¾¹ç•Œæ˜¯ä¸€ç§ React ç»„ä»¶ï¼Œå¯ä»¥æ•è·å­ç»„ä»¶æ ‘ä¸­çš„ JavaScript é”™è¯¯ï¼Œ
è®°å½•é”™è¯¯ï¼Œå¹¶å±•ç¤ºé™çº§ UIï¼Œè€Œä¸æ˜¯è®©æ•´ä¸ªåº”ç”¨å´©æºƒã€‚


ä»€ä¹ˆç»„ä»¶è¢«è§†ä¸ºé”™è¯¯è¾¹ç•Œï¼Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ä¸€ä¸ª Class ç»„ä»¶å¦‚æœå®šä¹‰äº†ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€ï¼ˆæˆ–ä¸¤è€…ï¼‰ï¼Œå°±æ˜¯é”™è¯¯è¾¹ç•Œï¼š

1. static getDerivedStateFromError(error)
   â€¢ åœ¨æ¸²æŸ“é˜¶æ®µè°ƒç”¨
   â€¢ è¿”å›æ–°çš„ stateï¼Œç”¨äºæ˜¾ç¤ºé™çº§ UI
   â€¢ ä¸èƒ½æ‰§è¡Œå‰¯ä½œç”¨

2. componentDidCatch(error, errorInfo)
   â€¢ åœ¨ commit é˜¶æ®µè°ƒç”¨
   â€¢ å¯ä»¥æ‰§è¡Œå‰¯ä½œç”¨ï¼ˆå¦‚é”™è¯¯ä¸ŠæŠ¥ï¼‰
   â€¢ errorInfo.componentStack åŒ…å«ç»„ä»¶æ ˆä¿¡æ¯


å…¸å‹çš„ ErrorBoundary å®ç°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  // æ¸²æŸ“é˜¶æ®µè°ƒç”¨ï¼Œæ›´æ–° state
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  // commit é˜¶æ®µè°ƒç”¨ï¼Œå¯ä»¥ä¸ŠæŠ¥é”™è¯¯
  componentDidCatch(error, errorInfo) {
    console.error('Error caught:', error);
    console.error('Component stack:', errorInfo.componentStack);
    // å¯ä»¥å‘é€åˆ°é”™è¯¯ç›‘æ§æœåŠ¡
    logErrorToService(error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      // æ˜¾ç¤ºé™çº§ UI
      return <h1>Something went wrong.</h1>;
    }
    return this.props.children;
  }
}


é”™è¯¯è¾¹ç•Œçš„é™åˆ¶
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é”™è¯¯è¾¹ç•Œ âŒ æ— æ³•æ•è·ä»¥ä¸‹é”™è¯¯ï¼š
â€¢ äº‹ä»¶å¤„ç†å‡½æ•°ä¸­çš„é”™è¯¯ï¼ˆéœ€è¦ try-catchï¼‰
â€¢ å¼‚æ­¥ä»£ç ï¼ˆå¦‚ setTimeoutã€Promiseï¼‰
â€¢ æœåŠ¡ç«¯æ¸²æŸ“
â€¢ é”™è¯¯è¾¹ç•Œè‡ªèº«æŠ›å‡ºçš„é”™è¯¯
`;

// ============================================================
// Part 2: é”™è¯¯å¤„ç†çš„æºç æµç¨‹
// ============================================================

/**
 * ğŸ“Š é”™è¯¯æ•è·ä¸å¤„ç†æµç¨‹
 */

const errorHandlingFlow = `
ğŸ“Š é”™è¯¯æ•è·ä¸å¤„ç†æµç¨‹

throwException ä¸­çš„é”™è¯¯å¤„ç†åˆ†æ”¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æºç ä½ç½®: ReactFiberThrow.new.js (Line 405+)

function throwException(root, returnFiber, sourceFiber, value, rootRenderLanes) {
  sourceFiber.flags |= Incomplete;

  if (value !== null && typeof value === 'object' && typeof value.then === 'function') {
    // Promise â†’ Suspense å¤„ç†ï¼ˆå‰é¢å·²è®²ï¼‰
  } else {
    // â­ Error â†’ é”™è¯¯è¾¹ç•Œå¤„ç†

    // åˆ›å»ºæ•è·çš„é”™è¯¯å€¼ï¼ˆåŒ…å«ç»„ä»¶æ ˆä¿¡æ¯ï¼‰
    const errorInfo = createCapturedValueAtFiber(value, sourceFiber);

    // å‘ä¸ŠæŸ¥æ‰¾é”™è¯¯è¾¹ç•Œ
    let workInProgress = returnFiber;
    do {
      switch (workInProgress.tag) {
        case HostRoot: {
          // åˆ°è¾¾æ ¹èŠ‚ç‚¹ï¼Œåˆ›å»ºæ ¹é”™è¯¯æ›´æ–°
          const errorInfo = createCapturedValueAtFiber(value, sourceFiber);
          const update = createRootErrorUpdate(workInProgress, errorInfo, lane);
          enqueueCapturedUpdate(workInProgress, update);
          workInProgress.flags |= ShouldCapture;
          return;
        }

        case ClassComponent: {
          // â­ æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯è¾¹ç•Œ
          const ctor = workInProgress.type;
          const instance = workInProgress.stateNode;

          if (
            typeof ctor.getDerivedStateFromError === 'function' ||
            (instance !== null && typeof instance.componentDidCatch === 'function')
          ) {
            // â­ æ˜¯é”™è¯¯è¾¹ç•Œï¼
            const errorInfo = createCapturedValueAtFiber(value, sourceFiber);
            const update = createClassErrorUpdate(workInProgress, errorInfo, lane);
            enqueueCapturedUpdate(workInProgress, update);
            workInProgress.flags |= ShouldCapture;
            return;
          }
          break;
        }
      }
      workInProgress = workInProgress.return;
    } while (workInProgress !== null);
  }
}


createClassErrorUpdate - åˆ›å»ºé”™è¯¯æ›´æ–°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æºç ä½ç½®: ReactFiberThrow.new.js (Line 106-164)

function createClassErrorUpdate(fiber, errorInfo, lane) {
  const update = createUpdate(NoTimestamp, lane);
  update.tag = CaptureUpdate;  // â­ ç‰¹æ®Šçš„æ›´æ–°ç±»å‹

  // 1. å¤„ç† getDerivedStateFromError
  const getDerivedStateFromError = fiber.type.getDerivedStateFromError;
  if (typeof getDerivedStateFromError === 'function') {
    const error = errorInfo.value;
    update.payload = () => {
      return getDerivedStateFromError(error);  // è¿”å›æ–° state
    };
    update.callback = () => {
      logCapturedError(fiber, errorInfo);
    };
  }

  // 2. å¤„ç† componentDidCatch
  const inst = fiber.stateNode;
  if (inst !== null && typeof inst.componentDidCatch === 'function') {
    update.callback = function callback() {
      logCapturedError(fiber, errorInfo);

      const error = errorInfo.value;
      const stack = errorInfo.stack;

      // â­ è°ƒç”¨ componentDidCatch
      this.componentDidCatch(error, {
        componentStack: stack !== null ? stack : '',
      });
    };
  }

  return update;
}
`;

// ============================================================
// Part 3: å®Œæ•´çš„é”™è¯¯å¤„ç†æ—¶é—´çº¿
// ============================================================

/**
 * ğŸ“Š é”™è¯¯å¤„ç†æ—¶é—´çº¿
 */

const errorHandlingTimeline = `
ğŸ“Š å®Œæ•´çš„é”™è¯¯å¤„ç†æ—¶é—´çº¿

ä»æŠ›å‡ºé”™è¯¯åˆ°æ˜¾ç¤ºé™çº§ UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 1: å­ç»„ä»¶æŠ›å‡ºé”™è¯¯                                                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚                                                                             â”‚
â”‚   function BuggyComponent() {                                               â”‚
â”‚     throw new Error('Something went wrong!');                               â”‚
â”‚     return <div>Never rendered</div>;                                       â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 2: WorkLoop catch æ•è·                                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                             â”‚
â”‚   try {                                                                     â”‚
â”‚     workLoopSync() / workLoopConcurrent();                                  â”‚
â”‚   } catch (thrownValue) {                                                   â”‚
â”‚     handleError(root, thrownValue);                                         â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 3: throwException å¤„ç†é”™è¯¯                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚                                                                             â”‚
â”‚   throwException(root, returnFiber, sourceFiber, error, lanes);             â”‚
â”‚                                                                             â”‚
â”‚   â€¢ æ£€æµ‹ value.then â†’ ä¸å­˜åœ¨ â†’ æ˜¯ Error                                     â”‚
â”‚   â€¢ å‘ä¸Šéå† Fiber æ ‘ï¼Œå¯»æ‰¾é”™è¯¯è¾¹ç•Œ                                         â”‚
â”‚   â€¢ æ£€æŸ¥ ClassComponent:                                                    â”‚
â”‚     - getDerivedStateFromError å­˜åœ¨? æˆ–                                     â”‚
â”‚     - componentDidCatch å­˜åœ¨?                                               â”‚
â”‚   â€¢ æ‰¾åˆ°åï¼š                                                                â”‚
â”‚     - createClassErrorUpdate åˆ›å»º CaptureUpdate                             â”‚
â”‚     - enqueueCapturedUpdate å…¥é˜Ÿ                                            â”‚
â”‚     - è®¾ç½® ShouldCapture æ ‡è®°                                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 4: Unwind é˜¶æ®µ                                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                             â”‚
â”‚   completeUnitOfWork æ£€æµ‹åˆ° Incomplete æ ‡è®°:                                â”‚
â”‚                                                                             â”‚
â”‚   // ReactFiberWorkLoop.new.js                                              â”‚
â”‚   if ((unitOfWork.flags & Incomplete) !== NoFlags) {                        â”‚
â”‚     const next = unwindWork(unitOfWork, ...);                               â”‚
â”‚     // ...                                                                  â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â”‚   unwindWork å¤„ç† ClassComponent:                                           â”‚
â”‚   â€¢ æ£€æŸ¥ ShouldCapture                                                      â”‚
â”‚   â€¢ æ¸…é™¤ ShouldCaptureï¼Œè®¾ç½® DidCapture                                     â”‚
â”‚   â€¢ è¿”å›é”™è¯¯è¾¹ç•Œ Fiberï¼Œå‡†å¤‡é‡æ–°æ¸²æŸ“                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 5: é‡æ–° beginWork(ErrorBoundary)                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚                                                                             â”‚
â”‚   // ReactFiberBeginWork.new.js - updateClassComponent                      â”‚
â”‚   â€¢ å¤„ç† updateQueue ä¸­çš„ CaptureUpdate                                     â”‚
â”‚   â€¢ è°ƒç”¨ getDerivedStateFromErrorï¼Œæ›´æ–° state                               â”‚
â”‚   â€¢ render() ä½¿ç”¨æ–° state æ¸²æŸ“é™çº§ UI                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 6: Commit é˜¶æ®µ                                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                             â”‚
â”‚   Before Mutation é˜¶æ®µ:                                                     â”‚
â”‚   â€¢ (æ— ç‰¹æ®Šå¤„ç†)                                                            â”‚
â”‚                                                                             â”‚
â”‚   Mutation é˜¶æ®µ:                                                            â”‚
â”‚   â€¢ é”™è¯¯å­æ ‘çš„ DOM è¢«å¸è½½                                                   â”‚
â”‚   â€¢ é™çº§ UI çš„ DOM è¢«æ’å…¥                                                   â”‚
â”‚                                                                             â”‚
â”‚   Layout é˜¶æ®µ:                                                              â”‚
â”‚   â€¢ è°ƒç”¨ componentDidCatchï¼ˆåœ¨ CaptureUpdate çš„ callback ä¸­ï¼‰               â”‚
â”‚   â€¢ å¯ä»¥æ‰§è¡Œå‰¯ä½œç”¨ï¼ˆå¦‚é”™è¯¯ä¸ŠæŠ¥ï¼‰                                            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 4: æ¡ˆä¾‹åˆ†æ - ErrorBoundary å®æˆ˜
// ============================================================

/**
 * ğŸ“Š æ¡ˆä¾‹ B: ErrorBoundary å®æˆ˜
 */

const errorBoundaryCase = `
ğŸ“Š æ¡ˆä¾‹ B: ErrorBoundary å®æˆ˜

ç¤ºä¾‹ä»£ç 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ErrorBoundary.js
class ErrorBoundary extends React.Component {
  state = { hasError: false, error: null };

  static getDerivedStateFromError(error) {
    console.log('getDerivedStateFromError called');
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.log('componentDidCatch called');
    console.log('Component stack:', errorInfo.componentStack);
  }

  render() {
    if (this.state.hasError) {
      return <div>Error: {this.state.error.message}</div>;
    }
    return this.props.children;
  }
}

// BuggyComponent.js
function BuggyComponent() {
  throw new Error('Oops!');
  return <div>Never rendered</div>;
}

// App.js
function App() {
  return (
    <div>
      <h1>App</h1>
      <ErrorBoundary>
        <BuggyComponent />
      </ErrorBoundary>
    </div>
  );
}


Fiber æ ‘ç»“æ„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   HostRoot                                                                  â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚   FunctionComponent (App)                                                   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚   HostComponent (div)                                                       â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”œâ”€â”€ HostComponent (h1) - "App"                                        â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â””â”€â”€ ClassComponent (ErrorBoundary)  â† â­ é”™è¯¯è¾¹ç•Œ                     â”‚
â”‚               â”‚                                                             â”‚
â”‚               â”‚ æœ‰ getDerivedStateFromError + componentDidCatch            â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚           FunctionComponent (BuggyComponent)  â† â­ æŠ›å‡ºé”™è¯¯                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


é”™è¯¯æ•è·çš„è¯¦ç»†è¿‡ç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. beginWork(BuggyComponent)
   â€¢ è°ƒç”¨ BuggyComponent()
   â€¢ throw new Error('Oops!')

2. WorkLoop catch
   â€¢ handleError(root, error)
   â€¢ throwException(root, ErrorBoundaryFiber, BuggyComponentFiber, error, lanes)

3. throwException
   â€¢ ä» BuggyComponent å‘ä¸Šæ‰¾
   â€¢ æ£€æŸ¥ ErrorBoundary: ClassComponent
     - getDerivedStateFromError å­˜åœ¨ âœ“
     - componentDidCatch å­˜åœ¨ âœ“
   â€¢ â­ æ˜¯é”™è¯¯è¾¹ç•Œï¼
   â€¢ åˆ›å»º CaptureUpdate:
     payload: () => getDerivedStateFromError(error)
     callback: () => componentDidCatch(error, errorInfo)
   â€¢ ErrorBoundaryFiber.flags |= ShouldCapture

4. Unwind
   â€¢ completeUnitOfWork(BuggyComponentFiber)
   â€¢ æ£€æµ‹åˆ° Incomplete
   â€¢ unwindWork æ‰¾åˆ° ErrorBoundary
   â€¢ ShouldCapture â†’ DidCapture
   â€¢ è¿”å› ErrorBoundaryFiber

5. é‡æ–° beginWork(ErrorBoundary)
   â€¢ processUpdateQueue å¤„ç† CaptureUpdate
   â€¢ è°ƒç”¨ getDerivedStateFromError(error)
   â€¢ state æ›´æ–°ä¸º { hasError: true, error }
   â€¢ render() è¿”å›é™çº§ UI: <div>Error: Oops!</div>

6. Commit
   â€¢ BuggyComponent çš„ DOM è¢«ç§»é™¤ï¼ˆå¦‚æœæœ‰ï¼‰
   â€¢ é™çº§ UI çš„ DOM è¢«æ’å…¥
   â€¢ Layout é˜¶æ®µè°ƒç”¨ componentDidCatch

è¾“å‡ºé¡ºåº:
â€¢ "getDerivedStateFromError called" (render é˜¶æ®µ)
â€¢ "componentDidCatch called" (commit é˜¶æ®µ)
â€¢ "Component stack: ..." (commit é˜¶æ®µ)
`;

// ============================================================
// Part 5: Suspense vs ErrorBoundary å¯¹æ¯”
// ============================================================

/**
 * ğŸ“Š Suspense vs ErrorBoundary å¯¹æ¯”
 */

const suspenseVsErrorBoundary = `
ğŸ“Š Suspense vs ErrorBoundary å¯¹æ¯”

å¤„ç†æœºåˆ¶å¯¹æ¯”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹æ€§               â”‚ Suspense                   â”‚ ErrorBoundary              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•è·çš„å†…å®¹         â”‚ thrown Promise             â”‚ thrown Error               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ¤æ–­æ–¹å¼           â”‚ value.then å­˜åœ¨            â”‚ value.then ä¸å­˜åœ¨          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾¹ç•Œè¯†åˆ«           â”‚ SuspenseComponent Fiber    â”‚ ClassComponent +           â”‚
â”‚                    â”‚                            â”‚ getDerivedStateFromError / â”‚
â”‚                    â”‚                            â”‚ componentDidCatch          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŠ¶æ€åˆ‡æ¢           â”‚ children â†” fallback       â”‚ children â†’ errorUI        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯æ¢å¤æ€§           â”‚ âœ“ Promise resolve åæ¢å¤   â”‚ éœ€è¦æ‰‹åŠ¨é‡ç½® state         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ‡è®°               â”‚ ShouldCapture, DidCapture â”‚ ShouldCapture, DidCapture  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…éƒ¨å®ç°           â”‚ å†…ç½®ç»„ä»¶                   â”‚ ç”¨æˆ·å®šä¹‰çš„ Class ç»„ä»¶      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å…±åŒç‚¹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢ éƒ½åœ¨ throwException ä¸­å¤„ç†
â€¢ éƒ½ä½¿ç”¨ ShouldCapture / DidCapture æ ‡è®°
â€¢ éƒ½è§¦å‘ unwind æµç¨‹
â€¢ éƒ½ä¼šé‡æ–°æ¸²æŸ“è¾¹ç•Œç»„ä»¶


é…åˆä½¿ç”¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

<ErrorBoundary fallback={<ErrorUI />}>
  <Suspense fallback={<Loading />}>
    <AsyncComponent />
  </Suspense>
</ErrorBoundary>

â€¢ Suspense å¤„ç†ï¼šæ•°æ®/ç»„ä»¶åŠ è½½ä¸­
â€¢ ErrorBoundary å¤„ç†ï¼šåŠ è½½å¤±è´¥æˆ–æ¸²æŸ“é”™è¯¯

Promise reject çš„æƒ…å†µ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ å¦‚æœç»„ä»¶ throw ä¸€ä¸ª rejected Promise
â€¢ React ä¼šåœ¨ Promise reject åé‡æ–°æŠ›å‡ºé”™è¯¯
â€¢ è¿™æ—¶ ErrorBoundary å¯ä»¥æ•è·
`;

// ============================================================
// Part 6: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 4 é¢è¯•è¦ç‚¹

Q1: ä»€ä¹ˆç»„ä»¶è¢«è§†ä¸ºé”™è¯¯è¾¹ç•Œï¼Ÿ
A: å®šä¹‰äº†ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€çš„ Class ç»„ä»¶ï¼š
   - static getDerivedStateFromError(error)
   - componentDidCatch(error, errorInfo)
   æ³¨æ„ï¼šå‡½æ•°ç»„ä»¶ä¸èƒ½æˆä¸ºé”™è¯¯è¾¹ç•Œ

Q2: getDerivedStateFromError å’Œ componentDidCatch çš„åŒºåˆ«ï¼Ÿ
A: - getDerivedStateFromErrorï¼š
     - æ¸²æŸ“é˜¶æ®µè°ƒç”¨
     - è¿”å›æ–° state ç”¨äºæ˜¾ç¤ºé™çº§ UI
     - ä¸èƒ½æ‰§è¡Œå‰¯ä½œç”¨
   - componentDidCatchï¼š
     - commit é˜¶æ®µè°ƒç”¨
     - å¯ä»¥æ‰§è¡Œå‰¯ä½œç”¨ï¼ˆå¦‚é”™è¯¯ä¸ŠæŠ¥ï¼‰
     - æ¥æ”¶ errorInfo.componentStack

Q3: é”™è¯¯æ˜¯å¦‚ä½•æ²¿ Fiber æ ‘å‘ä¸Šä¼ æ’­çš„ï¼Ÿ
A: throwException ä»æŠ›å‡ºé”™è¯¯çš„ Fiber å¼€å§‹ï¼Œæ²¿ return æŒ‡é’ˆå‘ä¸Šéå†ï¼Œ
   æ£€æŸ¥æ¯ä¸ª ClassComponent æ˜¯å¦æœ‰ getDerivedStateFromError æˆ– componentDidCatchã€‚
   æ‰¾åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯è¾¹ç•Œåï¼Œåˆ›å»º CaptureUpdate å¹¶å…¥é˜Ÿã€‚

Q4: é”™è¯¯è¾¹ç•Œæ— æ³•æ•è·å“ªäº›é”™è¯¯ï¼Ÿ
A: - äº‹ä»¶å¤„ç†å‡½æ•°ä¸­çš„é”™è¯¯
   - å¼‚æ­¥ä»£ç ï¼ˆsetTimeoutã€Promiseï¼‰
   - æœåŠ¡ç«¯æ¸²æŸ“
   - é”™è¯¯è¾¹ç•Œè‡ªèº«æŠ›å‡ºçš„é”™è¯¯

Q5: Suspense å’Œ ErrorBoundary çš„ä¸»è¦åŒºåˆ«ï¼Ÿ
A: - Suspenseï¼šå¤„ç† thrown Promiseï¼ˆå¼‚æ­¥/æš‚åœï¼‰ï¼Œå¯è‡ªåŠ¨æ¢å¤
   - ErrorBoundaryï¼šå¤„ç† thrown Errorï¼ˆé”™è¯¯ï¼‰ï¼Œéœ€æ‰‹åŠ¨é‡ç½®
   ä¸¤è€…éƒ½ä½¿ç”¨ ShouldCapture/DidCapture æ ‡è®°ï¼Œéƒ½è§¦å‘ unwind æµç¨‹

Q6: CaptureUpdate æ˜¯ä»€ä¹ˆï¼Ÿ
A: ä¸€ç§ç‰¹æ®Šçš„ Update ç±»å‹ï¼ˆtag = CaptureUpdateï¼‰ï¼Œ
   ç”¨äºé”™è¯¯è¾¹ç•Œå¤„ç†é”™è¯¯æ—¶æ›´æ–° stateã€‚
   payload åŒ…å« getDerivedStateFromError çš„è°ƒç”¨ï¼Œ
   callback åŒ…å« componentDidCatch çš„è°ƒç”¨ã€‚
`;

export {
  errorBoundaryOverview,
  errorHandlingFlow,
  errorHandlingTimeline,
  errorBoundaryCase,
  suspenseVsErrorBoundary,
  interviewPoints,
};

