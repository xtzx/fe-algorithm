/**
 * ============================================================
 * ğŸ“š Phase 4: Hooks åŸç† - Part 2: æ•°æ®ç»“æ„ä¸ Dispatcher
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-reconciler/src/ReactFiberHooks.new.js (Line 148-177)
 * - packages/react/src/ReactCurrentDispatcher.js
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š2-3 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­
 */

// ============================================================
// Part 1: Hook å¯¹è±¡çš„ç»“æ„
// ============================================================

/**
 * ğŸ“Š Hook å¯¹è±¡ç»“æ„
 */

const hookStructure = `
ğŸ“Š Hook å¯¹è±¡çš„ç»“æ„

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberHooks.new.js (Line 148-154)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export type Hook = {|
  memoizedState: any,                    // â­ å­˜å‚¨çš„çŠ¶æ€å€¼
  baseState: any,                        // åŸºç¡€çŠ¶æ€ï¼ˆå¤„ç†ä¼˜å…ˆçº§æ—¶ä½¿ç”¨ï¼‰
  baseQueue: Update<any, any> | null,    // åŸºç¡€æ›´æ–°é˜Ÿåˆ—
  queue: any,                            // â­ æ›´æ–°é˜Ÿåˆ—ï¼ˆUpdateQueueï¼‰
  next: Hook | null,                     // â­ æŒ‡å‘ä¸‹ä¸€ä¸ª Hook
|};


å­—æ®µè¯¦è§£:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—æ®µ          â”‚ è¯´æ˜                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ memoizedState â”‚ â­ æœ€é‡è¦çš„å­—æ®µï¼å­˜å‚¨ Hook çš„çŠ¶æ€                           â”‚
â”‚               â”‚                                                             â”‚
â”‚               â”‚ ä¸åŒ Hook å­˜å‚¨ä¸åŒå†…å®¹:                                     â”‚
â”‚               â”‚ â€¢ useState    â†’ state çš„å€¼                                  â”‚
â”‚               â”‚ â€¢ useReducer  â†’ state çš„å€¼                                  â”‚
â”‚               â”‚ â€¢ useRef      â†’ { current: ... }                            â”‚
â”‚               â”‚ â€¢ useMemo     â†’ [ç¼“å­˜å€¼, deps]                              â”‚
â”‚               â”‚ â€¢ useCallback â†’ [å‡½æ•°, deps]                                â”‚
â”‚               â”‚ â€¢ useEffect   â†’ Effect å¯¹è±¡                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ baseState     â”‚ åŸºç¡€çŠ¶æ€ï¼Œç”¨äºå¤„ç†ä½ä¼˜å…ˆçº§æ›´æ–°è¢«è·³è¿‡çš„æƒ…å†µ                  â”‚
â”‚               â”‚ å¤§å¤šæ•°åœºæ™¯ä¸‹ç­‰äº memoizedState                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ baseQueue     â”‚ è¢«è·³è¿‡çš„ä½ä¼˜å…ˆçº§æ›´æ–°ç»„æˆçš„é˜Ÿåˆ—                              â”‚
â”‚               â”‚ ä¸‹æ¬¡æ¸²æŸ“æ—¶ä¼šå’Œæ–°çš„æ›´æ–°åˆå¹¶å¤„ç†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ queue         â”‚ UpdateQueue å¯¹è±¡ï¼Œå­˜å‚¨å¾…å¤„ç†çš„æ›´æ–°                          â”‚
â”‚               â”‚ åŒ…å« pendingã€dispatch ç­‰å­—æ®µ                               â”‚
â”‚               â”‚ useState/useReducer ä¼šç”¨åˆ°                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ next          â”‚ æŒ‡å‘ä¸‹ä¸€ä¸ª Hookï¼Œå½¢æˆé“¾è¡¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ä¸åŒ Hook çš„ memoizedState å­˜å‚¨å†…å®¹:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hook ç±»å‹       â”‚ memoizedState å­˜å‚¨çš„å†…å®¹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ useState        â”‚ state çš„å½“å‰å€¼                                            â”‚
â”‚                 â”‚ ä¾‹ï¼šuseState(0) â†’ memoizedState = 0                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ useReducer      â”‚ state çš„å½“å‰å€¼                                            â”‚
â”‚                 â”‚ ä¸ useState ç›¸åŒ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ useRef          â”‚ { current: initialValue }                                 â”‚
â”‚                 â”‚ ä¾‹ï¼šuseRef(null) â†’ memoizedState = { current: null }     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ useMemo         â”‚ [è®¡ç®—ç»“æœ, depsæ•°ç»„]                                      â”‚
â”‚                 â”‚ ä¾‹ï¼šuseMemo(() => a*2, [a])                               â”‚
â”‚                 â”‚     â†’ memoizedState = [4, [2]]                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ useCallback     â”‚ [å›è°ƒå‡½æ•°, depsæ•°ç»„]                                      â”‚
â”‚                 â”‚ ä¾‹ï¼šuseCallback(fn, [a])                                  â”‚
â”‚                 â”‚     â†’ memoizedState = [fn, [2]]                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ useEffect       â”‚ Effect å¯¹è±¡                                               â”‚
â”‚ useLayoutEffect â”‚ { tag, create, destroy, deps, next }                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ useContext      â”‚ ä¸åˆ›å»º Hook èŠ‚ç‚¹                                          â”‚
â”‚                 â”‚ ç›´æ¥ä» Context ä¸­è¯»å–å€¼                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 2: UpdateQueue ç»“æ„
// ============================================================

/**
 * ğŸ“Š UpdateQueue ç»“æ„
 */

const updateQueueStructure = `
ğŸ“Š UpdateQueue ç»“æ„ï¼ˆç”¨äº useState/useReducerï¼‰

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberHooks.new.js (Line 134-140)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export type UpdateQueue<S, A> = {|
  pending: Update<S, A> | null,              // å¾…å¤„ç†çš„æ›´æ–°ï¼ˆç¯å½¢é“¾è¡¨ï¼‰
  lanes: Lanes,                              // æ›´æ–°çš„ä¼˜å…ˆçº§
  dispatch: (A => mixed) | null,             // â­ setState å‡½æ•°
  lastRenderedReducer: ((S, A) => S) | null, // ä¸Šæ¬¡ä½¿ç”¨çš„ reducer
  lastRenderedState: S | null,               // ä¸Šæ¬¡æ¸²æŸ“çš„ state
|};


Update å¯¹è±¡ç»“æ„:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export type Update<S, A> = {|
  lane: Lane,                  // æ›´æ–°çš„ä¼˜å…ˆçº§
  action: A,                   // æ›´æ–°çš„ actionï¼ˆæ–°å€¼æˆ–æ›´æ–°å‡½æ•°ï¼‰
  hasEagerState: boolean,      // æ˜¯å¦æœ‰æå‰è®¡ç®—çš„çŠ¶æ€
  eagerState: S | null,        // æå‰è®¡ç®—çš„çŠ¶æ€å€¼
  next: Update<S, A>,          // æŒ‡å‘ä¸‹ä¸€ä¸ª Updateï¼ˆç¯å½¢ï¼‰
|};


æ›´æ–°é˜Ÿåˆ—å›¾ç¤º:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å‡è®¾è¿ç»­è°ƒç”¨ 3 æ¬¡ setCount:

setCount(1);   // åˆ›å»º Update1
setCount(2);   // åˆ›å»º Update2
setCount(3);   // åˆ›å»º Update3

å½¢æˆçš„ç¯å½¢é“¾è¡¨:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   UpdateQueue                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚ pending â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ dispatch        â”‚                                       â”‚              â”‚
â”‚   â”‚ lastRendered... â”‚                                       â–¼              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                             â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                        â”‚                                      â”‚            â”‚
â”‚                        â–¼                                      â”‚            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚            â”‚
â”‚   â”‚  Update 1   â”‚â”€â”€â–¶â”‚  Update 2   â”‚â”€â”€â–¶â”‚  Update 3   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚   â”‚  action: 1  â”‚   â”‚  action: 2  â”‚   â”‚  action: 3  â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                              â†‘                              â”‚
â”‚                                              â”‚                              â”‚
â”‚                                        pending æŒ‡å‘æœ€åä¸€ä¸ª                 â”‚
â”‚                                        pending.next æŒ‡å‘ç¬¬ä¸€ä¸ª             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸ºä»€ä¹ˆæ˜¯ç¯å½¢é“¾è¡¨ï¼Ÿ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ pending æŒ‡å‘æœ€åä¸€ä¸ª Update
â€¢ pending.next æŒ‡å‘ç¬¬ä¸€ä¸ª Update
â€¢ è¿™æ ·å¯ä»¥ O(1) æ—¶é—´è¿½åŠ æ–° Update åˆ°æœ«å°¾
â€¢ ä¹Ÿå¯ä»¥ O(1) æ—¶é—´æ‰¾åˆ°ç¬¬ä¸€ä¸ª Update
`;

// ============================================================
// Part 3: Effect å¯¹è±¡ç»“æ„
// ============================================================

/**
 * ğŸ“Š Effect å¯¹è±¡ç»“æ„
 */

const effectStructure = `
ğŸ“Š Effect å¯¹è±¡ç»“æ„ï¼ˆç”¨äº useEffect/useLayoutEffectï¼‰

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberHooks.new.js (Line 156-162)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export type Effect = {|
  tag: HookFlags,                        // effect çš„ç±»å‹æ ‡è®°
  create: () => (() => void) | void,     // â­ effect å‡½æ•°
  destroy: (() => void) | void,          // â­ æ¸…ç†å‡½æ•°ï¼ˆcreate çš„è¿”å›å€¼ï¼‰
  deps: Array<mixed> | null,             // â­ ä¾èµ–æ•°ç»„
  next: Effect,                          // æŒ‡å‘ä¸‹ä¸€ä¸ª Effect
|};


å­—æ®µè¯¦è§£:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—æ®µ          â”‚ è¯´æ˜                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tag           â”‚ æ ‡è®° effect ç±»å‹å’Œæ˜¯å¦éœ€è¦æ‰§è¡Œ:                             â”‚
â”‚               â”‚ â€¢ HookPassive (Passive)     â†’ useEffect                     â”‚
â”‚               â”‚ â€¢ HookLayout (Layout)       â†’ useLayoutEffect               â”‚
â”‚               â”‚ â€¢ HookHasEffect             â†’ æœ¬æ¬¡éœ€è¦æ‰§è¡Œ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ create        â”‚ useEffect/useLayoutEffect çš„ç¬¬ä¸€ä¸ªå‚æ•°                      â”‚
â”‚               â”‚ å³ effect å‡½æ•°æœ¬èº«                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ destroy       â”‚ create çš„è¿”å›å€¼ï¼ˆæ¸…ç†å‡½æ•°ï¼‰                                 â”‚
â”‚               â”‚ ä¸‹æ¬¡æ‰§è¡Œ effect å‰æˆ–ç»„ä»¶å¸è½½æ—¶è°ƒç”¨                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ deps          â”‚ ä¾èµ–æ•°ç»„ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æ‰§è¡Œ effect                   â”‚
â”‚               â”‚ null è¡¨ç¤ºæ¯æ¬¡éƒ½æ‰§è¡Œ                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ next          â”‚ æŒ‡å‘ä¸‹ä¸€ä¸ª Effectï¼Œå½¢æˆç¯å½¢é“¾è¡¨                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Effect é“¾è¡¨ä¸ updateQueue:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Effect é“¾è¡¨æŒ‚åœ¨ Fiber.updateQueue ä¸Šï¼ˆå‡½æ•°ç»„ä»¶ï¼‰:

type FunctionComponentUpdateQueue = {|
  lastEffect: Effect | null,    // æŒ‡å‘æœ€åä¸€ä¸ª Effect
  stores: Array<...> | null,    // useSyncExternalStore ç›¸å…³
|};

ç¤ºä¾‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function MyComponent() {
  useEffect(() => console.log('effect 1'), []);  // Effect 1
  useLayoutEffect(() => console.log('effect 2'), []);  // Effect 2
  useEffect(() => console.log('effect 3'), []);  // Effect 3
  return <div />;
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Fiber.updateQueue                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚   â”‚ lastEffect â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚             â”‚
â”‚                                                              â–¼             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚  Effect 1    â”‚â”€â”€â–¶â”‚  Effect 2    â”‚â”€â”€â–¶â”‚  Effect 3    â”‚â”€â”€â”               â”‚
â”‚   â”‚  Passive     â”‚   â”‚  Layout      â”‚   â”‚  Passive     â”‚  â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚               â”‚
â”‚         â†‘                                                  â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                          ï¼ˆç¯å½¢é“¾è¡¨ï¼‰                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 4: Dispatcher æœºåˆ¶
// ============================================================

/**
 * ğŸ“Š Dispatcher æœºåˆ¶
 */

const dispatcherMechanism = `
ğŸ“Š Dispatcher æœºåˆ¶

æºç ä½ç½®:
- packages/react/src/ReactCurrentDispatcher.js
- packages/react-reconciler/src/ReactFiberHooks.new.js (Line 2427-2479)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ä»€ä¹ˆæ˜¯ Dispatcherï¼Ÿ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Dispatcher æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰ Hook çš„å®ç°ã€‚
ä¸åŒé˜¶æ®µä½¿ç”¨ä¸åŒçš„ Dispatcherï¼Œå®ç°ç›¸åŒ Hook åç§°ã€ä¸åŒè¡Œä¸ºã€‚


ReactCurrentDispatcher:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“ packages/react/src/ReactCurrentDispatcher.js

const ReactCurrentDispatcher = {
  current: (null: null | Dispatcher),  // å½“å‰ä½¿ç”¨çš„ Dispatcher
};

// React åŒ…ä¸­çš„ Hook å‡½æ•°:
function useState(initialState) {
  const dispatcher = ReactCurrentDispatcher.current;
  return dispatcher.useState(initialState);  // â­ å§”æ‰˜ç»™ dispatcher
}


ä¸¤ä¸ªæ ¸å¿ƒ Dispatcher:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ packages/react-reconciler/src/ReactFiberHooks.new.js (Line 2427)

const HooksDispatcherOnMount: Dispatcher = {
  useState: mountState,        // â­ é¦–æ¬¡æ¸²æŸ“ç”¨ mountState
  useEffect: mountEffect,
  useMemo: mountMemo,
  useRef: mountRef,
  useCallback: mountCallback,
  useReducer: mountReducer,
  useLayoutEffect: mountLayoutEffect,
  // ... å…¶ä»– Hook
};

const HooksDispatcherOnUpdate: Dispatcher = {
  useState: updateState,       // â­ æ›´æ–°æ¸²æŸ“ç”¨ updateState
  useEffect: updateEffect,
  useMemo: updateMemo,
  useRef: updateRef,
  useCallback: updateCallback,
  useReducer: updateReducer,
  useLayoutEffect: updateLayoutEffect,
  // ... å…¶ä»– Hook
};


åˆ‡æ¢æ—¶æœºï¼ˆåœ¨ renderWithHooks ä¸­ï¼‰:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ ReactFiberHooks.new.js (Line 374)

export function renderWithHooks(
  current: Fiber | null,
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) => any,
  props: Props,
  ...
): any {
  // è®¾ç½®å½“å‰æ¸²æŸ“çš„ Fiber
  currentlyRenderingFiber = workInProgress;

  // é‡ç½®çŠ¶æ€
  workInProgress.memoizedState = null;
  workInProgress.updateQueue = null;

  // â­â­â­ å…³é”®ï¼šæ ¹æ®æ˜¯å¦æœ‰ current é€‰æ‹© Dispatcher
  ReactCurrentDispatcher.current =
    current === null || current.memoizedState === null
      ? HooksDispatcherOnMount    // é¦–æ¬¡æ¸²æŸ“
      : HooksDispatcherOnUpdate;  // æ›´æ–°æ¸²æŸ“

  // æ‰§è¡Œç»„ä»¶å‡½æ•°ï¼ˆå†…éƒ¨ä¼šè°ƒç”¨ Hookï¼‰
  let children = Component(props, secondArg);

  // ... åç»­å¤„ç†

  return children;
}


æµç¨‹å›¾:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   renderWithHooks è¢«è°ƒç”¨                                                    â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚   current === null ?                                                        â”‚
â”‚   (é¦–æ¬¡æ¸²æŸ“ï¼Ÿ)                                                              â”‚
â”‚         â”‚                                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                                              â”‚
â”‚    â”‚         â”‚                                                              â”‚
â”‚   Yes        No                                                             â”‚
â”‚    â”‚         â”‚                                                              â”‚
â”‚    â–¼         â–¼                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚ â”‚HooksDispatcherOn â”‚    â”‚HooksDispatcherOn â”‚                               â”‚
â”‚ â”‚Mount             â”‚    â”‚Update            â”‚                               â”‚
â”‚ â”‚                  â”‚    â”‚                  â”‚                               â”‚
â”‚ â”‚ useState:        â”‚    â”‚ useState:        â”‚                               â”‚
â”‚ â”‚   mountState     â”‚    â”‚   updateState    â”‚                               â”‚
â”‚ â”‚ useEffect:       â”‚    â”‚ useEffect:       â”‚                               â”‚
â”‚ â”‚   mountEffect    â”‚    â”‚   updateEffect   â”‚                               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚         â”‚                        â”‚                                          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                    â”‚                                                        â”‚
â”‚                    â–¼                                                        â”‚
â”‚   ReactCurrentDispatcher.current = é€‰ä¸­çš„ Dispatcher                        â”‚
â”‚                    â”‚                                                        â”‚
â”‚                    â–¼                                                        â”‚
â”‚   Component(props)  â† æ‰§è¡Œç»„ä»¶å‡½æ•°ï¼Œå†…éƒ¨è°ƒç”¨ Hook                           â”‚
â”‚                    â”‚                                                        â”‚
â”‚                    â–¼                                                        â”‚
â”‚   useState(0)  â†’ dispatcher.useState(0)                                     â”‚
â”‚              â†’ mountState(0) / updateState(0)                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 5: Fiber ä¸Šä¸ Hooks ç›¸å…³çš„å­—æ®µ
// ============================================================

/**
 * ğŸ“Š Fiber ä¸Šçš„ Hooks ç›¸å…³å­—æ®µ
 */

const fiberHooksFields = `
ğŸ“Š Fiber ä¸Šä¸ Hooks ç›¸å…³çš„å­—æ®µ

æºç ä½ç½®: packages/react-reconciler/src/ReactFiber.new.js
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å¯¹äºå‡½æ•°ç»„ä»¶çš„ Fiberï¼Œä»¥ä¸‹å­—æ®µä¸ Hooks ç›¸å…³:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   FiberNode (å‡½æ•°ç»„ä»¶)                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚ memoizedState: Hook | null                                          â”‚  â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚  â”‚
â”‚   â”‚ â­ æŒ‡å‘ç¬¬ä¸€ä¸ª Hook èŠ‚ç‚¹                                             â”‚  â”‚
â”‚   â”‚ æ‰€æœ‰ Hook é€šè¿‡ next è¿æˆé“¾è¡¨                                        â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚ æ³¨æ„ï¼šç±»ç»„ä»¶çš„ memoizedState æ˜¯ state å¯¹è±¡                          â”‚  â”‚
â”‚   â”‚ å‡½æ•°ç»„ä»¶çš„ memoizedState æ˜¯ Hook é“¾è¡¨å¤´                             â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚ updateQueue: FunctionComponentUpdateQueue | null                    â”‚  â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”‚  â”‚
â”‚   â”‚ â­ å­˜å‚¨ Effect é“¾è¡¨                                                 â”‚  â”‚
â”‚   â”‚ {                                                                   â”‚  â”‚
â”‚   â”‚   lastEffect: Effect | null,  // æŒ‡å‘æœ€åä¸€ä¸ª Effect               â”‚  â”‚
â”‚   â”‚   stores: Array<...> | null,  // useSyncExternalStore              â”‚  â”‚
â”‚   â”‚ }                                                                   â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚ æ³¨æ„ï¼šç±»ç»„ä»¶çš„ updateQueue æ˜¯ Update é˜Ÿåˆ—                           â”‚  â”‚
â”‚   â”‚ å‡½æ•°ç»„ä»¶çš„ updateQueue æ˜¯ Effect é“¾è¡¨                               â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å®Œæ•´çš„æ•°æ®ç»“æ„å…³ç³»å›¾:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function MyComponent() {
  const [count, setCount] = useState(0);
  const double = useMemo(() => count * 2, [count]);
  useEffect(() => { console.log(count); }, [count]);
  return <div>{count}</div>;
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Fiber (MyComponent)                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ memoizedState â”€â”€â”€â”€â”                                                 â”‚  â”‚
â”‚   â”‚ updateQueue â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                  â”‚                 â”‚
â”‚                       â–¼                                  â”‚                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚                 â”‚
â”‚   â”‚ Hook 1 (useState)       â”‚                            â”‚                 â”‚
â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚                 â”‚
â”‚   â”‚ memoizedState: 0        â”‚                            â”‚                 â”‚
â”‚   â”‚ baseState: 0            â”‚                            â”‚                 â”‚
â”‚   â”‚ queue: {                â”‚                            â”‚                 â”‚
â”‚   â”‚   pending: null,        â”‚                            â”‚                 â”‚
â”‚   â”‚   dispatch: setCount,   â”‚                            â”‚                 â”‚
â”‚   â”‚   lastRenderedState: 0  â”‚                            â”‚                 â”‚
â”‚   â”‚ }                       â”‚                            â”‚                 â”‚
â”‚   â”‚ next: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”                         â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                         â”‚                 â”‚
â”‚                                â”‚                         â”‚                 â”‚
â”‚                                â–¼                         â”‚                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚                 â”‚
â”‚   â”‚ Hook 2 (useMemo)        â”‚                            â”‚                 â”‚
â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚                 â”‚
â”‚   â”‚ memoizedState: [0, [0]] â”‚  // [è®¡ç®—ç»“æœ, deps]       â”‚                 â”‚
â”‚   â”‚ next: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”                         â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                         â”‚                 â”‚
â”‚                                â”‚                         â”‚                 â”‚
â”‚                                â–¼                         â”‚                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚                 â”‚
â”‚   â”‚ Hook 3 (useEffect)      â”‚                            â–¼                 â”‚
â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ memoizedState: Effect â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Effect å¯¹è±¡                     â”‚  â”‚
â”‚   â”‚ next: null              â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ tag: Passive | HookHasEffect    â”‚  â”‚
â”‚                                      â”‚ create: () => console.log(count)â”‚  â”‚
â”‚                                      â”‚ destroy: undefined              â”‚  â”‚
â”‚                                      â”‚ deps: [0]                       â”‚  â”‚
â”‚                                      â”‚ next: (self) â† ç¯å½¢             â”‚  â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â†‘                             â”‚
â”‚                                              â”‚                             â”‚
â”‚                                   updateQueue.lastEffect                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 6: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 2 é¢è¯•è¦ç‚¹

Q1: Hook å¯¹è±¡æœ‰å“ªäº›é‡è¦å­—æ®µï¼Ÿ
A: 1. memoizedStateï¼šå­˜å‚¨ Hook çš„çŠ¶æ€ï¼ˆä¸åŒ Hook å­˜å‚¨ä¸åŒå†…å®¹ï¼‰
   2. baseStateï¼šåŸºç¡€çŠ¶æ€ï¼ˆå¤„ç†ä¼˜å…ˆçº§æ—¶ä½¿ç”¨ï¼‰
   3. queueï¼šUpdateQueueï¼Œå­˜å‚¨å¾…å¤„ç†çš„æ›´æ–°
   4. nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ª Hookï¼Œå½¢æˆé“¾è¡¨

Q2: ä¸åŒ Hook çš„ memoizedState åˆ†åˆ«å­˜å‚¨ä»€ä¹ˆï¼Ÿ
A: - useState/useReducer: state çš„å€¼
   - useRef: { current: value }
   - useMemo: [ç¼“å­˜å€¼, deps]
   - useCallback: [å‡½æ•°, deps]
   - useEffect: Effect å¯¹è±¡

Q3: UpdateQueue çš„ pending ä¸ºä»€ä¹ˆæ˜¯ç¯å½¢é“¾è¡¨ï¼Ÿ
A: 1. pending æŒ‡å‘æœ€åä¸€ä¸ª Update
   2. pending.next æŒ‡å‘ç¬¬ä¸€ä¸ª Update
   å¥½å¤„ï¼šO(1) æ—¶é—´è¿½åŠ æ–° Updateï¼ŒO(1) æ—¶é—´æ‰¾åˆ°ç¬¬ä¸€ä¸ª Update

Q4: Effect å¯¹è±¡æœ‰å“ªäº›å­—æ®µï¼Ÿ
A: 1. tag: æ ‡è®°ç±»å‹ï¼ˆPassive/Layoutï¼‰å’Œæ˜¯å¦éœ€è¦æ‰§è¡Œ
   2. create: effect å‡½æ•°
   3. destroy: æ¸…ç†å‡½æ•°ï¼ˆcreate çš„è¿”å›å€¼ï¼‰
   4. deps: ä¾èµ–æ•°ç»„
   5. next: ä¸‹ä¸€ä¸ª Effectï¼ˆç¯å½¢é“¾è¡¨ï¼‰

Q5: Dispatcher æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ
A: Dispatcher æ˜¯ Hook å®ç°çš„é›†åˆã€‚
   React é€šè¿‡ ReactCurrentDispatcher.current åˆ‡æ¢ä¸åŒ Dispatcherï¼š
   - HooksDispatcherOnMountï¼ˆé¦–æ¬¡æ¸²æŸ“ï¼‰
   - HooksDispatcherOnUpdateï¼ˆæ›´æ–°æ¸²æŸ“ï¼‰
   è¿™æ ·åŒä¸€ä¸ª useState åœ¨ä¸åŒé˜¶æ®µæ‰§è¡Œä¸åŒé€»è¾‘ã€‚

Q6: å‡½æ•°ç»„ä»¶ Fiber çš„ memoizedState å’Œç±»ç»„ä»¶æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
A: - å‡½æ•°ç»„ä»¶: memoizedState æŒ‡å‘ Hook é“¾è¡¨çš„å¤´èŠ‚ç‚¹
   - ç±»ç»„ä»¶: memoizedState æ˜¯ state å¯¹è±¡æœ¬èº«
   ä¸¤è€…ç”¨æ³•å®Œå…¨ä¸åŒï¼

Q7: Effect é“¾è¡¨å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ
A: å­˜å‚¨åœ¨ Fiber.updateQueue.lastEffect ä¸Šã€‚
   æ³¨æ„ï¼šå‡½æ•°ç»„ä»¶çš„ updateQueue ç»“æ„ä¸ç±»ç»„ä»¶ä¸åŒï¼Œ
   å‡½æ•°ç»„ä»¶æ˜¯ FunctionComponentUpdateQueue { lastEffect, stores }ã€‚
`;

export {
  hookStructure,
  updateQueueStructure,
  effectStructure,
  dispatcherMechanism,
  fiberHooksFields,
  interviewPoints,
};

