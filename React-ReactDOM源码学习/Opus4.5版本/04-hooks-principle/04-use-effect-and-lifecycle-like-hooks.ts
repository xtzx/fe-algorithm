/**
 * ============================================================
 * ğŸ“š Phase 4: Hooks åŸç† - Part 4: useEffect ä¸ç”Ÿå‘½å‘¨æœŸç±» Hooks
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-reconciler/src/ReactFiberHooks.new.js
 *   - mountEffect (Line 1702)
 *   - updateEffect (Line 1727)
 *   - pushEffect (Line 1544)
 * - packages/react-reconciler/src/ReactFiberCommitWork.new.js
 *   - commitHookEffectListMount (Line 562)
 *   - commitHookEffectListUnmount (Line 512)
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š2-3 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­
 */

// ============================================================
// Part 1: mountEffect - é¦–æ¬¡æ¸²æŸ“çš„ useEffect
// ============================================================

/**
 * ğŸ“Š mountEffect - æ³¨å†Œ Effect
 */

const mountEffectFn = `
ğŸ“Š mountEffect - é¦–æ¬¡æ¸²æŸ“çš„ useEffect

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberHooks.new.js
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å…¥å£å‡½æ•° (Line 1702)
function mountEffect(
  create: () => (() => void) | void,  // effect å‡½æ•°
  deps: Array<mixed> | void | null,   // ä¾èµ–æ•°ç»„
): void {
  return mountEffectImpl(
    PassiveEffect | PassiveStaticEffect,  // Fiber flags
    HookPassive,                          // Hook flags
    create,
    deps,
  );
}

// å®é™…å®ç° (Line 1663)
function mountEffectImpl(fiberFlags, hookFlags, create, deps): void {
  // 1. åˆ›å»º Hook èŠ‚ç‚¹
  const hook = mountWorkInProgressHook();

  // 2. å¤„ç†ä¾èµ–
  const nextDeps = deps === undefined ? null : deps;

  // 3. â­ ç»™ Fiber æ‰“ä¸Š Passive æ ‡è®°ï¼ˆæ ‡è®°æœ‰å‰¯ä½œç”¨ï¼‰
  currentlyRenderingFiber.flags |= fiberFlags;

  // 4. â­ åˆ›å»º Effect å¹¶æŒ‚åˆ° Hook ä¸Š
  hook.memoizedState = pushEffect(
    HookHasEffect | hookFlags,  // æ ‡è®°æœ¬æ¬¡éœ€è¦æ‰§è¡Œ
    create,                     // effect å‡½æ•°
    undefined,                  // destroyï¼ˆé¦–æ¬¡æ²¡æœ‰ï¼‰
    nextDeps,                   // ä¾èµ–æ•°ç»„
  );
}


pushEffect - åˆ›å»º Effect å¹¶åŠ å…¥é“¾è¡¨:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Line 1544
function pushEffect(tag, create, destroy, deps) {
  // 1. åˆ›å»º Effect å¯¹è±¡
  const effect: Effect = {
    tag,              // æ ‡è®°ç±»å‹å’Œæ˜¯å¦éœ€è¦æ‰§è¡Œ
    create,           // effect å‡½æ•°
    destroy,          // æ¸…ç†å‡½æ•°
    deps,             // ä¾èµ–æ•°ç»„
    next: (null: any),  // ä¸‹ä¸€ä¸ª Effect
  };

  // 2. è·å– Fiber ä¸Šçš„ updateQueue
  let componentUpdateQueue = currentlyRenderingFiber.updateQueue;

  // 3. åŠ å…¥ Effect é“¾è¡¨
  if (componentUpdateQueue === null) {
    // ç¬¬ä¸€ä¸ª Effectï¼šåˆ›å»º updateQueue
    componentUpdateQueue = createFunctionComponentUpdateQueue();
    currentlyRenderingFiber.updateQueue = componentUpdateQueue;
    componentUpdateQueue.lastEffect = effect.next = effect;  // ç¯å½¢
  } else {
    // åç»­ Effectï¼šè¿½åŠ åˆ°é“¾è¡¨æœ«å°¾
    const lastEffect = componentUpdateQueue.lastEffect;
    if (lastEffect === null) {
      componentUpdateQueue.lastEffect = effect.next = effect;
    } else {
      const firstEffect = lastEffect.next;
      lastEffect.next = effect;
      effect.next = firstEffect;
      componentUpdateQueue.lastEffect = effect;
    }
  }

  return effect;
}


å›¾ç¤ºï¼šEffect é“¾è¡¨çš„æ„å»º
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function MyComponent() {
  useEffect(() => { console.log('A'); }, []);  // Effect 1
  useEffect(() => { console.log('B'); }, []);  // Effect 2
  useEffect(() => { console.log('C'); }, []);  // Effect 3
  return <div />;
}

ç¬¬ä¸€ä¸ª useEffect å:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Fiber.updateQueue.lastEffect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                                                             â”‚              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚              â”‚
â”‚   â”‚ Effect 1 (A)         â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚   â”‚ tag: Passive|HasEffect                                                 â”‚
â”‚   â”‚ create: () => log('A')                                                 â”‚
â”‚   â”‚ next: self  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† ç¯å½¢ï¼ŒæŒ‡å‘è‡ªå·±                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â—€â”€â”˜                                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸‰ä¸ª useEffect éƒ½æ‰§è¡Œå:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Fiber.updateQueue.lastEffect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                                                     â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚      â”‚
â”‚   â”‚ Effect 1 (A) â”‚â”€â”€â–¶â”‚ Effect 2 (B) â”‚â”€â”€â–¶â”‚ Effect 3 (C) â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â†‘                                      â”‚                           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (ç¯å½¢)                    â”‚
â”‚                                                                             â”‚
â”‚   lastEffect æŒ‡å‘æœ€åä¸€ä¸ª (Effect 3)                                        â”‚
â”‚   lastEffect.next æŒ‡å‘ç¬¬ä¸€ä¸ª (Effect 1)                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 2: updateEffect - æ›´æ–°æ¸²æŸ“çš„ useEffect
// ============================================================

/**
 * ğŸ“Š updateEffect - æ›´æ–°æ—¶çš„ Effect å¤„ç†
 */

const updateEffectFn = `
ğŸ“Š updateEffect - æ›´æ–°æ¸²æŸ“çš„ useEffect

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberHooks.new.js
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å…¥å£å‡½æ•° (Line 1727)
function updateEffect(
  create: () => (() => void) | void,
  deps: Array<mixed> | void | null,
): void {
  return updateEffectImpl(PassiveEffect, HookPassive, create, deps);
}

// å®é™…å®ç° (Line 1675)
function updateEffectImpl(fiberFlags, hookFlags, create, deps): void {
  // 1. è·å–å½“å‰ Hook
  const hook = updateWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  let destroy = undefined;

  // 2. ä» current Hook è·å–ä¸Šæ¬¡çš„ Effect
  if (currentHook !== null) {
    const prevEffect = currentHook.memoizedState;
    destroy = prevEffect.destroy;  // è·å–ä¸Šæ¬¡çš„æ¸…ç†å‡½æ•°

    // 3. â­ æ¯”è¾ƒä¾èµ–
    if (nextDeps !== null) {
      const prevDeps = prevEffect.deps;
      if (areHookInputsEqual(nextDeps, prevDeps)) {
        // â­ ä¾èµ–æ²¡å˜ï¼šåˆ›å»º Effect ä½†ä¸æ ‡è®° HookHasEffect
        // è¿™ä¸ª Effect ä¸ä¼šåœ¨ commit é˜¶æ®µæ‰§è¡Œ
        hook.memoizedState = pushEffect(hookFlags, create, destroy, nextDeps);
        return;
      }
    }
  }

  // 4. â­ ä¾èµ–å˜äº†ï¼šç»™ Fiber æ‰“æ ‡è®° + æ ‡è®° Effect éœ€è¦æ‰§è¡Œ
  currentlyRenderingFiber.flags |= fiberFlags;

  hook.memoizedState = pushEffect(
    HookHasEffect | hookFlags,  // â­ æœ‰ HookHasEffectï¼Œä¼šæ‰§è¡Œ
    create,
    destroy,
    nextDeps,
  );
}


å…³é”®ç‚¹ï¼šHookHasEffect æ ‡è®°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Effect çš„ tag æ ‡è®°å†³å®šæ˜¯å¦æ‰§è¡Œ:                                           â”‚
â”‚                                                                             â”‚
â”‚   ä¾èµ–æ²¡å˜:                                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                 â”‚
â”‚   tag = HookPassive                                                         â”‚
â”‚   â†’ commit é˜¶æ®µè·³è¿‡                                                         â”‚
â”‚                                                                             â”‚
â”‚   ä¾èµ–å˜äº†:                                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                 â”‚
â”‚   tag = HookHasEffect | HookPassive                                         â”‚
â”‚   â†’ commit é˜¶æ®µæ‰§è¡Œ                                                         â”‚
â”‚                                                                             â”‚
â”‚   commit é˜¶æ®µæ£€æŸ¥:                                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚   if ((effect.tag & flags) === flags) {                                    â”‚
â”‚     // æ‰§è¡Œ effect                                                          â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ä¾èµ–å˜åŒ–çš„æ¯”è¾ƒé€»è¾‘:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ä½¿ç”¨ Object.is é€é¡¹æ¯”è¾ƒä¾èµ–æ•°ç»„
function areHookInputsEqual(nextDeps, prevDeps) {
  if (prevDeps === null) {
    return false;  // æ²¡æœ‰ä¸Šæ¬¡çš„ä¾èµ–ï¼Œè¿”å› false
  }

  for (let i = 0; i < prevDeps.length && i < nextDeps.length; i++) {
    if (is(nextDeps[i], prevDeps[i])) {  // Object.is
      continue;
    }
    return false;  // æœ‰ä¸€é¡¹ä¸åŒ
  }
  return true;  // å…¨éƒ¨ç›¸åŒ
}
`;

// ============================================================
// Part 3: Commit é˜¶æ®µçš„ Effect æ‰§è¡Œ
// ============================================================

/**
 * ğŸ“Š Effect åœ¨ Commit é˜¶æ®µçš„æ‰§è¡Œ
 */

const effectCommitPhase = `
ğŸ“Š Effect åœ¨ Commit é˜¶æ®µçš„æ‰§è¡Œ

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.new.js
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

useEffect (Passive Effect) çš„æ‰§è¡Œæ—¶æœº:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   commitRoot                                                                â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â”œâ”€â”€ commitBeforeMutationEffects                                        â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â”œâ”€â”€ commitMutationEffects â† useLayoutEffect destroy åœ¨è¿™é‡Œ             â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â”œâ”€â”€ root.current = finishedWork (åˆ‡æ¢ Fiber æ ‘)                        â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â”œâ”€â”€ commitLayoutEffects â† useLayoutEffect create åœ¨è¿™é‡Œ                â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â””â”€â”€ è°ƒåº¦ flushPassiveEffects (å¼‚æ­¥)                                    â”‚
â”‚                â”‚                                                            â”‚
â”‚                â”‚  æµè§ˆå™¨ç»˜åˆ¶...                                              â”‚
â”‚                â–¼                                                            â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚      â”‚ flushPassiveEffects                     â”‚                           â”‚
â”‚      â”‚                                          â”‚                           â”‚
â”‚      â”‚ 1. commitPassiveUnmountEffects          â”‚ â† useEffect destroy       â”‚
â”‚      â”‚    (æ‰§è¡Œæ‰€æœ‰ destroy)                    â”‚                           â”‚
â”‚      â”‚                                          â”‚                           â”‚
â”‚      â”‚ 2. commitPassiveMountEffects            â”‚ â† useEffect create        â”‚
â”‚      â”‚    (æ‰§è¡Œæ‰€æœ‰ create)                     â”‚                           â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


commitHookEffectListUnmount - æ‰§è¡Œæ¸…ç†å‡½æ•°:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Line 512
function commitHookEffectListUnmount(
  flags: HookFlags,              // è¦å¤„ç†çš„ Effect ç±»å‹
  finishedWork: Fiber,           // å½“å‰ Fiber
  nearestMountedAncestor: Fiber | null,
) {
  const updateQueue = finishedWork.updateQueue;
  const lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;

  if (lastEffect !== null) {
    // ä»ç¬¬ä¸€ä¸ª Effect å¼€å§‹éå†
    const firstEffect = lastEffect.next;
    let effect = firstEffect;

    do {
      // â­ æ£€æŸ¥ tag æ˜¯å¦åŒ¹é…
      if ((effect.tag & flags) === flags) {
        // æ‰§è¡Œæ¸…ç†å‡½æ•°
        const destroy = effect.destroy;
        effect.destroy = undefined;

        if (destroy !== undefined) {
          // â­ è°ƒç”¨ destroy()
          safelyCallDestroy(finishedWork, nearestMountedAncestor, destroy);
        }
      }
      effect = effect.next;
    } while (effect !== firstEffect);  // ç¯å½¢é“¾è¡¨ï¼Œå›åˆ°èµ·ç‚¹ç»“æŸ
  }
}


commitHookEffectListMount - æ‰§è¡Œ Effect å‡½æ•°:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Line 562
function commitHookEffectListMount(flags: HookFlags, finishedWork: Fiber) {
  const updateQueue = finishedWork.updateQueue;
  const lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;

  if (lastEffect !== null) {
    const firstEffect = lastEffect.next;
    let effect = firstEffect;

    do {
      // â­ æ£€æŸ¥ tag æ˜¯å¦åŒ¹é…
      if ((effect.tag & flags) === flags) {
        // æ‰§è¡Œ effect å‡½æ•°
        const create = effect.create;

        // â­ æ‰§è¡Œ create()ï¼Œè¿”å›å€¼ä½œä¸º destroy
        effect.destroy = create();
      }
      effect = effect.next;
    } while (effect !== firstEffect);
  }
}
`;

// ============================================================
// Part 4: useLayoutEffect vs useEffect
// ============================================================

/**
 * ğŸ“Š useLayoutEffect ä¸ useEffect çš„åŒºåˆ«
 */

const layoutVsEffect = `
ğŸ“Š useLayoutEffect vs useEffect

æºç å®ç°å¯¹æ¯”:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

useEffect:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mountEffect(create, deps) {
  return mountEffectImpl(
    PassiveEffect | PassiveStaticEffect,  // â­ Passive æ ‡è®°
    HookPassive,
    create,
    deps,
  );
}

useLayoutEffect:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mountLayoutEffect(create, deps) {
  return mountEffectImpl(
    UpdateEffect,         // â­ Update æ ‡è®°
    HookLayout,           // â­ Layout æ ‡è®°
    create,
    deps,
  );
}


æ‰§è¡Œæ—¶æœºå¯¹æ¯”:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Commit é˜¶æ®µæ—¶é—´çº¿:                                                        â”‚
â”‚                                                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                         Commit é˜¶æ®µ                               â”‚     â”‚
â”‚   â”‚                                                                   â”‚     â”‚
â”‚   â”‚  Before Mutation  â”‚  Mutation  â”‚  Layout  â”‚  Passive (å¼‚æ­¥)      â”‚     â”‚
â”‚   â”‚                   â”‚            â”‚          â”‚                       â”‚     â”‚
â”‚   â”‚                   â”‚  â†“         â”‚  â†“       â”‚         â†“             â”‚     â”‚
â”‚   â”‚                   â”‚  Layout    â”‚  Layout  â”‚       Passive         â”‚     â”‚
â”‚   â”‚                   â”‚  destroy   â”‚  create  â”‚    destroy/create     â”‚     â”‚
â”‚   â”‚                   â”‚            â”‚          â”‚                       â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                â”‚                            â”‚
â”‚                                                â”‚ æµè§ˆå™¨ç»˜åˆ¶                 â”‚
â”‚                                                â–¼                            â”‚
â”‚                                          DOM å¯è§                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


å¯¹æ¯”è¡¨:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹æ€§               â”‚ useLayoutEffect      â”‚ useEffect                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fiber flags        â”‚ UpdateEffect         â”‚ PassiveEffect                 â”‚
â”‚ Hook flags         â”‚ HookLayout           â”‚ HookPassive                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ destroy æ‰§è¡Œæ—¶æœº   â”‚ Mutation é˜¶æ®µ        â”‚ ä¸‹æ¬¡æ¸²æŸ“å‰çš„ Passive é˜¶æ®µ     â”‚
â”‚ create æ‰§è¡Œæ—¶æœº    â”‚ Layout é˜¶æ®µ          â”‚ Passive é˜¶æ®µï¼ˆå¼‚æ­¥ï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ˜¯å¦é˜»å¡ç»˜åˆ¶       â”‚ âœ… æ˜¯               â”‚ âŒ å¦                         â”‚
â”‚ æ‰§è¡Œç¯å¢ƒ           â”‚ DOM æ›´æ–°åï¼Œç»˜åˆ¶å‰   â”‚ ç»˜åˆ¶å                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä½¿ç”¨åœºæ™¯           â”‚ éœ€è¦åŒæ­¥æ“ä½œ DOM     â”‚ æ•°æ®è·å–ã€è®¢é˜…ã€æ—¥å¿—          â”‚
â”‚                    â”‚ æµ‹é‡å¸ƒå±€             â”‚ ä¸éœ€è¦åŒæ­¥æ‰§è¡Œçš„å‰¯ä½œç”¨        â”‚
â”‚                    â”‚ é˜²æ­¢é—ªçƒ             â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ä»£ç ç¤ºä¾‹:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// âŒ å¯èƒ½é—ªçƒ
function BadExample() {
  const [position, setPosition] = useState({ x: 0, y: 0 });

  useEffect(() => {
    // è®¡ç®—ä½ç½®ï¼Œæ›´æ–°çŠ¶æ€
    // ä½†æ­¤æ—¶æµè§ˆå™¨å¯èƒ½å·²ç»ç»˜åˆ¶äº†åˆå§‹ä½ç½®ï¼Œå¯¼è‡´é—ªçƒ
    setPosition(calcPosition());
  }, []);

  return <div style={{ top: position.y, left: position.x }} />;
}

// âœ… ä¸ä¼šé—ªçƒ
function GoodExample() {
  const [position, setPosition] = useState({ x: 0, y: 0 });

  useLayoutEffect(() => {
    // åœ¨ç»˜åˆ¶å‰åŒæ­¥è®¡ç®—å¹¶æ›´æ–°
    // æµè§ˆå™¨åªä¼šç»˜åˆ¶æœ€ç»ˆä½ç½®
    setPosition(calcPosition());
  }, []);

  return <div style={{ top: position.y, left: position.x }} />;
}
`;

// ============================================================
// Part 5: å®Œæ•´æµç¨‹å›¾
// ============================================================

/**
 * ğŸ“Š useEffect ä»æ³¨å†Œåˆ°æ‰§è¡Œçš„å®Œæ•´æµç¨‹
 */

const completeEffectFlow = `
ğŸ“Š useEffect ä»æ³¨å†Œåˆ°æ‰§è¡Œçš„å®Œæ•´æµç¨‹

ç¤ºä¾‹ç»„ä»¶:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log('effect', count);
    return () => console.log('cleanup', count);
  }, [count]);

  return <button onClick={() => setCount(count + 1)}>{count}</button>;
}


é¦–æ¬¡æ¸²æŸ“æµç¨‹:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   1ï¸âƒ£  Render é˜¶æ®µ                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚                                                                             â”‚
â”‚   renderWithHooks(Counter)                                                  â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”‚  ReactCurrentDispatcher = HooksDispatcherOnMount                  â”‚
â”‚         â–¼                                                                   â”‚
â”‚   Counter() æ‰§è¡Œ                                                            â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â–¶ useState(0)                                                     â”‚
â”‚         â”‚      â””â”€â–¶ mountState â†’ åˆ›å»º Hook1ï¼Œè¿”å› [0, setCount]             â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â–¶ useEffect(...)                                                  â”‚
â”‚                â””â”€â–¶ mountEffect                                              â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â”œâ”€â–¶ åˆ›å»º Hook2                                        â”‚
â”‚                       â”œâ”€â–¶ Fiber.flags |= PassiveEffect                      â”‚
â”‚                       â””â”€â–¶ pushEffect(HookHasEffect | HookPassive, ...)     â”‚
â”‚                              â””â”€â–¶ åˆ›å»º Effectï¼ŒåŠ å…¥ updateQueue.lastEffect  â”‚
â”‚                                                                             â”‚
â”‚   ç»“æœ:                                                                     â”‚
â”‚   â€¢ Fiber.memoizedState â†’ Hook1 â†’ Hook2                                    â”‚
â”‚   â€¢ Fiber.flags åŒ…å« PassiveEffect                                          â”‚
â”‚   â€¢ Fiber.updateQueue.lastEffect â†’ Effect                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   2ï¸âƒ£  Commit é˜¶æ®µ                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚                                                                             â”‚
â”‚   commitRoot                                                                â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â–¶ commitBeforeMutationEffects                                     â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â–¶ commitMutationEffects                                           â”‚
â”‚         â”‚      â””â”€â–¶ æ‰§è¡Œ DOM æ“ä½œ                                            â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â–¶ root.current = finishedWork                                     â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â–¶ commitLayoutEffects                                             â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â–¶ â­ è°ƒåº¦ flushPassiveEffectsï¼ˆå¼‚æ­¥ï¼‰                             â”‚
â”‚                â”‚                                                            â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                â”‚ æµè§ˆå™¨ç»˜åˆ¶                                                  â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                â”‚                                                            â”‚
â”‚                â–¼                                                            â”‚
â”‚   3ï¸âƒ£  Passive Effects é˜¶æ®µï¼ˆå¼‚æ­¥ï¼‰                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚                                                                             â”‚
â”‚   flushPassiveEffects                                                       â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â–¶ commitPassiveUnmountEffects                                     â”‚
â”‚         â”‚      â””â”€â–¶ é¦–æ¬¡æ¸²æŸ“æ²¡æœ‰ destroy                                     â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â–¶ commitPassiveMountEffects                                       â”‚
â”‚                â””â”€â–¶ commitHookEffectListMount(HookPassive | HookHasEffect)  â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â””â”€â–¶ éå† Effect é“¾è¡¨                                  â”‚
â”‚                              â””â”€â–¶ effect.destroy = effect.create()          â”‚
â”‚                                     â”‚                                       â”‚
â”‚                                     â””â”€â–¶ console.log('effect', 0)           â”‚
â”‚                                     â””â”€â–¶ è¿”å› cleanup å‡½æ•°                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ç‚¹å‡»æŒ‰é’®åçš„æ›´æ–°æµç¨‹:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   1ï¸âƒ£  è§¦å‘æ›´æ–°                                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚                                                                             â”‚
â”‚   setCount(1)                                                               â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â–¶ dispatchSetState â†’ scheduleUpdateOnFiber                       â”‚
â”‚                                                                             â”‚
â”‚   2ï¸âƒ£  Render é˜¶æ®µ                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚                                                                             â”‚
â”‚   ReactCurrentDispatcher = HooksDispatcherOnUpdate                          â”‚
â”‚                                                                             â”‚
â”‚   Counter() æ‰§è¡Œ                                                            â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â–¶ useState(0)                                                     â”‚
â”‚         â”‚      â””â”€â–¶ updateState â†’ è¿”å› [1, setCount]                        â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â–¶ useEffect(...)                                                  â”‚
â”‚                â””â”€â–¶ updateEffect                                             â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â”œâ”€â–¶ æ¯”è¾ƒ deps: [0] vs [1]                            â”‚
â”‚                       â”œâ”€â–¶ â­ ä¾èµ–å˜äº†ï¼                                     â”‚
â”‚                       â”œâ”€â–¶ Fiber.flags |= PassiveEffect                      â”‚
â”‚                       â””â”€â–¶ pushEffect(HookHasEffect | HookPassive, ...)     â”‚
â”‚                              â””â”€â–¶ destroy = ä¸Šæ¬¡çš„ cleanup å‡½æ•°             â”‚
â”‚                                                                             â”‚
â”‚   3ï¸âƒ£  Passive Effects é˜¶æ®µ                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚                                                                             â”‚
â”‚   flushPassiveEffects                                                       â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â–¶ commitPassiveUnmountEffects                                     â”‚
â”‚         â”‚      â””â”€â–¶ commitHookEffectListUnmount                              â”‚
â”‚         â”‚             â”‚                                                     â”‚
â”‚         â”‚             â””â”€â–¶ æ‰§è¡Œä¸Šæ¬¡çš„ destroy                                â”‚
â”‚         â”‚                    â””â”€â–¶ console.log('cleanup', 0)  â† æ—§å€¼         â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â–¶ commitPassiveMountEffects                                       â”‚
â”‚                â””â”€â–¶ commitHookEffectListMount                                â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â””â”€â–¶ effect.destroy = effect.create()                 â”‚
â”‚                              â””â”€â–¶ console.log('effect', 1)   â† æ–°å€¼         â”‚
â”‚                                                                             â”‚
â”‚   æ§åˆ¶å°è¾“å‡ºé¡ºåº:                                                           â”‚
â”‚   1. cleanup 0  (æ¸…ç†ä¸Šæ¬¡çš„ effect)                                         â”‚
â”‚   2. effect 1   (æ‰§è¡Œæ–°çš„ effect)                                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 6: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 4 é¢è¯•è¦ç‚¹

Q1: useEffect æ˜¯å¦‚ä½•æ³¨å†Œçš„ï¼Ÿ
A: 1. mountEffect åˆ›å»º Hook èŠ‚ç‚¹
   2. ç»™ Fiber.flags æ‰“ä¸Š PassiveEffect æ ‡è®°
   3. è°ƒç”¨ pushEffect åˆ›å»º Effect å¯¹è±¡ï¼ŒåŠ å…¥ updateQueue.lastEffect é“¾è¡¨
   4. Effect çš„ tag åŒ…å« HookHasEffect è¡¨ç¤ºéœ€è¦æ‰§è¡Œ

Q2: useEffect çš„ create å’Œ destroy åˆ†åˆ«åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ
A: éƒ½åœ¨ commit ä¹‹åçš„ Passive Effects é˜¶æ®µå¼‚æ­¥æ‰§è¡Œï¼š
   1. å…ˆæ‰§è¡Œæ‰€æœ‰éœ€è¦æ¸…ç†çš„ destroyï¼ˆä¸Šæ¬¡æ¸²æŸ“çš„ï¼‰
   2. å†æ‰§è¡Œæ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ createï¼ˆæœ¬æ¬¡æ¸²æŸ“çš„ï¼‰
   destroy çš„æ‰§è¡Œé¡ºåºåœ¨ create ä¹‹å‰ï¼

Q3: æ›´æ–°æ—¶ useEffect å¦‚ä½•åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œï¼Ÿ
A: é€šè¿‡æ¯”è¾ƒä¾èµ–æ•°ç»„ï¼ˆareHookInputsEqualï¼‰ï¼š
   - ä¾èµ–æ²¡å˜ï¼šEffect.tag åªæœ‰ HookPassiveï¼Œä¸æ‰§è¡Œ
   - ä¾èµ–å˜äº†ï¼šEffect.tag æœ‰ HookHasEffect | HookPassiveï¼Œä¼šæ‰§è¡Œ

Q4: useLayoutEffect å’Œ useEffect çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
A: æ‰§è¡Œæ—¶æœºä¸åŒï¼š
   - useLayoutEffectï¼šLayout é˜¶æ®µåŒæ­¥æ‰§è¡Œï¼Œåœ¨ DOM æ›´æ–°åã€æµè§ˆå™¨ç»˜åˆ¶å‰
   - useEffectï¼šPassive é˜¶æ®µå¼‚æ­¥æ‰§è¡Œï¼Œåœ¨æµè§ˆå™¨ç»˜åˆ¶å
   useLayoutEffect ä¼šé˜»å¡ç»˜åˆ¶ï¼Œé€‚åˆéœ€è¦åŒæ­¥æ“ä½œ DOM çš„åœºæ™¯ã€‚

Q5: ä¸ºä»€ä¹ˆ useEffect çš„æ¸…ç†å‡½æ•°æ‹¿åˆ°çš„æ˜¯æ—§å€¼ï¼Ÿ
A: Effect å¯¹è±¡åœ¨æ¸²æŸ“æ—¶åˆ›å»ºï¼Œcreate å’Œ deps éƒ½æ˜¯é—­åŒ…æ•è·çš„å½“å‰å€¼ã€‚
   æ‰§è¡Œ destroy æ—¶æ‰§è¡Œçš„æ˜¯ä¸Šæ¬¡æ¸²æŸ“åˆ›å»ºçš„ Effect çš„è¿”å›å‡½æ•°ï¼Œ
   è¯¥å‡½æ•°é—­åŒ…ä¸­çš„å€¼æ˜¯ä¸Šæ¬¡æ¸²æŸ“æ—¶çš„å€¼ã€‚

Q6: Effect é“¾è¡¨ä¸ºä»€ä¹ˆæ˜¯ç¯å½¢çš„ï¼Ÿ
A: 1. lastEffect æŒ‡å‘æœ€åä¸€ä¸ª Effect
   2. lastEffect.next æŒ‡å‘ç¬¬ä¸€ä¸ª Effect
   å¥½å¤„ï¼šO(1) æ—¶é—´è¿½åŠ æ–° Effectï¼ŒO(1) æ—¶é—´æ‰¾åˆ°ç¬¬ä¸€ä¸ª Effect

Q7: å¤šä¸ª useEffect çš„æ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ
A: æŒ‰ç…§è°ƒç”¨é¡ºåºæ‰§è¡Œï¼š
   1. æ‰€æœ‰ destroy æŒ‰é¡ºåºæ‰§è¡Œï¼ˆå…ˆ effect1 çš„ destroyï¼Œå† effect2 çš„...ï¼‰
   2. æ‰€æœ‰ create æŒ‰é¡ºåºæ‰§è¡Œï¼ˆå…ˆ effect1 çš„ createï¼Œå† effect2 çš„...ï¼‰
`;

export {
  mountEffectFn,
  updateEffectFn,
  effectCommitPhase,
  layoutVsEffect,
  completeEffectFlow,
  interviewPoints,
};

