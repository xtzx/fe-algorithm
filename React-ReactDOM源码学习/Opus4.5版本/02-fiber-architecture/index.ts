/**
 * ============================================================
 * ğŸ“š Phase 2: Fiber æ¶æ„ï¼ˆæ ¸å¿ƒé‡ç‚¹ï¼‰
 * ============================================================
 *
 * ğŸ¯ å­¦ä¹ ç›®æ ‡ï¼š
 * 1. ç†è§£ Fiber çš„è®¾è®¡åŠ¨æœº
 * 2. æŒæ¡ FiberNode æ•°æ®ç»“æ„
 * 3. ç†è§£ Fiber æ ‘çš„åŒç¼“å†²æœºåˆ¶
 * 4. ç†è§£ Fiber çš„å·¥ä½œåŸç†
 *
 * ğŸ“ æºç ä½ç½®ï¼š
 * - packages/react-reconciler/src/ReactFiber.js
 * - packages/react-reconciler/src/ReactFiberWorkLoop.js
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š8 å°æ—¶
 * ğŸ”¥ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­ï¼ˆå¿…è€ƒï¼‰
 */

// ============================================================
// 1. ä¸ºä»€ä¹ˆéœ€è¦ Fiberï¼Ÿ
// ============================================================

/**
 * ğŸ“Š React 15 çš„é—®é¢˜ï¼ˆStack Reconcilerï¼‰
 *
 * React 15 ä½¿ç”¨é€’å½’æ–¹å¼å¤„ç†è™šæ‹Ÿ DOMï¼š
 *
 * ```
 * æ›´æ–°å¼€å§‹
 *    â”‚
 *    â–¼
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  é€’å½’éå†æ•´æ£µæ ‘ï¼ˆä¸å¯ä¸­æ–­ï¼‰              â”‚
 * â”‚  å¯èƒ½è€—æ—¶ 100ms+                        â”‚
 * â”‚  æœŸé—´æ— æ³•å“åº”ç”¨æˆ·è¾“å…¥                   â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *    â”‚
 *    â–¼
 * æ›´æ–°å®Œæˆ
 * ```
 *
 * é—®é¢˜ï¼š
 * - JavaScript æ˜¯å•çº¿ç¨‹çš„
 * - é€’å½’ä¸å¯ä¸­æ–­
 * - é•¿æ—¶é—´å ç”¨ä¸»çº¿ç¨‹å¯¼è‡´é¡µé¢å¡é¡¿
 *
 * ğŸ“Š Fiber çš„è§£å†³æ–¹æ¡ˆ
 *
 * ```
 * æ›´æ–°å¼€å§‹
 *    â”‚
 *    â–¼
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ æ—¶é—´ç‰‡ 1  â”‚ â”€â”€â–º â”‚ æ—¶é—´ç‰‡ 2  â”‚ â”€â”€â–º â”‚ æ—¶é—´ç‰‡ 3  â”‚ â”€â”€â–º ...
 * â”‚  5ms     â”‚     â”‚  5ms     â”‚     â”‚  5ms     â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *       â”‚               â”‚               â”‚
 *       â–¼               â–¼               â–¼
 *   æ£€æŸ¥æ˜¯å¦æœ‰      æ£€æŸ¥æ˜¯å¦æœ‰       æ£€æŸ¥æ˜¯å¦æœ‰
 *   æ›´é«˜ä¼˜å…ˆçº§      æ›´é«˜ä¼˜å…ˆçº§       æ›´é«˜ä¼˜å…ˆçº§
 *   ä»»åŠ¡           ä»»åŠ¡             ä»»åŠ¡
 * ```
 *
 * Fiber æ ¸å¿ƒèƒ½åŠ›ï¼š
 * 1. å¯ä¸­æ–­ï¼šå°†é€’å½’æ”¹ä¸ºå¾ªç¯
 * 2. å¯æ¢å¤ï¼šä¿å­˜å·¥ä½œè¿›åº¦
 * 3. ä¼˜å…ˆçº§ï¼šé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿ
 */

// ============================================================
// 2. Fiber æ•°æ®ç»“æ„
// ============================================================

/**
 * ğŸ“Š FiberNode ç»“æ„
 *
 * æºç ä½ç½®ï¼špackages/react-reconciler/src/ReactFiber.js
 */

interface FiberNode {
  // ========== èŠ‚ç‚¹ç±»å‹ ==========
  tag: number;                    // èŠ‚ç‚¹ç±»å‹ï¼ˆFunctionComponent/ClassComponent/HostComponent...ï¼‰
  type: any;                      // å…ƒç´ ç±»å‹ï¼ˆ'div'/Function/Classï¼‰
  key: string | null;             // diff ç”¨çš„ key

  // ========== èŠ‚ç‚¹å…³ç³»ï¼ˆé“¾è¡¨ç»“æ„ï¼‰==========
  return: FiberNode | null;       // çˆ¶èŠ‚ç‚¹
  child: FiberNode | null;        // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
  sibling: FiberNode | null;      // ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
  index: number;                  // åœ¨å…„å¼Ÿä¸­çš„ç´¢å¼•

  // ========== çŠ¶æ€ç›¸å…³ ==========
  pendingProps: any;              // æ–°çš„ props
  memoizedProps: any;             // ä¸Šæ¬¡æ¸²æŸ“çš„ props
  memoizedState: any;             // ä¸Šæ¬¡æ¸²æŸ“çš„ stateï¼ˆHooks é“¾è¡¨ï¼‰
  updateQueue: any;               // æ›´æ–°é˜Ÿåˆ—

  // ========== å‰¯ä½œç”¨ ==========
  flags: number;                  // å‰¯ä½œç”¨æ ‡è®°ï¼ˆPlacement/Update/Deletionï¼‰
  subtreeFlags: number;           // å­æ ‘çš„å‰¯ä½œç”¨
  deletions: FiberNode[] | null;  // è¦åˆ é™¤çš„å­èŠ‚ç‚¹

  // ========== åŒç¼“å†² ==========
  alternate: FiberNode | null;    // æŒ‡å‘å¦ä¸€æ£µæ ‘çš„å¯¹åº”èŠ‚ç‚¹

  // ========== è°ƒåº¦ç›¸å…³ ==========
  lanes: number;                  // ä¼˜å…ˆçº§
  childLanes: number;             // å­æ ‘ä¼˜å…ˆçº§

  // ========== DOM ç›¸å…³ ==========
  stateNode: any;                 // DOM èŠ‚ç‚¹æˆ–ç»„ä»¶å®ä¾‹
  ref: any;                       // ref
}

/**
 * ğŸ“Š tag ç±»å‹ï¼ˆéƒ¨åˆ†ï¼‰
 *
 * æºç ä½ç½®ï¼špackages/react-reconciler/src/ReactWorkTags.js
 */
const WorkTags = {
  FunctionComponent: 0,    // å‡½æ•°ç»„ä»¶
  ClassComponent: 1,       // ç±»ç»„ä»¶
  HostRoot: 3,             // æ ¹èŠ‚ç‚¹
  HostComponent: 5,        // åŸç”Ÿ DOMï¼ˆdiv/spanï¼‰
  HostText: 6,             // æ–‡æœ¬èŠ‚ç‚¹
  Fragment: 7,             // Fragment
  ContextConsumer: 9,      // Context.Consumer
  ContextProvider: 10,     // Context.Provider
  ForwardRef: 11,          // forwardRef
  MemoComponent: 14,       // memo
  SimpleMemoComponent: 15, // ç®€å• memo
  LazyComponent: 16,       // lazy
};

// ============================================================
// 3. Fiber æ ‘ç»“æ„
// ============================================================

/**
 * ğŸ“Š Fiber æ ‘çš„é“¾è¡¨ç»“æ„
 *
 * React ç»„ä»¶ç»“æ„ï¼š
 * ```jsx
 * <App>
 *   <Header />
 *   <Content>
 *     <Article />
 *     <Sidebar />
 *   </Content>
 * </App>
 * ```
 *
 * å¯¹åº”çš„ Fiber æ ‘ï¼š
 *
 * ```
 *                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *                    â”‚   App   â”‚
 *                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
 *                         â”‚ child
 *                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
 *             â”Œâ”€â”€â”€â”€â”€â”€â”‚ Header  â”‚
 *             â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
 *             â”‚           â”‚ sibling
 *     return  â”‚      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
 *             â”‚      â”‚ Content â”‚
 *             â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
 *             â”‚           â”‚ child
 *             â”‚      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
 *             â””â”€â”€â”€â”€â”€â”€â”‚ Article â”‚
 *                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
 *                         â”‚ sibling
 *                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
 *                    â”‚ Sidebar â”‚
 *                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * ```
 *
 * ç‰¹ç‚¹ï¼š
 * - childï¼šæŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
 * - siblingï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
 * - returnï¼šæŒ‡å‘çˆ¶èŠ‚ç‚¹
 * - å½¢æˆé“¾è¡¨ï¼Œå¯ä»¥ç”¨å¾ªç¯éå†ï¼ˆè€Œéé€’å½’ï¼‰
 */

// ============================================================
// 4. åŒç¼“å†²æœºåˆ¶ï¼ˆDouble Bufferingï¼‰
// ============================================================

/**
 * ğŸ“Š åŒç¼“å†²
 *
 * å†…å­˜ä¸­å§‹ç»ˆå­˜åœ¨ä¸¤æ£µ Fiber æ ‘ï¼š
 *
 * ```
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                      FiberRoot                          â”‚
 * â”‚                                                         â”‚
 * â”‚    current â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
 * â”‚                        â”‚ current â”‚ â—„â”€â”€â”€â”€ å½“å‰æ˜¾ç¤º       â”‚
 * â”‚                        â”‚  æ ‘     â”‚                      â”‚
 * â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                      â”‚
 * â”‚                             â”‚ alternate                 â”‚
 * â”‚                        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                      â”‚
 * â”‚                        â”‚workIn-  â”‚ â—„â”€â”€â”€â”€ æ­£åœ¨æ„å»º       â”‚
 * â”‚                        â”‚Progress â”‚                      â”‚
 * â”‚                        â”‚  æ ‘     â”‚                      â”‚
 * â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
 * â”‚                                                         â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * ```
 *
 * å·¥ä½œæµç¨‹ï¼š
 * 1. current æ ‘ï¼šå½“å‰å±å¹•æ˜¾ç¤ºçš„å†…å®¹
 * 2. workInProgress æ ‘ï¼šæ­£åœ¨å†…å­˜ä¸­æ„å»ºçš„æ–°æ ‘
 * 3. æ„å»ºå®Œæˆåï¼ŒworkInProgress å˜æˆ current
 * 4. ä¸¤æ£µæ ‘é€šè¿‡ alternate äº’ç›¸å¼•ç”¨
 *
 * ä¼˜ç‚¹ï¼š
 * - å¤ç”¨èŠ‚ç‚¹ï¼ˆå¦‚æœèŠ‚ç‚¹æ²¡å˜ï¼Œç›´æ¥å¤ç”¨ï¼‰
 * - ä¸ä¼šå‡ºç°åŠæ›´æ–°çŠ¶æ€
 */

// ç®€åŒ–ç‰ˆåŒç¼“å†²ç¤ºæ„
class SimpleFiberRoot {
  current: FiberNode | null = null;        // å½“å‰æ ‘
  workInProgress: FiberNode | null = null; // æ„å»ºä¸­çš„æ ‘

  // äº¤æ¢ä¸¤æ£µæ ‘
  commitRoot() {
    // workInProgress å®Œæˆåå˜æˆ current
    this.current = this.workInProgress;
    this.workInProgress = null;
  }

  // åˆ›å»º workInProgress
  createWorkInProgress(current: FiberNode): FiberNode {
    let workInProgress = current.alternate;

    if (workInProgress === null) {
      // é¦–æ¬¡æ¸²æŸ“ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹
      workInProgress = {
        ...current,
        alternate: current,
      } as FiberNode;
      current.alternate = workInProgress;
    } else {
      // æ›´æ–°æ—¶ï¼Œå¤ç”¨èŠ‚ç‚¹
      workInProgress.pendingProps = current.pendingProps;
      workInProgress.flags = 0;
      workInProgress.subtreeFlags = 0;
      workInProgress.deletions = null;
    }

    return workInProgress;
  }
}

// ============================================================
// 5. ğŸ’¡ é¢è¯•é¢˜
// ============================================================

/**
 * ğŸ’¡ Q1: ä»€ä¹ˆæ˜¯ Fiberï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ Fiberï¼Ÿ
 *
 * A: Fiber æ˜¯ React 16 å¼•å…¥çš„æ–°åè°ƒæ¶æ„ã€‚
 *
 *    ä¸ºä»€ä¹ˆéœ€è¦ï¼š
 *    - React 15 ä½¿ç”¨é€’å½’å¤„ç†æ›´æ–°ï¼Œä¸å¯ä¸­æ–­
 *    - é•¿ä»»åŠ¡ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´é¡µé¢å¡é¡¿
 *
 *    Fiber è§£å†³ï¼š
 *    - å°†é€’å½’æ”¹ä¸ºé“¾è¡¨éå†ï¼ˆå¯ä¸­æ–­ï¼‰
 *    - å¼•å…¥æ—¶é—´åˆ‡ç‰‡ï¼Œæ¯å¸§åªå·¥ä½œä¸€æ®µæ—¶é—´
 *    - æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡å¯ä»¥æ’é˜Ÿ
 *
 * ğŸ’¡ Q2: Fiber èŠ‚ç‚¹çš„ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ
 *
 * A: Fiber èŠ‚ç‚¹æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„çš„å¯¹è±¡ï¼ŒåŒ…å«ï¼š
 *    - type/tagï¼šèŠ‚ç‚¹ç±»å‹
 *    - child/sibling/returnï¼šæ ‘ç»“æ„
 *    - memoizedStateï¼šçŠ¶æ€ï¼ˆHooks é“¾è¡¨ï¼‰
 *    - flagsï¼šå‰¯ä½œç”¨æ ‡è®°
 *    - alternateï¼šåŒç¼“å†²å¯¹åº”èŠ‚ç‚¹
 *
 * ğŸ’¡ Q3: ä»€ä¹ˆæ˜¯åŒç¼“å†²ï¼Ÿ
 *
 * A: å†…å­˜ä¸­åŒæ—¶å­˜åœ¨ä¸¤æ£µ Fiber æ ‘ï¼š
 *    - currentï¼šå½“å‰å±å¹•æ˜¾ç¤º
 *    - workInProgressï¼šæ­£åœ¨æ„å»º
 *
 *    æ„å»ºå®Œæˆåï¼ŒworkInProgress å˜æˆ currentã€‚
 *    å¥½å¤„æ˜¯å¯ä»¥å¤ç”¨èŠ‚ç‚¹ï¼Œé¿å…åŠæ›´æ–°çŠ¶æ€ã€‚
 *
 * ğŸ’¡ Q4: Fiber å¦‚ä½•å®ç°å¯ä¸­æ–­ï¼Ÿ
 *
 * A: é€šè¿‡é“¾è¡¨ç»“æ„ + å·¥ä½œå¾ªç¯ï¼š
 *    - ç”¨ child/sibling/return è¿æ¥èŠ‚ç‚¹
 *    - ç”¨ while å¾ªç¯éå†ï¼ˆè€Œéé€’å½’ï¼‰
 *    - æ¯å¤„ç†ä¸€ä¸ªèŠ‚ç‚¹æ£€æŸ¥æ˜¯å¦éœ€è¦è®©å‡º
 *    - è®©å‡ºåå¯ä»¥ä»ä¸­æ–­ç‚¹æ¢å¤
 */

// ============================================================
// 6. ğŸ¢ å®é™…å¼€å‘åº”ç”¨
// ============================================================

/**
 * ğŸ¢ åº”ç”¨ 1ï¼šç†è§£ React DevTools
 *
 * DevTools æ˜¾ç¤ºçš„å°±æ˜¯ Fiber æ ‘ç»“æ„
 * ç†è§£ Fiber åå¯ä»¥æ›´å¥½åœ°åˆ†æç»„ä»¶ç»“æ„
 */

/**
 * ğŸ¢ åº”ç”¨ 2ï¼šç†è§£æ€§èƒ½é—®é¢˜
 *
 * çŸ¥é“ Fiber æ˜¯é“¾è¡¨éå†åï¼š
 * - ç»„ä»¶å±‚çº§æ·± = éå†æ—¶é—´é•¿
 * - åˆç†æ‹†åˆ†ç»„ä»¶å¯ä»¥åˆ©ç”¨ bailout è·³è¿‡
 */

/**
 * ğŸ¢ åº”ç”¨ 3ï¼šç†è§£ key çš„ä½œç”¨
 *
 * key å­˜å‚¨åœ¨ Fiber.key ä¸­
 * ç”¨äº Diff æ—¶å¿«é€Ÿæ‰¾åˆ°å¯¹åº”çš„æ—§èŠ‚ç‚¹
 */

// ============================================================
// 7. ğŸ“– æºç é˜…è¯»æŒ‡å—
// ============================================================

/**
 * ğŸ“– é˜…è¯»é¡ºåºï¼š
 *
 * 1. packages/react-reconciler/src/ReactWorkTags.js
 *    - Fiber èŠ‚ç‚¹ç±»å‹å®šä¹‰
 *
 * 2. packages/react-reconciler/src/ReactFiber.js
 *    - FiberNode åˆ›å»º
 *    - createFiber å‡½æ•°
 *    - createWorkInProgress å‡½æ•°
 *
 * 3. packages/react-reconciler/src/ReactFiberRoot.js
 *    - FiberRoot ç»“æ„
 *    - createFiberRoot å‡½æ•°
 *
 * 4. packages/react-reconciler/src/ReactFiberFlags.js
 *    - å‰¯ä½œç”¨æ ‡è®°å®šä¹‰
 */

// ============================================================
// 8. âœ… å­¦ä¹ æ£€æŸ¥
// ============================================================

/**
 * âœ… å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š
 *
 * - [ ] ç†è§£ Fiber çš„è®¾è®¡åŠ¨æœº
 * - [ ] æŒæ¡ FiberNode æ•°æ®ç»“æ„
 * - [ ] ç†è§£åŒç¼“å†²æœºåˆ¶
 * - [ ] èƒ½ç”»å‡º Fiber æ ‘ç»“æ„
 * - [ ] é˜…è¯»æºç ï¼šReactFiber.js
 */

export { WorkTags, SimpleFiberRoot };
export type { FiberNode };

