/**
 * ============================================================
 * ğŸ“š Phase 2: Fiber æ¶æ„ - Part 4: åŒç¼“å­˜æ ‘ï¼ˆcurrent / workInProgress / alternateï¼‰
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-reconciler/src/ReactFiber.new.js (createWorkInProgress)
 * - packages/react-reconciler/src/ReactFiberWorkLoop.new.js
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š3-4 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­
 */

// ============================================================
// Part 1: ä»€ä¹ˆæ˜¯åŒç¼“å­˜ï¼Ÿ
// ============================================================

/**
 * ğŸ“Š åŒç¼“å­˜çš„æ¦‚å¿µ
 */

const doubleBufferingConcept = `
ğŸ“Š ä»€ä¹ˆæ˜¯åŒç¼“å­˜ï¼ˆDouble Bufferingï¼‰ï¼Ÿ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åŒç¼“å­˜çš„æ¥æº                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   åŒç¼“å­˜æ˜¯å›¾å½¢å­¦ä¸­çš„ç»å…¸æŠ€æœ¯ï¼Œä¹Ÿå«"åŒç¼“å†²"                                  â”‚
â”‚                                                                             â”‚
â”‚   é—®é¢˜åœºæ™¯ï¼ˆæ— ç¼“å†²ï¼‰ï¼š                                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   ç”»å®¶åœ¨ç”»å¸ƒä¸Šè¾¹ç”»è¾¹å±•ç¤ºç»™è§‚ä¼—çœ‹                                            â”‚
â”‚   è§‚ä¼—çœ‹åˆ°çš„æ˜¯ï¼šä¸€ç¬”ä¸€ç¬”çš„ç»˜åˆ¶è¿‡ç¨‹ã€åŠæˆå“ã€é—ªçƒ                            â”‚
â”‚                                                                             â”‚
â”‚   åŒç¼“å†²è§£å†³æ–¹æ¡ˆï¼š                                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   å‡†å¤‡ä¸¤å—ç”»å¸ƒï¼š                                                            â”‚
â”‚   - ç”»å¸ƒ Aï¼šå½“å‰å±•ç¤ºç»™è§‚ä¼—çš„å®Œæ•´ç”»é¢                                        â”‚
â”‚   - ç”»å¸ƒ Bï¼šç”»å®¶åœ¨å¹•åç»˜åˆ¶çš„æ–°ç”»é¢                                          â”‚
â”‚                                                                             â”‚
â”‚   å·¥ä½œæµç¨‹ï¼š                                                                â”‚
â”‚   1. è§‚ä¼—çœ‹ Aï¼Œç”»å®¶åœ¨ B ä¸Šç”»                                                â”‚
â”‚   2. ç”»å®¶ç”»å®Œ B                                                             â”‚
â”‚   3. ç¬é—´äº¤æ¢ï¼šè§‚ä¼—çœ‹ Bï¼ŒA å˜æˆæ–°çš„å¹•åç”»å¸ƒ                                 â”‚
â”‚   4. ä¸‹æ¬¡æ›´æ–°æ—¶ï¼Œç”»å®¶åœ¨ A ä¸Šç”»                                              â”‚
â”‚                                                                             â”‚
â”‚   æ•ˆæœï¼šè§‚ä¼—æ°¸è¿œåªçœ‹åˆ°å®Œæ•´çš„ç”»é¢ï¼Œä¸ä¼šçœ‹åˆ°åŠæˆå“                            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

React ä¸­çš„åŒç¼“å­˜:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   React ç»´æŠ¤ä¸¤æ£µ Fiber æ ‘ï¼š                                                 â”‚
â”‚                                                                             â”‚
â”‚   current æ ‘                              workInProgress æ ‘                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚   â€¢ å½“å‰å±å¹•ä¸Šæ˜¾ç¤ºçš„ UI                   â€¢ æ­£åœ¨å†…å­˜ä¸­æ„å»ºçš„æ–° UI           â”‚
â”‚   â€¢ å·²ç» commit åˆ° DOM                    â€¢ Render é˜¶æ®µåœ¨å¤„ç†              â”‚
â”‚   â€¢ ç”¨æˆ·çœ‹åˆ°çš„çŠ¶æ€                        â€¢ è¿˜æ²¡æœ‰æ˜¾ç¤ºç»™ç”¨æˆ·                â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚  current        â”‚â—„â”€â”€ alternate â”€â”€â”€â”€â–¶â”‚  workInProgress â”‚               â”‚
â”‚   â”‚  Fiber Tree     â”‚                    â”‚  Fiber Tree     â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚          â”‚                                        â”‚                         â”‚
â”‚          â”‚                                        â”‚                         â”‚
â”‚          â–¼                                        â”‚                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚                         â”‚
â”‚   â”‚  å½“å‰ DOM       â”‚                  Commit åäº¤æ¢                        â”‚
â”‚   â”‚  (ç”¨æˆ·å¯è§)     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 2: alternate çš„ä½œç”¨
// ============================================================

/**
 * ğŸ“Š alternate å­—æ®µè¯¦è§£
 */

const alternateExplanation = `
ğŸ“Š alternate å­—æ®µçš„ä½œç”¨

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       alternate çš„å®šä¹‰                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   æ¯ä¸ª Fiber èŠ‚ç‚¹æœ‰ä¸€ä¸ª alternate å­—æ®µ                                      â”‚
â”‚   æŒ‡å‘å¦ä¸€æ£µæ ‘ä¸Š"å¯¹åº”ä½ç½®"çš„ Fiber                                          â”‚
â”‚                                                                             â”‚
â”‚   currentFiber.alternate = workInProgressFiber;                             â”‚
â”‚   workInProgressFiber.alternate = currentFiber;                             â”‚
â”‚                                                                             â”‚
â”‚   å®ƒä»¬æ˜¯åŒä¸€ä¸ªç»„ä»¶çš„ä¸¤ä¸ªç‰ˆæœ¬ï¼š                                              â”‚
â”‚   - currentï¼šå½“å‰æ˜¾ç¤ºçš„ç‰ˆæœ¬                                                 â”‚
â”‚   - workInProgressï¼šæ­£åœ¨è®¡ç®—çš„æ–°ç‰ˆæœ¬                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

alternate çš„ä½œç”¨:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. å¤ç”¨ Fiber å¯¹è±¡
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   åˆ›å»º workInProgress æ—¶ï¼Œä¸æ˜¯æ¯æ¬¡éƒ½ new FiberNode
   è€Œæ˜¯å¤ç”¨ current.alternateï¼ˆå¦‚æœå­˜åœ¨ï¼‰

   ğŸ“ createWorkInProgress æºç ï¼ˆç®€åŒ–ï¼‰:

   function createWorkInProgress(current, pendingProps) {
     let workInProgress = current.alternate;

     if (workInProgress === null) {
       // é¦–æ¬¡æ¸²æŸ“ï¼šåˆ›å»ºæ–°çš„ Fiber
       workInProgress = createFiber(...);
       workInProgress.alternate = current;
       current.alternate = workInProgress;
     } else {
       // æ›´æ–°æ¸²æŸ“ï¼šå¤ç”¨ alternateï¼Œåªæ›´æ–°å±æ€§
       workInProgress.pendingProps = pendingProps;
       workInProgress.flags = NoFlags;
       workInProgress.subtreeFlags = NoFlags;
       workInProgress.deletions = null;
       // ... å¤åˆ¶å…¶ä»–éœ€è¦çš„å±æ€§
     }

     return workInProgress;
   }


2. æ¯”è¾ƒæ–°æ—§çŠ¶æ€
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   åœ¨ Render é˜¶æ®µï¼Œå¯ä»¥é€šè¿‡ alternate è®¿é—®"å½“å‰æ˜¾ç¤ºçš„çŠ¶æ€"

   // åœ¨ workInProgress ä¸Šå·¥ä½œæ—¶
   const current = workInProgress.alternate;
   const oldProps = current?.memoizedProps;
   const newProps = workInProgress.pendingProps;

   // æ¯”è¾ƒæ–°æ—§ propsï¼Œå†³å®šæ˜¯å¦éœ€è¦æ›´æ–°


3. åŒç¼“å­˜äº¤æ¢
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   Commit å®Œæˆåï¼Œåªéœ€è¦æŠŠ FiberRoot.current æŒ‡å‘æ–°æ ‘
   åŸæ¥çš„ current æ ‘å˜æˆäº†ä¸‹æ¬¡æ›´æ–°çš„ alternate

   // Commit å®Œæˆå
   fiberRoot.current = finishedWork;  // finishedWork æ˜¯ workInProgress æ ‘çš„æ ¹

   // è¿™æ ·ï¼š
   // - åŸ workInProgress å˜æˆæ–°çš„ currentï¼ˆæ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰
   // - åŸ current å˜æˆæ–°çš„ alternateï¼ˆç­‰å¾…ä¸‹æ¬¡å¤ç”¨ï¼‰
`;

// ============================================================
// Part 3: åˆæ¬¡æ¸²æŸ“ vs æ›´æ–°æ¸²æŸ“
// ============================================================

/**
 * ğŸ“Š ä¸¤ç§æ¸²æŸ“åœºæ™¯çš„å¯¹æ¯”
 */

const mountVsUpdate = `
ğŸ“Š åˆæ¬¡æ¸²æŸ“ vs æ›´æ–°æ¸²æŸ“

åˆæ¬¡æ¸²æŸ“ï¼ˆMountï¼‰:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   createRoot(container).render(<App />)                                     â”‚
â”‚                                                                             â”‚
â”‚   Step 1: åˆ›å»ºæ ¹èŠ‚ç‚¹                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚  FiberRoot      â”‚                                                       â”‚
â”‚   â”‚  current: â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶ HostRoot Fiber (alternate: null)                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                             â”‚
â”‚   æ­¤æ—¶åªæœ‰ä¸€æ£µæ ‘ï¼ˆå‡†ç¡®è¯´åªæœ‰æ ¹èŠ‚ç‚¹ï¼‰ï¼Œè¿˜æ²¡æœ‰ alternate                      â”‚
â”‚                                                                             â”‚
â”‚                                                                             â”‚
â”‚   Step 2: å¼€å§‹ Render é˜¶æ®µ                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                             â”‚
â”‚   // ä¸º HostRoot åˆ›å»º workInProgress                                        â”‚
â”‚   workInProgress = createWorkInProgress(current, pendingProps);             â”‚
â”‚   // å› ä¸º alternate === nullï¼Œä¼šåˆ›å»ºæ–°çš„ Fiber                              â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚  FiberRoot      â”‚                                                       â”‚
â”‚   â”‚  current: â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶ HostRoot â—„â”€â”€alternateâ”€â”€â–¶ HostRoot (wip)          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                             â”‚
â”‚   ç„¶åå‘ä¸‹æ„å»ºæ•´æ£µ workInProgress æ ‘...                                     â”‚
â”‚                                                                             â”‚
â”‚                                                                             â”‚
â”‚   Step 3: Render å®Œæˆå                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                             â”‚
â”‚      current æ ‘                     workInProgress æ ‘                       â”‚
â”‚      (åªæœ‰æ ¹)                       (å®Œæ•´çš„æ ‘)                              â”‚
â”‚                                                                             â”‚
â”‚      HostRoot â—„â”€â”€â”€alternateâ”€â”€â”€â–¶ HostRoot                                    â”‚
â”‚         â”‚                           â”‚                                       â”‚
â”‚         â”‚                           â”‚ child                                 â”‚
â”‚         â”‚                           â–¼                                       â”‚
â”‚        null                      App Fiber                                  â”‚
â”‚                                     â”‚                                       â”‚
â”‚                                     â–¼                                       â”‚
â”‚                                  div Fiber                                  â”‚
â”‚                                     â”‚                                       â”‚
â”‚                                    ...                                      â”‚
â”‚                                                                             â”‚
â”‚                                                                             â”‚
â”‚   Step 4: Commit å                                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                             â”‚
â”‚   fiberRoot.current = workInProgress æ ‘çš„æ ¹                                 â”‚
â”‚                                                                             â”‚
â”‚   ç°åœ¨ workInProgress æ ‘å˜æˆäº† current æ ‘                                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ›´æ–°æ¸²æŸ“ï¼ˆUpdateï¼‰:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å‡è®¾è§¦å‘äº†ä¸€æ¬¡ setState æ›´æ–°

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 1: æ›´æ–°å‰çš„çŠ¶æ€                                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                             â”‚
â”‚   ä¸Šæ¬¡æ¸²æŸ“åï¼Œcurrent æ˜¯å®Œæ•´çš„æ ‘                                            â”‚
â”‚   æ¯ä¸ª current Fiber çš„ alternate æŒ‡å‘ä¸Šæ¬¡çš„ workInProgress Fiber           â”‚
â”‚                                                                             â”‚
â”‚      current æ ‘                      alternateï¼ˆä¸Šæ¬¡çš„ wipï¼‰               â”‚
â”‚                                                                             â”‚
â”‚      HostRoot â—„â”€â”€â”€alternateâ”€â”€â”€â–¶ HostRoot                                    â”‚
â”‚         â”‚                           â”‚                                       â”‚
â”‚         â–¼                           â–¼                                       â”‚
â”‚      App â—„â”€â”€â”€â”€â”€alternateâ”€â”€â”€â”€â”€â–¶ App                                          â”‚
â”‚         â”‚                           â”‚                                       â”‚
â”‚         â–¼                           â–¼                                       â”‚
â”‚      div â—„â”€â”€â”€â”€â”€alternateâ”€â”€â”€â”€â”€â–¶ div                                          â”‚
â”‚                                                                             â”‚
â”‚                                                                             â”‚
â”‚   Step 2: å¼€å§‹æ–°çš„ Render                                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                             â”‚
â”‚   createWorkInProgress(current, pendingProps):                              â”‚
â”‚   - current.alternate å­˜åœ¨ï¼                                                â”‚
â”‚   - å¤ç”¨å®ƒä½œä¸ºæ–°çš„ workInProgress                                           â”‚
â”‚   - æ›´æ–°å…¶å±æ€§ï¼ˆpendingProps, flags ç­‰ï¼‰                                    â”‚
â”‚                                                                             â”‚
â”‚      current æ ‘                   æ–°çš„ workInProgress æ ‘                    â”‚
â”‚      (æ˜¾ç¤ºä¸­)                     (å¤ç”¨ alternate)                          â”‚
â”‚                                                                             â”‚
â”‚      HostRoot â—„â”€â”€â”€alternateâ”€â”€â”€â–¶ HostRoot                                    â”‚
â”‚         â”‚                           â”‚                                       â”‚
â”‚         â”‚                           â”‚ å¤ç”¨ + æ›´æ–°å±æ€§                       â”‚
â”‚         â–¼                           â–¼                                       â”‚
â”‚      App â—„â”€â”€â”€â”€â”€alternateâ”€â”€â”€â”€â”€â–¶ App (æ›´æ–° pendingProps)                      â”‚
â”‚         â”‚                           â”‚                                       â”‚
â”‚         â–¼                           â–¼                                       â”‚
â”‚      div â—„â”€â”€â”€â”€â”€alternateâ”€â”€â”€â”€â”€â–¶ div                                          â”‚
â”‚                                                                             â”‚
â”‚                                                                             â”‚
â”‚   Step 3: Commit å                                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                             â”‚
â”‚   fiberRoot.current = æ–°çš„ workInProgress æ ¹                                â”‚
â”‚                                                                             â”‚
â”‚   è§’è‰²äº¤æ¢ï¼š                                                                â”‚
â”‚   - åŸ workInProgress â†’ æ–°çš„ currentï¼ˆæ˜¾ç¤ºï¼‰                                â”‚
â”‚   - åŸ current â†’ æ–°çš„ alternateï¼ˆç­‰å¾…ä¸‹æ¬¡å¤ç”¨ï¼‰                             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 4: createWorkInProgress æºç åˆ†æ
// ============================================================

/**
 * ğŸ“Š createWorkInProgress æ ¸å¿ƒé€»è¾‘
 */

const createWorkInProgressAnalysis = `
ğŸ“Š createWorkInProgress æºç åˆ†æ

ğŸ“ packages/react-reconciler/src/ReactFiber.new.js (Line 249-352)

// æ ¸å¿ƒå‡½æ•°ï¼šä¸º current Fiber åˆ›å»º/å¤ç”¨ workInProgress
export function createWorkInProgress(current: Fiber, pendingProps: any): Fiber {
  let workInProgress = current.alternate;

  // ========== åˆ†æ”¯ 1ï¼šé¦–æ¬¡æ¸²æŸ“ï¼Œalternate ä¸å­˜åœ¨ ==========
  if (workInProgress === null) {
    // åˆ›å»ºæ–°çš„ Fiber
    workInProgress = createFiber(
      current.tag,
      pendingProps,
      current.key,
      current.mode,
    );

    // å¤åˆ¶ Instance ç›¸å…³å­—æ®µ
    workInProgress.elementType = current.elementType;
    workInProgress.type = current.type;
    workInProgress.stateNode = current.stateNode;  // å…±äº« DOM èŠ‚ç‚¹

    // å»ºç«‹åŒå‘å¼•ç”¨
    workInProgress.alternate = current;
    current.alternate = workInProgress;
  }
  // ========== åˆ†æ”¯ 2ï¼šæ›´æ–°æ¸²æŸ“ï¼Œå¤ç”¨ alternate ==========
  else {
    // æ›´æ–° props
    workInProgress.pendingProps = pendingProps;
    workInProgress.type = current.type;

    // é‡ç½®å‰¯ä½œç”¨ï¼ˆè¿™æ˜¯æ–°ä¸€è½®æ¸²æŸ“ï¼‰
    workInProgress.flags = NoFlags;
    workInProgress.subtreeFlags = NoFlags;
    workInProgress.deletions = null;
  }

  // ========== å…¬å…±éƒ¨åˆ†ï¼šå¤åˆ¶éœ€è¦çš„å­—æ®µ ==========

  // å¤åˆ¶ Lane ç›¸å…³
  workInProgress.flags = current.flags & StaticMask;  // ä¿ç•™é™æ€ flags
  workInProgress.childLanes = current.childLanes;
  workInProgress.lanes = current.lanes;

  // å¤åˆ¶æ ‘å…³ç³»ï¼ˆåç»­ä¼šè¢«æ›´æ–°ï¼‰
  workInProgress.child = current.child;
  workInProgress.sibling = current.sibling;
  workInProgress.index = current.index;
  workInProgress.ref = current.ref;

  // å¤åˆ¶çŠ¶æ€
  workInProgress.memoizedProps = current.memoizedProps;
  workInProgress.memoizedState = current.memoizedState;
  workInProgress.updateQueue = current.updateQueue;

  // å¤åˆ¶ Context ä¾èµ–
  workInProgress.dependencies = current.dependencies === null
    ? null
    : { lanes: current.dependencies.lanes,
        firstContext: current.dependencies.firstContext };

  return workInProgress;
}


å…³é”®ç‚¹æ€»ç»“:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒ…å†µ                      â”‚ è¡Œä¸º                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ alternate === null        â”‚ åˆ›å»ºæ–° Fiberï¼Œå»ºç«‹åŒå‘ alternate å¼•ç”¨           â”‚
â”‚ alternate !== null        â”‚ å¤ç”¨å·²æœ‰ Fiberï¼Œé‡ç½® flagsï¼Œæ›´æ–°å±æ€§            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ stateNode                 â”‚ å…±äº«ï¼current å’Œ wip æŒ‡å‘åŒä¸€ä¸ª DOM èŠ‚ç‚¹       â”‚
â”‚ memoizedState            â”‚ å¤åˆ¶å¼•ç”¨ï¼ŒHooks é“¾è¡¨è¢«å…±äº«                       â”‚
â”‚ child                    â”‚ å…ˆå¤åˆ¶ï¼Œåç»­ reconcile æ—¶å¯èƒ½æ›´æ–°                â”‚
â”‚ flags                    â”‚ é‡ç½®ï¼ˆæ–°ä¸€è½®æ¸²æŸ“ï¼Œå‰¯ä½œç”¨é‡æ–°è®¡ç®—ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 5: Commit é˜¶æ®µçš„æ ‘äº¤æ¢
// ============================================================

/**
 * ğŸ“Š Commit åçš„æ ‘äº¤æ¢
 */

const commitPhaseSwap = `
ğŸ“Š Commit é˜¶æ®µçš„æ ‘äº¤æ¢

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Commit å®Œæˆåçš„å…³é”®æ“ä½œ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   ğŸ“ packages/react-reconciler/src/ReactFiberWorkLoop.new.js               â”‚
â”‚                                                                             â”‚
â”‚   function commitRootImpl(root, ...) {                                      â”‚
â”‚     // ... Commit çš„ä¸‰ä¸ªé˜¶æ®µï¼š                                              â”‚
â”‚     //   - commitBeforeMutationEffects                                      â”‚
â”‚     //   - commitMutationEffects                                            â”‚
â”‚     //   - commitLayoutEffects                                              â”‚
â”‚                                                                             â”‚
â”‚     // â­ å…³é”®ä¸€è¡Œï¼šäº¤æ¢ current æŒ‡é’ˆ                                       â”‚
â”‚     root.current = finishedWork;                                            â”‚
â”‚                                                                             â”‚
â”‚     // finishedWork å°±æ˜¯ workInProgress æ ‘çš„æ ¹èŠ‚ç‚¹                          â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤æ¢è¿‡ç¨‹å›¾ç¤º:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Commit å‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FiberRoot     â”‚
â”‚   current: â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶  current æ ‘ï¼ˆæ˜¾ç¤ºä¸­ï¼‰
â”‚                 â”‚              â†• alternate
â”‚                 â”‚      workInProgress æ ‘ï¼ˆå‡†å¤‡å¥½äº†ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Commit åï¼ˆåªæ”¹ä¸€ä¸ªæŒ‡é’ˆï¼ï¼‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FiberRoot     â”‚
â”‚   current: â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶  åŸ workInProgress æ ‘ï¼ˆç°åœ¨æ˜¾ç¤ºï¼‰
â”‚                 â”‚              â†• alternate
â”‚                 â”‚      åŸ current æ ‘ï¼ˆç°åœ¨æ˜¯ alternateï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â­ äº¤æ¢çš„å¼€é”€æå°ï¼šåªæ˜¯æ”¹å˜ root.current çš„æŒ‡å‘

ä¸‹æ¬¡æ›´æ–°æ—¶:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

createWorkInProgress ä¼šå¤ç”¨åŸ current æ ‘ï¼ˆç°åœ¨çš„ alternateï¼‰
æŠŠå®ƒå˜æˆæ–°çš„ workInProgress æ ‘
`;

// ============================================================
// Part 6: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 4 é¢è¯•è¦ç‚¹

Q1: ä»€ä¹ˆæ˜¯ React çš„åŒç¼“å­˜ï¼Ÿ
A: React ç»´æŠ¤ä¸¤æ£µ Fiber æ ‘ï¼š
   - current æ ‘ï¼šå½“å‰å±å¹•æ˜¾ç¤ºçš„ UI
   - workInProgress æ ‘ï¼šå†…å­˜ä¸­æ„å»ºçš„æ–° UI
   é€šè¿‡ alternate æŒ‡é’ˆäº’ç›¸å…³è”ã€‚
   Commit åäº¤æ¢è§’è‰²ï¼Œå®ç°æ— é—ªçƒæ›´æ–°ã€‚

Q2: alternate å­—æ®µçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
A: ä¸‰ä¸ªä½œç”¨ï¼š
   1. è¿æ¥ä¸¤æ£µæ ‘ä¸Šå¯¹åº”ä½ç½®çš„ Fiber
   2. å¤ç”¨ Fiber å¯¹è±¡ï¼šæ›´æ–°æ—¶ä¸åˆ›å»ºæ–° Fiberï¼Œå¤ç”¨ alternate
   3. æ¯”è¾ƒæ–°æ—§çŠ¶æ€ï¼šé€šè¿‡ alternate è®¿é—®å½“å‰æ˜¾ç¤ºçš„ props/state

Q3: current å’Œ workInProgress æ˜¯å¦‚ä½•äº¤æ¢çš„ï¼Ÿ
A: Commit é˜¶æ®µå®Œæˆåï¼Œæ‰§è¡Œï¼š
   root.current = finishedWork;
   è¿™ä¸€è¡Œå°±å®Œæˆäº†äº¤æ¢ã€‚åŸ workInProgress å˜æˆæ–° currentï¼Œ
   åŸ current å˜æˆä¸‹æ¬¡æ›´æ–°çš„ alternateã€‚

Q4: ä¸ºä»€ä¹ˆè¦ç”¨åŒç¼“å­˜ï¼Ÿ
A: 1. é¿å… UI é—ªçƒï¼šç”¨æˆ·åªçœ‹åˆ°å®Œæ•´çš„ UIï¼Œä¸ä¼šçœ‹åˆ°åŠæˆå“
   2. å¤ç”¨ Fiberï¼šå‡å°‘å¯¹è±¡åˆ›å»ºï¼Œæé«˜æ€§èƒ½
   3. æ”¯æŒä¸­æ–­ï¼šworkInProgress æ ‘å¯ä»¥éšæ—¶ä¸¢å¼ƒé‡å»º

Q5: åˆæ¬¡æ¸²æŸ“å’Œæ›´æ–°æ¸²æŸ“æ—¶ï¼ŒcreateWorkInProgress æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ
A: - åˆæ¬¡æ¸²æŸ“ï¼šalternate === nullï¼Œåˆ›å»ºæ–° Fiber
   - æ›´æ–°æ¸²æŸ“ï¼šalternate å­˜åœ¨ï¼Œå¤ç”¨å®ƒï¼Œåªæ›´æ–°å±æ€§
   ä¸¤ç§æƒ…å†µéƒ½ä¼šå¤åˆ¶ memoizedStateã€child ç­‰å­—æ®µ

Q6: stateNode åœ¨ current å’Œ workInProgress ä¹‹é—´æ˜¯å…±äº«çš„å—ï¼Ÿ
A: æ˜¯çš„ï¼stateNodeï¼ˆDOM èŠ‚ç‚¹ï¼‰æ˜¯å…±äº«çš„ã€‚
   è¿™æ˜¯å› ä¸ºçœŸå® DOM åªæœ‰ä¸€ä»½ï¼Œä¸¤æ£µæ ‘éƒ½æŒ‡å‘åŒä¸€ä¸ª DOMã€‚
   æ›´æ–°æ—¶ä¿®æ”¹çš„æ˜¯ props/stateï¼ŒDOM åœ¨ Commit é˜¶æ®µæ‰æ›´æ–°ã€‚
`;

export {
  doubleBufferingConcept,
  alternateExplanation,
  mountVsUpdate,
  createWorkInProgressAnalysis,
  commitPhaseSwap,
  interviewPoints,
};

