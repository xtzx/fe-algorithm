/**
 * ============================================================
 * ğŸ“š Phase 11: SSR & Hydration - Part 3: Hydration æµç¨‹ä¸ DOM åŒ¹é…
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-dom/src/client/ReactDOMRoot.js (hydrateRoot)
 * - packages/react-reconciler/src/ReactFiberHydrationContext.new.js
 * - packages/react-dom/src/client/ReactDOMHostConfig.js
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š2-3 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­
 */

// ============================================================
// Part 1: Hydration çš„å…¥å£
// ============================================================

/**
 * ğŸ“Š hydrateRoot å…¥å£
 */

const hydrateRootEntry = `
ğŸ“Š hydrateRoot - Hydration çš„å…¥å£

æºç ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js (Line 255)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function hydrateRoot(
  container: Document | Element,
  initialChildren: ReactNodeList,
  options?: HydrateRootOptions,
): RootType {
  // 1. éªŒè¯å®¹å™¨
  if (!isValidContainer(container)) {
    throw new Error('hydrateRoot(...): Target container is not a DOM element.');
  }

  // 2. å¤„ç† options
  const hydrationCallbacks = options != null ? options : null;
  // ...

  // 3. â­ åˆ›å»º Hydration å®¹å™¨ï¼ˆä¸ createRoot çš„å…³é”®åŒºåˆ«ï¼‰
  const root = createHydrationContainer(
    initialChildren,
    null,
    container,
    ConcurrentRoot,
    hydrationCallbacks,
    // ...
  );

  // 4. æ ‡è®°å®¹å™¨
  markContainerAsRoot(root.current, container);

  // 5. â­ ç»‘å®šäº‹ä»¶ç›‘å¬ï¼ˆå§”æ‰˜åˆ°æ ¹å®¹å™¨ï¼‰
  listenToAllSupportedEvents(container);

  return new ReactDOMHydrationRoot(root);
}


createHydrationContainer vs createContainer
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                            â”‚
â”‚   createContainer (createRoot ä½¿ç”¨):                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚   â€¢ FiberRoot.hydrate = false                                              â”‚
â”‚   â€¢ æ¸²æŸ“æ—¶ä¼šåˆ›å»ºæ–°çš„ DOM èŠ‚ç‚¹                                              â”‚
â”‚                                                                            â”‚
â”‚   createHydrationContainer (hydrateRoot ä½¿ç”¨):                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚   â€¢ FiberRoot.hydrate = true                                               â”‚
â”‚   â€¢ â­ å¼€å¯ hydration æ¨¡å¼                                                 â”‚
â”‚   â€¢ æ¸²æŸ“æ—¶ä¼šå°è¯•å¤ç”¨å·²æœ‰ DOM èŠ‚ç‚¹                                          â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 2: HydrationContext - Hydration çŠ¶æ€ç®¡ç†
// ============================================================

/**
 * ğŸ“Š ReactFiberHydrationContext
 */

const hydrationContext = `
ğŸ“Š ReactFiberHydrationContext - Hydration çŠ¶æ€ç®¡ç†

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberHydrationContext.new.js
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ ¸å¿ƒçŠ¶æ€å˜é‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// å½“å‰æ­£åœ¨ hydrate çš„çˆ¶ Fiber
let hydrationParentFiber: null | Fiber = null;

// ä¸‹ä¸€ä¸ªå¯ä»¥ hydrate çš„ DOM èŠ‚ç‚¹
let nextHydratableInstance: null | HydratableInstance = null;

// æ˜¯å¦å¤„äº hydrating çŠ¶æ€
let isHydrating: boolean = false;


æ ¸å¿ƒå‡½æ•°æ¦‚è§ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‡½æ•°                            â”‚ èŒè´£                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ enterHydrationState             â”‚ è¿›å…¥ hydration çŠ¶æ€                        â”‚
â”‚                                 â”‚ è·å–å®¹å™¨å†…ç¬¬ä¸€ä¸ªå¯ hydrate çš„å­èŠ‚ç‚¹        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tryToClaimNextHydratableInstanceâ”‚ å°è¯•åŒ¹é…å½“å‰ Fiber ä¸ DOM èŠ‚ç‚¹             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ prepareToHydrateHostInstance    â”‚ å‡†å¤‡ hydrate ä¸€ä¸ª Host å®ä¾‹                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ popHydrationState               â”‚ å®Œæˆå½“å‰èŠ‚ç‚¹çš„ hydrationï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ resetHydrationState             â”‚ é‡ç½® hydration çŠ¶æ€                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


enterHydrationState - è¿›å…¥ Hydration çŠ¶æ€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function enterHydrationState(fiber: Fiber): boolean {
  if (!supportsHydration) {
    return false;
  }

  // è·å–å®¹å™¨ DOM èŠ‚ç‚¹
  const parentInstance: Container = fiber.stateNode.containerInfo;

  // â­ è·å–å®¹å™¨å†…ç¬¬ä¸€ä¸ªå¯ hydrate çš„å­èŠ‚ç‚¹
  nextHydratableInstance = getFirstHydratableChildWithinContainer(parentInstance);

  hydrationParentFiber = fiber;
  isHydrating = true;

  return true;
}


tryToClaimNextHydratableInstance - å°è¯•åŒ¹é…
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function tryToClaimNextHydratableInstance(fiber: Fiber): void {
  if (!isHydrating) return;

  // è·å–ä¸‹ä¸€ä¸ªå¯ hydrate çš„ DOM èŠ‚ç‚¹
  let nextInstance = nextHydratableInstance;

  if (nextInstance === null) {
    // æ²¡æœ‰å¯å¤ç”¨çš„ DOM èŠ‚ç‚¹äº†
    // æ ‡è®°éœ€è¦æ’å…¥æ–°èŠ‚ç‚¹
    insertNonHydratedInstance(hydrationParentFiber, fiber);
    isHydrating = false;
    return;
  }

  // å°è¯•åŒ¹é…
  const type = fiber.type;
  const props = fiber.pendingProps;

  if (canHydrateInstance(nextInstance, type, props)) {
    // â­ åŒ¹é…æˆåŠŸï¼å¤ç”¨ DOM èŠ‚ç‚¹
    fiber.stateNode = nextInstance;
    hydrationParentFiber = fiber;
    nextHydratableInstance = getFirstHydratableChild(nextInstance);
  } else {
    // åŒ¹é…å¤±è´¥
    // å°è¯•ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œæˆ–è€…åˆ›å»ºæ–°èŠ‚ç‚¹
    // ...
  }
}
`;

// ============================================================
// Part 3: DOM åŒ¹é…ä¸å¤ç”¨
// ============================================================

/**
 * ğŸ“Š DOM åŒ¹é…é€»è¾‘
 */

const domMatching = `
ğŸ“Š DOM åŒ¹é…ä¸å¤ç”¨

åŒ¹é…åˆ¤æ–­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æºç ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js

canHydrateInstance(instance, type, props): boolean {
  // æ£€æŸ¥ DOM èŠ‚ç‚¹ç±»å‹æ˜¯å¦åŒ¹é…
  if (instance.nodeType !== ELEMENT_NODE) {
    return false;
  }

  // æ£€æŸ¥æ ‡ç­¾åæ˜¯å¦åŒ¹é…
  if (instance.nodeName.toLowerCase() !== type.toLowerCase()) {
    return false;
  }

  return true;
}

canHydrateTextInstance(instance, text): boolean {
  // æ–‡æœ¬èŠ‚ç‚¹åŒ¹é…
  if (text === '' || instance.nodeType !== TEXT_NODE) {
    return false;
  }
  return true;
}


åŒ¹é…æˆåŠŸï¼šå¤ç”¨ DOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   å½“åŒ¹é…æˆåŠŸæ—¶:                                                             â”‚
â”‚                                                                             â”‚
â”‚   1. fiber.stateNode = domInstance                                          â”‚
â”‚      â€¢ å°†å·²æœ‰ DOM èŠ‚ç‚¹å…³è”åˆ° Fiber                                          â”‚
â”‚                                                                             â”‚
â”‚   2. hydrateInstance(instance, type, props)                                 â”‚
â”‚      â€¢ å¯¹æ¯” propsï¼Œæ ‡è®°éœ€è¦æ›´æ–°çš„å±æ€§                                       â”‚
â”‚      â€¢ å¦‚æœå±æ€§æœ‰å·®å¼‚ï¼Œæ ‡è®° Update flag                                     â”‚
â”‚                                                                             â”‚
â”‚   3. ç»§ç»­å¤„ç†å­èŠ‚ç‚¹                                                         â”‚
â”‚      â€¢ nextHydratableInstance = getFirstHydratableChild(instance)           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


åŒ¹é…å¤±è´¥ï¼šMismatch å¤„ç†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   å½“åŒ¹é…å¤±è´¥æ—¶ï¼ˆHydration Mismatchï¼‰:                                       â”‚
â”‚                                                                             â”‚
â”‚   1. å¼€å‘ç¯å¢ƒä¼šå‘å‡ºè­¦å‘Š                                                     â”‚
â”‚      "Warning: Expected server HTML to contain a matching <div> in <div>."  â”‚
â”‚                                                                             â”‚
â”‚   2. å¤„ç†ç­–ç•¥:                                                              â”‚
â”‚      â€¢ å°è¯•åˆ é™¤ä¸åŒ¹é…çš„æœåŠ¡ç«¯ DOM                                           â”‚
â”‚      â€¢ åœ¨å®¢æˆ·ç«¯é‡æ–°åˆ›å»ºæ­£ç¡®çš„ DOM                                           â”‚
â”‚      â€¢ è¿™ä¼šå¯¼è‡´æ€§èƒ½æŸå¤±ï¼Œåº”å°½é‡é¿å…                                         â”‚
â”‚                                                                             â”‚
â”‚   3. å¸¸è§å¯¼è‡´ Mismatch çš„åŸå› :                                              â”‚
â”‚      â€¢ æœåŠ¡ç«¯/å®¢æˆ·ç«¯æ¸²æŸ“ä¸åŒå†…å®¹ï¼ˆå¦‚åŸºäºæ—¶é—´ã€éšæœºæ•°ï¼‰                      â”‚
â”‚      â€¢ æµè§ˆå™¨è‡ªåŠ¨è¡¥å…¨æ ‡ç­¾ï¼ˆå¦‚ <table> è‡ªåŠ¨æ·»åŠ  <tbody>ï¼‰                    â”‚
â”‚      â€¢ ä½¿ç”¨äº†ä»…å®¢æˆ·ç«¯çš„ APIï¼ˆå¦‚ window, localStorageï¼‰                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


hydrateInstance - å¯¹æ¯”å’Œæ›´æ–°å±æ€§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function hydrateInstance(
  instance: Instance,
  type: string,
  props: Props,
  rootContainerInstance: Container,
  hostContext: HostContext,
  internalInstanceHandle: Object,
): null | Array<mixed> {
  // å°† Fiber å…³è”åˆ° DOM èŠ‚ç‚¹
  precacheFiberNode(internalInstanceHandle, instance);

  // æ›´æ–° props
  updateFiberProps(instance, props);

  // å¯¹æ¯”æœåŠ¡ç«¯æ¸²æŸ“çš„å±æ€§å’Œå®¢æˆ·ç«¯ props
  // è¿”å›éœ€è¦æ›´æ–°çš„å±æ€§åˆ—è¡¨
  return diffHydratedProperties(
    instance,
    type,
    props,
    rootContainerInstance,
    hostContext,
  );
}
`;

// ============================================================
// Part 4: äº‹ä»¶ç»‘å®šæ—¶æœº
// ============================================================

/**
 * ğŸ“Š äº‹ä»¶ç»‘å®šæ—¶æœº
 */

const eventBinding = `
ğŸ“Š Hydration è¿‡ç¨‹ä¸­çš„äº‹ä»¶ç»‘å®š

äº‹ä»¶å§”æ‰˜æœºåˆ¶å›é¡¾ï¼ˆPhase 8ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

React ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œæ‰€æœ‰äº‹ä»¶éƒ½ç»‘å®šåœ¨æ ¹å®¹å™¨ä¸Šï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   <div id="root">                    â† äº‹ä»¶ç›‘å¬ç»‘å®šåœ¨è¿™é‡Œ                   â”‚
â”‚     <button onClick={...}>           â† ä¸åœ¨è¿™é‡Œç»‘å®š                         â”‚
â”‚       Click                                                                 â”‚
â”‚     </button>                                                               â”‚
â”‚   </div>                                                                    â”‚
â”‚                                                                             â”‚
â”‚   å½“ç‚¹å‡» button æ—¶ï¼š                                                        â”‚
â”‚   1. åŸç”Ÿäº‹ä»¶å†’æ³¡åˆ° root                                                    â”‚
â”‚   2. React æ•è·äº‹ä»¶                                                         â”‚
â”‚   3. æ ¹æ® event.target æ‰¾åˆ°å¯¹åº” Fiber                                       â”‚
â”‚   4. æ‰§è¡Œ Fiber ä¸Šçš„ onClick                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Hydration æ—¶çš„äº‹ä»¶ç»‘å®š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// hydrateRoot ä¸­çš„å…³é”®ä»£ç 
export function hydrateRoot(container, initialChildren, options) {
  // ...

  // â­ ç»‘å®šäº‹ä»¶ç›‘å¬åˆ°å®¹å™¨
  // è¿™æ˜¯åœ¨ hydration å¼€å§‹ä¹‹å‰å°±æ‰§è¡Œçš„ï¼
  listenToAllSupportedEvents(container);

  // ...
}

listenToAllSupportedEvents ä¼šï¼š
1. åœ¨å®¹å™¨ä¸Šæ³¨å†Œæ‰€æœ‰æ”¯æŒçš„åŸç”Ÿäº‹ä»¶ç›‘å¬å™¨
2. è¿™äº›ç›‘å¬å™¨ä¼šå°†äº‹ä»¶åˆ†å‘ç»™ React çš„äº‹ä»¶ç³»ç»Ÿ
3. å³ä½¿åœ¨ hydration è¿‡ç¨‹ä¸­ï¼Œäº‹ä»¶ä¹Ÿå¯ä»¥è¢«å“åº”


äº‹ä»¶ç”Ÿæ•ˆçš„æ—¶æœº
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   æ—¶é—´çº¿:                                                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                                                             â”‚
â”‚   T1: HTML åˆ°è¾¾æµè§ˆå™¨ï¼Œæ˜¾ç¤ºå†…å®¹                                             â”‚
â”‚       â€¢ ç”¨æˆ·å¯è§                                                            â”‚
â”‚       â€¢ ä½†ç‚¹å‡»æ— ååº”ï¼ˆæ²¡æœ‰ Fiber æ ‘ï¼‰                                       â”‚
â”‚                                                                             â”‚
â”‚   T2: hydrateRoot è°ƒç”¨ï¼Œäº‹ä»¶ç›‘å¬ç»‘å®šåˆ° root                                 â”‚
â”‚       â€¢ åŸç”Ÿäº‹ä»¶å¯ä»¥è¢« React æ•è·                                           â”‚
â”‚       â€¢ ä½†è¿˜æ²¡æœ‰ Fiber æ ‘ï¼Œæ— æ³•æ‰¾åˆ°å¤„ç†å‡½æ•°                                 â”‚
â”‚                                                                             â”‚
â”‚   T3: Hydration è¿›è¡Œä¸­ï¼ŒFiber æ ‘é€æ­¥æ„å»º                                    â”‚
â”‚       â€¢ DOM èŠ‚ç‚¹é€ä¸ªä¸ Fiber å…³è”                                           â”‚
â”‚       â€¢ å·²å…³è”çš„èŠ‚ç‚¹å¯ä»¥å“åº”äº‹ä»¶                                            â”‚
â”‚                                                                             â”‚
â”‚   T4: Hydration å®Œæˆ                                                        â”‚
â”‚       â€¢ æ‰€æœ‰ DOM èŠ‚ç‚¹éƒ½ä¸ Fiber å…³è”                                        â”‚
â”‚       â€¢ äº‹ä»¶å¤„ç†å®Œå…¨å¯ç”¨                                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ—©æœŸç‚¹å‡»å¤„ç† - Selective Hydration
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

React 18 çš„ Selective Hydration å¯ä»¥ä¼˜å…ˆ hydrate ç”¨æˆ·æ­£åœ¨äº¤äº’çš„éƒ¨åˆ†ï¼š

// å¦‚æœç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªåŒºåŸŸï¼ŒReact ä¼šï¼š
// 1. è®°å½•è¿™ä¸ªäº¤äº’
// 2. ä¼˜å…ˆ hydrate è¿™ä¸ªåŒºåŸŸ
// 3. ç„¶åé‡æ”¾äº‹ä»¶

queueExplicitHydrationTarget(target);
`;

// ============================================================
// Part 5: æ¡ˆä¾‹ - å®Œæ•´ Hydration æµç¨‹
// ============================================================

/**
 * ğŸ“Š æ¡ˆä¾‹: å®Œæ•´ Hydration æµç¨‹
 */

const hydrationCase = `
ğŸ“Š æ¡ˆä¾‹ A: å®Œæ•´ Hydration æµç¨‹

SSR è¾“å‡ºçš„ HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

<div id="root">
  <header>
    <h1>My App</h1>
  </header>
  <main>
    <button>Click me</button>
  </main>
</div>


å®¢æˆ·ç«¯ä»£ç 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import { hydrateRoot } from 'react-dom/client';

function App() {
  const handleClick = () => alert('Clicked!');

  return (
    <div id="root">
      <header>
        <h1>My App</h1>
      </header>
      <main>
        <button onClick={handleClick}>Click me</button>
      </main>
    </div>
  );
}

hydrateRoot(document.getElementById('root'), <App />);


Hydration è¯¦ç»†æ­¥éª¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   Step 1: hydrateRoot è°ƒç”¨                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚   â€¢ createHydrationContainer åˆ›å»º FiberRootï¼ˆhydrate = trueï¼‰              â”‚
â”‚   â€¢ listenToAllSupportedEvents ç»‘å®šäº‹ä»¶                                     â”‚
â”‚   â€¢ updateContainer è§¦å‘é¦–æ¬¡æ¸²æŸ“                                            â”‚
â”‚                                                                             â”‚
â”‚   Step 2: è¿›å…¥ Hydration çŠ¶æ€                                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚   â€¢ enterHydrationState(HostRoot Fiber)                                     â”‚
â”‚   â€¢ nextHydratableInstance = <div id="root">                                â”‚
â”‚                                                                             â”‚
â”‚   Step 3: beginWork(App)                                                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚   â€¢ æ‰§è¡Œ App()                                                              â”‚
â”‚   â€¢ è¿”å› div å…ƒç´                                                            â”‚
â”‚   â€¢ tryToClaimNextHydratableInstance                                        â”‚
â”‚     - canHydrateInstance(<div id="root">, 'div') â†’ true                    â”‚
â”‚     - å¤ç”¨ï¼fiber.stateNode = <div id="root">                              â”‚
â”‚                                                                             â”‚
â”‚   Step 4: beginWork(header)                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚   â€¢ nextHydratableInstance = <header>                                       â”‚
â”‚   â€¢ canHydrateInstance(<header>, 'header') â†’ true                          â”‚
â”‚   â€¢ å¤ç”¨ï¼                                                                  â”‚
â”‚                                                                             â”‚
â”‚   Step 5: beginWork(h1)                                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     â”‚
â”‚   â€¢ nextHydratableInstance = <h1>                                           â”‚
â”‚   â€¢ canHydrateInstance(<h1>, 'h1') â†’ true                                  â”‚
â”‚   â€¢ å¤ç”¨ï¼                                                                  â”‚
â”‚                                                                             â”‚
â”‚   Step 6: beginWork(main) & beginWork(button)                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚   â€¢ åŒæ ·çš„åŒ¹é…å’Œå¤ç”¨è¿‡ç¨‹                                                    â”‚
â”‚   â€¢ button Fiber å…³è”åˆ° <button> DOM                                        â”‚
â”‚   â€¢ onClick={handleClick} å­˜å‚¨åœ¨ Fiber ä¸Š                                   â”‚
â”‚                                                                             â”‚
â”‚   Step 7: completeWork é˜¶æ®µ                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚   â€¢ è°ƒç”¨ hydrateInstance å¯¹æ¯”å±æ€§                                           â”‚
â”‚   â€¢ å¦‚æœæœ‰å·®å¼‚ï¼Œæ ‡è®° Update flag                                            â”‚
â”‚                                                                             â”‚
â”‚   Step 8: Commit é˜¶æ®µ                                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚   â€¢ å¤„ç†ä»»ä½•éœ€è¦æ›´æ–°çš„å±æ€§                                                  â”‚
â”‚   â€¢ Hydration å®Œæˆï¼                                                        â”‚
â”‚                                                                             â”‚
â”‚   Step 9: äº‹ä»¶å¯ç”¨                                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   â€¢ ç‚¹å‡» button                                                             â”‚
â”‚   â€¢ åŸç”Ÿäº‹ä»¶å†’æ³¡åˆ° root                                                     â”‚
â”‚   â€¢ React æ‰¾åˆ° button Fiber                                                 â”‚
â”‚   â€¢ æ‰§è¡Œ handleClick â†’ alert('Clicked!')                                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 6: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 3 é¢è¯•è¦ç‚¹

Q1: hydrateRoot å’Œ createRoot çš„å†…éƒ¨åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
A: - createRoot: åˆ›å»º FiberRoot æ—¶ hydrate = falseï¼Œæ¸²æŸ“æ—¶åˆ›å»ºæ–° DOM
   - hydrateRoot: åˆ›å»º FiberRoot æ—¶ hydrate = trueï¼Œæ¸²æŸ“æ—¶å°è¯•å¤ç”¨å·²æœ‰ DOM

   å†…éƒ¨è°ƒç”¨çš„æ˜¯ createHydrationContainer vs createContainerã€‚

Q2: Hydration æ˜¯å¦‚ä½•åŒ¹é… DOM èŠ‚ç‚¹çš„ï¼Ÿ
A: é€šè¿‡ tryToClaimNextHydratableInstanceï¼š
   1. è·å– nextHydratableInstanceï¼ˆå½“å‰å¾…åŒ¹é…çš„ DOM èŠ‚ç‚¹ï¼‰
   2. è°ƒç”¨ canHydrateInstance æ£€æŸ¥ç±»å‹æ˜¯å¦åŒ¹é…
   3. åŒ¹é…æˆåŠŸï¼šfiber.stateNode = domInstanceï¼Œå¤ç”¨ DOM
   4. åŒ¹é…å¤±è´¥ï¼šè§¦å‘ mismatch å¤„ç†

Q3: Hydration Mismatch ä¼šæ€æ ·ï¼Ÿ
A: - å¼€å‘ç¯å¢ƒå‘å‡ºè­¦å‘Š
   - åˆ é™¤ä¸åŒ¹é…çš„æœåŠ¡ç«¯ DOM
   - å®¢æˆ·ç«¯é‡æ–°åˆ›å»º DOM
   - æ€§èƒ½æŸå¤±ï¼Œåº”å°½é‡é¿å…

Q4: å¸¸è§çš„ Mismatch åŸå› æœ‰å“ªäº›ï¼Ÿ
A: - æœåŠ¡ç«¯/å®¢æˆ·ç«¯æ¸²æŸ“ä¸åŒå†…å®¹ï¼ˆæ—¶é—´ã€éšæœºæ•°ï¼‰
   - æµè§ˆå™¨è‡ªåŠ¨è¡¥å…¨æ ‡ç­¾ï¼ˆtable â†’ tbodyï¼‰
   - ä½¿ç”¨ä»…å®¢æˆ·ç«¯ APIï¼ˆwindow, localStorageï¼‰

Q5: Hydration æ—¶äº‹ä»¶æ˜¯ä½•æ—¶ç»‘å®šçš„ï¼Ÿ
A: hydrateRoot è°ƒç”¨æ—¶ï¼ŒlistenToAllSupportedEvents å°±ä¼šåœ¨å®¹å™¨ä¸Šç»‘å®šäº‹ä»¶ã€‚
   ä½†äº‹ä»¶å¤„ç†å‡½æ•°çš„æ‰§è¡Œéœ€è¦ Fiber æ ‘å»ºç«‹åæ‰èƒ½å·¥ä½œã€‚
   React ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œæ‰€æœ‰äº‹ä»¶éƒ½ç»‘å®šåœ¨æ ¹å®¹å™¨ï¼Œä¸åœ¨æ¯ä¸ª DOM ä¸Šç»‘å®šã€‚

Q6: ä»€ä¹ˆæ˜¯ Selective Hydrationï¼Ÿ
A: React 18 çš„ç‰¹æ€§ï¼Œå¯ä»¥ä¼˜å…ˆ hydrate ç”¨æˆ·æ­£åœ¨äº¤äº’çš„éƒ¨åˆ†ã€‚
   å¦‚æœç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªåŒºåŸŸï¼ŒReact ä¼šä¼˜å…ˆ hydrate è¿™ä¸ªåŒºåŸŸï¼Œç„¶åé‡æ”¾äº‹ä»¶ã€‚
   è¿™æå‡äº†äº¤äº’å“åº”æ€§ã€‚
`;

export {
  hydrateRootEntry,
  hydrationContext,
  domMatching,
  eventBinding,
  hydrationCase,
  interviewPoints,
};

