/**
 * ============================================================
 * ğŸ“š Phase 9: Context ä¸è·¨ç»„ä»¶çŠ¶æ€ä¼ æ’­ - Part 3: useContext ä¸è¯»å–è·¯å¾„
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-reconciler/src/ReactFiberHooks.new.js (useContext å®ç°)
 * - packages/react-reconciler/src/ReactFiberNewContext.new.js (readContext)
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š1-2 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­
 */

// ============================================================
// Part 1: useContext çš„å®ç°
// ============================================================

/**
 * ğŸ“Š useContext çš„å®ç°
 */

const useContextImplementation = `
ğŸ“Š useContext çš„å®ç°

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberHooks.new.js (Line 2431)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

useContext ä¸å…¶ä»– Hooks ä¸åŒâ€”â€”å®ƒæ²¡æœ‰ mount å’Œ update ä¸¤ä¸ªç‰ˆæœ¬ï¼

const HooksDispatcherOnMount: Dispatcher = {
  readContext,
  useCallback: mountCallback,
  useContext: readContext,    // â­ ç›´æ¥ä½¿ç”¨ readContext
  useEffect: mountEffect,
  // ...
};

const HooksDispatcherOnUpdate: Dispatcher = {
  readContext,
  useCallback: updateCallback,
  useContext: readContext,    // â­ åŒæ ·ä½¿ç”¨ readContext
  useEffect: updateEffect,
  // ...
};


å…³é”®ç†è§£
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   ä¸ºä»€ä¹ˆ useContext ä¸åŒºåˆ† mount å’Œ updateï¼Ÿ                                â”‚
â”‚                                                                             â”‚
â”‚   1. æ— çŠ¶æ€: useContext ä¸åœ¨ Fiber ä¸Šå­˜å‚¨ Hook çŠ¶æ€                         â”‚
â”‚      - ä¸åƒ useState éœ€è¦ç»´æŠ¤ memoizedState                                 â”‚
â”‚      - ä¸åƒ useEffect éœ€è¦ç»´æŠ¤ effect é“¾è¡¨                                  â”‚
â”‚                                                                             â”‚
â”‚   2. ç›´æ¥è¯»å–: æ¯æ¬¡éƒ½ç›´æ¥è¯»å– Context._currentValue                         â”‚
â”‚      - ä¸éœ€è¦"ä¸Šæ¬¡çš„å€¼"åšå¯¹æ¯”                                               â”‚
â”‚      - å€¼çš„å˜åŒ–ç”± Provider è´Ÿè´£è§¦å‘æ›´æ–°                                     â”‚
â”‚                                                                             â”‚
â”‚   3. ä¾èµ–æ”¶é›†: é€šè¿‡ readContext åœ¨ Fiber ä¸Šè®°å½•ä¾èµ–                         â”‚
â”‚      - æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šé‡æ–°æ”¶é›†ä¾èµ–                                             â”‚
â”‚      - ä¸éœ€è¦åŒºåˆ†é¦–æ¬¡å’Œæ›´æ–°                                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 2: readContext æ ¸å¿ƒå®ç°
// ============================================================

/**
 * ğŸ“Š readContext è¯¦è§£
 */

const readContextImplementation = `
ğŸ“Š readContext æ ¸å¿ƒå®ç°

æºç ä½ç½®: packages/react-reconciler/src/ReactFiberNewContext.new.js (Line 652)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function readContext<T>(context: ReactContext<T>): T {
  // 1. è¯»å–å½“å‰å€¼
  const value = isPrimaryRenderer
    ? context._currentValue      // â­ ç›´æ¥è¯»å– Context å¯¹è±¡çš„å­—æ®µ
    : context._currentValue2;

  // 2. æ£€æŸ¥æ˜¯å¦å·²ç»å®Œå…¨è§‚å¯Ÿè¿‡è¿™ä¸ª Context
  if (lastFullyObservedContext === context) {
    // å·²ç»è®°å½•äº†ä¾èµ–ï¼Œä¸éœ€è¦é‡å¤è®°å½•
  } else {
    // 3. åˆ›å»ºä¾èµ–é¡¹
    const contextItem = {
      context: context,          // ä¾èµ–çš„ Context
      memoizedValue: value,      // å½“æ—¶è¯»åˆ°çš„å€¼ï¼ˆç”¨äºåç»­å¯¹æ¯”ï¼‰
      next: null,                // é“¾è¡¨æŒ‡é’ˆ
    };

    // 4. å°†ä¾èµ–é¡¹æ·»åŠ åˆ°å½“å‰ Fiber çš„ä¾èµ–é“¾è¡¨
    if (lastContextDependency === null) {
      // ç¬¬ä¸€ä¸ªä¾èµ–
      if (currentlyRenderingFiber === null) {
        throw new Error('Context can only be read while React is rendering.');
      }
      lastContextDependency = contextItem;
      currentlyRenderingFiber.dependencies = {
        lanes: NoLanes,
        firstContext: contextItem,      // â­ æŒ‚åˆ° Fiber ä¸Š
      };
    } else {
      // è¿½åŠ åˆ°é“¾è¡¨
      lastContextDependency.next = contextItem;
      lastContextDependency = contextItem;
    }
  }

  return value;  // â­ è¿”å›å½“å‰å€¼
}


æ‰§è¡Œæµç¨‹å›¾
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   ç»„ä»¶ä¸­: const theme = useContext(ThemeContext);                           â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    readContext(ThemeContext)                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 1: è¯»å–å€¼                                                      â”‚  â”‚
â”‚   â”‚ value = ThemeContext._currentValue                                  â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚ è¿™ä¸ªå€¼æ˜¯ç”±æœ€è¿‘çš„ Provider é€šè¿‡ pushProvider è®¾ç½®çš„                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 2: åˆ›å»ºä¾èµ–é¡¹ (ContextDependency)                              â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚ contextItem = {                                                     â”‚  â”‚
â”‚   â”‚   context: ThemeContext,                                            â”‚  â”‚
â”‚   â”‚   memoizedValue: "dark",      // è®°å½•å½“æ—¶è¯»åˆ°çš„å€¼                   â”‚  â”‚
â”‚   â”‚   next: null                                                        â”‚  â”‚
â”‚   â”‚ }                                                                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 3: æŒ‚åˆ°å½“å‰ Fiber çš„ dependencies ä¸Š                           â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚ currentlyRenderingFiber.dependencies = {                            â”‚  â”‚
â”‚   â”‚   lanes: NoLanes,                                                   â”‚  â”‚
â”‚   â”‚   firstContext: contextItem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚ }                                                              â”‚   â”‚  â”‚
â”‚   â”‚                                                                â”‚   â”‚  â”‚
â”‚   â”‚ ContextDependency é“¾è¡¨:                                         â”‚   â”‚  â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    next    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚   â”‚  â”‚
â”‚   â”‚ â”‚ Theme Ctx   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ User Ctx    â”‚ â”€â–¶ null             â”‚   â”‚  â”‚
â”‚   â”‚ â”‚ value:"dark"â”‚            â”‚ value:{...} â”‚                     â”‚   â”‚  â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   â”‚  â”‚
â”‚   â”‚       â–²                                                        â”‚   â”‚  â”‚
â”‚   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                                     â”‚
â”‚                       â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 4: è¿”å›å€¼                                                      â”‚  â”‚
â”‚   â”‚ return "dark"                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 3: prepareToReadContext - å‡†å¤‡é˜¶æ®µ
// ============================================================

/**
 * ğŸ“Š prepareToReadContext - æ¸²æŸ“å‰çš„å‡†å¤‡
 */

const prepareToReadContext = `
ğŸ“Š prepareToReadContext - æ¸²æŸ“å‰çš„å‡†å¤‡

æºç ä½ç½®: ReactFiberNewContext.new.js (Line 625)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åœ¨å‡½æ•°ç»„ä»¶æ‰§è¡Œä¹‹å‰ï¼ŒReact ä¼šè°ƒç”¨ prepareToReadContextï¼š

export function prepareToReadContext(
  workInProgress: Fiber,
  renderLanes: Lanes,
): void {
  // 1. è®¾ç½®"å½“å‰æ­£åœ¨æ¸²æŸ“çš„ Fiber"
  currentlyRenderingFiber = workInProgress;

  // 2. é‡ç½®ä¾èµ–é“¾è¡¨æŒ‡é’ˆ
  lastContextDependency = null;
  lastFullyObservedContext = null;

  // 3. å¤„ç†å·²æœ‰çš„ä¾èµ–
  const dependencies = workInProgress.dependencies;
  if (dependencies !== null) {
    // é‡ç½® firstContextï¼Œåç»­ readContext ä¼šé‡æ–°æ”¶é›†
    dependencies.firstContext = null;

    // æ£€æŸ¥æ˜¯å¦æœ‰ Context å˜åŒ–ï¼ˆè§¦å‘æ›´æ–°æ ‡è®°ï¼‰
    if (includesSomeLane(dependencies.lanes, renderLanes)) {
      markWorkInProgressReceivedUpdate();
    }
  }
}


è°ƒç”¨æ—¶æœº
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   beginWork(FunctionComponent)                                              â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚   renderWithHooks(...)                                                      â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”œâ”€â–¶ prepareToReadContext(workInProgress, renderLanes)                â”‚
â”‚       â”‚       â†‘                                                             â”‚
â”‚       â”‚       â””â”€â”€ åœ¨è¿™é‡Œè®¾ç½® currentlyRenderingFiber                       â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”œâ”€â–¶ Component(props)                                                  â”‚
â”‚       â”‚       â†‘                                                             â”‚
â”‚       â”‚       â””â”€â”€ ç»„ä»¶æ‰§è¡Œï¼Œå¯èƒ½è°ƒç”¨ useContext                             â”‚
â”‚       â”‚           â””â”€â”€ useContext â†’ readContext                              â”‚
â”‚       â”‚               â””â”€â”€ ä½¿ç”¨ currentlyRenderingFiber è®°å½•ä¾èµ–             â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â””â”€â–¶ finishRenderingHooks(...)                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ä¸ºä»€ä¹ˆæ¯æ¬¡æ¸²æŸ“éƒ½è¦é‡æ–°æ”¶é›†ä¾èµ–ï¼Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç»„ä»¶å¯èƒ½åœ¨ä¸åŒæ¡ä»¶ä¸‹ä½¿ç”¨ä¸åŒçš„ Contextï¼š

function Component({ useTheme }) {
  // æ¡ä»¶æ€§ä½¿ç”¨ Context
  if (useTheme) {
    const theme = useContext(ThemeContext);  // æœ‰æ—¶ä¼šç”¨
    return <div className={theme}>...</div>;
  }
  return <div>Default</div>;
}

æ¯æ¬¡æ¸²æŸ“éƒ½é‡æ–°æ”¶é›†ï¼Œç¡®ä¿ä¾èµ–åˆ—è¡¨æ˜¯æœ€æ–°çš„ã€‚
`;

// ============================================================
// Part 4: ä¾èµ–æ”¶é›†çš„æ•°æ®ç»“æ„
// ============================================================

/**
 * ğŸ“Š ContextDependency æ•°æ®ç»“æ„
 */

const contextDependencyStructure = `
ğŸ“Š ContextDependency æ•°æ®ç»“æ„

æºç ä½ç½®: packages/react-reconciler/src/ReactInternalTypes.js
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

type ContextDependency<T> = {
  context: ReactContext<T>,     // ä¾èµ–çš„ Context å¯¹è±¡
  memoizedValue: T,             // è¯»å–æ—¶çš„å€¼ï¼ˆç”¨äºå˜åŒ–æ£€æµ‹ï¼‰
  next: ContextDependency<mixed> | null,  // é“¾è¡¨æŒ‡é’ˆ
};

type Dependencies = {
  lanes: Lanes,                 // éœ€è¦å¤„ç†çš„ä¼˜å…ˆçº§
  firstContext: ContextDependency<mixed> | null,  // ä¾èµ–é“¾è¡¨å¤´
};


Fiber.dependencies å­—æ®µ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ¯ä¸ª Fiber éƒ½æœ‰ä¸€ä¸ª dependencies å­—æ®µï¼Œç”¨äºå­˜å‚¨ Context ä¾èµ–ï¼š

interface Fiber {
  // ...
  dependencies: Dependencies | null;
  // ...
}


å›¾ç¤º: å¤šä¸ª Context ä¾èµ–
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function MyComponent() {
  const theme = useContext(ThemeContext);
  const user = useContext(UserContext);
  const locale = useContext(LocaleContext);
  // ...
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   MyComponent Fiber                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ tag: FunctionComponent (0)                                          â”‚  â”‚
â”‚   â”‚ type: MyComponent                                                   â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚ dependencies: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚                                                                â”‚   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”˜  â”‚
â”‚                                                                    â”‚        â”‚
â”‚                                                                    â–¼        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Dependencies                                                        â”‚  â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚   â”‚ â”‚ lanes: NoLanes                                                  â”‚â”‚  â”‚
â”‚   â”‚ â”‚ firstContext: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚â”‚  â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚            â”‚
â”‚                                                               â–¼            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  next  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  next â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚ ContextDependency  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ContextDependency  â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ Context- â”‚â”‚
â”‚   â”‚                    â”‚        â”‚                    â”‚       â”‚ Dependencyâ”‚â”‚
â”‚   â”‚ context:ThemeCtx   â”‚        â”‚ context: UserCtx   â”‚       â”‚          â”‚â”‚
â”‚   â”‚ memoizedValue:     â”‚        â”‚ memoizedValue:     â”‚       â”‚context:  â”‚â”‚
â”‚   â”‚   "dark"           â”‚        â”‚   {name:"John"}    â”‚       â”‚LocaleCtx â”‚â”‚
â”‚   â”‚ next: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚ next: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚memoized: â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  "en"    â”‚â”‚
â”‚                                                              â”‚ next:nullâ”‚â”‚
â”‚                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 5: useContext vs Consumer å¯¹æ¯”
// ============================================================

/**
 * ğŸ“Š useContext vs Consumer å¯¹æ¯”
 */

const useContextVsConsumer = `
ğŸ“Š useContext vs Consumer å†…éƒ¨å®ç°å¯¹æ¯”

Consumer çš„å·¥ä½œæµç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

<ThemeContext.Consumer>
  {theme => <Button theme={theme} />}
</ThemeContext.Consumer>

1. åˆ›å»º ContextConsumer Fiber (tag = 9)
2. beginWork æ—¶è°ƒç”¨ updateContextConsumer:
   - prepareToReadContext
   - readContext(context) â†’ è¯»å–å€¼
   - è°ƒç”¨ render prop: children(value)
   - reconcileChildren

ç‰¹ç‚¹ï¼š
â€¢ é¢å¤–åˆ›å»ºä¸€ä¸ª Fiber èŠ‚ç‚¹
â€¢ Render Props æ¨¡å¼å¯¼è‡´åµŒå¥—


useContext çš„å·¥ä½œæµç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function Button() {
  const theme = useContext(ThemeContext);
  return <button className={theme}>Click</button>;
}

1. ç»„ä»¶æœ¬èº«æ˜¯ FunctionComponent Fiber
2. renderWithHooks æ‰§è¡Œç»„ä»¶å‡½æ•°
3. ç»„ä»¶å†…è°ƒç”¨ useContext â†’ readContext
   - ç›´æ¥è¯»å– context._currentValue
   - è®°å½•ä¾èµ–åˆ° Fiber.dependencies

ç‰¹ç‚¹ï¼š
â€¢ ä¸åˆ›å»ºé¢å¤– Fiber
â€¢ ç›´æ¥åœ¨ç»„ä»¶å†…è°ƒç”¨
â€¢ æ›´ç®€æ´


å¯¹æ¯”æ€»ç»“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹æ€§               â”‚ Consumer                â”‚ useContext                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fiber æ•°é‡         â”‚ é¢å¤–åˆ›å»ºä¸€ä¸ª            â”‚ ä¸åˆ›å»ºé¢å¤– Fiber            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¾èµ–è®°å½•ä½ç½®       â”‚ Consumer Fiber          â”‚ ä½¿ç”¨ Context çš„ç»„ä»¶ Fiber   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»£ç é£æ ¼           â”‚ Render Propsï¼ˆåµŒå¥—ï¼‰    â”‚ Hookï¼ˆæ‰å¹³ï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤š Context         â”‚ åµŒå¥—åœ°ç‹±                â”‚ å¤šæ¬¡è°ƒç”¨å³å¯                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…éƒ¨å®ç°           â”‚ updateContextConsumer   â”‚ readContext                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 6: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 3 é¢è¯•è¦ç‚¹

Q1: useContext å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
A: useContext ç›´æ¥è°ƒç”¨ readContext å‡½æ•°ï¼š
   1. è¯»å– context._currentValue è·å–å½“å‰å€¼
   2. åˆ›å»º ContextDependency è®°å½•ä¾èµ–
   3. æŒ‚åˆ°å½“å‰ Fiber çš„ dependencies.firstContext é“¾è¡¨ä¸Š
   4. è¿”å›å½“å‰å€¼

Q2: useContext ä¸ºä»€ä¹ˆä¸åƒ useState é‚£æ ·åŒºåˆ† mount å’Œ updateï¼Ÿ
A: å› ä¸º useContext æ˜¯æ— çŠ¶æ€çš„ï¼š
   - ä¸åœ¨ Fiber ä¸Šå­˜å‚¨ Hook çŠ¶æ€
   - æ¯æ¬¡éƒ½ç›´æ¥è¯»å– Context._currentValue
   - ä¾èµ–æ¯æ¬¡æ¸²æŸ“éƒ½é‡æ–°æ”¶é›†
   - å€¼çš„å˜åŒ–ç”± Provider è´Ÿè´£è§¦å‘æ›´æ–°

Q3: Context ä¾èµ–æ˜¯å¦‚ä½•è¢«è®°å½•çš„ï¼Ÿ
A: é€šè¿‡ Fiber.dependencies å­—æ®µï¼š
   - dependencies.firstContext æŒ‡å‘ ContextDependency é“¾è¡¨
   - æ¯ä¸ª ContextDependency åŒ…å« context å¼•ç”¨å’Œ memoizedValue
   - é“¾è¡¨å½¢å¼æ”¯æŒä¸€ä¸ªç»„ä»¶ä¾èµ–å¤šä¸ª Context

Q4: prepareToReadContext çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
A: åœ¨ç»„ä»¶æ¸²æŸ“å‰åšå‡†å¤‡ï¼š
   1. è®¾ç½® currentlyRenderingFiberï¼ˆreadContext éœ€è¦ç”¨ï¼‰
   2. é‡ç½®ä¾èµ–é“¾è¡¨æŒ‡é’ˆ
   3. æ¸…ç©º firstContextï¼ˆåç»­é‡æ–°æ”¶é›†ï¼‰
   4. æ£€æŸ¥æ˜¯å¦æœ‰ Context å˜åŒ–éœ€è¦æ ‡è®°æ›´æ–°

Q5: memoizedValue çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
A: ç”¨äºå˜åŒ–æ£€æµ‹ã€‚Context å€¼å˜åŒ–æ—¶ï¼ŒReact éå†ä¾èµ–é“¾è¡¨ï¼Œ
   æ¯”è¾ƒ memoizedValue å’Œæ–°å€¼æ˜¯å¦ç›¸åŒï¼ˆObject.isï¼‰ã€‚
   ä¸åŒåˆ™æ ‡è®°ç»„ä»¶éœ€è¦æ›´æ–°ã€‚

Q6: ä¸€ä¸ªç»„ä»¶å¯ä»¥ä¾èµ–å¤šä¸ª Context å—ï¼Ÿå†…éƒ¨å¦‚ä½•å­˜å‚¨ï¼Ÿ
A: å¯ä»¥ã€‚é€šè¿‡ ContextDependency é“¾è¡¨å­˜å‚¨ï¼š
   - æ¯ä¸ª useContext è°ƒç”¨åˆ›å»ºä¸€ä¸ª ContextDependency èŠ‚ç‚¹
   - é€šè¿‡ next æŒ‡é’ˆè¿æ¥æˆé“¾è¡¨
   - Fiber.dependencies.firstContext æŒ‡å‘é“¾è¡¨å¤´
`;

export {
  useContextImplementation,
  readContextImplementation,
  prepareToReadContext,
  contextDependencyStructure,
  useContextVsConsumer,
  interviewPoints,
};

