/**
 * ============================================================
 * 📚 Phase 3: 渲染流程 - Part 1: 渲染管道概览
 * ============================================================
 *
 * 📁 核心源码位置:
 * - packages/react-dom/src/client/ReactDOMRoot.js
 * - packages/react-reconciler/src/ReactFiberWorkLoop.new.js
 *
 * ⏱️ 预计时间：2-3 小时
 * 🎯 面试权重：⭐⭐⭐⭐⭐
 */

// ============================================================
// Part 1: 从开发者视角看入口
// ============================================================

/**
 * 📊 React 18 的渲染入口
 */

const renderEntry = `
📊 React 18 的渲染入口

开发者视角的代码:
═══════════════════════════════════════════════════════════════════════════════

// React 18 新 API
import { createRoot } from 'react-dom/client';

const container = document.getElementById('root');
const root = createRoot(container);  // ⭐ Step 1: 创建根节点
root.render(<App />);                // ⭐ Step 2: 触发渲染

// 更新时（例如在 App 组件内）
const [count, setCount] = useState(0);
setCount(1);  // ⭐ Step 3: 触发更新


这两行代码背后发生了什么？
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   createRoot(container)                                                     │
│         │                                                                   │
│         │  1. 创建 FiberRootNode                                            │
│         │  2. 创建 HostRootFiber                                            │
│         │  3. 初始化 updateQueue                                            │
│         │  4. 注册事件监听                                                  │
│         ▼                                                                   │
│   ┌─────────────────┐                                                       │
│   │  ReactDOMRoot   │ ← 返回给开发者                                        │
│   │  {              │                                                       │
│   │    _internalRoot: FiberRoot,                                            │
│   │    render: fn,                                                          │
│   │    unmount: fn,                                                         │
│   │  }              │                                                       │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            │  root.render(<App />)                                          │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │  updateContainer │ ← 触发首次渲染                                       │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            │  进入 React 渲染管道                                           │
│            ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                      React 渲染管道                              │      │
│   │                                                                  │      │
│   │   Schedule → Render Phase → Commit Phase → DOM 更新              │      │
│   │                                                                  │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
`;

// ============================================================
// Part 2: 渲染流程的三大阶段
// ============================================================

/**
 * 📊 渲染流程三大阶段
 */

const threePhases = `
📊 渲染流程的三大阶段

┌─────────────────────────────────────────────────────────────────────────────┐
│                       React 渲染管道                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│   │   Schedule  │ ─▶ │  Render Phase   │ ─▶ │  Commit Phase   │            │
│   │   调度阶段  │    │  渲染阶段       │    │  提交阶段       │            │
│   └─────────────┘    └─────────────────┘    └─────────────────┘            │
│         │                    │                       │                      │
│         ▼                    ▼                       ▼                      │
│   • 确定更新优先级     • 构建/更新 Fiber 树    • 执行 DOM 操作             │
│   • 安排任务执行       • 计算 Diff              • 调用生命周期              │
│   • 可被高优先级打断   • 不操作 DOM             • 执行副作用                │
│                        • 可中断                 • 不可中断                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

各阶段详细说明:
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段 1: Schedule（调度阶段）                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 做什么？                                                                    │
│ • 接收更新请求（setState、props 变化等）                                    │
│ • 确定更新的优先级（Lane）                                                  │
│ • 决定何时开始渲染                                                          │
│ • 与 Scheduler 协调任务调度                                                 │
│                                                                             │
│ 关键函数:                                                                   │
│ • scheduleUpdateOnFiber()                                                   │
│ • ensureRootIsScheduled()                                                   │
│                                                                             │
│ 特点:                                                                       │
│ • 高优先级更新可以打断低优先级更新                                          │
│ • 支持批量更新（batching）                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段 2: Render Phase（渲染阶段）                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 做什么？                                                                    │
│ • 从根节点开始遍历 Fiber 树                                                 │
│ • 执行组件函数/类的 render 方法                                             │
│ • 处理 Hooks                                                                │
│ • Diff 新旧 ReactElement，决定哪些节点需要更新                              │
│ • 标记副作用（flags）                                                       │
│                                                                             │
│ 关键函数:                                                                   │
│ • performSyncWorkOnRoot() / performConcurrentWorkOnRoot()                   │
│ • renderRootSync() / renderRootConcurrent()                                 │
│ • workLoopSync() / workLoopConcurrent()                                     │
│ • beginWork() / completeWork()                                              │
│                                                                             │
│ 特点:                                                                       │
│ • 纯计算阶段，不操作 DOM                                                    │
│ • 在并发模式下可中断                                                        │
│ • 可以被更高优先级任务打断                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段 3: Commit Phase（提交阶段）                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 做什么？                                                                    │
│ • 执行真实的 DOM 操作                                                       │
│ • 调用生命周期方法（componentDidMount/Update）                              │
│ • 执行 useLayoutEffect                                                      │
│ • 调度 useEffect（异步执行）                                                │
│ • 更新 ref                                                                  │
│                                                                             │
│ 三个子阶段:                                                                 │
│ 1. Before Mutation：DOM 操作前（getSnapshotBeforeUpdate）                   │
│ 2. Mutation：执行 DOM 操作（插入、更新、删除）                              │
│ 3. Layout：DOM 操作后（componentDidMount/Update、useLayoutEffect）          │
│                                                                             │
│ 关键函数:                                                                   │
│ • commitRoot()                                                              │
│ • commitBeforeMutationEffects()                                             │
│ • commitMutationEffects()                                                   │
│ • commitLayoutEffects()                                                     │
│                                                                             │
│ 特点:                                                                       │
│ • 同步执行，不可中断                                                        │
│ • 操作真实 DOM                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
`;

// ============================================================
// Part 3: 完整流程图
// ============================================================

/**
 * 📊 完整渲染流程图
 */

const fullPipeline = `
📊 完整渲染流程图

从 render() 调用到 DOM 更新的完整时序:
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   root.render(<App />)                                                      │
│         │                                                                   │
│         ▼                                                                   │
│   ┌─────────────────┐                                                       │
│   │ updateContainer │  📁 ReactFiberReconciler.js                          │
│   └────────┬────────┘                                                       │
│            │ 创建 Update 对象，加入 updateQueue                             │
│            ▼                                                                │
│   ┌─────────────────────┐                                                   │
│   │ scheduleUpdateOnFiber│  📁 ReactFiberWorkLoop.new.js                   │
│   └────────┬────────────┘                                                   │
│            │ 标记 root 有待处理的更新                                       │
│            ▼                                                                │
│   ┌─────────────────────┐                                                   │
│   │ ensureRootIsScheduled│  决定调度策略                                    │
│   └────────┬────────────┘                                                   │
│            │                                                                │
│            ├────────────────────────────────────────┐                       │
│            │                                        │                       │
│            ▼ (同步更新)                             ▼ (并发更新)            │
│   ┌─────────────────────┐              ┌─────────────────────────┐          │
│   │performSyncWorkOnRoot│              │performConcurrentWorkOnRoot│         │
│   └────────┬────────────┘              └────────────┬────────────┘          │
│            │                                        │                       │
│            ▼                                        ▼                       │
│   ┌─────────────────┐                  ┌─────────────────────┐              │
│   │ renderRootSync  │                  │ renderRootConcurrent│              │
│   └────────┬────────┘                  └────────────┬────────┘              │
│            │                                        │                       │
│            ▼                                        ▼                       │
│   ┌─────────────────┐                  ┌─────────────────────┐              │
│   │  workLoopSync   │                  │  workLoopConcurrent │              │
│   │                 │                  │  (可中断)           │              │
│   └────────┬────────┘                  └────────────┬────────┘              │
│            │                                        │                       │
│            └────────────────┬───────────────────────┘                       │
│                             │                                               │
│                             ▼                                               │
│            ┌────────────────────────────────┐                               │
│            │       performUnitOfWork        │                               │
│            │  (处理每个 Fiber)              │                               │
│            └────────────────┬───────────────┘                               │
│                             │                                               │
│              ┌──────────────┴──────────────┐                                │
│              │                             │                                │
│              ▼                             ▼                                │
│   ┌─────────────────┐           ┌─────────────────┐                        │
│   │   beginWork     │           │  completeWork   │                        │
│   │   (向下遍历)    │           │  (向上遍历)     │                        │
│   │   创建子 Fiber   │           │  创建 DOM      │                        │
│   │   处理 Hooks    │           │  收集 flags    │                        │
│   └─────────────────┘           └─────────────────┘                        │
│                                                                             │
│                             │                                               │
│                             ▼                                               │
│   ════════════════════ Render 阶段完成 ════════════════════                │
│                             │                                               │
│                             ▼                                               │
│            ┌────────────────────────────────┐                               │
│            │         commitRoot             │                               │
│            │    (开始 Commit 阶段)          │                               │
│            └────────────────┬───────────────┘                               │
│                             │                                               │
│        ┌────────────────────┼────────────────────┐                          │
│        │                    │                    │                          │
│        ▼                    ▼                    ▼                          │
│ ┌──────────────┐  ┌──────────────────┐  ┌──────────────┐                   │
│ │Before Mutation│  │    Mutation     │  │    Layout    │                   │
│ │getSnapshot... │  │执行 DOM 操作    │  │生命周期/Hooks│                   │
│ └──────────────┘  └──────────────────┘  └──────────────┘                   │
│                             │                                               │
│                             ▼                                               │
│   ════════════════════ Commit 阶段完成 ════════════════════                │
│                             │                                               │
│                             ▼                                               │
│                    ┌─────────────────┐                                      │
│                    │   DOM 更新完成  │                                      │
│                    │   用户看到新 UI │                                      │
│                    └─────────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
`;

// ============================================================
// Part 4: 同步渲染 vs 并发渲染
// ============================================================

/**
 * 📊 同步渲染与并发渲染的区别
 */

const syncVsConcurrent = `
📊 同步渲染 vs 并发渲染

┌─────────────────────────────────────────────────────────────────────────────┐
│                       两种渲染模式对比                                       │
├─────────────────────┬───────────────────────┬───────────────────────────────┤
│ 特性                │ 同步渲染 (Sync)       │ 并发渲染 (Concurrent)         │
├─────────────────────┼───────────────────────┼───────────────────────────────┤
│ 触发条件            │ flushSync、某些事件   │ startTransition、默认更新     │
│ 入口函数            │ performSyncWorkOnRoot │ performConcurrentWorkOnRoot   │
│ 工作循环            │ workLoopSync          │ workLoopConcurrent            │
│ 可中断性            │ ❌ 不可中断           │ ✅ 可以被高优先级打断         │
│ 时间切片            │ ❌ 无                 │ ✅ 支持                       │
│ Lane               │ SyncLane              │ DefaultLane / TransitionLane  │
└─────────────────────┴───────────────────────┴───────────────────────────────┘

代码对比:
═══════════════════════════════════════════════════════════════════════════════

// 同步渲染的工作循环
function workLoopSync() {
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
    // ⭐ 不检查是否需要让出，一直执行到完成
  }
}

// 并发渲染的工作循环
function workLoopConcurrent() {
  while (workInProgress !== null && !shouldYield()) {
    performUnitOfWork(workInProgress);
    // ⭐ 每处理一个 Fiber，检查是否需要让出主线程
  }
}


什么时候用同步？什么时候用并发？
═══════════════════════════════════════════════════════════════════════════════

同步渲染场景:
─────────────────────────
• 离散用户事件（click、input）触发的更新
• flushSync() 强制同步
• Legacy 模式（ReactDOM.render）
• 首次渲染

并发渲染场景:
─────────────────────────
• startTransition() 包裹的更新
• useDeferredValue() 产生的更新
• 默认的 state 更新（React 18 createRoot）
• Suspense 相关的更新
`;

// ============================================================
// Part 5: 面试要点
// ============================================================

const interviewPoints = `
💡 Part 1 面试要点

Q1: React 渲染流程分为哪几个阶段？
A: 三个阶段：
   1. Schedule（调度）：确定优先级，安排任务
   2. Render（渲染）：构建 Fiber 树，计算 Diff，不操作 DOM
   3. Commit（提交）：执行 DOM 操作，调用生命周期

Q2: Render 阶段和 Commit 阶段的主要区别是什么？
A: - Render 阶段：纯计算，不操作 DOM，可中断（并发模式）
   - Commit 阶段：操作 DOM，调用副作用，同步执行不可中断
   这种分离让 React 可以在 Render 阶段被打断，而不会导致 UI 不一致。

Q3: workLoopSync 和 workLoopConcurrent 有什么区别？
A: - workLoopSync：不检查 shouldYield()，一直执行到完成
   - workLoopConcurrent：每处理一个 Fiber 检查是否需要让出
   并发模式支持时间切片，可以被高优先级任务打断。

Q4: 从 root.render() 到 DOM 更新，经历了哪些关键函数？
A: updateContainer → scheduleUpdateOnFiber → ensureRootIsScheduled
   → performSyncWorkOnRoot / performConcurrentWorkOnRoot
   → renderRootSync / renderRootConcurrent
   → workLoop → performUnitOfWork (beginWork + completeWork)
   → commitRoot → commitMutationEffects

Q5: 为什么 Render 阶段不直接操作 DOM？
A: 1. Render 阶段可能被中断，直接操作 DOM 会导致不一致
   2. 需要先计算出所有变更，再一次性应用
   3. 批量操作 DOM 性能更好
   4. 支持并发特性（如 Suspense）
`;

export {
  renderEntry,
  threePhases,
  fullPipeline,
  syncVsConcurrent,
  interviewPoints,
};

