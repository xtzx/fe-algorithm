/**
 * ============================================================
 * ğŸ“š Phase 5: Diff ç®—æ³• - Part 2: å•èŠ‚ç‚¹ä¸æ–‡æœ¬ Diff
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-reconciler/src/ReactChildFiber.new.js
 *   - reconcileSingleElement (Line 1129)
 *   - reconcileSingleTextNode (Line 1106)
 *   - placeSingleChild (Line 359)
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š1-2 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­
 */

// ============================================================
// Part 1: reconcileSingleElement æºç è§£æ
// ============================================================

/**
 * ğŸ“Š å•å…ƒç´  Diff - reconcileSingleElement
 */

const reconcileSingleElement = `
ğŸ“Š reconcileSingleElement - å•å…ƒç´  Diff

æºç ä½ç½®: packages/react-reconciler/src/ReactChildFiber.new.js (Line 1129)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å½“æ–°çš„ children æ˜¯å•ä¸ª ReactElement æ—¶è°ƒç”¨æ­¤å‡½æ•°ã€‚


å‡½æ•°ç­¾å:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function reconcileSingleElement(
  returnFiber: Fiber,           // çˆ¶ Fiber
  currentFirstChild: Fiber | null, // æ—§çš„ç¬¬ä¸€ä¸ªå­ Fiber
  element: ReactElement,        // æ–°çš„ ReactElement
  lanes: Lanes,                 // ä¼˜å…ˆçº§
): Fiber


æ ¸å¿ƒé€»è¾‘ï¼ˆä¼ªä»£ç ï¼‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function reconcileSingleElement(returnFiber, currentFirstChild, element, lanes) {
  const key = element.key;
  let child = currentFirstChild;

  // 1. éå†æ—§çš„å­ Fiber é“¾è¡¨ï¼Œå¯»æ‰¾å¯å¤ç”¨çš„èŠ‚ç‚¹
  while (child !== null) {

    // 2. æ¯”è¾ƒ key
    if (child.key === key) {

      // 3. key ç›¸åŒï¼Œæ¯”è¾ƒ type
      if (child.elementType === element.type) {
        // â­ key ç›¸åŒ + type ç›¸åŒ â†’ å¯ä»¥å¤ç”¨ï¼

        // åˆ é™¤å‰©ä½™çš„å…„å¼ŸèŠ‚ç‚¹ï¼ˆå› ä¸ºæ–°çš„åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼‰
        deleteRemainingChildren(returnFiber, child.sibling);

        // å¤ç”¨è¿™ä¸ª Fiberï¼Œæ›´æ–° props
        const existing = useFiber(child, element.props);
        existing.ref = coerceRef(returnFiber, child, element);
        existing.return = returnFiber;
        return existing;
      }

      // â­ key ç›¸åŒä½† type ä¸åŒ â†’ ä¸èƒ½å¤ç”¨
      // åˆ é™¤æ‰€æœ‰æ—§èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å½“å‰å’Œå…„å¼Ÿï¼‰
      deleteRemainingChildren(returnFiber, child);
      break;

    } else {
      // â­ key ä¸åŒ â†’ åˆ é™¤è¿™ä¸ªæ—§èŠ‚ç‚¹ï¼Œç»§ç»­æ‰¾
      deleteChild(returnFiber, child);
    }

    child = child.sibling;
  }

  // 4. æ²¡æ‰¾åˆ°å¯å¤ç”¨çš„ï¼Œåˆ›å»ºæ–°çš„ Fiber
  const created = createFiberFromElement(element, returnFiber.mode, lanes);
  created.ref = coerceRef(returnFiber, currentFirstChild, element);
  created.return = returnFiber;
  return created;
}


æµç¨‹å›¾:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   reconcileSingleElement(returnFiber, oldFirstChild, newElement)            â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚               éå†æ—§çš„ child é“¾è¡¨                                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚              child.key === newElement.key ?                                 â”‚
â”‚                    / \\                                                      â”‚
â”‚                  Yes   No                                                   â”‚
â”‚                  /       \\                                                  â”‚
â”‚                 â–¼         â–¼                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚   â”‚  æ¯”è¾ƒ type        â”‚  â”‚ deleteChild(child)â”‚                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ child = sibling   â”‚                             â”‚
â”‚             â”‚            â”‚ ç»§ç»­å¾ªç¯          â”‚                             â”‚
â”‚             â–¼            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚   child.type === element.type ?                                            â”‚
â”‚          / \\                                                                â”‚
â”‚        Yes   No                                                             â”‚
â”‚        /       \\                                                            â”‚
â”‚       â–¼         â–¼                                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ â”‚ å¯å¤ç”¨ï¼ â”‚  â”‚ key ç›¸åŒä½† type ä¸åŒ                 â”‚                     â”‚
â”‚ â”‚          â”‚  â”‚ â†’ deleteRemainingChildren(child)     â”‚                     â”‚
â”‚ â”‚ åˆ é™¤å…„å¼Ÿ â”‚  â”‚ â†’ break                             â”‚                     â”‚
â”‚ â”‚ useFiber â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚ â”‚ è¿”å›     â”‚                                                               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚           æ²¡æ‰¾åˆ°å¯å¤ç”¨çš„èŠ‚ç‚¹                                         â”‚  â”‚
â”‚   â”‚           createFiberFromElement(element)                           â”‚  â”‚
â”‚   â”‚           è¿”å›æ–° Fiber                                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 2: å•å…ƒç´  Diff çš„å…·ä½“åœºæ™¯
// ============================================================

/**
 * ğŸ“Š å•å…ƒç´  Diff åœºæ™¯åˆ†æ
 */

const singleElementScenarios = `
ğŸ“Š å•å…ƒç´  Diff çš„å…·ä½“åœºæ™¯

åœºæ™¯ 1: key ç›¸åŒ + type ç›¸åŒ â†’ å¤ç”¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ—§
<div className="old">Hello</div>

// æ–°
<div className="new">World</div>

æ‰§è¡Œè¿‡ç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. key: null === null âœ“
2. type: 'div' === 'div' âœ“
3. å¯ä»¥å¤ç”¨ï¼

ç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ å¤ç”¨æ—§çš„ div Fiber
â€¢ æ›´æ–° props: { className: 'old' } â†’ { className: 'new' }
â€¢ æ›´æ–° children: 'Hello' â†’ 'World'
â€¢ DOM èŠ‚ç‚¹ä¸å˜ï¼Œåªæ›´æ–°å±æ€§


åœºæ™¯ 2: key ç›¸åŒ + type ä¸åŒ â†’ åˆ é™¤æ—§çš„ï¼Œåˆ›å»ºæ–°çš„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ—§
<div>Content</div>

// æ–°
<span>Content</span>

æ‰§è¡Œè¿‡ç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. key: null === null âœ“
2. type: 'div' !== 'span' âœ—
3. ä¸èƒ½å¤ç”¨ï¼

ç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ æ ‡è®°æ—§ div ä¸º Deletion
â€¢ åˆ›å»ºæ–°çš„ span Fiber
â€¢ æ ‡è®°æ–° span ä¸º Placement
â€¢ commit é˜¶æ®µï¼šåˆ é™¤ div DOMï¼Œæ’å…¥ span DOM


åœºæ™¯ 3: key ä¸åŒ â†’ åˆ é™¤æ—§çš„ï¼Œç»§ç»­æ‰¾
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ—§
<div key="a">A</div>

// æ–°
<div key="b">B</div>

æ‰§è¡Œè¿‡ç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. key: 'a' !== 'b' âœ—
2. åˆ é™¤ key="a" çš„èŠ‚ç‚¹
3. ç»§ç»­æ‰¾ï¼ˆæ²¡æœ‰æ›´å¤šæ—§èŠ‚ç‚¹äº†ï¼‰
4. åˆ›å»ºæ–°çš„ key="b" çš„ Fiber

ç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ æ ‡è®°æ—§ div[key="a"] ä¸º Deletion
â€¢ åˆ›å»ºæ–°çš„ div[key="b"] Fiber
â€¢ æ ‡è®°æ–° div ä¸º Placement


åœºæ™¯ 4: æ—§èŠ‚ç‚¹æœ‰å¤šä¸ªï¼Œæ–°èŠ‚ç‚¹åªæœ‰ä¸€ä¸ª
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ—§
<>
  <div key="a">A</div>
  <div key="b">B</div>
  <div key="c">C</div>
</>

// æ–°
<div key="b">B updated</div>

æ‰§è¡Œè¿‡ç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. éå† child = oldFirstChild (key="a")
   key: 'a' !== 'b' âœ— â†’ deleteChild(key="a")

2. child = child.sibling (key="b")
   key: 'b' === 'b' âœ“
   type: 'div' === 'div' âœ“
   â†’ å¯å¤ç”¨ï¼

3. deleteRemainingChildren(child.sibling) // åˆ é™¤ key="c"

ç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ æ ‡è®° key="a" ä¸º Deletion
â€¢ å¤ç”¨ key="b" çš„ Fiberï¼Œæ›´æ–° props
â€¢ æ ‡è®° key="c" ä¸º Deletion

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   æ—§:  [key="a"] â†’ [key="b"] â†’ [key="c"]                                   â”‚
â”‚            â†“           â†“           â†“                                       â”‚
â”‚        Deletion     å¤ç”¨      Deletion                                     â”‚
â”‚                                                                             â”‚
â”‚   æ–°:       [key="b"]                                                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 3: æ–‡æœ¬èŠ‚ç‚¹ Diff
// ============================================================

/**
 * ğŸ“Š æ–‡æœ¬èŠ‚ç‚¹ Diff - reconcileSingleTextNode
 */

const textNodeDiff = `
ğŸ“Š æ–‡æœ¬èŠ‚ç‚¹ Diff - reconcileSingleTextNode

æºç ä½ç½®: packages/react-reconciler/src/ReactChildFiber.new.js (Line 1106)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å½“æ–°çš„ children æ˜¯çº¯æ–‡æœ¬ï¼ˆstring æˆ– numberï¼‰æ—¶è°ƒç”¨ã€‚


æ ¸å¿ƒé€»è¾‘ï¼ˆä¼ªä»£ç ï¼‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function reconcileSingleTextNode(
  returnFiber,
  currentFirstChild,
  textContent,
  lanes,
) {
  // 1. å¦‚æœæ—§çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥å¤ç”¨
  if (currentFirstChild !== null && currentFirstChild.tag === HostText) {
    // â­ æ—§èŠ‚ç‚¹ä¹Ÿæ˜¯æ–‡æœ¬ â†’ å¤ç”¨ï¼Œåªæ›´æ–°å†…å®¹
    deleteRemainingChildren(returnFiber, currentFirstChild.sibling);
    const existing = useFiber(currentFirstChild, textContent);
    existing.return = returnFiber;
    return existing;
  }

  // 2. æ—§èŠ‚ç‚¹ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œéœ€è¦åˆ é™¤æ—§çš„ï¼Œåˆ›å»ºæ–°çš„æ–‡æœ¬èŠ‚ç‚¹
  deleteRemainingChildren(returnFiber, currentFirstChild);
  const created = createFiberFromText(textContent, returnFiber.mode, lanes);
  created.return = returnFiber;
  return created;
}


åœºæ™¯åˆ†æ:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åœºæ™¯ 1: æ–‡æœ¬ â†’ æ–‡æœ¬ï¼ˆå¤ç”¨ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// æ—§
<div>Hello</div>

// æ–°
<div>World</div>

ç»“æœ:
â€¢ å¤ç”¨ HostText Fiber
â€¢ æ›´æ–° memoizedProps: 'Hello' â†’ 'World'
â€¢ DOM æ“ä½œï¼štextNode.nodeValue = 'World'


åœºæ™¯ 2: å…ƒç´  â†’ æ–‡æœ¬ï¼ˆåˆ é™¤+åˆ›å»ºï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// æ—§
<div>
  <span>Hello</span>
</div>

// æ–°
<div>World</div>

ç»“æœ:
â€¢ æ ‡è®° span ä¸º Deletion
â€¢ åˆ›å»ºæ–°çš„ HostText Fiber
â€¢ æ ‡è®°æ–° HostText ä¸º Placement


åœºæ™¯ 3: æ–‡æœ¬ â†’ å…ƒç´ ï¼ˆåˆ é™¤+åˆ›å»ºï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// æ—§
<div>Hello</div>

// æ–°
<div>
  <span>World</span>
</div>

ç»“æœ:
â€¢ æ ‡è®° HostText ä¸º Deletion
â€¢ åˆ›å»ºæ–°çš„ span Fiber
â€¢ æ ‡è®°æ–° span ä¸º Placement
`;

// ============================================================
// Part 4: useFiber ä¸ placeSingleChild
// ============================================================

/**
 * ğŸ“Š å¤ç”¨ä¸æ ‡è®°å‡½æ•°
 */

const reuseAndPlaceFunctions = `
ğŸ“Š å¤ç”¨ä¸æ ‡è®°å‡½æ•°

useFiber - å¤ç”¨ Fiber èŠ‚ç‚¹:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function useFiber(fiber: Fiber, pendingProps: mixed): Fiber {
  // 1. åˆ›å»º workInProgressï¼ˆåŸºäº currentï¼‰
  const clone = createWorkInProgress(fiber, pendingProps);

  // 2. æ¸…ç©º index å’Œ siblingï¼ˆå› ä¸ºå¯èƒ½åœ¨æ–°ä½ç½®ï¼‰
  clone.index = 0;
  clone.sibling = null;

  return clone;
}

è¯´æ˜:
â€¢ ä¸æ˜¯ç›´æ¥å¤ç”¨ Fiber å¯¹è±¡ï¼Œè€Œæ˜¯åˆ›å»º workInProgress
â€¢ workInProgress.alternate æŒ‡å‘ currentï¼ˆåŒç¼“å­˜ï¼‰
â€¢ æ–°çš„ props ä¼šé€šè¿‡ pendingProps ä¼ å…¥


placeSingleChild - æ ‡è®°å•ä¸ªå­èŠ‚ç‚¹:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function placeSingleChild(newFiber: Fiber): Fiber {
  // åªåœ¨éœ€è¦è¿½è¸ªå‰¯ä½œç”¨ + æ²¡æœ‰ alternate æ—¶æ ‡è®° Placement
  if (shouldTrackSideEffects && newFiber.alternate === null) {
    newFiber.flags |= Placement;
  }
  return newFiber;
}

è¯´æ˜:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ shouldTrackSideEffectsï¼šæ›´æ–°æ—¶ä¸º trueï¼Œé¦–æ¬¡æŒ‚è½½æ—¶ä¸º false
â€¢ alternate === nullï¼šè¯´æ˜æ˜¯å…¨æ–°åˆ›å»ºçš„èŠ‚ç‚¹
â€¢ åªæœ‰"æ›´æ–°é˜¶æ®µçš„æ–°èŠ‚ç‚¹"æ‰éœ€è¦æ ‡è®° Placement


shouldTrackSideEffects çš„æ¥æº:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ReactChildFiber.new.js
export const reconcileChildFibers = ChildReconciler(true);  // æ›´æ–°
export const mountChildFibers = ChildReconciler(false);     // é¦–æ¬¡æŒ‚è½½

function ChildReconciler(shouldTrackSideEffects) {
  // shouldTrackSideEffects åœ¨é—­åŒ…ä¸­ä¿å­˜
  // true â†’ ä¼šç»™æ–°èŠ‚ç‚¹æ‰“ Placement æ ‡è®°
  // false â†’ ä¸æ‰“æ ‡è®°ï¼ˆé¦–æ¬¡æŒ‚è½½æ•´æ£µæ ‘éƒ½è¦æ’å…¥ï¼Œä¸éœ€è¦å•ç‹¬æ ‡è®°ï¼‰
}
`;

// ============================================================
// Part 5: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 2 é¢è¯•è¦ç‚¹

Q1: å•èŠ‚ç‚¹ Diff çš„æ¯”è¾ƒé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ
A: 1. å…ˆæ¯”è¾ƒ key
   2. key ç›¸åŒå†æ¯”è¾ƒ type
   3. key ç›¸åŒ + type ç›¸åŒ â†’ å¤ç”¨
   4. key ç›¸åŒ + type ä¸åŒ â†’ åˆ é™¤æ‰€æœ‰æ—§èŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹
   5. key ä¸åŒ â†’ åˆ é™¤å½“å‰æ—§èŠ‚ç‚¹ï¼Œç»§ç»­æ‰¾

Q2: ä¸ºä»€ä¹ˆ key ç›¸åŒä½† type ä¸åŒæ—¶è¦åˆ é™¤æ‰€æœ‰æ—§èŠ‚ç‚¹ï¼Ÿ
A: key æ˜¯èŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†ã€‚
   å¦‚æœ key åŒ¹é…ä½† type ä¸åŒï¼Œè¯´æ˜è¿™ä¸ª"æ§½ä½"çš„å†…å®¹å®Œå…¨å˜äº†ã€‚
   React è®¤ä¸ºåé¢çš„èŠ‚ç‚¹ä¹Ÿå¯èƒ½å˜äº†ï¼Œä¸å¦‚ç›´æ¥åˆ é™¤é‡å»ºæ›´ç®€å•ã€‚
   è¿™æ˜¯ä¸€ç§å¯å‘å¼ä¼˜åŒ–ï¼šé€šå¸¸ç»“æ„å˜åŒ–æ—¶ï¼Œå…„å¼ŸèŠ‚ç‚¹ä¹Ÿä¼šå˜åŒ–ã€‚

Q3: reconcileSingleElement å’Œ reconcileSingleTextNode çš„åŒºåˆ«ï¼Ÿ
A: - reconcileSingleElementï¼šå¤„ç†å•ä¸ª ReactElementï¼ˆç»„ä»¶/DOM å…ƒç´ ï¼‰
   - reconcileSingleTextNodeï¼šå¤„ç†çº¯æ–‡æœ¬ï¼ˆstring/numberï¼‰
   æ–‡æœ¬èŠ‚ç‚¹æ›´ç®€å•ï¼Œåªéœ€æ£€æŸ¥æ—§èŠ‚ç‚¹æ˜¯å¦ä¹Ÿæ˜¯ HostTextã€‚

Q4: useFiber æ˜¯ç›´æ¥å¤ç”¨ Fiber å¯¹è±¡å—ï¼Ÿ
A: ä¸æ˜¯ã€‚useFiber è°ƒç”¨ createWorkInProgress åˆ›å»ºæ–°çš„ workInProgress Fiberï¼Œ
   å¹¶å»ºç«‹ alternate è¿æ¥ã€‚è¿™æ˜¯åŒç¼“å­˜æœºåˆ¶çš„ä¸€éƒ¨åˆ†ã€‚
   æ—§ Fiber ä¿ç•™ä¸º currentï¼Œæ–° Fiber ä½œä¸º workInProgressã€‚

Q5: shouldTrackSideEffects ä»€ä¹ˆæ—¶å€™ä¸º trueï¼Ÿ
A: - æ›´æ–°æ¸²æŸ“æ—¶ä¸º trueï¼ˆreconcileChildFibersï¼‰
   - é¦–æ¬¡æŒ‚è½½æ—¶ä¸º falseï¼ˆmountChildFibersï¼‰
   é¦–æ¬¡æŒ‚è½½æ—¶æ•´æ£µæ ‘éƒ½è¦æ’å…¥ï¼Œä¸éœ€è¦ç»™æ¯ä¸ªèŠ‚ç‚¹æ‰“ Placement æ ‡è®°ï¼›
   æ›´æ–°æ—¶åªæœ‰æ–°å¢/ç§»åŠ¨çš„èŠ‚ç‚¹éœ€è¦æ ‡è®°ã€‚

Q6: æ–‡æœ¬èŠ‚ç‚¹æ˜¯å¦‚ä½• Diff çš„ï¼Ÿ
A: 1. å¦‚æœæ—§çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹æ˜¯ HostText â†’ å¤ç”¨ï¼Œåªæ›´æ–°æ–‡æœ¬å†…å®¹
   2. å¦åˆ™ â†’ åˆ é™¤æ‰€æœ‰æ—§èŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°çš„ HostText
   æ–‡æœ¬èŠ‚ç‚¹æ²¡æœ‰ keyï¼ŒåªæŒ‰"æ˜¯å¦æ˜¯æ–‡æœ¬ç±»å‹"åˆ¤æ–­å¤ç”¨ã€‚
`;

export {
  reconcileSingleElement,
  singleElementScenarios,
  textNodeDiff,
  reuseAndPlaceFunctions,
  interviewPoints,
};
