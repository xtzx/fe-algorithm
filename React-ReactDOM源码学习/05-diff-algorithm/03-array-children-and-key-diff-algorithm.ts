/**
 * ============================================================
 * ğŸ“š Phase 5: Diff ç®—æ³• - Part 3: æ•°ç»„ Children ä¸ Key Diff ç®—æ³•
 * ============================================================
 *
 * ğŸ“ æ ¸å¿ƒæºç ä½ç½®:
 * - packages/react-reconciler/src/ReactChildFiber.new.js
 *   - reconcileChildrenArray (Line 736)
 *   - placeChild (Line 329)
 *   - mapRemainingChildren (Line 318)
 *   - updateFromMap (Line 518)
 *
 * â±ï¸ é¢„è®¡æ—¶é—´ï¼š2-3 å°æ—¶
 * ğŸ¯ é¢è¯•æƒé‡ï¼šâ­â­â­â­â­
 */

// ============================================================
// Part 1: reconcileChildrenArray æ•´ä½“æµç¨‹
// ============================================================

/**
 * ğŸ“Š æ•°ç»„ Diff çš„æ•´ä½“æµç¨‹
 */

const arrayDiffOverview = `
ğŸ“Š reconcileChildrenArray - æ•°ç»„ Diff æ•´ä½“æµç¨‹

æºç ä½ç½®: packages/react-reconciler/src/ReactChildFiber.new.js (Line 736)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å½“æ–°çš„ children æ˜¯æ•°ç»„æ—¶è°ƒç”¨æ­¤å‡½æ•°ã€‚è¿™æ˜¯æœ€å¤æ‚çš„ Diff åœºæ™¯ã€‚


ç®—æ³•åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   é˜¶æ®µ 1: é¡ºåºæ¯”è¾ƒï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                             â”‚
â”‚   åŒæ—¶éå†æ–°æ•°ç»„å’Œæ—§é“¾è¡¨ï¼ŒæŒ‰é¡ºåºæ¯”è¾ƒï¼š                                      â”‚
â”‚                                                                             â”‚
â”‚   æ—§:  [A] â†’ [B] â†’ [C] â†’ [D]                                               â”‚
â”‚         â†“     â†“     â†“     â†“                                                â”‚
â”‚   æ–°:  [A]   [B]   [C]   [D]                                               â”‚
â”‚                                                                             â”‚
â”‚   â€¢ æ¯”è¾ƒ newChildren[i] å’Œ oldFiber                                        â”‚
â”‚   â€¢ key å’Œ type éƒ½ç›¸åŒ â†’ å¤ç”¨                                               â”‚
â”‚   â€¢ ä¸åŒ â†’ è·³å‡ºå¾ªç¯ï¼Œè¿›å…¥é˜¶æ®µ 2                                             â”‚
â”‚                                                                             â”‚
â”‚   è¿™ä¸ªé˜¶æ®µå¤„ç†"å¤§éƒ¨åˆ†èŠ‚ç‚¹æ²¡å˜åŒ–"çš„å¸¸è§æƒ…å†µï¼ŒO(min(n,m))                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   é˜¶æ®µ 2: ä½¿ç”¨ Map å¤„ç†å‰©ä½™èŠ‚ç‚¹                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                             â”‚
â”‚   å½“é¡ºåºæ¯”è¾ƒä¸­æ–­åï¼š                                                        â”‚
â”‚                                                                             â”‚
â”‚   1. å°†å‰©ä½™çš„æ—§èŠ‚ç‚¹æ”¾å…¥ Map (key â†’ Fiber)                                   â”‚
â”‚   2. éå†å‰©ä½™çš„æ–°èŠ‚ç‚¹ï¼Œä» Map ä¸­æŸ¥æ‰¾å¯å¤ç”¨çš„                                â”‚
â”‚   3. æ²¡æœ‰æ‰¾åˆ°çš„æ–°èŠ‚ç‚¹ â†’ åˆ›å»º                                                â”‚
â”‚   4. Map ä¸­å‰©ä½™çš„æ—§èŠ‚ç‚¹ â†’ åˆ é™¤                                              â”‚
â”‚                                                                             â”‚
â”‚   è¿™ä¸ªé˜¶æ®µå¤„ç†"èŠ‚ç‚¹é¡ºåºå˜åŒ–"çš„æƒ…å†µ                                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ä¸ºä»€ä¹ˆæ˜¯è¿™ç§è®¾è®¡ï¼Ÿ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æºç æ³¨é‡Šï¼ˆLine 742-756ï¼‰è¯´æ˜ï¼š

"This algorithm can't optimize by searching from both ends since we
don't have backpointers on fibers."

â€¢ Fiber é“¾è¡¨æ˜¯å•å‘çš„ï¼ˆåªæœ‰ siblingï¼Œæ²¡æœ‰ prevSiblingï¼‰
â€¢ æ— æ³•åƒ Vue é‚£æ ·ä»ä¸¤ç«¯åŒæ—¶éå†
â€¢ ä½†å¯¹äºå¤§å¤šæ•°åœºæ™¯ï¼ˆåˆ—è¡¨æœ«å°¾å¢åˆ ï¼‰ï¼Œç¬¬ä¸€é˜¶æ®µå·²ç»è¶³å¤Ÿé«˜æ•ˆ
`;

// ============================================================
// Part 2: é˜¶æ®µ 1 - é¡ºåºæ¯”è¾ƒ
// ============================================================

/**
 * ğŸ“Š é˜¶æ®µ 1: é¡ºåºæ¯”è¾ƒ
 */

const phase1SequentialComparison = `
ğŸ“Š é˜¶æ®µ 1: é¡ºåºæ¯”è¾ƒï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰

æºç ä½ç½®: ReactChildFiber.new.js (Line 773-820)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let oldFiber = currentFirstChild;
let lastPlacedIndex = 0;
let newIdx = 0;
let nextOldFiber = null;

// â­ é˜¶æ®µ 1ï¼šé¡ºåºéå†ï¼Œå°è¯•å¤ç”¨
for (; oldFiber !== null && newIdx < newChildren.length; newIdx++) {
  // å¤„ç† index ä¸è¿ç»­çš„æƒ…å†µï¼ˆæœ‰ null å­èŠ‚ç‚¹ï¼‰
  if (oldFiber.index > newIdx) {
    nextOldFiber = oldFiber;
    oldFiber = null;
  } else {
    nextOldFiber = oldFiber.sibling;
  }

  // â­ å°è¯•æ›´æ–°/å¤ç”¨å½“å‰ä½ç½®çš„èŠ‚ç‚¹
  const newFiber = updateSlot(
    returnFiber,
    oldFiber,
    newChildren[newIdx],
    lanes,
  );

  // newFiber === null è¯´æ˜ key ä¸åŒ¹é…ï¼Œæ— æ³•å¤ç”¨
  if (newFiber === null) {
    if (oldFiber === null) {
      oldFiber = nextOldFiber;
    }
    break;  // â­ è·³å‡ºå¾ªç¯ï¼Œè¿›å…¥é˜¶æ®µ 2
  }

  // å¤„ç†æˆåŠŸå¤ç”¨ä½† key åŒ¹é…ä½† type ä¸åŒ¹é…çš„æƒ…å†µ
  if (shouldTrackSideEffects) {
    if (oldFiber && newFiber.alternate === null) {
      deleteChild(returnFiber, oldFiber);
    }
  }

  // æ ‡è®°ä½ç½®
  lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);

  // æ„å»ºæ–°çš„ Fiber é“¾è¡¨
  if (previousNewFiber === null) {
    resultingFirstChild = newFiber;
  } else {
    previousNewFiber.sibling = newFiber;
  }
  previousNewFiber = newFiber;
  oldFiber = nextOldFiber;
}


updateSlot çš„é€»è¾‘:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateSlot(returnFiber, oldFiber, newChild, lanes) {
  // è·å–æ—§èŠ‚ç‚¹çš„ key
  const key = oldFiber !== null ? oldFiber.key : null;

  // æ–°èŠ‚ç‚¹æ˜¯æ–‡æœ¬
  if (typeof newChild === 'string' || typeof newChild === 'number') {
    if (key !== null) {
      return null;  // æ—§èŠ‚ç‚¹æœ‰ keyï¼Œæ–‡æœ¬æ²¡æœ‰ keyï¼Œä¸åŒ¹é…
    }
    return updateTextNode(returnFiber, oldFiber, newChild, lanes);
  }

  // æ–°èŠ‚ç‚¹æ˜¯ ReactElement
  if (typeof newChild === 'object' && newChild !== null) {
    if (newChild.$$typeof === REACT_ELEMENT_TYPE) {
  if (newChild.key === key) {
        // â­ key åŒ¹é…ï¼å°è¯•å¤ç”¨
    return updateElement(returnFiber, oldFiber, newChild, lanes);
  } else {
        // â­ key ä¸åŒ¹é…ï¼Œè¿”å› null è¡¨ç¤ºæ— æ³•å¤ç”¨
    return null;
  }
    }
    // ... å…¶ä»–ç±»å‹å¤„ç†
  }

  return null;
}


å›¾ç¤º: é˜¶æ®µ 1 çš„å·¥ä½œè¿‡ç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ—§: [A] â†’ [B] â†’ [C] â†’ [D] â†’ [E]
æ–°: [A', B', X, D', E']

ç¬¬ 1 è½® (newIdx=0):
oldFiber=[A], newChild=[A']
key ç›¸åŒ, type ç›¸åŒ â†’ å¤ç”¨, æ›´æ–° props

ç¬¬ 2 è½® (newIdx=1):
oldFiber=[B], newChild=[B']
key ç›¸åŒ, type ç›¸åŒ â†’ å¤ç”¨, æ›´æ–° props

ç¬¬ 3 è½® (newIdx=2):
oldFiber=[C], newChild=[X]
key ä¸åŒ â†’ newFiber = null â†’ break!

æ­¤æ—¶çŠ¶æ€:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
newIdx = 2
oldFiber = [C]
å·²å¤„ç†: [A'], [B'] (å¤ç”¨)
å¾…å¤„ç†: æ—§ [C][D][E], æ–° [X][D'][E']

è¿›å…¥é˜¶æ®µ 2...
`;

// ============================================================
// Part 3: é˜¶æ®µ 2 - ä½¿ç”¨ Map å¤„ç†å‰©ä½™èŠ‚ç‚¹
// ============================================================

/**
 * ğŸ“Š é˜¶æ®µ 2: Map å¤„ç†
 */

const phase2MapProcessing = `
ğŸ“Š é˜¶æ®µ 2: ä½¿ç”¨ Map å¤„ç†å‰©ä½™èŠ‚ç‚¹

æºç ä½ç½®: ReactChildFiber.new.js (Line 856-900)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åœ¨é˜¶æ®µ 1 ç»“æŸåï¼Œå¯èƒ½å‡ºç°å‡ ç§æƒ…å†µï¼š


æƒ…å†µ A: æ–°æ•°ç»„éå†å®Œäº†ï¼ˆnewIdx === newChildren.lengthï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if (newIdx === newChildren.length) {
  // åˆ é™¤å‰©ä½™çš„æ—§èŠ‚ç‚¹
  deleteRemainingChildren(returnFiber, oldFiber);
  return resultingFirstChild;
}

ç¤ºä¾‹:
æ—§: [A] â†’ [B] â†’ [C] â†’ [D]
æ–°: [A, B]

ç»“æœ: å¤ç”¨ A, Bï¼›åˆ é™¤ C, D


æƒ…å†µ B: æ—§é“¾è¡¨éå†å®Œäº†ï¼ˆoldFiber === nullï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if (oldFiber === null) {
  // å‰©ä½™çš„æ–°èŠ‚ç‚¹éƒ½éœ€è¦åˆ›å»º
  for (; newIdx < newChildren.length; newIdx++) {
    const newFiber = createChild(returnFiber, newChildren[newIdx], lanes);
    if (newFiber === null) continue;
    lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);
    // ... æ„å»ºé“¾è¡¨
  }
  return resultingFirstChild;
}

ç¤ºä¾‹:
æ—§: [A] â†’ [B]
æ–°: [A, B, C, D]

ç»“æœ: å¤ç”¨ A, Bï¼›åˆ›å»º C, D


æƒ…å†µ C: ä¸¤è¾¹éƒ½æœ‰å‰©ä½™ï¼ˆéœ€è¦ Mapï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// 1. å°†å‰©ä½™æ—§èŠ‚ç‚¹æ”¾å…¥ Map
const existingChildren = mapRemainingChildren(returnFiber, oldFiber);

// 2. éå†å‰©ä½™æ–°èŠ‚ç‚¹ï¼Œä» Map ä¸­æŸ¥æ‰¾
for (; newIdx < newChildren.length; newIdx++) {
  const newFiber = updateFromMap(
    existingChildren,
    returnFiber,
    newIdx,
    newChildren[newIdx],
    lanes,
  );

  if (newFiber !== null) {
    if (shouldTrackSideEffects) {
      if (newFiber.alternate !== null) {
        // æ‰¾åˆ°äº†å¯å¤ç”¨çš„ï¼Œä» Map ä¸­åˆ é™¤
        existingChildren.delete(
          newFiber.key === null ? newIdx : newFiber.key,
        );
      }
    }
    lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);
    // ... æ„å»ºé“¾è¡¨
  }
}

// 3. Map ä¸­å‰©ä½™çš„èŠ‚ç‚¹éƒ½è¦åˆ é™¤
if (shouldTrackSideEffects) {
existingChildren.forEach(child => deleteChild(returnFiber, child));
}


mapRemainingChildren çš„å®ç°:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function mapRemainingChildren(
  returnFiber: Fiber,
  currentFirstChild: Fiber,
): Map<string | number, Fiber> {
  const existingChildren: Map<string | number, Fiber> = new Map();

  let existingChild = currentFirstChild;
  while (existingChild !== null) {
    // â­ ä½¿ç”¨ key æˆ– index ä½œä¸º Map çš„é”®
    if (existingChild.key !== null) {
      existingChildren.set(existingChild.key, existingChild);
    } else {
      existingChildren.set(existingChild.index, existingChild);
    }
    existingChild = existingChild.sibling;
  }
  return existingChildren;
}


å›¾ç¤º: é˜¶æ®µ 2 çš„ Map å¤„ç†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ¥ç»­é˜¶æ®µ 1 çš„çŠ¶æ€:
newIdx = 2
æ—§å‰©ä½™: [C] â†’ [D] â†’ [E]
æ–°å‰©ä½™: [X, D', E']

Step 1: æ„å»º Map
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Map {
  'C' => Fiber[C],
  'D' => Fiber[D],
  'E' => Fiber[E]
}

Step 2: éå†æ–°å‰©ä½™ [X, D', E']
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

å¤„ç† X:
  Map.get('X') â†’ undefined
  åˆ›å»ºæ–° Fiberï¼Œæ ‡è®° Placement

å¤„ç† D':
  Map.get('D') â†’ Fiber[D]
  å¤ç”¨ Fiber[D]ï¼Œä» Map åˆ é™¤ 'D'
  è°ƒç”¨ placeChild åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨

å¤„ç† E':
  Map.get('E') â†’ Fiber[E]
  å¤ç”¨ Fiber[E]ï¼Œä» Map åˆ é™¤ 'E'

Step 3: åˆ é™¤ Map ä¸­å‰©ä½™çš„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Map { 'C' => Fiber[C] } â†’ æ ‡è®° Fiber[C] ä¸º Deletion
`;

// ============================================================
// Part 4: placeChild - ç§»åŠ¨æ£€æµ‹
// ============================================================

/**
 * ğŸ“Š placeChild - æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨
 */

const placeChildFunction = `
ğŸ“Š placeChild - æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨

æºç ä½ç½®: ReactChildFiber.new.js (Line 329-357)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function placeChild(
  newFiber: Fiber,
  lastPlacedIndex: number,
  newIndex: number,
): number {
  newFiber.index = newIndex;

  if (!shouldTrackSideEffects) {
    newFiber.flags |= Forked;
    return lastPlacedIndex;
  }

  const current = newFiber.alternate;
  if (current !== null) {
    // â­ æœ‰ alternateï¼Œè¯´æ˜æ˜¯å¤ç”¨çš„èŠ‚ç‚¹
    const oldIndex = current.index;

    if (oldIndex < lastPlacedIndex) {
      // â­ æ—§ä½ç½®åœ¨ lastPlacedIndex å·¦è¾¹ï¼Œéœ€è¦ç§»åŠ¨
      newFiber.flags |= Placement;
      return lastPlacedIndex;
    } else {
      // â­ æ—§ä½ç½®åœ¨ lastPlacedIndex å³è¾¹ï¼Œä¸éœ€è¦ç§»åŠ¨
      return oldIndex;
    }
  } else {
    // â­ æ²¡æœ‰ alternateï¼Œæ˜¯æ–°å»ºçš„èŠ‚ç‚¹
    newFiber.flags |= Placement;
    return lastPlacedIndex;
  }
}


å…³é”®ç†è§£: lastPlacedIndex
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

lastPlacedIndex è®°å½•çš„æ˜¯ï¼š
"åœ¨æ–°åˆ—è¡¨ä¸­ï¼Œä¸Šä¸€ä¸ªå¤ç”¨çš„èŠ‚ç‚¹åœ¨æ—§åˆ—è¡¨ä¸­çš„ä½ç½®"

åˆ¤æ–­é€»è¾‘:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ å¦‚æœå½“å‰å¤ç”¨èŠ‚ç‚¹çš„ oldIndex < lastPlacedIndex
  â†’ è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹åœ¨æ—§åˆ—è¡¨ä¸­çš„ä½ç½®ï¼Œæ¯”å·²å¤„ç†çš„æŸä¸ªèŠ‚ç‚¹è¿˜é å‰
  â†’ ä½†åœ¨æ–°åˆ—è¡¨ä¸­å®ƒæ’åœ¨åé¢
  â†’ éœ€è¦ç§»åŠ¨ï¼

â€¢ å¦‚æœ oldIndex >= lastPlacedIndex
  â†’ èŠ‚ç‚¹çš„ç›¸å¯¹é¡ºåºæ²¡å˜
  â†’ ä¸éœ€è¦ç§»åŠ¨


å›¾è§£ä¾‹å­ 1: æ— éœ€ç§»åŠ¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ—§: [A(0), B(1), C(2)]
æ–°: [A, B, C]

éå†æ–°åˆ—è¡¨:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
A: oldIndex=0, lastPlacedIndex=0
   0 >= 0 â†’ ä¸ç§»åŠ¨, lastPlacedIndex = 0

B: oldIndex=1, lastPlacedIndex=0
   1 >= 0 â†’ ä¸ç§»åŠ¨, lastPlacedIndex = 1

C: oldIndex=2, lastPlacedIndex=1
   2 >= 1 â†’ ä¸ç§»åŠ¨, lastPlacedIndex = 2

ç»“æœ: æ—  Placement æ ‡è®°


å›¾è§£ä¾‹å­ 2: éœ€è¦ç§»åŠ¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ—§: [A(0), B(1), C(2)]
æ–°: [C, A, B]

éå†æ–°åˆ—è¡¨:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
C: oldIndex=2, lastPlacedIndex=0
   2 >= 0 â†’ ä¸ç§»åŠ¨, lastPlacedIndex = 2

A: oldIndex=0, lastPlacedIndex=2
   0 < 2 â†’ â­ éœ€è¦ç§»åŠ¨! flags |= Placement

B: oldIndex=1, lastPlacedIndex=2
   1 < 2 â†’ â­ éœ€è¦ç§»åŠ¨! flags |= Placement

ç»“æœ: A å’Œ B æ ‡è®° Placementï¼ŒC ä¸éœ€è¦ç§»åŠ¨

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   æ—§ DOM:  [A] [B] [C]                                                      â”‚
â”‚                                                                             â”‚
â”‚   React çš„å¤„ç†ç­–ç•¥:                                                          â”‚
â”‚   â€¢ C ä¸åŠ¨ï¼ˆç›¸å¯¹ä½ç½®å¯¹äº†ï¼‰                                                  â”‚
â”‚   â€¢ æŠŠ A ç§»åŠ¨åˆ° C åé¢                                                      â”‚
â”‚   â€¢ æŠŠ B ç§»åŠ¨åˆ° A åé¢                                                      â”‚
â”‚                                                                             â”‚
â”‚   æ–° DOM:  [C] [A] [B]                                                      â”‚
â”‚                                                                             â”‚
â”‚   æ³¨æ„: è¿™ä¸æ˜¯æœ€ä¼˜è§£ï¼æœ€ä¼˜è§£æ˜¯åªç§»åŠ¨ C åˆ°æœ€å‰é¢ã€‚                           â”‚
â”‚   ä½† React é€‰æ‹©äº†å®ç°ç®€å• + å¤§å¤šæ•°åœºæ™¯å¤Ÿç”¨çš„ç­–ç•¥ã€‚                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`;

// ============================================================
// Part 5: çœŸå®æ¡ˆä¾‹ - åˆ—è¡¨å¢åˆ 
// ============================================================

/**
 * ğŸ“Š çœŸå®æ¡ˆä¾‹ï¼šåˆ—è¡¨å¢åˆ 
 */

const realCaseListModification = `
ğŸ“Š çœŸå®æ¡ˆä¾‹ Aï¼šåˆ—è¡¨å¢åˆ 

åœºæ™¯:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åˆå§‹åˆ—è¡¨:
items = [{id: 1, text: 'A'}, {id: 2, text: 'B'}, {id: 3, text: 'C'}]

æ›´æ–°å:
items = [{id: 2, text: 'B'}, {id: 3, text: 'C'}, {id: 4, text: 'D'}]

// åˆ é™¤ id=1ï¼Œæ–°å¢ id=4


æƒ…å†µ 1: ä½¿ç”¨ id ä½œä¸º key
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{items.map(item => <li key={item.id}>{item.text}</li>)}

æ—§ Fiber é“¾è¡¨:
[key=1, text=A] â†’ [key=2, text=B] â†’ [key=3, text=C]

æ–° ReactElement æ•°ç»„:
[{key=2, text=B}, {key=3, text=C}, {key=4, text=D}]

Diff è¿‡ç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

é˜¶æ®µ 1 (é¡ºåºæ¯”è¾ƒ):

newIdx=0, oldFiber=key=1
  newChild.key=2 !== oldFiber.key=1
  â†’ break! è¿›å…¥é˜¶æ®µ 2

é˜¶æ®µ 2 (Map å¤„ç†):

Map { 1 => Fiber[A], 2 => Fiber[B], 3 => Fiber[C] }

å¤„ç† newIdx=0, key=2:
  Map.get(2) â†’ Fiber[B] âœ“
  å¤ç”¨ Fiber[B], oldIndex=1
  placeChild: 1 >= 0 â†’ ä¸ç§»åŠ¨, lastPlacedIndex=1
  Map.delete(2)

å¤„ç† newIdx=1, key=3:
  Map.get(3) â†’ Fiber[C] âœ“
  å¤ç”¨ Fiber[C], oldIndex=2
  placeChild: 2 >= 1 â†’ ä¸ç§»åŠ¨, lastPlacedIndex=2
  Map.delete(3)

å¤„ç† newIdx=2, key=4:
  Map.get(4) â†’ undefined
  åˆ›å»ºæ–° Fiber[D], æ ‡è®° Placement

Map å‰©ä½™: { 1 => Fiber[A] }
  â†’ æ ‡è®° Fiber[A] ä¸º Deletion

ç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Fiber[A]: Deletion
â€¢ Fiber[B]: å¤ç”¨ï¼Œæ— ç§»åŠ¨
â€¢ Fiber[C]: å¤ç”¨ï¼Œæ— ç§»åŠ¨
â€¢ Fiber[D]: Placementï¼ˆæ–°å»ºï¼‰

DOM æ“ä½œ: 1 æ¬¡åˆ é™¤ + 1 æ¬¡æ’å…¥ = 2 æ¬¡æ“ä½œ âœ…


æƒ…å†µ 2: ä¸å†™ keyï¼ˆä½¿ç”¨ indexï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{items.map(item => <li>{item.text}</li>)}

æ—§ Fiber é“¾è¡¨:
[index=0, text=A] â†’ [index=1, text=B] â†’ [index=2, text=C]

æ–° ReactElement æ•°ç»„:
[{text=B}, {text=C}, {text=D}]  // éšå¼ index=0,1,2

Diff è¿‡ç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

é˜¶æ®µ 1 (é¡ºåºæ¯”è¾ƒ):

newIdx=0, oldFiber=index=0
  key: null === null âœ“
  type: 'li' === 'li' âœ“
  â†’ å¤ç”¨! ä½† text: A â†’ B (æ›´æ–° props)

newIdx=1, oldFiber=index=1
  key: null === null âœ“
  type: 'li' === 'li' âœ“
  â†’ å¤ç”¨! ä½† text: B â†’ C (æ›´æ–° props)

newIdx=2, oldFiber=index=2
  key: null === null âœ“
  type: 'li' === 'li' âœ“
  â†’ å¤ç”¨! ä½† text: C â†’ D (æ›´æ–° props)

ç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ æ‰€æœ‰ 3 ä¸ªèŠ‚ç‚¹éƒ½"å¤ç”¨"äº†ï¼Œä½† props å…¨éƒ¨æ›´æ–°
â€¢ æ²¡æœ‰åˆ é™¤ï¼Œæ²¡æœ‰æ–°å»º

DOM æ“ä½œ: 3 æ¬¡æ–‡æœ¬æ›´æ–° âŒ

âš ï¸ é—®é¢˜:
â€¢ è¡¨é¢ä¸Š"å¤ç”¨"äº†ï¼Œå®é™…ä¸Šå…¨éƒ¨å†…å®¹éƒ½å˜äº†
â€¢ å¦‚æœèŠ‚ç‚¹æœ‰å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚ input valueï¼‰ï¼Œä¼šå‡ºé—®é¢˜
`;

// ============================================================
// Part 6: é¢è¯•è¦ç‚¹
// ============================================================

const interviewPoints = `
ğŸ’¡ Part 3 é¢è¯•è¦ç‚¹

Q1: React æ•°ç»„ Diff åˆ†ä¸ºå“ªå‡ ä¸ªé˜¶æ®µï¼Ÿ
A: ä¸¤ä¸ªé˜¶æ®µï¼š
   1. é¡ºåºæ¯”è¾ƒï¼šåŒæ—¶éå†æ–°æ•°ç»„å’Œæ—§é“¾è¡¨ï¼ŒæŒ‰é¡ºåºæ¯”è¾ƒï¼Œå°½å¯èƒ½å¤ç”¨
   2. Map å¤„ç†ï¼šå°†å‰©ä½™æ—§èŠ‚ç‚¹æ”¾å…¥ Mapï¼Œé€šè¿‡ key æŸ¥æ‰¾å¯å¤ç”¨èŠ‚ç‚¹

Q2: ä¸ºä»€ä¹ˆ React ä¸ä½¿ç”¨åŒç«¯æ¯”è¾ƒç®—æ³•ï¼Ÿ
A: Fiber é“¾è¡¨æ˜¯å•å‘çš„ï¼Œåªæœ‰ sibling æŒ‡é’ˆï¼Œæ²¡æœ‰ prevSiblingã€‚
   æ— æ³•åƒ Vue é‚£æ ·ä»ä¸¤ç«¯åŒæ—¶éå†ã€‚
   ä½†å¯¹äºå¤§å¤šæ•°åœºæ™¯ï¼ˆæœ«å°¾å¢åˆ ï¼‰ï¼Œé¡ºåºæ¯”è¾ƒå·²ç»è¶³å¤Ÿé«˜æ•ˆã€‚

Q3: lastPlacedIndex çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
A: è®°å½•"ä¸Šä¸€ä¸ªå¤ç”¨èŠ‚ç‚¹åœ¨æ—§åˆ—è¡¨ä¸­çš„ä½ç½®"ï¼Œç”¨äºæ£€æµ‹èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨ã€‚
   å¦‚æœå½“å‰èŠ‚ç‚¹çš„ oldIndex < lastPlacedIndexï¼Œè¯´æ˜éœ€è¦ç§»åŠ¨ã€‚

Q4: ä¸å†™ key æ—¶ React ç”¨ä»€ä¹ˆä½œä¸ºæ ‡è¯†ï¼Ÿ
A: ä½¿ç”¨æ•°ç»„çš„ index ä½œä¸ºéšå¼ keyã€‚
   è¿™åœ¨åˆ—è¡¨å˜åŒ–æ—¶ä¼šå¯¼è‡´"é”™è¯¯å¤ç”¨"ï¼š
   â€¢ æœ¬è´¨ä¸åŒçš„èŠ‚ç‚¹å› ä¸º index ç›¸åŒè€Œå¤ç”¨
   â€¢ éœ€è¦æ›´æ–°æ‰€æœ‰ propsï¼Œè€Œä¸æ˜¯æœ€å°åŒ–æ›´æ–°

Q5: ä¸ºä»€ä¹ˆä½¿ç”¨ index ä½œä¸º key æ˜¯ä¸æ¨èçš„ï¼Ÿ
A: 1. åˆ—è¡¨é¡¹é‡æ–°æ’åºæ—¶ï¼Œindex ä¼šå˜åŒ–ï¼Œå¯¼è‡´é”™è¯¯å¤ç”¨
   2. åˆ—è¡¨é¦–éƒ¨å¢åˆ æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„ index éƒ½å˜äº†
   3. æœ‰å†…éƒ¨çŠ¶æ€çš„ç»„ä»¶ï¼ˆå¦‚ inputï¼‰ä¼šå‡ºç°çŠ¶æ€é”™ä¹±
   4. æ€§èƒ½é—®é¢˜ï¼šæœ¬åº”å¤ç”¨çš„èŠ‚ç‚¹å´è¢«"æ›´æ–°"äº†

Q6: React ç§»åŠ¨æ£€æµ‹çš„ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯æœ€ä¼˜çš„å—ï¼Ÿ
A: ç­–ç•¥ï¼šæ‰¾ä¸€ä¸ª"ä¸éœ€è¦ç§»åŠ¨çš„å‚è€ƒèŠ‚ç‚¹"ï¼Œå…¶ä»–èŠ‚ç‚¹ç›¸å¯¹å®ƒç§»åŠ¨ã€‚
   ä¸æ˜¯æœ€ä¼˜çš„ï¼ä¾‹å¦‚ [A,B,C] â†’ [C,A,B]ï¼š
   â€¢ æœ€ä¼˜ï¼šåªç§»åŠ¨ C åˆ°æœ€å‰é¢ï¼ˆ1 æ¬¡ç§»åŠ¨ï¼‰
   â€¢ Reactï¼šç§»åŠ¨ A å’Œ Bï¼ˆ2 æ¬¡ç§»åŠ¨ï¼‰
   è¿™æ˜¯å®ç°ç®€å• vs ç®—æ³•æœ€ä¼˜çš„æƒè¡¡ã€‚
`;

export {
  arrayDiffOverview,
  phase1SequentialComparison,
  phase2MapProcessing,
  placeChildFunction,
  realCaseListModification,
  interviewPoints,
};
