/**
 * ğŸ“ é¢˜ç›®ï¼šæ‰¾åˆ°å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—æ¯å¼‚ä½è¯
 * ğŸ”— é“¾æ¥ï¼šhttps://leetcode.cn/problems/find-all-anagrams-in-a-string/
 * ğŸ·ï¸ éš¾åº¦ï¼šMedium
 * ğŸ·ï¸ æ ‡ç­¾ï¼šå“ˆå¸Œè¡¨ã€å­—ç¬¦ä¸²ã€æ»‘åŠ¨çª—å£
 *
 * ğŸ“‹ é¢˜ç›®æè¿°ï¼š
 * ç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸² s å’Œ pï¼Œæ‰¾åˆ° s ä¸­æ‰€æœ‰ p çš„ å¼‚ä½è¯ çš„å­ä¸²ï¼Œ
 * è¿”å›è¿™äº›å­ä¸²çš„èµ·å§‹ç´¢å¼•ã€‚ä¸è€ƒè™‘ç­”æ¡ˆè¾“å‡ºçš„é¡ºåºã€‚
 *
 * ç¤ºä¾‹ï¼š
 * è¾“å…¥ï¼šs = "cbaebabacd", p = "abc"
 * è¾“å‡ºï¼š[0,6]
 * è§£é‡Šï¼š
 * - èµ·å§‹ç´¢å¼•ç­‰äº 0 çš„å­ä¸²æ˜¯ "cba", å®ƒæ˜¯ "abc" çš„å¼‚ä½è¯
 * - èµ·å§‹ç´¢å¼•ç­‰äº 6 çš„å­ä¸²æ˜¯ "bac", å®ƒæ˜¯ "abc" çš„å¼‚ä½è¯
 */

// ============================================================
// ğŸ’¡ æ€è·¯åˆ†æï¼šè¿™é“é¢˜çš„è§£æ³•æ˜¯æ€ä¹ˆæƒ³å‡ºæ¥çš„ï¼Ÿ
// ============================================================
//
// è¿™æ˜¯ã€Œæ»‘åŠ¨çª—å£ + å“ˆå¸Œè¡¨ã€çš„ç»å…¸é¢˜ï¼
//
// å…³é”®è§‚å¯Ÿï¼š
// - å¼‚ä½è¯é•¿åº¦ç›¸åŒï¼ˆéƒ½æ˜¯ p.lengthï¼‰
// - å¼‚ä½è¯å­—ç¬¦é¢‘ç‡ç›¸åŒ
//
// æ€è·¯ï¼š
// - ç»´æŠ¤ä¸€ä¸ªé•¿åº¦ä¸º p.length çš„æ»‘åŠ¨çª—å£
// - çª—å£å†…çš„å­—ç¬¦é¢‘ç‡ = p çš„å­—ç¬¦é¢‘ç‡ â†’ æ‰¾åˆ°ä¸€ä¸ªå¼‚ä½è¯
//
// ä¼˜åŒ–ï¼š
// - ä¸éœ€è¦æ¯æ¬¡éƒ½å®Œæ•´æ¯”è¾ƒä¸¤ä¸ªé¢‘ç‡è¡¨
// - ç”¨ valid å˜é‡è®°å½•æ»¡è¶³æ¡ä»¶çš„å­—ç¬¦ç§ç±»æ•°

// ============================================================
// è§£æ³•ä¸€ï¼šæ»‘åŠ¨çª—å£ + å“ˆå¸Œè¡¨ï¼ˆæ¨èï¼‰
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n) | ç©ºé—´å¤æ‚åº¦ï¼šO(k)ï¼Œk æ˜¯å­—ç¬¦é›†å¤§å°

/**
 * ğŸ“Š æ‰§è¡Œè¿‡ç¨‹å›¾è§£ï¼š
 *
 * s = "cbaebabacd", p = "abc"
 * need = {a:1, b:1, c:1}, need.size = 3
 *
 *   [c b a] e b a b a c d     window={c:1,b:1,a:1}, valid=3 âœ“ æ‰¾åˆ°!
 *    0
 *
 *    c [b a e] b a b a c d    window={b:1,a:1,e:1}, valid=2
 *
 *    c  b [a e b] a b a c d   window={a:1,e:1,b:1}, valid=2
 *
 *    c  b  a [e b a] b a c d  window={e:1,b:1,a:1}, valid=2
 *
 *    c  b  a  e [b a b] a c d window={b:2,a:1}, valid=1
 *
 *    c  b  a  e  b [a b a] c d window={a:2,b:1}, valid=1
 *
 *    c  b  a  e  b  a [b a c] d window={b:1,a:1,c:1}, valid=3 âœ“ æ‰¾åˆ°!
 *                       6
 *
 *    c  b  a  e  b  a  b [a c d] window={a:1,c:1,d:1}, valid=2
 *
 * ç»“æœï¼š[0, 6]
 */
function findAnagrams_v1(s: string, p: string): number[] {
  const result: number[] = [];
  if (s.length < p.length) return result;

  // ç»Ÿè®¡ p çš„å­—ç¬¦é¢‘ç‡
  const need = new Map<string, number>();
  for (const char of p) {
    need.set(char, (need.get(char) || 0) + 1);
  }

  const window = new Map<string, number>();
  let left = 0;
  let right = 0;
  let valid = 0; // æ»¡è¶³æ¡ä»¶çš„å­—ç¬¦ç§ç±»æ•°

  while (right < s.length) {
    // æ‰©å¼ çª—å£
    const c = s[right];
    right++;

    if (need.has(c)) {
      window.set(c, (window.get(c) || 0) + 1);
      if (window.get(c) === need.get(c)) {
        valid++;
      }
    }

    // å½“çª—å£å¤§å°ç­‰äº p çš„é•¿åº¦æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å¼‚ä½è¯
    while (right - left >= p.length) {
      // å¦‚æœ valid == need.sizeï¼Œæ‰¾åˆ°ä¸€ä¸ªå¼‚ä½è¯
      if (valid === need.size) {
        result.push(left);
      }

      // æ”¶ç¼©çª—å£
      const d = s[left];
      left++;

      if (need.has(d)) {
        if (window.get(d) === need.get(d)) {
          valid--;
        }
        window.set(d, window.get(d)! - 1);
      }
    }
  }

  return result;
}

// ============================================================
// è§£æ³•äºŒï¼šæ•°ç»„è®¡æ•° + å›ºå®šçª—å£
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n) | ç©ºé—´å¤æ‚åº¦ï¼šO(1)
// ğŸ“ ç”¨æ•°ç»„ä»£æ›¿ Mapï¼Œæ•ˆç‡æ›´é«˜ï¼ˆä»…é™å°å†™å­—æ¯ï¼‰

function findAnagrams_v2(s: string, p: string): number[] {
  const result: number[] = [];
  if (s.length < p.length) return result;

  const pCount = new Array(26).fill(0);
  const sCount = new Array(26).fill(0);
  const aCode = 'a'.charCodeAt(0);

  // ç»Ÿè®¡ p çš„å­—ç¬¦é¢‘ç‡
  for (const char of p) {
    pCount[char.charCodeAt(0) - aCode]++;
  }

  // åˆå§‹åŒ–çª—å£
  for (let i = 0; i < p.length; i++) {
    sCount[s.charCodeAt(i) - aCode]++;
  }

  // æ¯”è¾ƒä¸¤ä¸ªæ•°ç»„æ˜¯å¦ç›¸ç­‰
  const isEqual = (): boolean => {
    for (let i = 0; i < 26; i++) {
      if (pCount[i] !== sCount[i]) return false;
    }
    return true;
  };

  // æ£€æŸ¥ç¬¬ä¸€ä¸ªçª—å£
  if (isEqual()) result.push(0);

  // æ»‘åŠ¨çª—å£
  for (let i = p.length; i < s.length; i++) {
    // åŠ å…¥æ–°å­—ç¬¦
    sCount[s.charCodeAt(i) - aCode]++;
    // ç§»é™¤æ—§å­—ç¬¦
    sCount[s.charCodeAt(i - p.length) - aCode]--;

    // æ£€æŸ¥æ˜¯å¦æ˜¯å¼‚ä½è¯
    if (isEqual()) {
      result.push(i - p.length + 1);
    }
  }

  return result;
}

// ============================================================
// è§£æ³•ä¸‰ï¼šå·®å€¼æ•°ç»„ï¼ˆè¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n) | ç©ºé—´å¤æ‚åº¦ï¼šO(1)
// ğŸ“ ç”¨ä¸€ä¸ªæ•°ç»„è®°å½•å·®å€¼ï¼Œå·®å€¼å…¨ä¸º 0 æ—¶æ˜¯å¼‚ä½è¯

function findAnagrams_v3(s: string, p: string): number[] {
  const result: number[] = [];
  if (s.length < p.length) return result;

  // diff[i] = s çª—å£ä¸­å­—ç¬¦ i çš„æ•°é‡ - p ä¸­å­—ç¬¦ i çš„æ•°é‡
  const diff = new Array(26).fill(0);
  const aCode = 'a'.charCodeAt(0);

  // åˆå§‹åŒ–å·®å€¼æ•°ç»„
  for (let i = 0; i < p.length; i++) {
    diff[s.charCodeAt(i) - aCode]++;
    diff[p.charCodeAt(i) - aCode]--;
  }

  // è®°å½•å·®å€¼ä¸ä¸º 0 çš„å­—ç¬¦æ•°é‡
  let diffCount = 0;
  for (const d of diff) {
    if (d !== 0) diffCount++;
  }

  // æ£€æŸ¥ç¬¬ä¸€ä¸ªçª—å£
  if (diffCount === 0) result.push(0);

  // æ»‘åŠ¨çª—å£
  for (let i = p.length; i < s.length; i++) {
    const addIndex = s.charCodeAt(i) - aCode;
    const removeIndex = s.charCodeAt(i - p.length) - aCode;

    // åŠ å…¥æ–°å­—ç¬¦
    if (diff[addIndex] === 0) diffCount++;
    diff[addIndex]++;
    if (diff[addIndex] === 0) diffCount--;

    // ç§»é™¤æ—§å­—ç¬¦
    if (diff[removeIndex] === 0) diffCount++;
    diff[removeIndex]--;
    if (diff[removeIndex] === 0) diffCount--;

    // æ£€æŸ¥æ˜¯å¦æ˜¯å¼‚ä½è¯
    if (diffCount === 0) {
      result.push(i - p.length + 1);
    }
  }

  return result;
}

// ============================================================
// ğŸ”„ è§£æ³•å¯¹æ¯”
// ============================================================
/**
 * | è§£æ³•           | æ—¶é—´  | ç©ºé—´  | ç‰¹ç‚¹                        |
 * |---------------|-------|-------|----------------------------|
 * | æ»‘åŠ¨çª—å£+Map   | O(n)  | O(k)  | é€šç”¨ï¼Œé€‚åˆå„ç§å­—ç¬¦           |
 * | æ•°ç»„è®¡æ•°       | O(n)  | O(1)  | ä»…é™å°å†™å­—æ¯ï¼Œæ¯æ¬¡æ¯”è¾ƒ O(26) |
 * | å·®å€¼æ•°ç»„       | O(n)  | O(1)  | ä»…é™å°å†™å­—æ¯ï¼Œæœ€ä¼˜           |
 */

// ============================================================
// âš ï¸ æ˜“é”™ç‚¹
// ============================================================
/**
 * 1. valid çš„æ›´æ–°æ—¶æœºï¼š
 *    - åªæœ‰å½“ window[c] == need[c] æ—¶æ‰ valid++
 *    - åªæœ‰å½“ window[c] == need[c] æ—¶æ‰ valid--ï¼ˆåœ¨å‡å°‘ä¹‹å‰åˆ¤æ–­ï¼‰
 *
 * 2. çª—å£å¤§å°å›ºå®šä¸º p.length
 *
 * 3. å·®å€¼æ•°ç»„æ³•ä¸­ diffCount çš„æ›´æ–°è¦æ³¨æ„é¡ºåºï¼š
 *    - å…ˆåˆ¤æ–­å˜åŒ–å‰æ˜¯å¦ä¸º 0
 *    - ä¿®æ”¹å€¼
 *    - å†åˆ¤æ–­å˜åŒ–åæ˜¯å¦ä¸º 0
 */

// ============================================================
// ğŸ”— ä¸¾ä¸€åä¸‰ï¼šç›¸ä¼¼é¢˜ç›®
// ============================================================
/**
 * - æœ€å°è¦†ç›–å­ä¸² â†’ æ»‘åŠ¨çª—å£ï¼ˆä¸å›ºå®šå¤§å°ï¼‰
 * - å­—ç¬¦ä¸²çš„æ’åˆ— â†’ æ»‘åŠ¨çª—å£ï¼ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼‰
 * - æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸² â†’ æ»‘åŠ¨çª—å£
 *
 * å…±åŒæ¨¡å¼ï¼šæ»‘åŠ¨çª—å£ + å­—ç¬¦è®¡æ•°
 */

// ============================================================
// ğŸ¢ å‰ç«¯ä¸šåŠ¡åœºæ™¯
// ============================================================
/**
 * 1. æ–‡æœ¬æœç´¢ï¼šæ‰¾å‡ºæ‰€æœ‰åŒ¹é…æŸç§æ¨¡å¼çš„ä½ç½®
 * 2. ä»£ç åˆ†æï¼šæ‰¾å‡ºå˜é‡åçš„å˜å½¢ï¼ˆanagramï¼‰
 * 3. æ‹¼å†™æ£€æŸ¥ï¼šæ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„æ‹¼å†™å˜ä½“
 * 4. æ•°æ®è„±æ•ï¼šè¯†åˆ«æ•æ„Ÿè¯çš„å„ç§å˜å½¢
 */

// å¯¼å‡ºä¸»è§£æ³•
export { findAnagrams_v1, findAnagrams_v2, findAnagrams_v3 };
export default findAnagrams_v1;

