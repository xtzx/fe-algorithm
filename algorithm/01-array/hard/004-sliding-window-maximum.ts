/**
 * ğŸ“ é¢˜ç›®ï¼šæ»‘åŠ¨çª—å£æœ€å¤§å€¼
 * ğŸ”— é“¾æ¥ï¼šhttps://leetcode.cn/problems/sliding-window-maximum/
 * ğŸ·ï¸ éš¾åº¦ï¼šHard
 * ğŸ·ï¸ æ ‡ç­¾ï¼šé˜Ÿåˆ—ã€æ•°ç»„ã€æ»‘åŠ¨çª—å£ã€å•è°ƒé˜Ÿåˆ—ã€å †ï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼‰
 *
 * ğŸ“‹ é¢˜ç›®æè¿°ï¼š
 * ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ numsï¼Œæœ‰ä¸€ä¸ªå¤§å°ä¸º k çš„æ»‘åŠ¨çª—å£ä»æ•°ç»„çš„æœ€å·¦ä¾§ç§»åŠ¨åˆ°æ•°ç»„çš„æœ€å³ä¾§ã€‚
 * ä½ åªå¯ä»¥çœ‹åˆ°åœ¨æ»‘åŠ¨çª—å£å†…çš„ k ä¸ªæ•°å­—ã€‚æ»‘åŠ¨çª—å£æ¯æ¬¡åªå‘å³ç§»åŠ¨ä¸€ä½ã€‚
 * è¿”å›æ»‘åŠ¨çª—å£ä¸­çš„æœ€å¤§å€¼ã€‚
 *
 * ç¤ºä¾‹ï¼š
 * è¾“å…¥ï¼šnums = [1,3,-1,-3,5,3,6,7], k = 3
 * è¾“å‡ºï¼š[3,3,5,5,6,7]
 *
 * è§£é‡Šï¼š
 * çª—å£ä½ç½®                æœ€å¤§å€¼
 * ---------------        -----
 * [1  3  -1] -3  5  3  6  7    3
 *  1 [3  -1  -3] 5  3  6  7    3
 *  1  3 [-1  -3  5] 3  6  7    5
 *  1  3  -1 [-3  5  3] 6  7    5
 *  1  3  -1  -3 [5  3  6] 7    6
 *  1  3  -1  -3  5 [3  6  7]   7
 */

// ============================================================
// ğŸ’¡ æ€è·¯åˆ†æ
// ============================================================
//
// æš´åŠ›è§£æ³•ï¼šæ¯ä¸ªçª—å£éå†æ‰¾æœ€å¤§å€¼ â†’ O(nk)ï¼Œä¼šè¶…æ—¶
//
// ä¼˜åŒ–æ€è·¯ï¼š
// 1. å †ï¼šç»´æŠ¤ä¸€ä¸ªæœ€å¤§å †ï¼Œä½†éœ€è¦å¤„ç†è¿‡æœŸå…ƒç´  â†’ O(n log n)
// 2. å•è°ƒé˜Ÿåˆ—ï¼šç»´æŠ¤ä¸€ä¸ªé€’å‡é˜Ÿåˆ— â†’ O(n) â† æœ€ä¼˜
//
// å•è°ƒé˜Ÿåˆ—çš„æ ¸å¿ƒæ€æƒ³ï¼š
// - é˜Ÿåˆ—ä¸­åªä¿ç•™å¯èƒ½æˆä¸ºæœ€å¤§å€¼çš„å…ƒç´ 
// - å¦‚æœæ–°æ¥çš„å…ƒç´ æ¯”é˜Ÿå°¾å…ƒç´ å¤§ï¼Œé˜Ÿå°¾å…ƒç´ æ°¸è¿œä¸å¯èƒ½æˆä¸ºæœ€å¤§å€¼ï¼Œç›´æ¥ç§»é™¤
// - é˜Ÿå¤´å…ƒç´ å°±æ˜¯å½“å‰çª—å£çš„æœ€å¤§å€¼
// - é˜Ÿåˆ—å­˜å‚¨çš„æ˜¯ä¸‹æ ‡ï¼Œæ–¹ä¾¿åˆ¤æ–­å…ƒç´ æ˜¯å¦è¿‡æœŸ

// ============================================================
// è§£æ³•ä¸€ï¼šå•è°ƒé˜Ÿåˆ—ï¼ˆæ¨èï¼‰
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n) | ç©ºé—´å¤æ‚åº¦ï¼šO(k)

/**
 * ğŸ“Š å•è°ƒé˜Ÿåˆ—æ‰§è¡Œè¿‡ç¨‹å›¾è§£ï¼š
 *
 * nums = [1, 3, -1, -3, 5, 3, 6, 7], k = 3
 *
 * å•è°ƒé˜Ÿåˆ—ï¼ˆå­˜å‚¨ä¸‹æ ‡ï¼Œå¯¹åº”å€¼é€’å‡ï¼‰
 *
 * i=0: nums[0]=1
 *      é˜Ÿåˆ—ä¸ºç©ºï¼Œç›´æ¥å…¥é˜Ÿ
 *      é˜Ÿåˆ—: [0]  (å¯¹åº”å€¼: [1])
 *
 * i=1: nums[1]=3
 *      3 > nums[0]=1ï¼Œå¼¹å‡º0ï¼Œå…¥é˜Ÿ1
 *      é˜Ÿåˆ—: [1]  (å¯¹åº”å€¼: [3])
 *
 * i=2: nums[2]=-1
 *      -1 < nums[1]=3ï¼Œç›´æ¥å…¥é˜Ÿ
 *      é˜Ÿåˆ—: [1, 2]  (å¯¹åº”å€¼: [3, -1])
 *      çª—å£å½¢æˆï¼Œæœ€å¤§å€¼ = nums[é˜Ÿå¤´] = nums[1] = 3 âœ“
 *
 * i=3: nums[3]=-3
 *      -3 < nums[2]=-1ï¼Œç›´æ¥å…¥é˜Ÿ
 *      é˜Ÿåˆ—: [1, 2, 3]  (å¯¹åº”å€¼: [3, -1, -3])
 *      æ£€æŸ¥é˜Ÿå¤´ï¼š1 >= i-k+1=1ï¼Œæœªè¿‡æœŸ
 *      æœ€å¤§å€¼ = nums[1] = 3 âœ“
 *
 * i=4: nums[4]=5
 *      5 > nums[3]=-3ï¼Œå¼¹å‡º3
 *      5 > nums[2]=-1ï¼Œå¼¹å‡º2
 *      5 > nums[1]=3ï¼Œå¼¹å‡º1
 *      é˜Ÿåˆ—: [4]  (å¯¹åº”å€¼: [5])
 *      æœ€å¤§å€¼ = nums[4] = 5 âœ“
 *
 * i=5: nums[5]=3
 *      3 < nums[4]=5ï¼Œç›´æ¥å…¥é˜Ÿ
 *      é˜Ÿåˆ—: [4, 5]  (å¯¹åº”å€¼: [5, 3])
 *      æœ€å¤§å€¼ = nums[4] = 5 âœ“
 *
 * i=6: nums[6]=6
 *      6 > nums[5]=3ï¼Œå¼¹å‡º5
 *      6 > nums[4]=5ï¼Œå¼¹å‡º4
 *      é˜Ÿåˆ—: [6]  (å¯¹åº”å€¼: [6])
 *      æœ€å¤§å€¼ = nums[6] = 6 âœ“
 *
 * i=7: nums[7]=7
 *      7 > nums[6]=6ï¼Œå¼¹å‡º6
 *      é˜Ÿåˆ—: [7]  (å¯¹åº”å€¼: [7])
 *      æœ€å¤§å€¼ = nums[7] = 7 âœ“
 *
 * ç»“æœ: [3, 3, 5, 5, 6, 7]
 */
function maxSlidingWindow_v1(nums: number[], k: number): number[] {
  const n = nums.length;
  const result: number[] = [];
  const deque: number[] = []; // å­˜å‚¨ä¸‹æ ‡ï¼Œå¯¹åº”å€¼å•è°ƒé€’å‡

  for (let i = 0; i < n; i++) {
    // 1. ç§»é™¤è¿‡æœŸå…ƒç´ ï¼ˆé˜Ÿå¤´å…ƒç´ ä¸åœ¨å½“å‰çª—å£å†…ï¼‰
    while (deque.length > 0 && deque[0] < i - k + 1) {
      deque.shift();
    }

    // 2. ç»´æŠ¤å•è°ƒæ€§ï¼šç§»é™¤æ‰€æœ‰æ¯”å½“å‰å…ƒç´ å°çš„é˜Ÿå°¾å…ƒç´ 
    while (deque.length > 0 && nums[deque[deque.length - 1]] < nums[i]) {
      deque.pop();
    }

    // 3. å½“å‰å…ƒç´ å…¥é˜Ÿ
    deque.push(i);

    // 4. å½“çª—å£å½¢æˆåï¼Œè®°å½•æœ€å¤§å€¼ï¼ˆé˜Ÿå¤´ï¼‰
    if (i >= k - 1) {
      result.push(nums[deque[0]]);
    }
  }

  return result;
}

// ============================================================
// è§£æ³•äºŒï¼šä½¿ç”¨æ›´é«˜æ•ˆçš„åŒç«¯é˜Ÿåˆ—å®ç°
// ============================================================
// ğŸ“ ä¸Šé¢çš„å®ç°ç”¨ shift() æ˜¯ O(n)ï¼Œå¯ä»¥ç”¨çœŸæ­£çš„åŒç«¯é˜Ÿåˆ—ä¼˜åŒ–

/**
 * è‡ªå®šä¹‰åŒç«¯é˜Ÿåˆ—ç±»
 */
class Deque<T> {
  private data: (T | undefined)[] = [];
  private head = 0;
  private tail = 0;

  push(val: T): void {
    this.data[this.tail++] = val;
  }

  pop(): T | undefined {
    if (this.isEmpty()) return undefined;
    const val = this.data[--this.tail];
    this.data[this.tail] = undefined;
    return val;
  }

  shift(): T | undefined {
    if (this.isEmpty()) return undefined;
    const val = this.data[this.head];
    this.data[this.head++] = undefined;
    return val;
  }

  front(): T | undefined {
    return this.data[this.head];
  }

  back(): T | undefined {
    return this.data[this.tail - 1];
  }

  isEmpty(): boolean {
    return this.head === this.tail;
  }
}

function maxSlidingWindow_v2(nums: number[], k: number): number[] {
  const n = nums.length;
  const result: number[] = [];
  const deque = new Deque<number>();

  for (let i = 0; i < n; i++) {
    // ç§»é™¤è¿‡æœŸå…ƒç´ 
    while (!deque.isEmpty() && deque.front()! < i - k + 1) {
      deque.shift();
    }

    // ç»´æŠ¤å•è°ƒæ€§
    while (!deque.isEmpty() && nums[deque.back()!] < nums[i]) {
      deque.pop();
    }

    deque.push(i);

    if (i >= k - 1) {
      result.push(nums[deque.front()!]);
    }
  }

  return result;
}

// ============================================================
// è§£æ³•ä¸‰ï¼šå †ï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼‰
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n log n) | ç©ºé—´å¤æ‚åº¦ï¼šO(n)
// ğŸ“ JavaScript æ²¡æœ‰å†…ç½®å †ï¼Œéœ€è¦è‡ªå·±å®ç°

/**
 * æœ€å¤§å †å®ç°
 */
class MaxHeap {
  private heap: [number, number][] = []; // [value, index]

  push(val: number, idx: number): void {
    this.heap.push([val, idx]);
    this.siftUp(this.heap.length - 1);
  }

  pop(): [number, number] | undefined {
    if (this.heap.length === 0) return undefined;
    const top = this.heap[0];
    const last = this.heap.pop()!;
    if (this.heap.length > 0) {
      this.heap[0] = last;
      this.siftDown(0);
    }
    return top;
  }

  peek(): [number, number] | undefined {
    return this.heap[0];
  }

  size(): number {
    return this.heap.length;
  }

  private siftUp(i: number): void {
    while (i > 0) {
      const parent = Math.floor((i - 1) / 2);
      if (this.heap[parent][0] >= this.heap[i][0]) break;
      [this.heap[parent], this.heap[i]] = [this.heap[i], this.heap[parent]];
      i = parent;
    }
  }

  private siftDown(i: number): void {
    const n = this.heap.length;
    while (true) {
      const left = 2 * i + 1;
      const right = 2 * i + 2;
      let largest = i;

      if (left < n && this.heap[left][0] > this.heap[largest][0]) {
        largest = left;
      }
      if (right < n && this.heap[right][0] > this.heap[largest][0]) {
        largest = right;
      }

      if (largest === i) break;

      [this.heap[i], this.heap[largest]] = [this.heap[largest], this.heap[i]];
      i = largest;
    }
  }
}

function maxSlidingWindow_v3(nums: number[], k: number): number[] {
  const n = nums.length;
  const result: number[] = [];
  const heap = new MaxHeap();

  for (let i = 0; i < n; i++) {
    heap.push(nums[i], i);

    if (i >= k - 1) {
      // å»¶è¿Ÿåˆ é™¤ï¼šåªåœ¨éœ€è¦æ—¶æ£€æŸ¥å †é¡¶æ˜¯å¦è¿‡æœŸ
      while (heap.peek()![1] <= i - k) {
        heap.pop();
      }
      result.push(heap.peek()![0]);
    }
  }

  return result;
}

// ============================================================
// ğŸ”„ è§£æ³•å¯¹æ¯”
// ============================================================
/**
 * | è§£æ³•        | æ—¶é—´       | ç©ºé—´  | ç‰¹ç‚¹                      |
 * |------------|-----------|-------|--------------------------|
 * | æš´åŠ›       | O(nk)     | O(1)  | ä¼šè¶…æ—¶                    |
 * | å•è°ƒé˜Ÿåˆ—    | O(n)      | O(k)  | æœ€ä¼˜è§£ï¼Œç†è§£å•è°ƒé˜Ÿåˆ—çš„æ ¸å¿ƒ   |
 * | å †         | O(n log n)| O(n)  | éœ€è¦å»¶è¿Ÿåˆ é™¤               |
 *
 * é¢è¯•å»ºè®®ï¼š
 * 1. å…ˆè¯´æš´åŠ›æ€è·¯å’Œå¤æ‚åº¦
 * 2. å¼•å‡ºå•è°ƒé˜Ÿåˆ—ä¼˜åŒ–
 * 3. è§£é‡Šå•è°ƒé˜Ÿåˆ—çš„æ ¸å¿ƒæ€æƒ³ï¼šåªä¿ç•™å¯èƒ½æˆä¸ºç­”æ¡ˆçš„å…ƒç´ 
 */

// ============================================================
// âš ï¸ æ˜“é”™ç‚¹
// ============================================================
/**
 * 1. é˜Ÿåˆ—å­˜å‚¨ä¸‹æ ‡è€Œéå€¼ï¼š
 *    æ–¹ä¾¿åˆ¤æ–­å…ƒç´ æ˜¯å¦è¿‡æœŸï¼ˆä¸‹æ ‡ < i - k + 1ï¼‰
 *
 * 2. ä¸¤ä¸ª while çš„é¡ºåºï¼š
 *    - å…ˆç§»é™¤è¿‡æœŸå…ƒç´ 
 *    - å†ç»´æŠ¤å•è°ƒæ€§
 *    - æœ€åå…¥é˜Ÿ
 *
 * 3. ç»´æŠ¤å•è°ƒæ€§ç”¨ä¸¥æ ¼å°äºï¼š
 *    while (nums[deque.back()] < nums[i])
 *    å¦‚æœç”¨ <=ï¼Œä¼šç§»é™¤ç›¸åŒçš„å…ƒç´ ï¼Œå¯èƒ½å¯¼è‡´é—®é¢˜
 *
 * 4. çª—å£å½¢æˆçš„æ¡ä»¶ï¼š
 *    i >= k - 1ï¼Œå³å¤„ç†äº† k ä¸ªå…ƒç´ åæ‰å¼€å§‹è¾“å‡º
 *
 * 5. shift() çš„æ€§èƒ½ï¼š
 *    JavaScript çš„ shift() æ˜¯ O(n)ï¼Œå¤§é‡ä½¿ç”¨ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜
 *    å¯ä»¥ç”¨åŒç«¯é˜Ÿåˆ—ç±»ä¼˜åŒ–
 */

// ============================================================
// ğŸ”— ä¸¾ä¸€åä¸‰ï¼šç›¸ä¼¼é¢˜ç›®
// ============================================================
/**
 * - æ¯æ—¥æ¸©åº¦ â†’ å•è°ƒæ ˆï¼ˆæ‰¾ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ ï¼‰
 * - ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´  II â†’ å•è°ƒæ ˆ + ç¯å½¢æ•°ç»„
 * - æŸ±çŠ¶å›¾ä¸­æœ€å¤§çš„çŸ©å½¢ â†’ å•è°ƒæ ˆ
 * - ç»å¯¹å·®ä¸è¶…è¿‡é™åˆ¶çš„æœ€é•¿è¿ç»­å­æ•°ç»„ â†’ å•è°ƒé˜Ÿåˆ—
 *
 * å•è°ƒæ ˆ vs å•è°ƒé˜Ÿåˆ—ï¼š
 * - å•è°ƒæ ˆï¼šæ‰¾ä¸‹ä¸€ä¸ª/ä¸Šä¸€ä¸ªæ›´å¤§/æ›´å°å…ƒç´ 
 * - å•è°ƒé˜Ÿåˆ—ï¼šæ»‘åŠ¨çª—å£ä¸­çš„æå€¼
 */

// ============================================================
// ğŸ¢ å‰ç«¯ä¸šåŠ¡åœºæ™¯
// ============================================================
/**
 * 1. æ€§èƒ½ç›‘æ§ï¼šæ»šåŠ¨ç»Ÿè®¡æœ€è¿‘ N æ¬¡è¯·æ±‚ä¸­çš„æœ€å¤§å“åº”æ—¶é—´
 * 2. è‚¡ç¥¨å›¾è¡¨ï¼šè®¡ç®—ç§»åŠ¨çª—å£å†…çš„æœ€é«˜ä»·
 * 3. æ¸¸æˆå¼€å‘ï¼šè®¡ç®—ç©å®¶æœ€è¿‘ N å±€çš„æœ€é«˜å¾—åˆ†
 * 4. æ•°æ®å¯è§†åŒ–ï¼šå¹³æ»‘æ›²çº¿çš„å³°å€¼æ£€æµ‹
 */

export { maxSlidingWindow_v1, maxSlidingWindow_v2, maxSlidingWindow_v3, Deque, MaxHeap };
export default maxSlidingWindow_v1;

