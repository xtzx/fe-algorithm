# æµå¼ä¸å¢é‡æ’åº

> å¤„ç†æŒç»­åˆ°æ¥çš„æ•°æ®æµï¼Œç»´æŠ¤å®æ—¶æœ‰åºçŠ¶æ€

## ğŸ“š ç›®å½•

1. [åº”ç”¨åœºæ™¯](#1-åº”ç”¨åœºæ™¯)
2. [ç»´æŠ¤æœ‰åºçª—å£](#2-ç»´æŠ¤æœ‰åºçª—å£)
3. [åœ¨çº¿ä¸­ä½æ•°](#3-åœ¨çº¿ä¸­ä½æ•°)
4. [å¢é‡æ›´æ–°æ’åº](#4-å¢é‡æ›´æ–°æ’åº)
5. [ä»£ç å®ç°](#5-ä»£ç å®ç°)

---

## 1. åº”ç”¨åœºæ™¯

### 1.1 å…¸å‹åœºæ™¯

| åœºæ™¯ | æ•°æ®ç‰¹ç‚¹ | æ’åºéœ€æ±‚ |
|------|---------|---------|
| **æ—¥å¿—å®æ—¶ç›‘æ§** | æŒç»­äº§ç”Ÿã€æ—¶é—´æˆ³æ’åº | Top N æœ€æ–° |
| **æœç´¢ç»“æœæ›´æ–°** | å¢é‡è¿”å›ã€ç›¸å…³åº¦æ’åº | åŠ¨æ€ TopK |
| **è‚¡ç¥¨è¡Œæƒ…** | é«˜é¢‘æ›´æ–°ã€ä»·æ ¼/æ¶¨å¹…æ’åº | å®æ—¶æ’å |
| **åœ¨çº¿æ¸¸æˆæ’è¡Œæ¦œ** | é¢‘ç¹å˜åŒ–ã€åˆ†æ•°æ’åº | Top N + æ’å |
| **å®æ—¶æ¨è** | æµå¼è®¡ç®—ã€å¾—åˆ†æ’åº | åŠ¨æ€ TopK |

### 1.2 ä¸æ‰¹é‡æ’åºçš„åŒºåˆ«

```
æ‰¹é‡æ’åº:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰€æœ‰æ•°æ® â†’ æ’åº â†’ ç»“æœ      â”‚  O(n log n) ä¸€æ¬¡æ€§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æµå¼æ’åº:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®1 â†’ æ›´æ–° â†’ æ•°æ®2 â†’ ...  â”‚  O(k) æ¯æ¬¡æ›´æ–°
â”‚     ç»´æŠ¤æœ‰åºçŠ¶æ€             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ç»´æŠ¤æœ‰åºçª—å£

### 2.1 é—®é¢˜å®šä¹‰

```
æ•°æ®æŒç»­åˆ°æ¥ï¼Œå§‹ç»ˆç»´æŠ¤æœ€è¿‘/æœ€å¤§/æœ€å°çš„ K æ¡æœ‰åºæ•°æ®
```

### 2.2 æ•°æ®ç»“æ„é€‰æ‹©

| æ–¹æ¡ˆ | æ’å…¥ | åˆ é™¤ | æŸ¥è¯¢ç¬¬k | é€‚ç”¨åœºæ™¯ |
|------|------|------|--------|---------|
| **æœ‰åºæ•°ç»„ + äºŒåˆ†** | O(k) | O(k) | O(1) | K è¾ƒå° |
| **å°é¡¶å †/å¤§é¡¶å †** | O(log k) | O(log k) | O(1) | TopK |
| **å¹³è¡¡æ ‘/è·³è¡¨** | O(log k) | O(log k) | O(log k) | é¢‘ç¹å¢åˆ  |

### 2.3 æœ‰åºçª—å£æ›´æ–°æµç¨‹

```mermaid
flowchart TD
    Start[æ–°æ•°æ®åˆ°æ¥] --> Full{çª—å£å·²æ»¡?}

    Full -->|å¦| Insert[äºŒåˆ†æ’å…¥]
    Full -->|æ˜¯| Compare{æ¯”æœ€å°å€¼å¤§?}

    Compare -->|å¦| Discard[ä¸¢å¼ƒ]
    Compare -->|æ˜¯| Remove[ç§»é™¤æœ€å°]
    Remove --> Insert

    Insert --> Done[å®Œæˆ]
    Discard --> Done

    style Insert fill:#c8e6c9
    style Discard fill:#ffcdd2
```

### 2.4 å®ç°ç¤ºä¾‹

```typescript
class SortedWindow<T> {
  private items: T[] = [];
  private capacity: number;
  private cmp: (a: T, b: T) => number;

  constructor(capacity: number, cmp: (a: T, b: T) => number) {
    this.capacity = capacity;
    this.cmp = cmp;
  }

  add(item: T): void {
    // äºŒåˆ†æŸ¥æ‰¾æ’å…¥ä½ç½®
    const pos = this.findInsertPosition(item);

    // çª—å£æœªæ»¡ï¼Œç›´æ¥æ’å…¥
    if (this.items.length < this.capacity) {
      this.items.splice(pos, 0, item);
      return;
    }

    // çª—å£å·²æ»¡ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›¿æ¢
    // å‡è®¾ç»´æŠ¤çš„æ˜¯ Top K æœ€å¤§
    if (pos === 0) {
      return; // æ¯”æœ€å°çš„è¿˜å°ï¼Œä¸¢å¼ƒ
    }

    // ç§»é™¤æœ€å°ï¼Œæ’å…¥æ–°å…ƒç´ 
    this.items.shift();
    this.items.splice(pos - 1, 0, item);
  }

  private findInsertPosition(item: T): number {
    let lo = 0, hi = this.items.length;
    while (lo < hi) {
      const mid = (lo + hi) >>> 1;
      if (this.cmp(this.items[mid], item) < 0) {
        lo = mid + 1;
      } else {
        hi = mid;
      }
    }
    return lo;
  }

  toArray(): T[] {
    return [...this.items];
  }
}
```

---

## 3. åœ¨çº¿ä¸­ä½æ•°

### 3.1 é—®é¢˜å®šä¹‰

```
æ•°æ®æŒç»­åˆ°æ¥ï¼Œéšæ—¶æŸ¥è¯¢å½“å‰æ‰€æœ‰æ•°æ®çš„ä¸­ä½æ•°

LeetCode 295: æ•°æ®æµçš„ä¸­ä½æ•°
```

### 3.2 åŒå †æ–¹æ¡ˆ

ä½¿ç”¨ä¸¤ä¸ªå †ç»´æŠ¤æ•°æ®çš„ä¸¤åŠï¼š

```
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚            æ‰€æœ‰æ•°æ®                    â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚     å°çš„ä¸€åŠ      â”‚     å¤§çš„ä¸€åŠ       â”‚
       â”‚    (å¤§é¡¶å †)       â”‚    (å°é¡¶å †)        â”‚
       â”‚     maxHeap       â”‚     minHeap        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                       ä¸­ä½æ•°
```

**ä¸å˜å¼**ï¼š
1. `maxHeap` å­˜å‚¨è¾ƒå°çš„ä¸€åŠï¼Œå †é¡¶æ˜¯å…¶ä¸­æœ€å¤§çš„
2. `minHeap` å­˜å‚¨è¾ƒå¤§çš„ä¸€åŠï¼Œå †é¡¶æ˜¯å…¶ä¸­æœ€å°çš„
3. ä¸¤ä¸ªå †å¤§å°å·®ä¸è¶…è¿‡ 1

### 3.3 ç»´æŠ¤æµç¨‹

```mermaid
flowchart TD
    Start[æ–°æ•°æ® num] --> Check1{maxHeap ä¸ºç©º?}

    Check1 -->|æ˜¯| AddMax[åŠ å…¥ maxHeap]
    Check1 -->|å¦| Compare{num â‰¤ maxHeap.top?}

    Compare -->|æ˜¯| AddMax
    Compare -->|å¦| AddMin[åŠ å…¥ minHeap]

    AddMax --> Balance
    AddMin --> Balance

    Balance[å¹³è¡¡ä¸¤å †å¤§å°] --> Done[å®Œæˆ]

    style Balance fill:#fff3e0
```

### 3.4 è·å–ä¸­ä½æ•°

```typescript
getMedian(): number {
  if (this.maxHeap.size() > this.minHeap.size()) {
    return this.maxHeap.peek();
  }
  if (this.minHeap.size() > this.maxHeap.size()) {
    return this.minHeap.peek();
  }
  // å¤§å°ç›¸ç­‰ï¼Œå–å¹³å‡
  return (this.maxHeap.peek() + this.minHeap.peek()) / 2;
}
```

### 3.5 å¤æ‚åº¦

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ |
|------|-----------|
| æ’å…¥ | O(log n) |
| æŸ¥è¯¢ä¸­ä½æ•° | O(1) |
| ç©ºé—´ | O(n) |

---

## 4. å¢é‡æ›´æ–°æ’åº

### 4.1 åœºæ™¯

å·²æœ‰æœ‰åºæ•°ç»„ï¼Œéœ€è¦æ”¯æŒï¼š
- æ’å…¥æ–°å…ƒç´ 
- åˆ é™¤æŒ‡å®šå…ƒç´ 
- ä¿®æ”¹å…ƒç´ å€¼

### 4.2 æ“ä½œç­–ç•¥

#### æ’å…¥ï¼šäºŒåˆ†æŸ¥æ‰¾ + æ’å…¥

```typescript
function insertSorted<T>(
  arr: T[],
  item: T,
  cmp: (a: T, b: T) => number
): void {
  const pos = binarySearchInsertPos(arr, item, cmp);
  arr.splice(pos, 0, item);
}

// æ—¶é—´å¤æ‚åº¦ï¼šO(log n) æŸ¥æ‰¾ + O(n) ç§»åŠ¨ = O(n)
// å¯ä¼˜åŒ–ï¼šä½¿ç”¨å¹³è¡¡æ ‘é™åˆ° O(log n)
```

#### åˆ é™¤ï¼šç›´æ¥åˆ é™¤

```typescript
function removeSorted<T>(
  arr: T[],
  item: T,
  cmp: (a: T, b: T) => number
): boolean {
  const pos = binarySearch(arr, item, cmp);
  if (pos < 0) return false;
  arr.splice(pos, 1);
  return true;
}

// æ—¶é—´å¤æ‚åº¦ï¼šO(log n) + O(n) = O(n)
```

#### ä¿®æ”¹ï¼šåˆ é™¤ + æ’å…¥

```typescript
function updateSorted<T>(
  arr: T[],
  oldItem: T,
  newItem: T,
  cmp: (a: T, b: T) => number
): boolean {
  if (!removeSorted(arr, oldItem, cmp)) {
    return false;
  }
  insertSorted(arr, newItem, cmp);
  return true;
}
```

### 4.3 æƒ°æ€§åˆ é™¤ä¼˜åŒ–

é¢‘ç¹åˆ é™¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æƒ°æ€§åˆ é™¤ï¼š

```typescript
class LazyDeleteArray<T> {
  private items: (T | null)[] = [];
  private deletedCount = 0;
  private readonly COMPACT_THRESHOLD = 0.5;

  delete(index: number): void {
    this.items[index] = null;
    this.deletedCount++;

    // åˆ é™¤æ¯”ä¾‹è¿‡é«˜æ—¶ï¼Œå‹ç¼©æ•°ç»„
    if (this.deletedCount / this.items.length > this.COMPACT_THRESHOLD) {
      this.compact();
    }
  }

  private compact(): void {
    this.items = this.items.filter(item => item !== null);
    this.deletedCount = 0;
  }
}
```

### 4.4 å¢é‡æ›´æ–°æµç¨‹å›¾

```mermaid
flowchart TD
    subgraph æ’å…¥
        I1[æ–°æ•°æ®] --> I2[äºŒåˆ†æŸ¥æ‰¾ä½ç½®]
        I2 --> I3[splice æ’å…¥]
    end

    subgraph åˆ é™¤
        D1[ç›®æ ‡æ•°æ®] --> D2[äºŒåˆ†æŸ¥æ‰¾ä½ç½®]
        D2 --> D3{æ‰¾åˆ°?}
        D3 -->|æ˜¯| D4[splice åˆ é™¤]
        D3 -->|å¦| D5[è¿”å›å¤±è´¥]
    end

    subgraph ä¿®æ”¹
        U1[æ—§å€¼, æ–°å€¼] --> U2[åˆ é™¤æ—§å€¼]
        U2 --> U3[æ’å…¥æ–°å€¼]
    end

    style I3 fill:#c8e6c9
    style D4 fill:#ffcdd2
    style U3 fill:#bbdefb
```

---

## 5. ä»£ç å®ç°

### 5.1 åœ¨çº¿ä¸­ä½æ•°

```typescript
import { OnlineMedian } from './æµå¼æ’åº';

const median = new OnlineMedian();

median.add(1);
console.log(median.getMedian()); // 1

median.add(2);
console.log(median.getMedian()); // 1.5

median.add(3);
console.log(median.getMedian()); // 2
```

### 5.2 æœ‰åºçª—å£

```typescript
import { SortedWindow } from './æµå¼æ’åº';

// ç»´æŠ¤ Top 5 æœ€å¤§å€¼
const window = new SortedWindow<number>(5, (a, b) => a - b);

window.add(10);
window.add(3);
window.add(7);
window.add(15);
window.add(8);
window.add(20); // 3 è¢«æ·˜æ±°

console.log(window.toArray()); // [7, 8, 10, 15, 20]
console.log(window.get(0));    // 7 (æœ€å°)
console.log(window.get(4));    // 20 (æœ€å¤§)
```

### 5.3 å®é™…åº”ç”¨ç¤ºä¾‹

```typescript
// å®æ—¶è‚¡ç¥¨æ¶¨å¹…æ¦œ Top 10
interface Stock {
  symbol: string;
  changePercent: number;
}

const topGainers = new SortedWindow<Stock>(
  10,
  (a, b) => a.changePercent - b.changePercent
);

// æ¨¡æ‹Ÿå®æ—¶æ•°æ®
function onStockUpdate(stock: Stock) {
  topGainers.add(stock);
  renderLeaderboard(topGainers.toArray());
}

// å®æ—¶æ—¥å¿—æœ€æ–° 100 æ¡
interface LogEntry {
  timestamp: number;
  message: string;
}

const recentLogs = new SortedWindow<LogEntry>(
  100,
  (a, b) => a.timestamp - b.timestamp
);
```

---

## ğŸ“– LeetCode ç›¸å…³é¢˜ç›®

| é¢˜å· | é¢˜ç›® | éš¾åº¦ | å…³è”çŸ¥è¯†ç‚¹ |
|:----:|------|:----:|-----------|
| 295 | æ•°æ®æµçš„ä¸­ä½æ•° | H | åŒå † |
| 480 | æ»‘åŠ¨çª—å£ä¸­ä½æ•° | H | åŒå † + æƒ°æ€§åˆ é™¤ |
| 703 | æ•°æ®æµä¸­çš„ç¬¬ K å¤§å…ƒç´  | E | å°é¡¶å † |
| 239 | æ»‘åŠ¨çª—å£æœ€å¤§å€¼ | H | å•è°ƒé˜Ÿåˆ— |
| 352 | å°†æ•°æ®æµå˜ä¸ºå¤šä¸ªä¸ç›¸äº¤åŒºé—´ | H | æœ‰åºé›†åˆ |

---

## ğŸ¯ æ€»ç»“

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | æ—¶é—´å¤æ‚åº¦ |
|------|---------|-----------|
| TopK ç»´æŠ¤ | å°é¡¶å †/å¤§é¡¶å † | O(log k) |
| æœ‰åºçª—å£ | æœ‰åºæ•°ç»„ + äºŒåˆ† | O(k) |
| åœ¨çº¿ä¸­ä½æ•° | åŒå † | O(log n) |
| é¢‘ç¹å¢åˆ  | å¹³è¡¡æ ‘/è·³è¡¨ | O(log n) |
| å°‘é‡æ›´æ–° | äºŒåˆ† + splice | O(n) |

