# å¹¶è¡Œæ’åº

> åˆ©ç”¨å¤šæ ¸ CPU åŠ é€Ÿå¤§è§„æ¨¡æ•°æ®æ’åº

## ğŸ“š ç›®å½•

1. [å¹¶è¡Œæ’åºåŸç†](#1-å¹¶è¡Œæ’åºåŸç†)
2. [Web Worker å®ç°æ–¹æ¡ˆ](#2-web-worker-å®ç°æ–¹æ¡ˆ)
3. [ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ’åº](#3-ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ’åº)
4. [æ€§èƒ½åˆ†æ](#4-æ€§èƒ½åˆ†æ)
5. [ä»£ç å®ç°](#5-ä»£ç å®ç°)

---

## 1. å¹¶è¡Œæ’åºåŸç†

### 1.1 æ ¸å¿ƒæ€æƒ³

```
åˆ†å— â†’ å¹¶è¡Œæ’åº â†’ å¤šè·¯å½’å¹¶
```

å°†å¤§æ•°ç»„åˆ†æˆå¤šä¸ªå—ï¼Œæ¯ä¸ªå—åœ¨ç‹¬ç«‹çš„ Worker ä¸­æ’åºï¼Œæœ€ååˆå¹¶ç»“æœã€‚

### 1.2 æ•°æ®æµ

```mermaid
flowchart TD
    subgraph ä¸»çº¿ç¨‹
        A[åŸå§‹æ•°ç»„] --> B[åˆ†å—]
        B --> C1[chunk 1]
        B --> C2[chunk 2]
        B --> C3[chunk N]

        M[Kè·¯å½’å¹¶] --> R[æ’åºç»“æœ]
    end

    subgraph Worker1
        C1 --> S1[æ’åº]
        S1 --> R1[sorted 1]
    end

    subgraph Worker2
        C2 --> S2[æ’åº]
        S2 --> R2[sorted 2]
    end

    subgraph WorkerN
        C3 --> S3[æ’åº]
        S3 --> R3[sorted N]
    end

    R1 --> M
    R2 --> M
    R3 --> M

    style A fill:#e3f2fd
    style R fill:#c8e6c9
```

### 1.3 æ—¶é—´å¤æ‚åº¦åˆ†æ

| é˜¶æ®µ | å•çº¿ç¨‹ | P ä¸ª Worker |
|------|--------|-------------|
| åˆ†å— | O(n) | O(n) |
| æ’åº | O(n log n) | O(n/P Â· log(n/P)) |
| å½’å¹¶ | - | O(n log P) |
| **æ€»è®¡** | O(n log n) | O(n/P Â· log(n/P) + n log P) |

**ç†æƒ³åŠ é€Ÿæ¯”**ï¼šæ¥è¿‘ Pï¼ˆWorker æ•°é‡ï¼‰

**å®é™…åŠ é€Ÿæ¯”**ï¼šå—é€šä¿¡å¼€é”€ã€å†…å­˜å¤åˆ¶å½±å“ï¼Œé€šå¸¸ < P

---

## 2. Web Worker å®ç°æ–¹æ¡ˆ

### 2.1 æ¶æ„å›¾

```
ä¸»çº¿ç¨‹                 Worker 1              Worker 2
   â”‚                      â”‚                     â”‚
   â”œâ”€â”€â”€â”€ chunk1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
   â”œâ”€â”€â”€â”€ chunk2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚                     â”‚
   â”‚â—„â”€â”€â”€â”€ sorted1 â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
   â”‚â—„â”€â”€â”€â”€ sorted2 â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                      â”‚                     â”‚
   â”œâ”€â”€ k-way merge â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
final sorted array
```

### 2.2 Worker ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> Created: new Worker()
    Created --> Idle: onmessage æ³¨å†Œ
    Idle --> Sorting: æ¥æ”¶æ•°æ®
    Sorting --> Idle: è¿”å›ç»“æœ
    Idle --> Terminated: terminate()
    Terminated --> [*]

    note right of Sorting
        æ‰§è¡Œæ’åºç®—æ³•
        postMessage è¿”å›
    end note
```

### 2.3 é€šä¿¡æ–¹å¼

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **ç»“æ„åŒ–å…‹éš†** | ç®€å•ã€æ”¯æŒå¤æ‚å¯¹è±¡ | æœ‰å¤åˆ¶å¼€é”€ | ä¸­å°æ•°æ® |
| **Transferable** | é›¶å¤åˆ¶ | åªæ”¯æŒ ArrayBuffer | å¤§é‡æ•°å€¼ |
| **SharedArrayBuffer** | çœŸæ­£å…±äº« | éœ€è¦ CORS å¤´ã€å¤æ‚åŒæ­¥ | æç«¯æ€§èƒ½éœ€æ±‚ |

### 2.4 æ¨èæ–¹æ¡ˆ

```typescript
// å°æ•°æ®ï¼ˆ< 100KBï¼‰ï¼šç»“æ„åŒ–å…‹éš†
worker.postMessage({ data: array });

// å¤§æ•°æ®ï¼ˆæ•°å€¼å‹ï¼‰ï¼šTransferable
const buffer = new Float64Array(array).buffer;
worker.postMessage({ buffer }, [buffer]);

// æ¥æ”¶æ—¶è½¬å›æ•°ç»„
const result = new Float64Array(e.data.buffer);
```

---

## 3. ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ’åº

### 3.1 å†³ç­–æµç¨‹

```mermaid
flowchart TD
    Start[éœ€è¦æ’åº] --> Size{æ•°æ®é‡?}

    Size -->|< 10,000| Single[å•çº¿ç¨‹æ’åº]
    Size -->|10,000 - 100,000| Check{CPU æ ¸å¿ƒæ•° > 2?}
    Size -->|> 100,000| Parallel[å¹¶è¡Œæ’åº]

    Check -->|å¦| Single
    Check -->|æ˜¯| Maybe{æ•°æ®ç±»å‹?}

    Maybe -->|æ•°å€¼å‹| Parallel
    Maybe -->|å¤æ‚å¯¹è±¡| Single

    Single --> Done[å®Œæˆ]
    Parallel --> Done

    style Single fill:#fff3e0
    style Parallel fill:#c8e6c9
```

### 3.2 é˜ˆå€¼å»ºè®®

| åœºæ™¯ | å•çº¿ç¨‹ | 2 Workers | 4 Workers |
|------|:------:|:---------:|:---------:|
| n < 10,000 | âœ… | âŒ | âŒ |
| 10,000 â‰¤ n < 50,000 | âœ… | å¯é€‰ | âŒ |
| 50,000 â‰¤ n < 500,000 | å¯é€‰ | âœ… | å¯é€‰ |
| n â‰¥ 500,000 | âŒ | âœ… | âœ… |

### 3.3 ä¸é€‚åˆå¹¶è¡Œçš„åœºæ™¯

```
âŒ æ•°æ®é‡å¤ªå°ï¼ˆWorker åˆ›å»º/é€šä¿¡å¼€é”€ > æ’åºæ—¶é—´ï¼‰
âŒ å¤æ‚å¯¹è±¡ï¼ˆåºåˆ—åŒ–å¼€é”€å¤§ï¼‰
âŒ å·²ç»æœ‰å…¶ä»– CPU å¯†é›†ä»»åŠ¡
âŒ ç›®æ ‡ç¯å¢ƒä¸æ”¯æŒ Workerï¼ˆéƒ¨åˆ†æ—§æµè§ˆå™¨ï¼‰
```

---

## 4. æ€§èƒ½åˆ†æ

### 4.1 å®æµ‹æ•°æ®ï¼ˆå‚è€ƒï¼‰

æµ‹è¯•ç¯å¢ƒï¼šChrome 120ï¼ŒM1 MacBook Pro

| æ•°æ®é‡ | å•çº¿ç¨‹ | 2 Workers | 4 Workers | æœ€ä½³åŠ é€Ÿæ¯” |
|-------:|-------:|----------:|----------:|-----------:|
| 10,000 | 5ms | 8ms | 12ms | 0.6x |
| 50,000 | 25ms | 18ms | 15ms | 1.7x |
| 100,000 | 55ms | 35ms | 28ms | 2.0x |
| 500,000 | 300ms | 170ms | 120ms | 2.5x |
| 1,000,000 | 650ms | 350ms | 220ms | 3.0x |

### 4.2 å¼€é”€åˆ†æ

```mermaid
pie title å¹¶è¡Œæ’åºæ—¶é—´åˆ†å¸ƒï¼ˆ100ä¸‡æ•°æ®ï¼Œ4 Workersï¼‰
    "Worker æ’åº" : 60
    "Kè·¯å½’å¹¶" : 25
    "é€šä¿¡å¼€é”€" : 10
    "å…¶ä»–" : 5
```

### 4.3 åŠ é€Ÿæ¯”å…¬å¼

```
å®é™…åŠ é€Ÿæ¯” = T_å•çº¿ç¨‹ / T_å¹¶è¡Œ

å…¶ä¸­ T_å¹¶è¡Œ = T_é€šä¿¡ + T_æ’åº/P + T_å½’å¹¶

åŠ é€Ÿæ¯”ä¸Šé™ï¼ˆé˜¿å§†è¾¾å°”å®šå¾‹ï¼‰:
S(P) = 1 / (s + (1-s)/P)

s = ä¸²è¡Œéƒ¨åˆ†æ¯”ä¾‹ï¼ˆé€šä¿¡ + å½’å¹¶ï¼‰
P = Worker æ•°é‡
```

---

## 5. ä»£ç å®ç°

### 5.1 ä¸»çº¿ç¨‹ API

```typescript
import { parallelMergeSort, shouldUseParallel } from './å¹¶è¡Œå½’å¹¶æ’åº';

// åˆ¤æ–­æ˜¯å¦å€¼å¾—å¹¶è¡Œ
if (shouldUseParallel(data.length)) {
  const sorted = await parallelMergeSort(data, (a, b) => a - b);
}

// æŒ‡å®š Worker æ•°é‡
const sorted = await parallelMergeSort(data, comparator, {
  workerCount: 4,
});
```

### 5.2 å®ç°è¦ç‚¹

```typescript
// 1. åˆ†å—ç­–ç•¥
function splitIntoChunks<T>(arr: T[], chunkCount: number): T[][] {
  const chunkSize = Math.ceil(arr.length / chunkCount);
  const chunks: T[][] = [];

  for (let i = 0; i < arr.length; i += chunkSize) {
    chunks.push(arr.slice(i, i + chunkSize));
  }

  return chunks;
}

// 2. Kè·¯å½’å¹¶
function kWayMerge<T>(
  sortedArrays: T[][],
  cmp: (a: T, b: T) => number
): T[] {
  // ä½¿ç”¨æœ€å°å †ä¼˜åŒ–
  // è¯¦è§å®ç°æ–‡ä»¶
}

// 3. Worker ç®¡ç†
class WorkerPool {
  private workers: Worker[] = [];

  async sort<T>(chunks: T[][], cmp: Comparator<T>): Promise<T[][]> {
    // å¹¶è¡Œæ’åºæ‰€æœ‰å—
  }

  terminate(): void {
    this.workers.forEach(w => w.terminate());
  }
}
```

### 5.3 ä½¿ç”¨ç¤ºä¾‹

```typescript
// æ•°å€¼æ’åº
const numbers = Array.from({ length: 1000000 }, () => Math.random());
const sorted = await parallelMergeSort(numbers, (a, b) => a - b);

// å¯¹è±¡æ’åºï¼ˆéœ€è¦æ³¨æ„åºåˆ—åŒ–å¼€é”€ï¼‰
interface User { id: number; name: string; }
const users: User[] = generateUsers(100000);

// å¯¹äºå¯¹è±¡ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†æ¯”è¾ƒå‡½æ•°
const sorted = await parallelMergeSort(
  users,
  (a, b) => a.name.localeCompare(b.name),
  { workerCount: 2 }  // å¯¹è±¡å¼€é”€å¤§ï¼Œå‡å°‘ Worker
);
```

---

## ğŸ“– å»¶ä¼¸é˜…è¯»

### GPU æ’åºç®€ä»‹

**WebGPU** å¯ä»¥åˆ©ç”¨ GPU è¿›è¡Œæ’åºï¼Œé€‚åˆå¤§è§„æ¨¡æ•°å€¼è®¡ç®—ï¼š

```
ä¼˜ç‚¹ï¼š
- å¤§è§„æ¨¡å¹¶è¡Œï¼ˆæ•°åƒä¸ªæ ¸å¿ƒï¼‰
- é€‚åˆæ•°å€¼å‹æ•°æ®

ç¼ºç‚¹ï¼š
- API å¤æ‚
- æµè§ˆå™¨æ”¯æŒæœ‰é™
- ä¸é€‚åˆå¤æ‚æ¯”è¾ƒå‡½æ•°
```

**ç»å…¸ GPU æ’åºç®—æ³•**ï¼š
- Bitonic Sortï¼ˆåŒè°ƒæ’åºï¼‰
- Radix Sortï¼ˆåŸºæ•°æ’åºï¼‰

### ç›¸å…³èµ„æº

- [Web Workers API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API)
- [Transferable Objects](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Transferable_objects)
- [SharedArrayBuffer](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)
- [WebGPU](https://www.w3.org/TR/webgpu/)

