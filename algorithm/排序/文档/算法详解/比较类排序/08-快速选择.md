# å¿«é€Ÿé€‰æ‹© (Quick Select)

## ğŸ“Œ æ ¸å¿ƒæ€æƒ³

åŸºäºå¿«é€Ÿæ’åºçš„ **partition** æ€æƒ³ï¼Œä½†åªé€’å½’å¤„ç†åŒ…å«ç›®æ ‡ä½ç½®çš„é‚£ä¸€åŠï¼Œä»è€Œåœ¨ **O(n)** å¹³å‡æ—¶é—´å†…æ‰¾åˆ°ç¬¬ K å¤§/å°çš„å…ƒç´ ã€‚

> å…³é”®æ´å¯Ÿï¼šæˆ‘ä»¬ä¸éœ€è¦å®Œå…¨æ’åºï¼Œåªéœ€è¦è®©ç¬¬ K ä¸ªä½ç½®çš„å…ƒç´ å½’ä½å³å¯ã€‚

---

## ğŸ¯ é€‚ç”¨åœºæ™¯

### âœ… æ¨èä½¿ç”¨

| åœºæ™¯ | åŸå›  |
|------|------|
| æ‰¾ç¬¬ K å¤§/å°å…ƒç´  | O(n) å¹³å‡ï¼Œæ¯”æ’åºå¿« |
| TopK é—®é¢˜ï¼ˆæ— éœ€æœ‰åºï¼‰ | ä¸€æ¬¡ partition ç¡®å®šè¾¹ç•Œ |
| ä¸­ä½æ•°æŸ¥æ‰¾ | K = n/2 |

### âŒ ä¸æ¨èä½¿ç”¨

| åœºæ™¯ | åŸå›  |
|------|------|
| éœ€è¦ TopK æœ‰åºç»“æœ | åªèƒ½ç¡®å®šå“ªäº›æ˜¯ TopKï¼Œä¸æ’åº |
| åœ¨çº¿/æµå¼æ•°æ® | å †æ›´é€‚åˆåŠ¨æ€ç»´æŠ¤ |
| æœ€åæƒ…å†µæ•æ„Ÿ | O(nÂ²) æœ€åæƒ…å†µ |

---

## ğŸ“Š å¤æ‚åº¦åˆ†æ

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| **å¹³å‡æ—¶é—´** | O(n) | n + n/2 + n/4 + ... â‰ˆ 2n |
| **æœ€åæ—¶é—´** | O(nÂ²) | æ¯æ¬¡åªæ’é™¤ 1 ä¸ªå…ƒç´  |
| **ç©ºé—´å¤æ‚åº¦** | O(1) | åŸåœ°æ“ä½œï¼ˆè¿­ä»£ç‰ˆï¼‰ |

---

## ğŸ”„ ä¸å¿«é€Ÿæ’åºçš„å¯¹æ¯”ï¼ˆMermaidï¼‰

```mermaid
graph TD
    subgraph "å¿«é€Ÿæ’åº Quick Sort"
        QS1["partition å¾—åˆ° pivot ä½ç½®"]
        QS1 --> QS2["é€’å½’å·¦è¾¹"]
        QS1 --> QS3["é€’å½’å³è¾¹"]
        QS2 --> QS4["ä¸¤è¾¹éƒ½è¦å¤„ç†"]
        QS3 --> QS4
    end

    subgraph "å¿«é€Ÿé€‰æ‹© Quick Select"
        SE1["partition å¾—åˆ° pivot ä½ç½®"]
        SE1 --> SE2{"pivot == k?"}
        SE2 -->|"æ˜¯"| SE3["æ‰¾åˆ°ç­”æ¡ˆï¼"]
        SE2 -->|"pivot > k"| SE4["åªé€’å½’å·¦è¾¹"]
        SE2 -->|"pivot < k"| SE5["åªé€’å½’å³è¾¹"]
    end

    style SE3 fill:#90EE90
```

### æ—¶é—´å¤æ‚åº¦å¯¹æ¯”

```mermaid
graph LR
    subgraph "å¿«é€Ÿæ’åº O(n log n)"
        A["n"] --> B["n/2 + n/2"]
        B --> C["n/4 Ã— 4"]
        C --> D["..."]
        D --> E["log n å±‚"]
    end

    subgraph "å¿«é€Ÿé€‰æ‹© O(n)"
        F["n"] --> G["n/2 (åªä¸€è¾¹)"]
        G --> H["n/4"]
        H --> I["..."]
        I --> J["n + n/2 + n/4 â‰ˆ 2n"]
    end

    style J fill:#90EE90
```

---

## ğŸ’» æ ¸å¿ƒå®ç°

### åŸºç¡€ç‰ˆæœ¬

```typescript
/**
 * å¿«é€Ÿé€‰æ‹©ï¼šæ‰¾åˆ°ç¬¬ k å°çš„å…ƒç´ ï¼ˆk ä» 0 å¼€å§‹ï¼‰
 *
 * @param arr è¾“å…¥æ•°ç»„ï¼ˆä¼šè¢«ä¿®æ”¹ï¼‰
 * @param k ç›®æ ‡ä½ç½®ï¼ˆ0-indexedï¼‰
 * @param cmp æ¯”è¾ƒå‡½æ•°
 * @returns ç¬¬ k å°çš„å…ƒç´ 
 */
export function quickSelect<T>(
  arr: T[],
  k: number,
  cmp: (a: T, b: T) => number
): T {
  if (k < 0 || k >= arr.length) {
    throw new Error(`k=${k} è¶…å‡ºèŒƒå›´ [0, ${arr.length - 1}]`);
  }

  let left = 0;
  let right = arr.length - 1;

  while (left < right) {
    const pivotIndex = partition(arr, left, right, cmp);

    if (pivotIndex === k) {
      return arr[k];
    } else if (pivotIndex < k) {
      left = pivotIndex + 1;  // åªçœ‹å³è¾¹
    } else {
      right = pivotIndex - 1; // åªçœ‹å·¦è¾¹
    }
  }

  return arr[k];
}

function partition<T>(
  arr: T[],
  left: number,
  right: number,
  cmp: (a: T, b: T) => number
): number {
  // éšæœºé€‰æ‹© pivot é¿å…æœ€åæƒ…å†µ
  const randomIndex = left + Math.floor(Math.random() * (right - left + 1));
  [arr[randomIndex], arr[right]] = [arr[right], arr[randomIndex]];

  const pivot = arr[right];
  let i = left - 1;

  for (let j = left; j < right; j++) {
    if (cmp(arr[j], pivot) < 0) {
      i++;
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  [arr[i + 1], arr[right]] = [arr[right], arr[i + 1]];
  return i + 1;
}
```

### TopK å®ç°

```typescript
/**
 * è¿”å›æœ€å°çš„ k ä¸ªå…ƒç´ ï¼ˆæ— åºï¼‰
 */
export function topKSmallest<T>(
  arr: readonly T[],
  k: number,
  cmp: (a: T, b: T) => number
): T[] {
  if (k <= 0) return [];
  if (k >= arr.length) return [...arr];

  const result = [...arr];
  quickSelect(result, k - 1, cmp); // ç¡®ä¿å‰ k ä¸ªéƒ½å°äºç­‰äºç¬¬ k ä¸ª

  return result.slice(0, k);
}

/**
 * è¿”å›æœ€å¤§çš„ k ä¸ªå…ƒç´ ï¼ˆæ— åºï¼‰
 */
export function topKLargest<T>(
  arr: readonly T[],
  k: number,
  cmp: (a: T, b: T) => number
): T[] {
  // åè½¬æ¯”è¾ƒå™¨ï¼Œæ‰¾"æœ€å°"çš„ k ä¸ªï¼ˆå®é™…æ˜¯æœ€å¤§ï¼‰
  const reverseCmp = (a: T, b: T) => cmp(b, a);
  return topKSmallest(arr, k, reverseCmp);
}
```

---

## ğŸ†š TopK é—®é¢˜çš„å¤šç§è§£æ³•å¯¹æ¯”

| è§£æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | æ˜¯å¦æœ‰åº | é€‚ç”¨åœºæ™¯ |
|------|-----------|-----------|---------|---------|
| **å…¨æ’åº** | O(n log n) | O(1)~O(n) | âœ… æœ‰åº | ç®€å•å®ç° |
| **å †ï¼ˆå¤§å°ä¸º Kï¼‰** | O(n log k) | O(k) | âœ… å¯æœ‰åº | åœ¨çº¿/æµå¼æ•°æ® |
| **å¿«é€Ÿé€‰æ‹©** | O(n) å¹³å‡ | O(1) | âŒ æ— åº | ç¦»çº¿æ‰¹é‡ã€K è¾ƒå¤§ |
| **BFPRT** | O(n) æœ€å | O(1) | âŒ æ— åº | éœ€è¦ä¿è¯æœ€åæƒ…å†µ |

### é€‰æ‹©å†³ç­–

```mermaid
graph TD
    A["TopK é—®é¢˜"] --> B{"æ•°æ®æ˜¯æµå¼çš„?"}
    B -->|"æ˜¯"| C["ç”¨å † O(n log k)"]
    B -->|"å¦"| D{"éœ€è¦æœ‰åºç»“æœ?"}
    D -->|"æ˜¯"| E{"k å¾ˆå°?"}
    E -->|"æ˜¯"| F["ç”¨å † + æ’åº"]
    E -->|"å¦"| G["å…¨æ’åº"]
    D -->|"å¦"| H{"æœ€åæƒ…å†µæ•æ„Ÿ?"}
    H -->|"æ˜¯"| I["BFPRT ç®—æ³•"]
    H -->|"å¦"| J["å¿«é€Ÿé€‰æ‹© â­"]

    style J fill:#90EE90
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. k çš„å®šä¹‰

```typescript
// ç¬¬ k å° vs ç¬¬ k å¤§
// æ³¨æ„ k æ˜¯ 0-indexed è¿˜æ˜¯ 1-indexed

// 0-indexedï¼ˆæœ¬å®ç°ï¼‰ï¼šk=0 æ˜¯æœ€å°ï¼Œk=n-1 æ˜¯æœ€å¤§
const kthSmallest = quickSelect(arr, k, numberAsc);

// 1-indexedï¼ˆLeetCode é£æ ¼ï¼‰ï¼šk=1 æ˜¯æœ€å°
const kthSmallest = quickSelect(arr, k - 1, numberAsc);

// ç¬¬ k å¤§ï¼šç”¨åå‘æ¯”è¾ƒå™¨ï¼Œæˆ–ç”¨ n-k
const kthLargest = quickSelect(arr, arr.length - k, numberAsc);
```

### 2. åŸæ•°ç»„ä¼šè¢«ä¿®æ”¹

```typescript
// âš ï¸ quickSelect ä¼šä¿®æ”¹åŸæ•°ç»„
const arr = [3, 1, 4, 1, 5];
quickSelect(arr, 2, (a, b) => a - b);
console.log(arr); // é¡ºåºå·²æ”¹å˜ï¼

// âœ… å¦‚æœéœ€è¦ä¿ç•™åŸæ•°ç»„
const copy = [...arr];
const result = quickSelect(copy, 2, (a, b) => a - b);
```

### 3. éšæœºåŒ–é¿å…æœ€åæƒ…å†µ

```typescript
// âŒ å›ºå®šå–æœ€åä¸€ä¸ªå…ƒç´ ï¼Œæœ‰åºæ•°ç»„ä¼šé€€åŒ–åˆ° O(nÂ²)
const pivot = arr[right];

// âœ… éšæœºé€‰æ‹© pivot
const randomIndex = left + Math.floor(Math.random() * (right - left + 1));
[arr[randomIndex], arr[right]] = [arr[right], arr[randomIndex]];
```

---

## ğŸŒ å‰ç«¯ä¸šåŠ¡åœºæ™¯

### 1. æœç´¢ç»“æœ TopK

```typescript
interface SearchResult {
  id: string;
  relevance: number;
}

// æ‰¾å‡ºç›¸å…³åº¦æœ€é«˜çš„ 10 æ¡ç»“æœï¼ˆæ— éœ€å®Œå…¨æ’åºï¼‰
function getTopResults(results: SearchResult[], k: number): SearchResult[] {
  const copy = [...results];
  const cmp = (a: SearchResult, b: SearchResult) => b.relevance - a.relevance;

  // å¿«é€Ÿé€‰æ‹©ç¡®ä¿å‰ k ä¸ªæ˜¯æœ€å¤§çš„
  if (k < copy.length) {
    quickSelect(copy, k - 1, cmp);
  }

  // å¦‚æœéœ€è¦æœ‰åºï¼Œå†å¯¹å‰ k ä¸ªæ’åº
  return copy.slice(0, k).sort(cmp);
}
```

### 2. ä¸­ä½æ•°è®¡ç®—

```typescript
function median(arr: readonly number[]): number {
  const copy = [...arr];
  const n = copy.length;
  const cmp = (a: number, b: number) => a - b;

  if (n % 2 === 1) {
    // å¥‡æ•°ï¼šä¸­é—´é‚£ä¸ª
    return quickSelect(copy, n >> 1, cmp);
  } else {
    // å¶æ•°ï¼šä¸­é—´ä¸¤ä¸ªçš„å¹³å‡
    const mid1 = quickSelect(copy, (n >> 1) - 1, cmp);
    const mid2 = quickSelect(copy, n >> 1, cmp);
    return (mid1 + mid2) / 2;
  }
}
```

### 3. æ€§èƒ½ç›‘æ§ç™¾åˆ†ä½æ•°

```typescript
// è®¡ç®— P99 å»¶è¿Ÿ
function p99Latency(latencies: number[]): number {
  const copy = [...latencies];
  const p99Index = Math.floor(copy.length * 0.99);
  return quickSelect(copy, p99Index, (a, b) => a - b);
}

// è®¡ç®—å¤šä¸ªç™¾åˆ†ä½
function percentiles(
  values: number[],
  ps: number[]
): Map<number, number> {
  const copy = [...values];
  const result = new Map<number, number>();

  // å…ˆæ’åºæœ€å¤§çš„ç™¾åˆ†ä½ï¼Œå¯ä»¥å¤ç”¨ä¹‹å‰çš„ç»“æœ
  const sortedPs = [...ps].sort((a, b) => b - a);

  for (const p of sortedPs) {
    const index = Math.floor(copy.length * p);
    result.set(p, quickSelect(copy, index, (a, b) => a - b));
  }

  return result;
}
```

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

1. **BFPRT ç®—æ³•ï¼ˆMedian of Mediansï¼‰**ï¼šO(n) æœ€åæƒ…å†µä¿è¯
2. **Introselect**ï¼šå¿«é€Ÿé€‰æ‹© + BFPRT çš„æ··åˆ
3. **åŒå †æ³•æ±‚ä¸­ä½æ•°**ï¼šåœ¨çº¿ç»´æŠ¤ä¸­ä½æ•°
4. **åˆ†å¸ƒå¼ TopK**ï¼šMapReduce åœºæ™¯ä¸‹çš„ TopK

---

## âœ… è‡ªæ£€æ¸…å•

- [ ] èƒ½æ‰‹å†™ quickSelect åŸºç¡€å®ç°
- [ ] ç†è§£ä¸å¿«æ’çš„å…³ç³»ï¼ˆåªé€’å½’ä¸€è¾¹ï¼‰
- [ ] ç†è§£å¹³å‡ O(n) çš„æ•°å­¦åŸç†
- [ ] èƒ½å®ç° TopKï¼ˆæœ€å¤§/æœ€å° k ä¸ªå…ƒç´ ï¼‰
- [ ] çŸ¥é“ä½•æ—¶ç”¨å †ã€ä½•æ—¶ç”¨å¿«é€‰
- [ ] èƒ½å¤„ç† k çš„è¾¹ç•Œæƒ…å†µ
- [ ] çŸ¥é“éšæœºåŒ– pivot çš„é‡è¦æ€§

