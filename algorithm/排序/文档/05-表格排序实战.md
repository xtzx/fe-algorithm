# è¡¨æ ¼æ’åºå®æˆ˜

## ğŸ“Œ æ ¸å¿ƒé—®é¢˜

å‰ç«¯è¡¨æ ¼æ’åºçš„å…¸å‹éœ€æ±‚ï¼š
- ç‚¹å‡»åˆ—å¤´åˆ‡æ¢å‡åº/é™åº
- å¤šåˆ—æ’åºï¼ˆå…ˆæŒ‰ A åˆ—ï¼Œå†æŒ‰ B åˆ—ï¼‰
- ä¿æŒç›¸åŒå€¼çš„åŸå§‹é¡ºåºï¼ˆç¨³å®šæ€§ï¼‰
- æ”¯æŒè‡ªå®šä¹‰æ¯”è¾ƒé€»è¾‘

---

## ğŸ¯ ç¨³å®šæ€§çš„çœŸå®å«ä¹‰

### ä»€ä¹ˆæ˜¯ç¨³å®šæ’åºï¼Ÿ

> ç›¸ç­‰çš„å…ƒç´ åœ¨æ’åºåä¿æŒå®ƒä»¬åœ¨åŸæ•°ç»„ä¸­çš„ç›¸å¯¹é¡ºåºã€‚

**å®é™…æ„ä¹‰**ï¼šç”¨æˆ·å…ˆæŒ‰ A åˆ—æ’åºï¼Œå†æŒ‰ B åˆ—æ’åºåï¼ŒA åˆ—ç›¸åŒçš„è¡Œä»ä¿æŒä¹‹å‰çš„é¡ºåºã€‚

### ç¤ºä¾‹

```typescript
const data = [
  { name: 'Alice', score: 85 },
  { name: 'Bob', score: 92 },
  { name: 'Charlie', score: 85 }, // ä¸ Alice åŒåˆ†
];

// ç¨³å®šæ’åºåï¼šAlice ä»åœ¨ Charlie å‰é¢
// [Alice(85), Charlie(85), Bob(92)] âŒ
// [Alice(85), Charlie(85), Bob(92)] âœ… ä¿æŒåŸé¡ºåº
```

---

## ğŸ”§ ä¸¤ç§å¤šåˆ—æ’åºæ–¹å¼

### æ–¹å¼ Aï¼šç¨³å®šæ’åº + é€†åºæ’åº

**æ€è·¯**ï¼šä»æ¬¡å…³é”®å­—åˆ°ä¸»å…³é”®å­—ä¾æ¬¡æ’åº

```mermaid
flowchart LR
    A["åŸå§‹æ•°æ®"] --> B["æŒ‰æ¬¡å…³é”®å­—æ’åº"]
    B --> C["æŒ‰ä¸»å…³é”®å­—æ’åº"]
    C --> D["æœ€ç»ˆç»“æœ"]

    note1["ç¨³å®šæ€§ä¿è¯ï¼šç›¸åŒä¸»å…³é”®å­—çš„è¡Œ<br/>ä¿æŒæ¬¡å…³é”®å­—çš„æ’åºç»“æœ"]
```

**ä»£ç ç¤ºä¾‹**ï¼š

```typescript
import { stableSortBy } from '../ç®—æ³•åŒ…/å…¬å…±åº“/src/ç¨³å®šæ’åºè¾…åŠ©';

// å…ˆæŒ‰ scoreï¼Œå†æŒ‰ nameï¼ˆæœ€ç»ˆä¸»æ’åºé”®æ˜¯ nameï¼‰
let result = [...data];
result = stableSortBy(result, r => r.score, numberAsc);  // æ¬¡å…³é”®å­—
result = stableSortBy(result, r => r.name, stringAsc);   // ä¸»å…³é”®å­—
```

**ä¼˜ç‚¹**ï¼š
- ç›´è§‚ï¼Œå®¹æ˜“ç†è§£
- æ¯ä¸€æ­¥å¯è°ƒè¯•

**ç¼ºç‚¹**ï¼š
- å¤šæ¬¡æ’åºï¼Œæ€§èƒ½è¾ƒä½
- ä»£ç é¡ºåºä¸æ’åºä¼˜å…ˆçº§ç›¸å

---

### æ–¹å¼ Bï¼šç»„åˆæ¯”è¾ƒå™¨ä¸€æ¬¡æ’åº

**æ€è·¯**ï¼šç”¨ `compose` ç»„åˆå¤šä¸ªæ¯”è¾ƒå™¨ï¼Œä¸€æ¬¡æ’åºå®Œæˆ

```mermaid
flowchart TD
    subgraph "ç»„åˆæ¯”è¾ƒå™¨"
        C1["byField('name', stringAsc)"]
        C2["byField('score', numberAsc)"]
    end

    A["compare(a, b)"] --> D{"name æ¯”è¾ƒç»“æœ"}
    D -->|"!= 0"| E["è¿”å› name æ¯”è¾ƒç»“æœ"]
    D -->|"== 0"| F{"score æ¯”è¾ƒç»“æœ"}
    F --> G["è¿”å› score æ¯”è¾ƒç»“æœ"]
```

**ä»£ç ç¤ºä¾‹**ï¼š

```typescript
import { compose, byField, numberAsc, stringAsc } from '../ç®—æ³•åŒ…/å…¬å…±åº“/src/æ¯”è¾ƒå™¨';

// å…ˆæŒ‰ nameï¼Œç›¸åŒå†æŒ‰ score
const comparator = compose(
  byField('name', stringAsc),
  byField('score', numberAsc)
);

const result = [...data].sort(comparator);
```

**ä¼˜ç‚¹**ï¼š
- ä¸€æ¬¡æ’åºï¼Œæ€§èƒ½æœ€ä¼˜
- æ’åºä¼˜å…ˆçº§ä¸ä»£ç é¡ºåºä¸€è‡´

**ç¼ºç‚¹**ï¼š
- æ¯”è¾ƒå™¨ç»„åˆå¯èƒ½è¾ƒå¤æ‚
- éœ€è¦ç¡®ä¿æ¯”è¾ƒå™¨æ»¡è¶³æ•°å­¦æ€§è´¨

---

## ğŸ“Š ä¸¤ç§æ–¹å¼å¯¹æ¯”

| ç»´åº¦ | æ–¹å¼ Aï¼ˆé€†åºå¤šæ¬¡æ’åºï¼‰ | æ–¹å¼ Bï¼ˆç»„åˆæ¯”è¾ƒå™¨ï¼‰ |
|------|----------------------|-------------------|
| **æ€§èƒ½** | O(k Â· n log n) | O(n log n) |
| **å¯è¯»æ€§** | é¡ºåºä¸ä¼˜å…ˆçº§ç›¸å | é¡ºåºä¸ä¼˜å…ˆçº§ä¸€è‡´ |
| **å¯ç»´æŠ¤æ€§** | ç®€å•ç›´æ¥ | éœ€è¦ç†è§£æ¯”è¾ƒå™¨ç»„åˆ |
| **åŠ¨æ€åˆ—** | å®¹æ˜“æ·»åŠ /ç§»é™¤ | éœ€è¦é‡å»ºæ¯”è¾ƒå™¨ |
| **æ¨èåœºæ™¯** | å°‘é‡å›ºå®šåˆ— | æ€§èƒ½æ•æ„Ÿ/åˆ—å¤š |

---

## ğŸ’» å®æˆ˜ä»£ç 

### 1. ä½¿ç”¨ç¨³å®šæ’åºè¾…åŠ©

```typescript
import { stableSortBy, makeStableComparator } from '../ç®—æ³•åŒ…/å…¬å…±åº“/src/ç¨³å®šæ’åºè¾…åŠ©';
import { byField, numberAsc, stringAsc } from '../ç®—æ³•åŒ…/å…¬å…±åº“/src/æ¯”è¾ƒå™¨';

interface TableRow {
  id: number;
  name: string;
  score: number;
  department: string;
}

// æ–¹å¼ Aï¼šé€†åºå¤šæ¬¡æ’åº
function sortByMultipleColumnsA(
  data: TableRow[],
  columns: Array<{ field: keyof TableRow; order: 'asc' | 'desc' }>
): TableRow[] {
  let result = [...data];

  // ä»åå¾€å‰æ’åºï¼ˆæœ€åçš„æ˜¯ä¸»å…³é”®å­—ï¼‰
  for (let i = columns.length - 1; i >= 0; i--) {
    const { field, order } = columns[i];
    const cmp = order === 'asc' ? numberAsc : (a: number, b: number) => -numberAsc(a, b);
    result = stableSortBy(result, r => r[field] as number, cmp);
  }

  return result;
}
```

### 2. ä½¿ç”¨ç»„åˆæ¯”è¾ƒå™¨

```typescript
import { compose, byField, reverse, numberAsc, stringAsc } from '../ç®—æ³•åŒ…/å…¬å…±åº“/src/æ¯”è¾ƒå™¨';

interface SortColumn<T> {
  field: keyof T;
  order: 'asc' | 'desc';
  type: 'number' | 'string';
}

function createMultiColumnComparator<T>(
  columns: SortColumn<T>[]
): (a: T, b: T) => number {
  const comparators = columns.map(({ field, order, type }) => {
    const baseCmp = type === 'number' ? numberAsc : stringAsc;
    const fieldCmp = byField(field, baseCmp as any);
    return order === 'desc' ? reverse(fieldCmp) : fieldCmp;
  });

  return compose(...comparators);
}

// ä½¿ç”¨
const comparator = createMultiColumnComparator<TableRow>([
  { field: 'department', order: 'asc', type: 'string' },
  { field: 'score', order: 'desc', type: 'number' },
]);

const sorted = [...data].sort(comparator);
```

### 3. è¡¨æ ¼ç»„ä»¶é›†æˆ

```typescript
interface TableState<T> {
  data: T[];
  sortColumns: SortColumn<T>[];
}

function handleColumnClick<T>(
  state: TableState<T>,
  field: keyof T,
  type: 'number' | 'string'
): TableState<T> {
  const existing = state.sortColumns.find(c => c.field === field);

  let newSortColumns: SortColumn<T>[];

  if (existing) {
    // å·²å­˜åœ¨ï¼šåˆ‡æ¢æ’åºæ–¹å‘æˆ–ç§»é™¤
    if (existing.order === 'asc') {
      newSortColumns = state.sortColumns.map(c =>
        c.field === field ? { ...c, order: 'desc' as const } : c
      );
    } else {
      // ç§»é™¤è¯¥åˆ—
      newSortColumns = state.sortColumns.filter(c => c.field !== field);
    }
  } else {
    // æ–°å¢æ’åºåˆ—
    newSortColumns = [...state.sortColumns, { field, order: 'asc', type }];
  }

  const comparator = createMultiColumnComparator(newSortColumns);
  const sortedData = [...state.data].sort(comparator);

  return {
    data: sortedData,
    sortColumns: newSortColumns,
  };
}
```

---

## âš ï¸ å¸¸è§é™·é˜±

### 1. JavaScript sort() ä¸ä¿è¯ç¨³å®š

```typescript
// âŒ ä¸åŒæµè§ˆå™¨/ç‰ˆæœ¬å¯èƒ½ä¸ç¨³å®š
data.sort((a, b) => a.score - b.score);

// âœ… ä½¿ç”¨ stableSortBy ä¿è¯ç¨³å®š
const sorted = stableSortBy(data, r => r.score, numberAsc);
```

### 2. æ¯”è¾ƒå™¨è¿”å› NaN

```typescript
// âŒ å¯èƒ½è¿”å› NaN
const cmp = (a, b) => a.value - b.value; // value å¯èƒ½æ˜¯ undefined

// âœ… å¤„ç†è¾¹ç•Œæƒ…å†µ
import { nullSafe, numberAsc } from '../ç®—æ³•åŒ…/å…¬å…±åº“/src/æ¯”è¾ƒå™¨';
const safeCmp = nullSafe(numberAsc);
```

### 3. æ··åˆç±»å‹æ¯”è¾ƒ

```typescript
// âŒ å­—ç¬¦ä¸²å’Œæ•°å­—æ··åˆ
const data = [{ val: '10' }, { val: 2 }];
data.sort((a, b) => a.val - b.val); // NaN

// âœ… ç»Ÿä¸€ç±»å‹
data.sort((a, b) => Number(a.val) - Number(b.val));
```

---

## âœ… è‡ªæ£€æ¸…å•

- [ ] ç†è§£ç¨³å®šæ’åºåœ¨å¤šåˆ—åœºæ™¯çš„ä½œç”¨
- [ ] èƒ½ç”¨ä¸¤ç§æ–¹å¼å®ç°å¤šåˆ—æ’åº
- [ ] çŸ¥é“ JavaScript sort() ç¨³å®šæ€§çš„å†å²é—®é¢˜
- [ ] èƒ½å¤„ç† null/undefined å’Œæ··åˆç±»å‹
- [ ] èƒ½å®ç°åŠ¨æ€åˆ—æ’åºçš„è¡¨æ ¼ç»„ä»¶

