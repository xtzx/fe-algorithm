/**
 * ğŸ“ é¢˜ç›®ï¼šäºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ
 * ğŸ”— é“¾æ¥ï¼šhttps://leetcode.cn/problems/lowest-common-ancestor-of-a-binary-tree/
 * ğŸ·ï¸ éš¾åº¦ï¼šMedium
 * ğŸ·ï¸ æ ‡ç­¾ï¼šæ ‘ã€æ·±åº¦ä¼˜å…ˆæœç´¢ã€äºŒå‰æ ‘
 *
 * ğŸ“‹ é¢˜ç›®æè¿°ï¼š
 * ç»™å®šä¸€ä¸ªäºŒå‰æ ‘, æ‰¾åˆ°è¯¥æ ‘ä¸­ä¸¤ä¸ªæŒ‡å®šèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚
 *
 * æœ€è¿‘å…¬å…±ç¥–å…ˆçš„å®šä¹‰ä¸ºï¼šå¯¹äºæœ‰æ ¹æ ‘ T çš„ä¸¤ä¸ªèŠ‚ç‚¹ pã€qï¼Œæœ€è¿‘å…¬å…±ç¥–å…ˆè¡¨ç¤ºä¸ºä¸€ä¸ªèŠ‚ç‚¹ xï¼Œ
 * æ»¡è¶³ x æ˜¯ pã€q çš„ç¥–å…ˆä¸” x çš„æ·±åº¦å°½å¯èƒ½å¤§ï¼ˆä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„ç¥–å…ˆï¼‰ã€‚
 *
 * ç¤ºä¾‹ï¼š
 *          3
 *         / \
 *        5   1
 *       / \ / \
 *      6  2 0  8
 *        / \
 *       7   4
 *
 * è¾“å…¥ï¼šroot = [3,5,1,6,2,0,8,null,null,7,4], p = 5, q = 1
 * è¾“å‡ºï¼š3
 * è§£é‡Šï¼šèŠ‚ç‚¹ 5 å’ŒèŠ‚ç‚¹ 1 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯èŠ‚ç‚¹ 3
 *
 * è¾“å…¥ï¼šroot = [3,5,1,6,2,0,8,null,null,7,4], p = 5, q = 4
 * è¾“å‡ºï¼š5
 * è§£é‡Šï¼šèŠ‚ç‚¹ 5 å’ŒèŠ‚ç‚¹ 4 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆæ˜¯èŠ‚ç‚¹ 5ï¼ˆç¥–å…ˆå¯ä»¥æ˜¯è‡ªå·±ï¼‰
 */

class TreeNode {
  val: number;
  left: TreeNode | null;
  right: TreeNode | null;
  constructor(val?: number, left?: TreeNode | null, right?: TreeNode | null) {
    this.val = val === undefined ? 0 : val;
    this.left = left === undefined ? null : left;
    this.right = right === undefined ? null : right;
  }
}

// ============================================================
// ğŸ’¡ æ€è·¯åˆ†æï¼šè¿™é“é¢˜çš„è§£æ³•æ˜¯æ€ä¹ˆæƒ³å‡ºæ¥çš„ï¼Ÿ
// ============================================================
//
// é€’å½’æ€è·¯ï¼š
// 1. å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ p æˆ– qï¼Œè¿”å›å½“å‰èŠ‚ç‚¹
// 2. é€’å½’æœç´¢å·¦å³å­æ ‘
// 3. å¦‚æœå·¦å³éƒ½æ‰¾åˆ°äº†ï¼Œå½“å‰èŠ‚ç‚¹å°±æ˜¯ LCA
// 4. å¦‚æœåªæœ‰ä¸€è¾¹æ‰¾åˆ°ï¼Œè¿”å›é‚£ä¸€è¾¹çš„ç»“æœ
//
// ä¸‰ç§æƒ…å†µï¼š
// - p å’Œ q åˆ†åˆ«åœ¨å·¦å³å­æ ‘ â†’ å½“å‰èŠ‚ç‚¹æ˜¯ LCA
// - p å’Œ q éƒ½åœ¨å·¦å­æ ‘ â†’ LCA åœ¨å·¦å­æ ‘
// - p å’Œ q éƒ½åœ¨å³å­æ ‘ â†’ LCA åœ¨å³å­æ ‘

// ============================================================
// è§£æ³•ï¼šé€’å½’
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n) | ç©ºé—´å¤æ‚åº¦ï¼šO(h)

/**
 * ğŸ“Š é€’å½’è¿‡ç¨‹å›¾è§£ï¼š
 *
 *          3
 *         / \
 *        5   1
 *       / \
 *      6   2
 *         / \
 *        7   4
 *
 * æ‰¾ LCA(5, 4):
 *
 * ä» 3 å¼€å§‹ï¼š
 *   - æœç´¢å·¦å­æ ‘(5)ï¼šå‘ç° 5 == pï¼Œè¿”å› 5
 *   - ä¸éœ€è¦ç»§ç»­æœç´¢ 5 çš„å­æ ‘ï¼Œå› ä¸º 5 æœ¬èº«å°±æ˜¯å¯èƒ½çš„ LCA
 *
 * ä½†ç­‰ç­‰ï¼Œ4 åœ¨ 5 çš„å­æ ‘é‡Œï¼
 * å®é™…ä¸Šè¿”å› 5 æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºï¼š
 *   - 5 æ˜¯ p
 *   - 4 åœ¨ 5 çš„å­æ ‘é‡Œ
 *   - æ‰€ä»¥ 5 å°±æ˜¯ LCA
 *
 * ğŸ”„ é€’å½’é€»è¾‘ (Mermaid):
 * ```mermaid
 * flowchart TD
 *     A[å½“å‰èŠ‚ç‚¹] --> B{æ˜¯ p æˆ– q?}
 *     B -->|Yes| C[è¿”å›å½“å‰èŠ‚ç‚¹]
 *     B -->|No| D[é€’å½’æœç´¢å·¦å­æ ‘]
 *     D --> E[é€’å½’æœç´¢å³å­æ ‘]
 *     E --> F{å·¦å³éƒ½æ‰¾åˆ°?}
 *     F -->|Yes| G[è¿”å›å½“å‰èŠ‚ç‚¹ LCA]
 *     F -->|No| H[è¿”å›æ‰¾åˆ°çš„é‚£ä¸€è¾¹]
 * ```
 */
function lowestCommonAncestor(
  root: TreeNode | null,
  p: TreeNode,
  q: TreeNode
): TreeNode | null {
  // Base Case: ç©ºèŠ‚ç‚¹æˆ–æ‰¾åˆ° p/q
  if (!root || root === p || root === q) {
    return root;
  }

  // åœ¨å·¦å³å­æ ‘ä¸­æœç´¢
  const left = lowestCommonAncestor(root.left, p, q);
  const right = lowestCommonAncestor(root.right, p, q);

  // å¦‚æœå·¦å³éƒ½æ‰¾åˆ°äº†ï¼Œå½“å‰èŠ‚ç‚¹å°±æ˜¯ LCA
  if (left && right) {
    return root;
  }

  // å¦åˆ™è¿”å›æ‰¾åˆ°çš„é‚£ä¸€è¾¹ï¼ˆå¯èƒ½æ˜¯ nullï¼‰
  return left || right;
}

// ============================================================
// è§£æ³•äºŒï¼šå­˜å‚¨çˆ¶èŠ‚ç‚¹
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n) | ç©ºé—´å¤æ‚åº¦ï¼šO(n)
function lowestCommonAncestor_v2(
  root: TreeNode | null,
  p: TreeNode,
  q: TreeNode
): TreeNode | null {
  if (!root) return null;

  // å­˜å‚¨æ¯ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹
  const parent = new Map<TreeNode, TreeNode | null>();
  parent.set(root, null);

  // BFS éå†ï¼Œè®°å½•çˆ¶èŠ‚ç‚¹
  const queue: TreeNode[] = [root];
  while (!parent.has(p) || !parent.has(q)) {
    const node = queue.shift()!;
    if (node.left) {
      parent.set(node.left, node);
      queue.push(node.left);
    }
    if (node.right) {
      parent.set(node.right, node);
      queue.push(node.right);
    }
  }

  // è·å– p çš„æ‰€æœ‰ç¥–å…ˆ
  const ancestors = new Set<TreeNode>();
  let curr: TreeNode | null = p;
  while (curr) {
    ancestors.add(curr);
    curr = parent.get(curr) || null;
  }

  // æ‰¾ q çš„ç¥–å…ˆä¸­ç¬¬ä¸€ä¸ªä¹Ÿæ˜¯ p çš„ç¥–å…ˆçš„èŠ‚ç‚¹
  curr = q;
  while (curr && !ancestors.has(curr)) {
    curr = parent.get(curr) || null;
  }

  return curr;
}

// ============================================================
// ğŸ”„ è§£æ³•å¯¹æ¯”
// ============================================================
/**
 * | è§£æ³•         | æ—¶é—´  | ç©ºé—´  | ç‰¹ç‚¹                     |
 * |-------------|-------|-------|-------------------------|
 * | é€’å½’        | O(n)  | O(h)  | æ¨èï¼Œä»£ç ç®€æ´            |
 * | å­˜å‚¨çˆ¶èŠ‚ç‚¹   | O(n)  | O(n)  | æ€è·¯ç›´è§‚ï¼Œç©ºé—´è¾ƒå¤§        |
 */

// ============================================================
// âš ï¸ æ˜“é”™ç‚¹
// ============================================================
/**
 * 1. èŠ‚ç‚¹å¯ä»¥æ˜¯è‡ªå·±çš„ç¥–å…ˆï¼š
 *    - å¦‚æœ p æ˜¯ q çš„ç¥–å…ˆï¼ŒLCA å°±æ˜¯ p
 *
 * 2. é€’å½’è¿”å›å€¼çš„ç†è§£ï¼š
 *    - è¿”å› nullï¼šå½“å‰å­æ ‘ä¸­æ—¢æ²¡æœ‰ p ä¹Ÿæ²¡æœ‰ q
 *    - è¿”å›é nullï¼šæ‰¾åˆ°äº† p æˆ– qï¼Œæˆ–è€…æ‰¾åˆ°äº† LCA
 *
 * 3. ä¸¤è¾¹éƒ½æœ‰è¿”å›å€¼æ—¶ï¼š
 *    - è¯´æ˜ p å’Œ q åˆ†åˆ«åœ¨å·¦å³å­æ ‘
 *    - å½“å‰èŠ‚ç‚¹å°±æ˜¯ LCA
 */

// ============================================================
// ğŸ”— ä¸¾ä¸€åä¸‰ï¼šç›¸ä¼¼é¢˜ç›®
// ============================================================
/**
 * - BST çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ â†’ åˆ©ç”¨ BST æ€§è´¨ç®€åŒ–
 * - äºŒå‰æ ‘ä¸­çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ II â†’ èŠ‚ç‚¹å¯èƒ½ä¸å­˜åœ¨
 * - äºŒå‰æ ‘ä¸­çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ III â†’ ç»™å®šçˆ¶æŒ‡é’ˆ
 */

// ============================================================
// ğŸ¢ å‰ç«¯ä¸šåŠ¡åœºæ™¯
// ============================================================
/**
 * 1. DOM æ“ä½œï¼šæ‰¾ä¸¤ä¸ªå…ƒç´ çš„æœ€è¿‘å…¬å…±çˆ¶å…ƒç´ 
 * 2. ç»„ä»¶æ ‘ï¼šæ‰¾ä¸¤ä¸ªç»„ä»¶çš„å…¬å…±ç¥–å…ˆç»„ä»¶
 * 3. ç»„ç»‡æ¶æ„ï¼šæ‰¾ä¸¤ä¸ªäººçš„å…±åŒä¸Šçº§
 */

export { TreeNode, lowestCommonAncestor, lowestCommonAncestor_v2 };
export default lowestCommonAncestor;

