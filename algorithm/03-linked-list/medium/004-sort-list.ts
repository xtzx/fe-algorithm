/**
 * ğŸ“ é¢˜ç›®ï¼šæ’åºé“¾è¡¨
 * ğŸ”— é“¾æ¥ï¼šhttps://leetcode.cn/problems/sort-list/
 * ğŸ·ï¸ éš¾åº¦ï¼šMedium
 * ğŸ·ï¸ æ ‡ç­¾ï¼šé“¾è¡¨ã€åŒæŒ‡é’ˆã€åˆ†æ²»ã€æ’åºã€å½’å¹¶æ’åº
 *
 * ğŸ“‹ é¢˜ç›®æè¿°ï¼š
 * ç»™ä½ é“¾è¡¨çš„å¤´ç»“ç‚¹ headï¼Œè¯·å°†å…¶æŒ‰ å‡åº æ’åˆ—å¹¶è¿”å› æ’åºåçš„é“¾è¡¨ã€‚
 *
 * è¿›é˜¶ï¼šä½ å¯ä»¥åœ¨ O(n log n) æ—¶é—´å¤æ‚åº¦å’Œå¸¸æ•°çº§ç©ºé—´å¤æ‚åº¦ä¸‹ï¼Œå¯¹é“¾è¡¨è¿›è¡Œæ’åºå—ï¼Ÿ
 *
 * ç¤ºä¾‹ï¼š
 * è¾“å…¥ï¼šhead = [4,2,1,3]
 * è¾“å‡ºï¼š[1,2,3,4]
 */

class ListNode {
  val: number;
  next: ListNode | null;
  constructor(val?: number, next?: ListNode | null) {
    this.val = val === undefined ? 0 : val;
    this.next = next === undefined ? null : next;
  }
}

// ============================================================
// ğŸ’¡ æ€è·¯åˆ†æï¼šè¿™é“é¢˜çš„è§£æ³•æ˜¯æ€ä¹ˆæƒ³å‡ºæ¥çš„ï¼Ÿ
// ============================================================
//
// é“¾è¡¨æ’åºçš„æœ€ä½³é€‰æ‹©ï¼šå½’å¹¶æ’åº
//
// ä¸ºä»€ä¹ˆé€‰å½’å¹¶æ’åºï¼Ÿ
// - å½’å¹¶æ’åºæ˜¯ç¨³å®šçš„ O(n log n) æ’åº
// - é“¾è¡¨çš„åˆå¹¶æ˜¯ O(1) ç©ºé—´ï¼ˆä¸éœ€è¦é¢å¤–æ•°ç»„ï¼‰
// - é“¾è¡¨ä¸æ”¯æŒéšæœºè®¿é—®ï¼Œä¸é€‚åˆå¿«æ’
//
// å½’å¹¶æ’åºæ­¥éª¤ï¼š
// 1. æ‰¾åˆ°é“¾è¡¨ä¸­ç‚¹ï¼Œåˆ†æˆä¸¤åŠ
// 2. é€’å½’æ’åºä¸¤åŠ
// 3. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨

// ============================================================
// è§£æ³•ä¸€ï¼šå½’å¹¶æ’åºï¼ˆé€’å½’ï¼Œæ¨èï¼‰
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n log n) | ç©ºé—´å¤æ‚åº¦ï¼šO(log n) é€’å½’æ ˆ

/**
 * ğŸ“Š å½’å¹¶æ’åºå›¾è§£ï¼š
 *
 * åŸé“¾è¡¨: 4 -> 2 -> 1 -> 3
 *
 * ç¬¬ä¸€å±‚åˆ†å‰²:
 *   4 -> 2  |  1 -> 3
 *
 * ç¬¬äºŒå±‚åˆ†å‰²:
 *   4 | 2  |  1 | 3
 *
 * åˆå¹¶:
 *   2 -> 4  |  1 -> 3
 *
 * ç»§ç»­åˆå¹¶:
 *   1 -> 2 -> 3 -> 4
 *
 * ğŸ”„ æµç¨‹å›¾ (Mermaid):
 * ```mermaid
 * flowchart TD
 *     A[åŸé“¾è¡¨] --> B[æ‰¾ä¸­ç‚¹]
 *     B --> C[åˆ†å‰²æˆä¸¤åŠ]
 *     C --> D[é€’å½’æ’åºå·¦åŠ]
 *     C --> E[é€’å½’æ’åºå³åŠ]
 *     D --> F[åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨]
 *     E --> F
 *     F --> G[è¿”å›æ’åºåçš„é“¾è¡¨]
 * ```
 */
function sortList_v1(head: ListNode | null): ListNode | null {
  // åŸºæœ¬æƒ…å†µï¼šç©ºé“¾è¡¨æˆ–åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹
  if (!head || !head.next) return head;

  // 1. æ‰¾åˆ°ä¸­ç‚¹ï¼Œåˆ†å‰²æˆä¸¤åŠ
  const mid = findMiddle(head);
  const rightHead = mid.next;
  mid.next = null; // æ–­å¼€è¿æ¥

  // 2. é€’å½’æ’åºä¸¤åŠ
  const left = sortList_v1(head);
  const right = sortList_v1(rightHead);

  // 3. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨
  return merge(left, right);
}

// æ‰¾ä¸­ç‚¹ï¼ˆè¿”å›å·¦åŠéƒ¨åˆ†çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼‰
function findMiddle(head: ListNode): ListNode {
  let slow = head;
  let fast = head;

  while (fast.next && fast.next.next) {
    slow = slow.next!;
    fast = fast.next.next;
  }

  return slow;
}

// åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨
function merge(l1: ListNode | null, l2: ListNode | null): ListNode | null {
  const dummy = new ListNode(0);
  let curr = dummy;

  while (l1 && l2) {
    if (l1.val <= l2.val) {
      curr.next = l1;
      l1 = l1.next;
    } else {
      curr.next = l2;
      l2 = l2.next;
    }
    curr = curr.next;
  }

  curr.next = l1 || l2;
  return dummy.next;
}

// ============================================================
// è§£æ³•äºŒï¼šå½’å¹¶æ’åºï¼ˆè¿­ä»£ï¼ŒO(1) ç©ºé—´ï¼‰
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n log n) | ç©ºé—´å¤æ‚åº¦ï¼šO(1)
// ğŸ“ è‡ªåº•å‘ä¸Šçš„å½’å¹¶æ’åºï¼Œæ»¡è¶³è¿›é˜¶è¦æ±‚

/**
 * ğŸ“Š è¿­ä»£å½’å¹¶æ’åºå›¾è§£ï¼š
 *
 * åŸé“¾è¡¨: 4 -> 2 -> 1 -> 3
 *
 * step = 1: æ¯ 1 ä¸ªä¸€ç»„ï¼Œä¸¤ä¸¤åˆå¹¶
 *   (4) (2) -> (2 -> 4)
 *   (1) (3) -> (1 -> 3)
 *   ç»“æœ: 2 -> 4 -> 1 -> 3
 *
 * step = 2: æ¯ 2 ä¸ªä¸€ç»„ï¼Œä¸¤ä¸¤åˆå¹¶
 *   (2 -> 4) (1 -> 3) -> (1 -> 2 -> 3 -> 4)
 *   ç»“æœ: 1 -> 2 -> 3 -> 4
 *
 * step = 4 >= lengthï¼Œç»“æŸ
 */
function sortList_v2(head: ListNode | null): ListNode | null {
  if (!head || !head.next) return head;

  // è®¡ç®—é“¾è¡¨é•¿åº¦
  let length = 0;
  let curr: ListNode | null = head;
  while (curr) {
    length++;
    curr = curr.next;
  }

  const dummy = new ListNode(0);
  dummy.next = head;

  // step ä» 1 å¼€å§‹ï¼Œæ¯æ¬¡ç¿»å€
  for (let step = 1; step < length; step *= 2) {
    let prev = dummy;
    curr = dummy.next;

    while (curr) {
      // è·å–ç¬¬ä¸€æ®µ
      const left = curr;
      const right = split(left, step);
      curr = split(right, step);

      // åˆå¹¶ä¸¤æ®µï¼Œè¿æ¥åˆ° prev åé¢
      prev = mergeAndGetTail(prev, left, right);
    }
  }

  return dummy.next;
}

// åˆ†å‰²é“¾è¡¨ï¼šä» head å¼€å§‹ï¼Œåˆ†å‰²å‡º n ä¸ªèŠ‚ç‚¹ï¼Œè¿”å›å‰©ä½™éƒ¨åˆ†çš„å¤´
function split(head: ListNode | null, n: number): ListNode | null {
  if (!head) return null;

  for (let i = 1; i < n && head.next; i++) {
    head = head.next;
  }

  const rest = head.next;
  head.next = null;
  return rest;
}

// åˆå¹¶ä¸¤ä¸ªé“¾è¡¨ï¼Œè¿æ¥åˆ° prev åé¢ï¼Œè¿”å›åˆå¹¶åçš„å°¾èŠ‚ç‚¹
function mergeAndGetTail(
  prev: ListNode,
  l1: ListNode | null,
  l2: ListNode | null
): ListNode {
  let curr = prev;

  while (l1 && l2) {
    if (l1.val <= l2.val) {
      curr.next = l1;
      l1 = l1.next;
    } else {
      curr.next = l2;
      l2 = l2.next;
    }
    curr = curr.next;
  }

  curr.next = l1 || l2;

  // ç§»åŠ¨åˆ°å°¾èŠ‚ç‚¹
  while (curr.next) {
    curr = curr.next;
  }

  return curr;
}

// ============================================================
// ğŸ”„ è§£æ³•å¯¹æ¯”
// ============================================================
/**
 * | è§£æ³•         | æ—¶é—´        | ç©ºé—´       | ç‰¹ç‚¹                  |
 * |-------------|-------------|------------|----------------------|
 * | é€’å½’å½’å¹¶     | O(n log n)  | O(log n)   | æ¨èï¼Œä»£ç ç®€æ´         |
 * | è¿­ä»£å½’å¹¶     | O(n log n)  | O(1)       | æ»¡è¶³è¿›é˜¶ï¼Œä»£ç å¤æ‚      |
 */

// ============================================================
// âš ï¸ æ˜“é”™ç‚¹
// ============================================================
/**
 * 1. åˆ†å‰²é“¾è¡¨æ—¶è¦æ–­å¼€è¿æ¥ï¼š
 *    - mid.next = null
 *
 * 2. æ‰¾ä¸­ç‚¹çš„æ–¹å¼ï¼š
 *    - è¦è¿”å›å·¦åŠéƒ¨åˆ†çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹
 *    - ç”¨äºæ–­å¼€è¿æ¥
 *
 * 3. è¿­ä»£ç‰ˆæœ¬çš„å¤æ‚åº¦ï¼š
 *    - step ä» 1 å¼€å§‹ï¼Œæ¯æ¬¡ç¿»å€
 *    - å¤–å±‚å¾ªç¯ log n æ¬¡
 */

// ============================================================
// ğŸ”— ä¸¾ä¸€åä¸‰ï¼šç›¸ä¼¼é¢˜ç›®
// ============================================================
/**
 * - åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨ â†’ å½’å¹¶çš„åŸºç¡€
 * - åˆå¹¶ K ä¸ªå‡åºé“¾è¡¨ â†’ åˆ†æ²» + å½’å¹¶
 * - æ•°ç»„çš„å½’å¹¶æ’åº â†’ ç±»ä¼¼æ€è·¯
 */

// ============================================================
// ğŸ¢ å‰ç«¯ä¸šåŠ¡åœºæ™¯
// ============================================================
/**
 * 1. æ•°æ®æ’åºï¼šå¯¹é“¾å¼å­˜å‚¨çš„æ•°æ®æ’åº
 * 2. æ—¥å¿—æ’åºï¼šæŒ‰æ—¶é—´æ’åºæ—¥å¿—
 * 3. ä»»åŠ¡è°ƒåº¦ï¼šæŒ‰ä¼˜å…ˆçº§æ’åºä»»åŠ¡é˜Ÿåˆ—
 */

export { ListNode, sortList_v1, sortList_v2 };
export default sortList_v1;

