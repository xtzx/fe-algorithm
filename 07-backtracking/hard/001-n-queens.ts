/**
 * ğŸ“ é¢˜ç›®ï¼šN çš‡å
 * ğŸ”— é“¾æ¥ï¼šhttps://leetcode.cn/problems/n-queens/
 * ğŸ·ï¸ éš¾åº¦ï¼šHard
 * ğŸ·ï¸ æ ‡ç­¾ï¼šæ•°ç»„ã€å›æº¯
 *
 * ğŸ“‹ é¢˜ç›®æè¿°ï¼š
 * æŒ‰ç…§å›½é™…è±¡æ£‹çš„è§„åˆ™ï¼Œçš‡åå¯ä»¥æ”»å‡»ä¸ä¹‹å¤„åœ¨åŒä¸€è¡Œæˆ–åŒä¸€åˆ—æˆ–åŒä¸€æ–œçº¿ä¸Šçš„æ£‹å­ã€‚
 *
 * n çš‡åé—®é¢˜ ç ”ç©¶çš„æ˜¯å¦‚ä½•å°† n ä¸ªçš‡åæ”¾ç½®åœ¨ nÃ—n çš„æ£‹ç›˜ä¸Šï¼Œå¹¶ä¸”ä½¿çš‡åå½¼æ­¤ä¹‹é—´ä¸èƒ½ç›¸äº’æ”»å‡»ã€‚
 *
 * ç»™ä½ ä¸€ä¸ªæ•´æ•° nï¼Œè¿”å›æ‰€æœ‰ä¸åŒçš„ n çš‡åé—®é¢˜ çš„è§£å†³æ–¹æ¡ˆã€‚
 *
 * ç¤ºä¾‹ï¼š
 * è¾“å…¥ï¼šn = 4
 * è¾“å‡ºï¼š[[".Q..","...Q","Q...","..Q."],["..Q.","Q...","...Q",".Q.."]]
 *
 * å›¾ç¤ºï¼ˆn=4 çš„ä¸€ç§è§£æ³•ï¼‰ï¼š
 *   . Q . .
 *   . . . Q
 *   Q . . .
 *   . . Q .
 */

// ============================================================
// ğŸ’¡ æ€è·¯åˆ†æï¼šè¿™é“é¢˜çš„è§£æ³•æ˜¯æ€ä¹ˆæƒ³å‡ºæ¥çš„ï¼Ÿ
// ============================================================
//
// æ¯ä¸€è¡Œæ”¾ä¸€ä¸ªçš‡å â†’ æ’åˆ—é—®é¢˜
// æ”¾ç½®æ—¶æ£€æŸ¥æ˜¯å¦å†²çª â†’ å‰ªæ
//
// å†²çªæ¡ä»¶ï¼š
// 1. åŒä¸€åˆ—ï¼šcol ç›¸åŒ
// 2. ä¸»å¯¹è§’çº¿ï¼šrow - col ç›¸åŒ
// 3. å‰¯å¯¹è§’çº¿ï¼šrow + col ç›¸åŒ
//
// ç”¨é›†åˆè®°å½•å·²è¢«å ç”¨çš„åˆ—å’Œå¯¹è§’çº¿

// ============================================================
// è§£æ³•ï¼šå›æº¯ + é›†åˆå‰ªæ
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n!) | ç©ºé—´å¤æ‚åº¦ï¼šO(n)

/**
 * ğŸ“Š æ‰§è¡Œè¿‡ç¨‹å›¾è§£ (n=4)ï¼š
 *
 * ç¬¬ 0 è¡Œï¼šå°è¯• Q æ”¾åœ¨æ¯ä¸€åˆ—
 *
 *   Q . . .     . Q . .     . . Q .     . . . Q
 *     â†“           â†“           â†“           â†“
 *   æ£€æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦æœ‰åˆæ³•ä½ç½®
 *
 * ğŸ”„ å›æº¯è¿‡ç¨‹ (Mermaid):
 *
 * ```mermaid
 * flowchart TD
 *     A[row=0] --> B{éå† col}
 *     B --> C[æ£€æŸ¥æ˜¯å¦å†²çª]
 *     C -->|æ— å†²çª| D[æ”¾ç½®çš‡å]
 *     D --> E[æ ‡è®°åˆ—å’Œå¯¹è§’çº¿]
 *     E --> F[é€’å½’ row+1]
 *     F --> G[æ’¤é”€æ ‡è®°]
 *     C -->|æœ‰å†²çª| B
 *     F -->|row==n| H[æ”¶é›†ç»“æœ]
 * ```
 */
function solveNQueens(n: number): string[][] {
  const result: string[][] = [];
  // è®°å½•æ¯ä¸€è¡Œçš‡åæ”¾åœ¨å“ªä¸€åˆ—
  const queens: number[] = [];

  // è®°å½•å·²å ç”¨çš„åˆ—å’Œå¯¹è§’çº¿
  const cols = new Set<number>();
  const diag1 = new Set<number>(); // ä¸»å¯¹è§’çº¿ row - col
  const diag2 = new Set<number>(); // å‰¯å¯¹è§’çº¿ row + col

  function backtrack(row: number) {
    // æ‰€æœ‰è¡Œéƒ½æ”¾å¥½äº†
    if (row === n) {
      result.push(generateBoard(queens, n));
      return;
    }

    // å°è¯•åœ¨å½“å‰è¡Œçš„æ¯ä¸€åˆ—æ”¾çš‡å
    for (let col = 0; col < n; col++) {
      // æ£€æŸ¥æ˜¯å¦å†²çª
      if (cols.has(col) || diag1.has(row - col) || diag2.has(row + col)) {
        continue;
      }

      // æ”¾ç½®çš‡å
      queens.push(col);
      cols.add(col);
      diag1.add(row - col);
      diag2.add(row + col);

      // é€’å½’ä¸‹ä¸€è¡Œ
      backtrack(row + 1);

      // æ’¤é”€
      queens.pop();
      cols.delete(col);
      diag1.delete(row - col);
      diag2.delete(row + col);
    }
  }

  backtrack(0);
  return result;
}

// ç”Ÿæˆæ£‹ç›˜å­—ç¬¦ä¸²
function generateBoard(queens: number[], n: number): string[] {
  const board: string[] = [];
  for (const col of queens) {
    board.push('.'.repeat(col) + 'Q' + '.'.repeat(n - col - 1));
  }
  return board;
}

// ============================================================
// è§£æ³•äºŒï¼šä½è¿ç®—ä¼˜åŒ–ï¼ˆè¿›é˜¶ï¼‰
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n!) | ç©ºé—´å¤æ‚åº¦ï¼šO(n)

/**
 * ç”¨ä½è¿ç®—ä»£æ›¿é›†åˆï¼Œæ›´å¿«
 * - col: å·²å ç”¨çš„åˆ—
 * - diag1: ä¸»å¯¹è§’çº¿
 * - diag2: å‰¯å¯¹è§’çº¿
 *
 * availablePos = ~(col | diag1 | diag2) & ((1 << n) - 1)
 */
function solveNQueens_bit(n: number): string[][] {
  const result: string[][] = [];
  const queens: number[] = [];

  function backtrack(row: number, col: number, diag1: number, diag2: number) {
    if (row === n) {
      result.push(generateBoard(queens, n));
      return;
    }

    // è®¡ç®—å¯ç”¨ä½ç½®ï¼ˆä½è¿ç®—ï¼‰
    let availablePos = ~(col | diag1 | diag2) & ((1 << n) - 1);

    while (availablePos) {
      // å–æœ€ä½ä½çš„ 1
      const pos = availablePos & -availablePos;
      // è®¡ç®—åˆ—å·
      const colIndex = Math.log2(pos);

      queens.push(colIndex);
      backtrack(
        row + 1,
        col | pos, // æ ‡è®°åˆ—
        (diag1 | pos) << 1, // ä¸»å¯¹è§’çº¿å·¦ç§»
        (diag2 | pos) >> 1 // å‰¯å¯¹è§’çº¿å³ç§»
      );
      queens.pop();

      // å»æ‰æœ€ä½ä½çš„ 1
      availablePos &= availablePos - 1;
    }
  }

  backtrack(0, 0, 0, 0);
  return result;
}

// ============================================================
// ğŸ”„ è§£æ³•å¯¹æ¯”
// ============================================================
/**
 * | è§£æ³•     | æ—¶é—´   | ç©ºé—´  | ç‰¹ç‚¹              |
 * |----------|--------|-------|-------------------|
 * | é›†åˆ     | O(n!)  | O(n)  | æ¨èï¼Œæ˜“äºç†è§£     |
 * | ä½è¿ç®—   | O(n!)  | O(n)  | æ›´å¿«ï¼Œé€‚åˆ n è¾ƒå¤§ |
 */

// ============================================================
// âš ï¸ æ˜“é”™ç‚¹
// ============================================================
/**
 * 1. å¯¹è§’çº¿çš„è¡¨ç¤ºï¼š
 *    - ä¸»å¯¹è§’çº¿ï¼šrow - col ç›¸åŒï¼ˆå¯èƒ½ä¸ºè´Ÿæ•°ï¼‰
 *    - å‰¯å¯¹è§’çº¿ï¼šrow + col ç›¸åŒ
 *
 * 2. çŠ¶æ€çš„æ’¤é”€ï¼š
 *    - æ’¤é”€æ—¶è¦å®Œæ•´ï¼ˆqueens, cols, diag1, diag2ï¼‰
 *
 * 3. æ£‹ç›˜ç”Ÿæˆï¼š
 *    - æ³¨æ„å­—ç¬¦ä¸²çš„æ‹¼æ¥æ–¹å¼
 */

// ============================================================
// ğŸ”— ä¸¾ä¸€åä¸‰ï¼šç›¸ä¼¼é¢˜ç›®
// ============================================================
/**
 * - N çš‡å II â†’ åªè¿”å›è§£çš„æ•°é‡
 * - è§£æ•°ç‹¬ â†’ ç±»ä¼¼çš„çº¦æŸæ»¡è¶³é—®é¢˜
 */

// ============================================================
// ğŸ¢ å‰ç«¯ä¸šåŠ¡åœºæ™¯
// ============================================================
/**
 * 1. æ’ç­ç³»ç»Ÿï¼šå¤šä¸ªçº¦æŸæ¡ä»¶ä¸‹çš„èµ„æºåˆ†é…
 * 2. å¸ƒå±€å¼•æ“ï¼šç»„ä»¶ä¸èƒ½é‡å çš„å¸ƒå±€è®¡ç®—
 */

export { solveNQueens, solveNQueens_bit };
export default solveNQueens;

