/**
 * ğŸ“ é¢˜ç›®ï¼šå•è¯æœç´¢ II
 * ğŸ”— é“¾æ¥ï¼šhttps://leetcode.cn/problems/word-search-ii/
 * ğŸ·ï¸ éš¾åº¦ï¼šHard
 * ğŸ·ï¸ æ ‡ç­¾ï¼šå­—å…¸æ ‘ã€æ•°ç»„ã€å­—ç¬¦ä¸²ã€å›æº¯ã€çŸ©é˜µ
 *
 * ğŸ“‹ é¢˜ç›®æè¿°ï¼š
 * ç»™å®šä¸€ä¸ª m x n äºŒç»´å­—ç¬¦ç½‘æ ¼ board å’Œä¸€ä¸ªå•è¯ï¼ˆå­—ç¬¦ä¸²ï¼‰åˆ—è¡¨ wordsï¼Œ
 * è¿”å›æ‰€æœ‰äºŒç»´ç½‘æ ¼ä¸Šçš„å•è¯ã€‚
 *
 * å•è¯å¿…é¡»æŒ‰ç…§å­—æ¯é¡ºåºï¼Œé€šè¿‡ ç›¸é‚»çš„å•å…ƒæ ¼ å†…çš„å­—æ¯æ„æˆï¼Œ
 * å…¶ä¸­"ç›¸é‚»"å•å…ƒæ ¼æ˜¯é‚£äº›æ°´å¹³ç›¸é‚»æˆ–å‚ç›´ç›¸é‚»çš„å•å…ƒæ ¼ã€‚
 * åŒä¸€ä¸ªå•å…ƒæ ¼å†…çš„å­—æ¯åœ¨ä¸€ä¸ªå•è¯ä¸­ä¸å…è®¸è¢«é‡å¤ä½¿ç”¨ã€‚
 *
 * ç¤ºä¾‹ï¼š
 * è¾“å…¥ï¼šboard = [["o","a","a","n"],["e","t","a","e"],["i","h","k","r"],["i","f","l","v"]],
 *       words = ["oath","pea","eat","rain"]
 * è¾“å‡ºï¼š["eat","oath"]
 */

// ============================================================
// ğŸ’¡ æ€è·¯åˆ†æï¼šè¿™é“é¢˜çš„è§£æ³•æ˜¯æ€ä¹ˆæƒ³å‡ºæ¥çš„ï¼Ÿ
// ============================================================
//
// æ–¹æ³•ä¸€ï¼šæœ´ç´ å›æº¯
// - å¯¹æ¯ä¸ªå•è¯ï¼Œä»æ¯ä¸ªæ ¼å­å¼€å§‹æœç´¢
// - æ—¶é—´å¤æ‚åº¦å¤ªé«˜
//
// æ–¹æ³•äºŒï¼šå­—å…¸æ ‘ + å›æº¯
// - å…ˆç”¨æ‰€æœ‰å•è¯æ„å»ºå­—å…¸æ ‘
// - ä»æ¯ä¸ªæ ¼å­å¼€å§‹ï¼Œåœ¨å­—å…¸æ ‘ä¸ŠåŒæ—¶æœç´¢
// - å¤§å¤§å‡å°‘é‡å¤æœç´¢
//
// ä¸ºä»€ä¹ˆç”¨å­—å…¸æ ‘ï¼Ÿ
// - å¤šä¸ªå•è¯å¯èƒ½æœ‰å…¬å…±å‰ç¼€
// - å­—å…¸æ ‘å¯ä»¥åŒæ—¶åŒ¹é…å¤šä¸ªå•è¯
// - é‡åˆ°ä¸åœ¨å­—å…¸æ ‘ä¸Šçš„è·¯å¾„å¯ä»¥æå‰å‰ªæ

// ============================================================
// è§£æ³•ï¼šå­—å…¸æ ‘ + å›æº¯
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(m Ã— n Ã— 4 Ã— 3^(L-1)) | ç©ºé—´å¤æ‚åº¦ï¼šO(å•è¯æ€»é•¿åº¦)

// å­—å…¸æ ‘èŠ‚ç‚¹
class TrieNode {
  children: Map<string, TrieNode> = new Map();
  word: string | null = null; // å¦‚æœæ˜¯å•è¯ç»“å°¾ï¼Œè®°å½•è¿™ä¸ªå•è¯
}

function findWords(board: string[][], words: string[]): string[] {
  // 1. æ„å»ºå­—å…¸æ ‘
  const root = new TrieNode();
  for (const word of words) {
    let node = root;
    for (const char of word) {
      if (!node.children.has(char)) {
        node.children.set(char, new TrieNode());
      }
      node = node.children.get(char)!;
    }
    node.word = word; // æ ‡è®°å•è¯ç»“å°¾
  }

  const result: string[] = [];
  const m = board.length;
  const n = board[0].length;
  const directions = [
    [0, 1],
    [0, -1],
    [1, 0],
    [-1, 0],
  ];

  // 2. å›æº¯æœç´¢
  function backtrack(row: number, col: number, node: TrieNode) {
    // è¾¹ç•Œæ£€æŸ¥
    if (row < 0 || row >= m || col < 0 || col >= n) return;

    const char = board[row][col];

    // å‰ªæï¼šå­—ç¬¦ä¸åœ¨å­—å…¸æ ‘ä¸Šï¼Œæˆ–å·²è®¿é—®
    if (char === '#' || !node.children.has(char)) return;

    const nextNode = node.children.get(char)!;

    // æ‰¾åˆ°ä¸€ä¸ªå•è¯
    if (nextNode.word !== null) {
      result.push(nextNode.word);
      nextNode.word = null; // é¿å…é‡å¤æ·»åŠ 
    }

    // æ ‡è®°ä¸ºå·²è®¿é—®
    board[row][col] = '#';

    // å››ä¸ªæ–¹å‘æœç´¢
    for (const [dr, dc] of directions) {
      backtrack(row + dr, col + dc, nextNode);
    }

    // æ¢å¤
    board[row][col] = char;

    // ä¼˜åŒ–ï¼šå‰ªæç©ºèŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰
    if (nextNode.children.size === 0) {
      node.children.delete(char);
    }
  }

  // 3. ä»æ¯ä¸ªæ ¼å­å¼€å§‹æœç´¢
  for (let i = 0; i < m; i++) {
    for (let j = 0; j < n; j++) {
      backtrack(i, j, root);
    }
  }

  return result;
}

// ============================================================
// ğŸ“Š å­—å…¸æ ‘å›¾è§£
// ============================================================

/**
 * words = ["oath", "oat", "pea", "eat"]
 *
 * å­—å…¸æ ‘ç»“æ„ï¼š
 *
 *           root
 *         /   |   \
 *        o    p    e
 *        |    |    |
 *        a    e    a
 *        |    |    |
 *        t*   a*   t*
 *        |
 *        h*
 *
 * * è¡¨ç¤ºå•è¯ç»“å°¾
 *
 * æœç´¢æ—¶ï¼š
 * - ä» board æŸä¸ªæ ¼å­å¼€å§‹
 * - æ¯èµ°ä¸€æ­¥ï¼Œåœ¨å­—å…¸æ ‘ä¸Šä¹Ÿèµ°ä¸€æ­¥
 * - å¦‚æœå­—å…¸æ ‘ä¸Šèµ°ä¸é€šï¼Œå‰ªæ
 * - å¦‚æœé‡åˆ°å•è¯ç»“å°¾ï¼Œè®°å½•ç»“æœ
 */

// ============================================================
// ğŸ”‘ ä¼˜åŒ–æŠ€å·§
// ============================================================

/**
 * 1. å‰ªæç©ºèŠ‚ç‚¹ï¼š
 *    - æ‰¾åˆ°å•è¯åï¼Œå¦‚æœèŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œä»å­—å…¸æ ‘åˆ é™¤
 *    - å‡å°‘åç»­æœç´¢
 *
 * 2. æ ‡è®°å·²è®¿é—®ï¼š
 *    - ç›´æ¥ä¿®æ”¹ boardï¼Œç”¨ç‰¹æ®Šå­—ç¬¦æ ‡è®°
 *    - é¿å…ä½¿ç”¨é¢å¤–çš„ visited æ•°ç»„
 *
 * 3. åœ¨èŠ‚ç‚¹ä¸Šè®°å½•å•è¯ï¼š
 *    - è€Œä¸æ˜¯ä»æ ¹åˆ°å¶å­é‡æ–°æ‹¼æ¥
 *    - æ‰¾åˆ°åç›´æ¥è·å–
 */

// ============================================================
// âš ï¸ æ˜“é”™ç‚¹
// ============================================================
/**
 * 1. å»é‡ï¼š
 *    - åŒä¸€ä¸ªå•è¯å¯èƒ½ä»ä¸åŒè·¯å¾„æ‰¾åˆ°
 *    - æ‰¾åˆ°åå°† node.word è®¾ä¸º null
 *
 * 2. æ¢å¤çŠ¶æ€ï¼š
 *    - æ ‡è®°å·²è®¿é—®åè¦æ¢å¤
 *
 * 3. å­—å…¸æ ‘æ„å»ºï¼š
 *    - åœ¨å¶å­èŠ‚ç‚¹è®°å½•å®Œæ•´å•è¯
 */

// ============================================================
// ğŸ”— ä¸¾ä¸€åä¸‰ï¼šç›¸ä¼¼é¢˜ç›®
// ============================================================
/**
 * - å•è¯æœç´¢ â†’ åªæœç´¢ä¸€ä¸ªå•è¯
 * - å®ç° Trieï¼ˆå‰ç¼€æ ‘ï¼‰â†’ å­—å…¸æ ‘åŸºç¡€
 */

// ============================================================
// ğŸ¢ å‰ç«¯ä¸šåŠ¡åœºæ™¯
// ============================================================
/**
 * 1. æœç´¢å»ºè®®ï¼šä»å·²æœ‰æ•°æ®ä¸­å¿«é€ŸåŒ¹é…
 * 2. æ‹¼å†™æ£€æŸ¥ï¼šåœ¨å­—å…¸ä¸­æŸ¥æ‰¾ç›¸ä¼¼å•è¯
 * 3. è‡ªåŠ¨è¡¥å…¨ï¼šå‰ç¼€åŒ¹é…
 */

export { findWords };
export default findWords;

