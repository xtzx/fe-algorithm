# P13: æ–‡ä»¶è‡ªåŠ¨åŒ–

> æ‰¹å¤„ç†ä»»åŠ¡å¯æ§ã€å¯å›æ»šã€å¯æ¢å¤

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ¨¡å—åï¼Œä½ å°†èƒ½å¤Ÿï¼š

- ç¼–å†™å¯æ¢å¤çš„æ‰¹å¤„ç†è„šæœ¬
- å®ç° dry-run æ¨¡å¼é¢„è§ˆå˜æ›´
- è®¾è®¡å¹‚ç­‰æ“ä½œå’Œå›æ»šæœºåˆ¶
- å¤„ç†æ‰¹å¤„ç†ä¸­çš„å¤±è´¥ä¸é‡è¯•

## ğŸ“‹ å‰ç½®è¦æ±‚

- å®Œæˆ P12ï¼ˆæ•°æ®å¤„ç†ä¸æ¨¡å‹åŒ–ï¼‰
- ç†Ÿæ‚‰ `pathlib`ã€`json`ã€`logging`
- äº†è§£åŸºæœ¬çš„æ–‡ä»¶æ“ä½œ

## ğŸ—ºï¸ çŸ¥è¯†å›¾è°±

```
æ–‡ä»¶è‡ªåŠ¨åŒ–
â”œâ”€â”€ æ‰¹å¤„ç†è®¾è®¡æ¨¡å¼
â”‚   â”œâ”€â”€ Planner/Executor åˆ†ç¦»
â”‚   â”œâ”€â”€ æ“ä½œè®¡åˆ’ä¸æ‰§è¡Œ
â”‚   â””â”€â”€ åŸå­æ“ä½œ
â”œâ”€â”€ å¯æ¢å¤æœºåˆ¶
â”‚   â”œâ”€â”€ state.json æ–­ç‚¹ç»­è·‘
â”‚   â”œâ”€â”€ å¹‚ç­‰æ“ä½œè®¾è®¡
â”‚   â””â”€â”€ äº‹åŠ¡æ€ç»´
â”œâ”€â”€ Dry-run æ¨¡å¼
â”‚   â”œâ”€â”€ é¢„è§ˆå˜æ›´
â”‚   â”œâ”€â”€ ç¡®è®¤æ‰§è¡Œ
â”‚   â””â”€â”€ æ—¥å¿—è®°å½•
â”œâ”€â”€ å¤±è´¥å¤„ç†
â”‚   â”œâ”€â”€ å¤±è´¥æ±‡æ€»
â”‚   â”œâ”€â”€ é‡è¯•ç­–ç•¥
â”‚   â””â”€â”€ å›æ»šè®¾è®¡
â””â”€â”€ å¸¸è§è‡ªåŠ¨åŒ–ä»»åŠ¡
    â”œâ”€â”€ æ‰¹é‡é‡å‘½å
    â”œâ”€â”€ æ–‡ä»¶åˆ†ç±»æ•´ç†
    â”œâ”€â”€ æ‰¹é‡æ ¼å¼è½¬æ¢
    â””â”€â”€ æ•°æ®è¿ç§»
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd py-13-automation

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -e .

# è¿è¡Œç¤ºä¾‹
python -m file_automation --help

# è¿è¡Œæµ‹è¯•
pytest tests/ -v
```

## ğŸ“ ç›®å½•ç»“æ„

```
py-13-automation/
â”œâ”€â”€ README.md                 # æœ¬æ–‡ä»¶
â”œâ”€â”€ pyproject.toml           # é¡¹ç›®é…ç½®
â”œâ”€â”€ docs/                    # æ–‡æ¡£
â”‚   â”œâ”€â”€ 01-batch-patterns.md     # æ‰¹å¤„ç†è®¾è®¡æ¨¡å¼
â”‚   â”œâ”€â”€ 02-resumable.md          # å¯æ¢å¤æœºåˆ¶
â”‚   â”œâ”€â”€ 03-dry-run.md            # dry-run æ¨¡å¼
â”‚   â”œâ”€â”€ 04-failure-handling.md   # å¤±è´¥å¤„ç†
â”‚   â”œâ”€â”€ 05-common-tasks.md       # å¸¸è§è‡ªåŠ¨åŒ–ä»»åŠ¡
â”‚   â”œâ”€â”€ 06-exercises.md          # ç»ƒä¹ é¢˜
â”‚   â””â”€â”€ 07-interview.md          # é¢è¯•é¢˜
â”œâ”€â”€ src/
â”‚   â””â”€â”€ file_automation/     # æ ¸å¿ƒæºç 
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ planner.py           # æ“ä½œè®¡åˆ’å™¨
â”‚       â”œâ”€â”€ executor.py          # æ‰§è¡Œå™¨
â”‚       â”œâ”€â”€ state.py             # çŠ¶æ€ç®¡ç†
â”‚       â”œâ”€â”€ operations.py        # åŸå­æ“ä½œå®šä¹‰
â”‚       â””â”€â”€ cli.py               # å‘½ä»¤è¡Œæ¥å£
â”œâ”€â”€ tests/                   # æµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py
â”‚   â”œâ”€â”€ test_planner.py
â”‚   â”œâ”€â”€ test_executor.py
â”‚   â”œâ”€â”€ test_state.py
â”‚   â””â”€â”€ test_operations.py
â”œâ”€â”€ examples/                # ç¤ºä¾‹è„šæœ¬
â”‚   â””â”€â”€ sample_files/            # ç¤ºä¾‹æ–‡ä»¶
â””â”€â”€ scripts/
    â”œâ”€â”€ run_demo.sh              # è¿è¡Œæ¼”ç¤º
    â””â”€â”€ test.sh                  # è¿è¡Œæµ‹è¯•
```

## ğŸ“š å­¦ä¹ è·¯å¾„

### ç¬¬ä¸€é˜¶æ®µï¼šè®¾è®¡æ¨¡å¼ï¼ˆDay 1ï¼‰

1. é˜…è¯» `docs/01-batch-patterns.md`
2. ç†è§£ Planner/Executor åˆ†ç¦»æ¨¡å¼
3. å­¦ä¹ æ“ä½œè®¡åˆ’çš„è®¾è®¡

### ç¬¬äºŒé˜¶æ®µï¼šå¯æ¢å¤æœºåˆ¶ï¼ˆDay 2ï¼‰

1. é˜…è¯» `docs/02-resumable.md`
2. å®ç° state.json æ–­ç‚¹ç»­è·‘
3. ç†è§£å¹‚ç­‰æ“ä½œ

### ç¬¬ä¸‰é˜¶æ®µï¼šDry-run ä¸å¤±è´¥å¤„ç†ï¼ˆDay 3ï¼‰

1. é˜…è¯» `docs/03-dry-run.md` å’Œ `docs/04-failure-handling.md`
2. å®ç°é¢„è§ˆå’Œç¡®è®¤æµç¨‹
3. è®¾è®¡é‡è¯•å’Œå›æ»šç­–ç•¥

### ç¬¬å››é˜¶æ®µï¼šå®æˆ˜ä»»åŠ¡ï¼ˆDay 4ï¼‰

1. é˜…è¯» `docs/05-common-tasks.md`
2. å®Œæˆæ‰¹é‡é‡å‘½åç­‰ä»»åŠ¡
3. å®Œæˆç»ƒä¹ é¢˜

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ

### Planner/Executor æ¨¡å¼

```python
# è®¡åˆ’é˜¶æ®µï¼šåˆ†æå¹¶ç”Ÿæˆæ“ä½œåˆ—è¡¨
plan = planner.create_plan(source_dir, rules)
# plan = [
#   {"op": "rename", "src": "a.txt", "dst": "a_backup.txt"},
#   {"op": "move", "src": "b.txt", "dst": "archive/b.txt"},
# ]

# æ‰§è¡Œé˜¶æ®µï¼šé€ä¸ªæ‰§è¡Œæ“ä½œ
executor.execute(plan, dry_run=True)  # å…ˆé¢„è§ˆ
executor.execute(plan, dry_run=False) # å†æ‰§è¡Œ
```

### å¹‚ç­‰æ“ä½œ

```python
def idempotent_move(src: Path, dst: Path) -> bool:
    """å¹‚ç­‰ç§»åŠ¨ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ"""
    if dst.exists() and not src.exists():
        return True  # å·²ç»å®Œæˆï¼Œè·³è¿‡
    if src.exists():
        shutil.move(src, dst)
        return True
    return False  # æºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¤±è´¥
```

### æ–­ç‚¹ç»­è·‘

```python
# ä¿å­˜çŠ¶æ€
state = {"completed": [0, 1, 2], "failed": [], "pending": [3, 4, 5]}
with open("state.json", "w") as f:
    json.dump(state, f)

# æ¢å¤æ‰§è¡Œ
with open("state.json") as f:
    state = json.load(f)
for i in state["pending"]:
    execute_operation(plan[i])
```

## âš¡ JS/TS å·¥ç¨‹å¸ˆå¯¹ç…§

| æ¦‚å¿µ | Python å®ç° | JS/TS ç±»æ¯” |
|------|-------------|-----------|
| ä»»åŠ¡é˜Ÿåˆ— | `list[Operation]` | `Array<Task>` |
| çŠ¶æ€æŒä¹…åŒ– | `json.dump/load` | `fs.writeFileSync(JSON.stringify())` |
| å¹‚ç­‰æ“ä½œ | æ£€æŸ¥ç›®æ ‡çŠ¶æ€ | å¹‚ç­‰ API è®¾è®¡ |
| Dry-run | `--dry-run` å‚æ•° | `--dry-run` in CLI tools |
| å›æ»š | è®°å½•åå‘æ“ä½œ | Database transactions |
| é‡è¯• | `tenacity` åº“ | `p-retry` åº“ |

## ğŸ“Š å°é¡¹ç›®ï¼šæ–‡ä»¶æ‰¹å¤„ç†å·¥å…·

æ„å»ºä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶æ‰¹å¤„ç†å·¥å…·ï¼Œæ”¯æŒï¼š

- ğŸ“ **æ‰¹é‡é‡å‘½å**ï¼šæ­£åˆ™æ›¿æ¢ã€åºå·ã€æ—¥æœŸ
- ğŸ“‚ **æ–‡ä»¶åˆ†ç±»**ï¼šæŒ‰æ‰©å±•åã€æ—¥æœŸã€å¤§å°åˆ†ç±»
- ğŸ§¹ **æ–‡ä»¶æ¸…ç†**ï¼šåˆ é™¤ç©ºæ–‡ä»¶ã€ä¸´æ—¶æ–‡ä»¶
- ğŸ”„ **Dry-run**ï¼šé¢„è§ˆæ‰€æœ‰å˜æ›´
- ğŸ’¾ **æ–­ç‚¹ç»­è·‘**ï¼šä¸­æ–­åå¯æ¢å¤
- â†©ï¸ **å›æ»šæ”¯æŒ**ï¼šæ’¤é”€å·²æ‰§è¡Œçš„æ“ä½œ

```bash
# é¢„è§ˆé‡å‘½å
file-auto rename "*.txt" --pattern "doc_{n:03d}.txt" --dry-run

# æ‰§è¡Œåˆ†ç±»
file-auto organize ./downloads --by extension

# æŸ¥çœ‹çŠ¶æ€
file-auto status

# æ¢å¤æ‰§è¡Œ
file-auto resume

# å›æ»šä¸Šæ¬¡æ“ä½œ
file-auto rollback
```

## âœ… å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ Planner/Executor åˆ†ç¦»æ¨¡å¼
- [ ] èƒ½å®ç° state.json æ–­ç‚¹ç»­è·‘
- [ ] ç†è§£å¹¶èƒ½è®¾è®¡å¹‚ç­‰æ“ä½œ
- [ ] èƒ½å®ç° dry-run é¢„è§ˆæ¨¡å¼
- [ ] èƒ½å¤„ç†æ‰¹å¤„ç†ä¸­çš„å¤±è´¥å’Œé‡è¯•
- [ ] èƒ½è®¾è®¡å›æ»šæœºåˆ¶
- [ ] å®Œæˆ 10 é“ç»ƒä¹ é¢˜
- [ ] èƒ½å›ç­” 6 ä¸ªé¢è¯•é¢˜

## ğŸ”— å»¶ä¼¸é˜…è¯»

- [Python pathlib å®˜æ–¹æ–‡æ¡£](https://docs.python.org/3/library/pathlib.html)
- [shutil é«˜çº§æ–‡ä»¶æ“ä½œ](https://docs.python.org/3/library/shutil.html)
- [tenacity é‡è¯•åº“](https://github.com/jd/tenacity)
- [tqdm è¿›åº¦æ¡](https://github.com/tqdm/tqdm)

