# 04. 依赖管理工具对比

## 本节目标

- 了解主流依赖管理工具
- 掌握 uv 的使用（推荐）
- 根据场景选择合适的工具

---

## 工具概览

| 工具 | 特点 | 锁定 | 速度 |
|------|------|------|------|
| pip | 标准工具 | 无原生支持 | 慢 |
| uv | Rust 实现，极快 | uv.lock | 极快 |
| poetry | 完整解决方案 | poetry.lock | 中 |
| pdm | PEP 标准 | pdm.lock | 快 |
| pip-tools | 简单锁定 | requirements.txt | 中 |

---

## uv（优先推荐）

uv 是用 Rust 编写的超快包管理器，兼容 pip。

### 安装

```bash
# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# 或使用 pip
pip install uv
```

### 基本使用

```bash
# 创建虚拟环境
uv venv

# 激活
source .venv/bin/activate

# 安装包
uv pip install requests

# 安装项目依赖
uv pip install -e ".[dev]"

# 从 requirements.txt 安装
uv pip install -r requirements.txt
```

### 锁定依赖

```bash
# 从 pyproject.toml 生成锁定文件
uv pip compile pyproject.toml -o requirements.lock

# 从锁定文件安装（精确版本）
uv pip sync requirements.lock

# 带开发依赖
uv pip compile pyproject.toml --extra dev -o requirements-dev.lock
```

### 速度对比

```bash
# pip
time pip install django  # ~10s

# uv
time uv pip install django  # ~1s
```

---

## poetry

完整的项目管理工具，类似 npm。

### 安装

```bash
curl -sSL https://install.python-poetry.org | python3 -
```

### 初始化项目

```bash
# 新项目
poetry new myproject

# 现有项目
poetry init
```

### 管理依赖

```bash
# 添加依赖
poetry add requests

# 添加开发依赖
poetry add --group dev pytest

# 移除依赖
poetry remove requests

# 更新依赖
poetry update
poetry update requests  # 只更新特定包
```

### 安装依赖

```bash
# 安装所有依赖（根据 poetry.lock）
poetry install

# 只安装生产依赖
poetry install --only main

# 安装特定组
poetry install --with dev,test
```

### pyproject.toml（poetry 格式）

```toml
[tool.poetry]
name = "myproject"
version = "0.1.0"
description = ""
authors = ["Your Name <you@example.com>"]

[tool.poetry.dependencies]
python = "^3.10"
requests = "^2.28"

[tool.poetry.group.dev.dependencies]
pytest = "^7.0"
ruff = "^0.1"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

### 运行命令

```bash
# 在虚拟环境中运行
poetry run python script.py
poetry run pytest

# 进入虚拟环境 shell
poetry shell
```

---

## pdm

遵循 PEP 标准的现代包管理器。

### 安装

```bash
pip install pdm
```

### 基本使用

```bash
# 初始化
pdm init

# 添加依赖
pdm add requests
pdm add -dG dev pytest

# 安装
pdm install

# 运行
pdm run python script.py
```

### 特点

- 严格遵循 PEP 标准
- 支持 PEP 582（__pypackages__）
- 快速的依赖解析

---

## pip-tools

简单的依赖锁定工具。

### 安装

```bash
pip install pip-tools
```

### 工作流

```bash
# 1. 创建 requirements.in
echo "requests>=2.28" > requirements.in
echo "fastapi>=0.100" >> requirements.in

# 2. 编译为精确版本
pip-compile requirements.in -o requirements.txt

# 3. 安装
pip-sync requirements.txt
```

### requirements.txt 输出

```txt
# This file is autogenerated by pip-compile
certifi==2023.7.22
charset-normalizer==3.2.0
idna==3.4
requests==2.31.0
urllib3==2.0.4
```

---

## 工具选择指南

### 决策树

```
新项目？
├── 需要快速和简单 → uv
├── 需要完整项目管理 → poetry
├── 需要严格 PEP 标准 → pdm
└── 已有 requirements.txt → pip-tools
```

### 按场景选择

| 场景 | 推荐工具 |
|------|----------|
| 个人项目 | uv |
| 团队项目 | poetry 或 uv |
| 开源库 | uv 或 poetry |
| CI/CD | uv（速度快） |
| 企业环境 | poetry（功能全） |
| 简单脚本 | pip + venv |

---

## 迁移指南

### 从 pip 到 uv

```bash
# 几乎无需改动
# pip install → uv pip install
# pip freeze → uv pip freeze
```

### 从 pip 到 poetry

```bash
# 初始化 poetry
poetry init

# 导入现有依赖
poetry add $(cat requirements.txt)
```

### 从 poetry 到 uv

```bash
# 导出 requirements.txt
poetry export -f requirements.txt -o requirements.txt

# 使用 uv
uv pip install -r requirements.txt
```

---

## 命令对照表

| 操作 | pip | uv | poetry |
|------|-----|----|----|
| 安装包 | `pip install pkg` | `uv pip install pkg` | `poetry add pkg` |
| 安装所有 | `pip install -r req.txt` | `uv pip install -r req.txt` | `poetry install` |
| 卸载 | `pip uninstall pkg` | `uv pip uninstall pkg` | `poetry remove pkg` |
| 列出 | `pip list` | `uv pip list` | `poetry show` |
| 冻结 | `pip freeze` | `uv pip freeze` | `poetry export` |
| 更新 | `pip install -U pkg` | `uv pip install -U pkg` | `poetry update pkg` |
| 搜索 | `pip search` (已禁用) | - | `poetry search` |

---

## 本节要点

1. **uv**: 极快，pip 兼容，推荐新项目
2. **poetry**: 完整解决方案，适合团队
3. **pdm**: 严格 PEP 标准
4. **pip-tools**: 简单锁定
5. 根据项目需求选择合适的工具

