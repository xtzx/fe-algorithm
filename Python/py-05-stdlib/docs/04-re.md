# 04. re - 正则表达式

## 本节目标

- 掌握 Python 正则表达式常用方法
- 理解贪婪和非贪婪匹配
- 熟练使用分组

---

## 基本匹配

### match - 从开头匹配

```python
import re

# match 只从开头匹配
result = re.match(r"\d+", "123abc")
print(result.group())  # 123

result = re.match(r"\d+", "abc123")
print(result)  # None（不是从开头）
```

### search - 搜索第一个匹配

```python
import re

# search 搜索整个字符串
result = re.search(r"\d+", "abc123def456")
print(result.group())  # 123（第一个匹配）
```

### fullmatch - 完整匹配

```python
import re

# 整个字符串必须匹配
result = re.fullmatch(r"\d+", "123")
print(result.group())  # 123

result = re.fullmatch(r"\d+", "123abc")
print(result)  # None
```

---

## 查找所有匹配

### findall - 返回列表

```python
import re

text = "电话：13812345678，备用：13987654321"

# 返回所有匹配的字符串列表
numbers = re.findall(r"1\d{10}", text)
print(numbers)  # ['13812345678', '13987654321']

# 如果有分组，返回分组内容
matches = re.findall(r"(\d{3})(\d{8})", text)
print(matches)  # [('138', '12345678'), ('139', '87654321')]
```

### finditer - 返回迭代器

```python
import re

text = "价格：100元，折扣：80元"

for match in re.finditer(r"\d+", text):
    print(f"匹配: {match.group()}, 位置: {match.span()}")
# 匹配: 100, 位置: (3, 6)
# 匹配: 80, 位置: (11, 13)
```

---

## 替换

### sub - 替换

```python
import re

text = "Hello World"

# 简单替换
result = re.sub(r"World", "Python", text)
print(result)  # Hello Python

# 使用函数替换
def upper_replace(match):
    return match.group().upper()

result = re.sub(r"\b\w+\b", upper_replace, text)
print(result)  # HELLO WORLD

# 限制替换次数
text = "aaa bbb ccc"
result = re.sub(r"\w+", "X", text, count=2)
print(result)  # X X ccc
```

### subn - 替换并返回次数

```python
import re

text = "one two three"
result, count = re.subn(r"\w+", "X", text)
print(result)  # X X X
print(count)   # 3
```

---

## 分割

```python
import re

text = "one, two;  three    four"

# 按正则分割
parts = re.split(r"[,;\s]+", text)
print(parts)  # ['one', 'two', 'three', 'four']

# 保留分隔符
parts = re.split(r"([,;])", "a,b;c")
print(parts)  # ['a', ',', 'b', ';', 'c']

# 限制分割次数
parts = re.split(r"\s+", "a b c d", maxsplit=2)
print(parts)  # ['a', 'b', 'c d']
```

---

## 编译正则

```python
import re

# 编译后复用（性能更好）
pattern = re.compile(r"\d+")

result = pattern.findall("abc 123 def 456")
print(result)  # ['123', '456']

result = pattern.search("abc 123")
print(result.group())  # 123
```

### 编译标志

```python
import re

# 忽略大小写
pattern = re.compile(r"hello", re.IGNORECASE)
print(pattern.findall("Hello HELLO hello"))  # ['Hello', 'HELLO', 'hello']

# 多行模式
pattern = re.compile(r"^\w+", re.MULTILINE)
text = "line1\nline2\nline3"
print(pattern.findall(text))  # ['line1', 'line2', 'line3']

# 点匹配换行
pattern = re.compile(r".+", re.DOTALL)
text = "line1\nline2"
print(pattern.findall(text))  # ['line1\nline2']

# 组合标志
pattern = re.compile(r"hello", re.IGNORECASE | re.MULTILINE)
```

---

## 分组

### 基本分组

```python
import re

text = "John: 25, Jane: 30"

# 使用括号分组
pattern = r"(\w+): (\d+)"
for match in re.finditer(pattern, text):
    print(f"全部: {match.group(0)}")  # 完整匹配
    print(f"组1: {match.group(1)}")   # 第一组
    print(f"组2: {match.group(2)}")   # 第二组
    print(f"所有组: {match.groups()}")
```

### 命名分组

```python
import re

text = "2024-01-15"

# 使用 ?P<name> 命名
pattern = r"(?P<year>\d{4})-(?P<month>\d{2})-(?P<day>\d{2})"
match = re.match(pattern, text)

print(match.group("year"))   # 2024
print(match.group("month"))  # 01
print(match.groupdict())     # {'year': '2024', 'month': '01', 'day': '15'}
```

### 非捕获分组

```python
import re

# (?:...) 不捕获
pattern = r"(?:https?://)?(\w+\.com)"
match = re.search(pattern, "https://example.com")

print(match.groups())  # ('example.com',) - 只有一个组
```

---

## 贪婪 vs 非贪婪

```python
import re

text = "<div>content</div>"

# 贪婪匹配（默认）
pattern = r"<.*>"
match = re.search(pattern, text)
print(match.group())  # <div>content</div>

# 非贪婪匹配（加 ?）
pattern = r"<.*?>"
match = re.search(pattern, text)
print(match.group())  # <div>

# 其他非贪婪：+? ?? {n,m}?
```

---

## 常用模式

### 邮箱

```python
import re

email_pattern = r"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"

text = "联系：user@example.com 或 test@domain.org"
emails = re.findall(email_pattern, text)
print(emails)  # ['user@example.com', 'test@domain.org']
```

### URL

```python
import re

url_pattern = r"https?://[^\s]+"

text = "访问 https://example.com 或 http://test.org/path?q=1"
urls = re.findall(url_pattern, text)
print(urls)
```

### 中国手机号

```python
import re

phone_pattern = r"1[3-9]\d{9}"

text = "电话：13812345678，座机：010-12345678"
phones = re.findall(phone_pattern, text)
print(phones)  # ['13812345678']
```

### IP 地址

```python
import re

ip_pattern = r"\b(?:\d{1,3}\.){3}\d{1,3}\b"

text = "服务器 192.168.1.1 和 10.0.0.255"
ips = re.findall(ip_pattern, text)
print(ips)  # ['192.168.1.1', '10.0.0.255']
```

---

## Python re vs JavaScript RegExp

| 功能 | Python | JavaScript |
|------|--------|------------|
| 匹配 | `re.match()` | `str.match(/^.../)` |
| 搜索 | `re.search()` | `str.match()` |
| 全部查找 | `re.findall()` | `str.matchAll()` / `g` 标志 |
| 替换 | `re.sub()` | `str.replace()` |
| 分割 | `re.split()` | `str.split()` |
| 编译 | `re.compile()` | `new RegExp()` |
| 忽略大小写 | `re.IGNORECASE` | `/i` 标志 |
| 全局 | 默认全部 | `/g` 标志 |

---

## 本节要点

1. `match` 开头匹配，`search` 任意位置，`fullmatch` 完整
2. `findall` 返回列表，`finditer` 返回迭代器
3. `sub` 替换，`split` 分割
4. `compile` 编译正则提高性能
5. `groups()` 和 `groupdict()` 获取分组
6. `*?`、`+?` 非贪婪匹配


