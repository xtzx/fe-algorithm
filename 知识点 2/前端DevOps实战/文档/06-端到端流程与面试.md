# 06. 端到端流程与面试要点

> 从本地开发到生产部署的完整链路

---

## 📑 目录

1. [端到端部署流程](#端到端部署流程)
2. [各环节职责详解](#各环节职责详解)
3. [常见架构模式](#常见架构模式)
4. [面试高频问题](#面试高频问题)

---

## 端到端部署流程

### 完整流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        端到端部署流程                                    │
│                                                                         │
│  ┌──────────────┐                                                       │
│  │  本地开发     │                                                       │
│  │  - 编写代码   │                                                       │
│  │  - 本地测试   │                                                       │
│  │  - docker-    │                                                       │
│  │    compose up│                                                       │
│  └──────┬───────┘                                                       │
│         │                                                               │
│         │ git push / 创建 PR                                             │
│         ▼                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        CI Pipeline                                │  │
│  │                                                                   │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐             │  │
│  │  │Checkout │─►│ Install │─►│  Lint   │─►│  Test   │             │  │
│  │  │  代码   │  │  依赖   │  │  检查   │  │  测试   │             │  │
│  │  └─────────┘  └─────────┘  └─────────┘  └────┬────┘             │  │
│  │                                              │                   │  │
│  │                                         ┌────┴────┐              │  │
│  │                                         │  Build  │              │  │
│  │                                         │  构建   │              │  │
│  │                                         └────┬────┘              │  │
│  └──────────────────────────────────────────────┼───────────────────┘  │
│                                                 │                       │
│         ┌───────────────────────────────────────┘                       │
│         │ CI 通过，合并到 main                                           │
│         ▼                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        CD Pipeline                                │  │
│  │                                                                   │  │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐     │  │
│  │  │构建 Docker│─►│推送到     │─►│ SSH 连接  │─►│ 拉取镜像  │     │  │
│  │  │  镜像     │  │ Registry  │  │  服务器   │  │ 重启服务  │     │  │
│  │  └───────────┘  └───────────┘  └───────────┘  └─────┬─────┘     │  │
│  └─────────────────────────────────────────────────────┼────────────┘  │
│                                                        │                │
│         ┌──────────────────────────────────────────────┘                │
│         ▼                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        生产服务器                                 │  │
│  │                                                                   │  │
│  │       ┌─────────────────────────────────┐                        │  │
│  │       │          Nginx (入口)           │ :80 / :443             │  │
│  │       │  - SSL 终结                      │                        │  │
│  │       │  - 静态资源服务                  │                        │  │
│  │       │  - 反向代理 API                  │                        │  │
│  │       └───────────────┬─────────────────┘                        │  │
│  │                       │                                          │  │
│  │           ┌───────────┴───────────┐                              │  │
│  │           │                       │                               │  │
│  │           ▼                       ▼                               │  │
│  │    ┌───────────┐          ┌───────────┐                          │  │
│  │    │  Node.js  │◄────────►│   Redis   │                          │  │
│  │    │  (API)    │  缓存/会话│  (缓存)   │                          │  │
│  │    └───────────┘          └───────────┘                          │  │
│  │                                                                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│         ┌───────────────────────────────────────────────────┐          │
│         ▼                                                               │
│  ┌──────────────┐                                                       │
│  │   用户访问    │                                                       │
│  │ example.com  │                                                       │
│  └──────────────┘                                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 各环节职责详解

### 1. 本地开发

| 职责 | 工具/方法 |
|------|----------|
| 代码编写 | VS Code, WebStorm |
| 本地运行 | `npm run dev`, Vite Dev Server |
| 本地测试 | Jest, Vitest |
| 环境模拟 | docker-compose (模拟生产依赖) |
| 代码规范 | ESLint, Prettier |

### 2. 版本控制

| 职责 | 工具/方法 |
|------|----------|
| 代码托管 | GitHub, GitLab |
| 分支策略 | Git Flow, GitHub Flow |
| 代码审查 | Pull Request, Code Review |
| 保护分支 | main 分支保护，禁止直接推送 |

### 3. CI Pipeline

| 阶段 | 职责 | 失败处理 |
|------|------|---------|
| Lint | 代码风格检查 | 阻止合并 |
| Type Check | 类型检查 | 阻止合并 |
| Test | 单元测试、集成测试 | 阻止合并 |
| Build | 构建验证 | 阻止合并 |

### 4. CD Pipeline

| 阶段 | 职责 | 输出 |
|------|------|------|
| Build Docker | 构建生产镜像 | Docker 镜像 |
| Push | 推送到 Registry | 镜像 URL |
| Deploy | 部署到服务器 | 运行的容器 |

### 5. 生产环境

| 组件 | 职责 |
|------|------|
| Nginx | 入口网关、SSL、静态资源、反向代理 |
| Node.js | API 服务、业务逻辑 |
| Redis | 缓存、会话存储 |
| 监控 | 日志收集、性能监控、告警 |

---

## 常见架构模式

### 模式一：简单部署（单服务器）

```
┌─────────────────────────────────────┐
│            单服务器                  │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │  Nginx  │─►│ Node.js │          │
│  └─────────┘  └─────────┘          │
│                                     │
└─────────────────────────────────────┘

适用：小型项目、个人项目
优点：简单、成本低
缺点：单点故障、无法水平扩展
```

### 模式二：容器化部署

```
┌─────────────────────────────────────┐
│           Docker Compose            │
│                                     │
│  ┌─────────┐  ┌─────────┐          │
│  │  Nginx  │─►│ Node.js │          │
│  └─────────┘  └────┬────┘          │
│                    │                │
│               ┌────▼────┐          │
│               │  Redis  │          │
│               └─────────┘          │
│                                     │
└─────────────────────────────────────┘

适用：中小型项目
优点：环境一致、易于管理
缺点：单机限制
```

### 模式三：集群部署

```
                    ┌─────────────┐
                    │ 负载均衡器   │
                    │ (云 LB)     │
                    └──────┬──────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
         ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│  Node 1     │   │  Node 2     │   │  Node 3     │
│  Nginx      │   │  Nginx      │   │  Nginx      │
│  Node.js    │   │  Node.js    │   │  Node.js    │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       └─────────────────┼─────────────────┘
                         │
                    ┌────▼────┐
                    │  Redis  │
                    │ Cluster │
                    └─────────┘

适用：大型项目、高可用需求
优点：高可用、可水平扩展
缺点：复杂、成本高
```

### 模式四：Kubernetes

```
┌─────────────────────────────────────────────────────┐
│                   Kubernetes Cluster                │
│                                                     │
│  ┌───────────────────────────────────────────────┐ │
│  │                  Ingress                       │ │
│  └──────────────────────┬────────────────────────┘ │
│                         │                          │
│  ┌──────────────────────▼────────────────────────┐ │
│  │              Service (ClusterIP)               │ │
│  └──────────────────────┬────────────────────────┘ │
│                         │                          │
│     ┌───────────────────┼───────────────────┐     │
│     │                   │                   │      │
│  ┌──▼──┐             ┌──▼──┐             ┌──▼──┐  │
│  │ Pod │             │ Pod │             │ Pod │  │
│  │Node │             │Node │             │Node │  │
│  └─────┘             └─────┘             └─────┘  │
│                                                     │
└─────────────────────────────────────────────────────┘

适用：大规模、微服务架构
优点：自动扩缩容、自愈、声明式配置
缺点：学习曲线陡峭、运维复杂
```

---

## 面试高频问题

### Q1: 描述一下你们项目的部署流程？

**答案框架**：

> 我们采用 **GitHub Actions + Docker + 云服务器** 的部署方案：
>
> **1. 开发阶段**
> - 本地使用 docker-compose 搭建开发环境
> - 提交代码前确保本地测试通过
>
> **2. CI 阶段**（PR 触发）
> - 自动运行 ESLint 检查代码规范
> - 运行单元测试和 E2E 测试
> - 构建验证
>
> **3. CD 阶段**（合并到 main 触发）
> - 构建 Docker 镜像（多阶段构建，最终镜像约 100MB）
> - 推送到 GitHub Container Registry
> - SSH 连接服务器，拉取最新镜像，docker-compose 重启服务
>
> **4. 生产环境**
> - Nginx 做入口，处理 SSL 和静态资源
> - Node.js 处理 API 请求
> - Redis 做缓存和会话存储

---

### Q2: 如何保证部署的零停机？

**答案**：

> 几种策略：
>
> **1. 滚动更新 (Rolling Update)**
> - 先启动新容器，健康检查通过后再停止旧容器
> - docker-compose 需要配置 `deploy.update_config`
>
> **2. 蓝绿部署 (Blue-Green)**
> - 同时运行两套环境
> - 切换负载均衡器指向
>
> **3. 金丝雀发布 (Canary)**
> - 新版本先接收 5% 流量
> - 观察无问题后逐步增加
>
> 我们目前使用 **滚动更新 + 健康检查**：
> ```yaml
> # docker-compose.yml
> services:
>   api:
>     deploy:
>       update_config:
>         parallelism: 1
>         delay: 10s
>     healthcheck:
>       test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
>       interval: 10s
> ```

---

### Q3: CI/CD 中如何管理敏感信息（密码、API Key）？

**答案**：

> **原则**：敏感信息绝不提交到代码仓库
>
> **方案**：
>
> 1. **GitHub Secrets**
>    - 在 Settings > Secrets 中配置
>    - 通过 `${{ secrets.NAME }}` 访问
>    - 日志中自动遮蔽
>
> 2. **环境变量注入**
>    - CI 时从 Secrets 注入
>    - 运行时通过 docker-compose env_file
>
> 3. **密钥管理服务**
>    - AWS Secrets Manager
>    - HashiCorp Vault
>    - 适合大型项目

---

### Q4: 前端项目多环境配置如何处理？

**答案**：

> **构建时注入**（Vite/Next.js）：
>
> ```yaml
> # CI 配置
> - name: Build for production
>   run: npm run build
>   env:
>     VITE_API_URL: ${{ vars.PROD_API_URL }}
>     VITE_APP_ENV: production
> ```
>
> **运行时注入**（更灵活）：
>
> ```nginx
> # Nginx 配置
> location /config.js {
>     alias /etc/nginx/config/config.production.js;
> }
> ```
>
> **最佳实践**：
> - 敏感配置用运行时注入
> - 非敏感配置用构建时注入
> - 使用 environment 区分不同环境

---

### Q5: 如何处理前端项目的版本号和发布日志？

**答案**：

> **版本号管理**：
>
> 1. **语义化版本 (SemVer)**：`MAJOR.MINOR.PATCH`
> 2. **自动版本**：使用 commit SHA 或构建时间戳
>
> ```yaml
> env:
>   VITE_APP_VERSION: ${{ github.sha }}
>   VITE_BUILD_TIME: ${{ github.event.head_commit.timestamp }}
> ```
>
> **发布日志**：
>
> 1. **Conventional Commits**：规范化 commit 信息
> 2. **自动生成 Changelog**：使用 `standard-version` 或 `semantic-release`
> 3. **GitHub Releases**：配合 CI 自动创建

---

### Q6: Docker 和传统部署相比有什么优势？

**答案**：

> | 维度 | 传统部署 | Docker 部署 |
> |------|---------|------------|
> | 环境一致性 | "在我机器上能跑" | 开发=测试=生产 |
> | 依赖管理 | 手动安装，可能冲突 | 容器隔离，互不影响 |
> | 部署速度 | 分钟级（安装依赖） | 秒级（拉取镜像） |
> | 回滚 | 复杂 | 简单（切换镜像版本） |
> | 扩展 | 需要手动配置 | docker-compose scale |
>
> **实际收益**：
> - 新人入职配置环境从 1 天降到 10 分钟
> - 部署失败率从 10% 降到 1%
> - 回滚时间从 30 分钟降到 1 分钟

