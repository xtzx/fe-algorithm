
================================================================================
【R9】并发模型（cluster / child_process / worker_threads）
================================================================================

```text
你现在是「Node.js 并发与性能优化方向专家 & 资深面试官」，
要为一位「7-8 年资深前端工程师」深入讲解 Node.js 并发模型，面向中高级面试。

【本次主题】R9：并发模型（cluster / child_process / worker_threads）

必须覆盖以下内容（每项都要有详细讲解 + 代码示例）：

1）Node.js 并发模型概述
   - 单线程 JS 执行 + 多线程 I/O
   - 单线程的优势：
     - 无锁编程、避免死锁
     - 上下文切换开销小
   - 单线程的局限：
     - 只能使用单核 CPU
     - CPU 密集型任务阻塞
   - 解决方案：
     - cluster：多进程
     - child_process：子进程
     - worker_threads：多线程

2）child_process 模块 ⭐
   - 四种创建子进程的方式：
     ┌────────────┬───────────────────────────────────────────┐
     │ 方法       │ 特点                                      │
     ├────────────┼───────────────────────────────────────────┤
     │ spawn      │ 流式输出，适合长时间运行                   │
     │ exec       │ 带 shell，输出缓冲到内存                   │
     │ execFile   │ 直接执行文件，更安全                       │
     │ fork       │ 专门用于运行 Node.js 脚本，有 IPC          │
     └────────────┴───────────────────────────────────────────┘
   - spawn(command, args, options)：
     - 返回 ChildProcess 对象
     - 流式获取 stdout/stderr
     - 适合执行命令、日志流
   - exec(command, callback)：
     - 带 shell 执行
     - 输出缓冲后返回
     - 适合简单命令
   - execFile(file, args, callback)：
     - 直接执行可执行文件
     - 不经过 shell，更安全
   - fork(modulePath, args, options)：
     - 专门运行 Node.js 脚本
     - 内置 IPC 通道
     - 进程间通信

3）进程间通信（IPC）
   - fork() 的 IPC：
     - 父进程：child.send(message)
     - 子进程：process.on('message', handler)
     - 子进程发送：process.send(message)
     - 父进程接收：child.on('message', handler)
   - 传递的数据类型：序列化对象
   - 传递文件描述符 / socket

4）worker_threads 模块 ⭐⭐⭐⭐⭐
   - 与 child_process 的区别：
     - 共享进程内存（可选）
     - 更轻量，创建更快
     - 适合 CPU 密集型任务
   - 创建 Worker：
     - new Worker(filename)
     - new Worker(code, { eval: true })
   - 通信：
     - 主线程：worker.postMessage(data)
     - 工作线程：parentPort.on('message', handler)
     - 工作线程发送：parentPort.postMessage(data)
   - 数据传递方式：
     - 结构化克隆（默认）
     - SharedArrayBuffer：共享内存
     - Atomics：原子操作
     - transferList：转移所有权
   - 线程池模式
   - 实战示例：CPU 密集型计算

5）cluster 模块 ⭐⭐⭐⭐⭐
   - 作用：利用多核 CPU 运行多个 Node.js 实例
   - 主进程（Master）与工作进程（Worker）
   - 负载均衡策略：
     - 默认：round-robin（除 Windows）
     - CLUSTER_SCHEDULING_POLICY
   - 核心 API：
     - cluster.isMaster / cluster.isWorker
     - cluster.fork()：创建工作进程
     - cluster.workers：所有工作进程
   - 工作进程事件：
     - 'exit'：进程退出
     - 'disconnect'：IPC 断开
     - 'error'：错误
   - 自动重启崩溃的 worker
   - 进程间状态共享的挑战：
     - 每个 worker 独立
     - 需要 Redis 等共享存储

6）PM2 进程管理 ⭐
   - 功能：
     - 进程守护（自动重启）
     - 集群模式（多实例）
     - 日志管理
     - 监控
   - 常用命令：
     - pm2 start app.js -i max
     - pm2 stop / restart / reload
     - pm2 logs / monit
   - 配置文件：ecosystem.config.js
   - 优雅重启：pm2 reload
   - 与 cluster 的关系

7）选择指南
   - child_process 适合：
     - 执行外部命令
     - 调用其他语言脚本
     - 进程隔离
   - worker_threads 适合：
     - CPU 密集型计算
     - 需要共享内存
     - 更轻量的并发
   - cluster 适合：
     - HTTP 服务多核利用
     - 生产环境部署

8）性能监控与压测
   - process.memoryUsage()：内存使用
   - 压测工具：autocannon / wrk / ab
   - 指标：QPS、延迟、错误率
   - 对比单进程 vs 多进程性能

9）面试高频问题（至少 8 个问题 + 加分回答）
   - Node.js 是单线程吗？那它怎么利用多核 CPU？
   - child_process 和 worker_threads 有什么区别？
   - spawn 和 exec 有什么区别？
   - cluster 模块的负载均衡是怎么实现的？
   - 如何在多进程间共享状态？
   - PM2 的 cluster 模式原理是什么？
   - 什么是 CPU 密集型任务？如何处理？
   - 你们服务的 QPS 是多少？怎么压测的？

【输出形式要求：多文件、多格式】

/node-concurrency-model/
├── README.md
├── docs/
│   ├── 01-node-concurrency-overview.md
│   ├── 02-child-process.md
│   ├── 03-worker-threads.md
│   ├── 04-cluster.md
│   ├── 05-pm2-and-process-management.md
│   └── 06-interview-questions.md
├── examples/
│   ├── child-process/
│   │   ├── spawn-example.ts
│   │   ├── exec-example.ts
│   │   ├── fork-example.ts
│   │   ├── fork-child.ts
│   │   └── ipc-communication.ts
│   ├── worker-threads/
│   │   ├── simple-worker.ts
│   │   ├── worker-file.ts
│   │   ├── shared-array-buffer.ts
│   │   ├── thread-pool.ts
│   │   └── cpu-intensive-task.ts
│   ├── cluster/
│   │   ├── cluster-server.ts
│   │   ├── single-vs-cluster.ts
│   │   └── worker-restart.ts
│   └── benchmark/
│       └── load-test.ts
├── config/
│   └── pm2.config.js
├── diagrams/
│   ├── process-vs-thread.txt
│   └── cluster-architecture.txt
└── scripts/
    ├── run-cluster.sh
    ├── run-worker-threads.sh
    └── load-test.sh

要求：

1. 先输出完整目录树。
2. docs 下重点是 03-worker-threads.md 和 04-cluster.md。
3. examples 下：
   - 包含 CPU 密集型任务示例
   - 包含线程池实现
   - cluster 自动重启示例
4. 包含 PM2 配置文件。
5. 使用 TypeScript，可运行。

请从项目结构开始，然后依次输出每个文件的完整内容。
```

================================================================================

