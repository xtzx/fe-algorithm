/**
 * ğŸ“ é¢˜ç›®ï¼šK ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨
 * ğŸ”— é“¾æ¥ï¼šhttps://leetcode.cn/problems/reverse-nodes-in-k-group/
 * ğŸ·ï¸ éš¾åº¦ï¼šHard
 * ğŸ·ï¸ æ ‡ç­¾ï¼šé€’å½’ã€é“¾è¡¨
 *
 * ğŸ“‹ é¢˜ç›®æè¿°ï¼š
 * ç»™ä½ é“¾è¡¨çš„å¤´èŠ‚ç‚¹ headï¼Œæ¯ k ä¸ªèŠ‚ç‚¹ä¸€ç»„è¿›è¡Œç¿»è½¬ï¼Œè¯·ä½ è¿”å›ä¿®æ”¹åçš„é“¾è¡¨ã€‚
 *
 * k æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œå®ƒçš„å€¼å°äºæˆ–ç­‰äºé“¾è¡¨çš„é•¿åº¦ã€‚
 * å¦‚æœèŠ‚ç‚¹æ€»æ•°ä¸æ˜¯ k çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆè¯·å°†æœ€åå‰©ä½™çš„èŠ‚ç‚¹ä¿æŒåŸæœ‰é¡ºåºã€‚
 *
 * ä½ ä¸èƒ½åªæ˜¯å•çº¯çš„æ”¹å˜èŠ‚ç‚¹å†…éƒ¨çš„å€¼ï¼Œè€Œæ˜¯éœ€è¦å®é™…è¿›è¡ŒèŠ‚ç‚¹äº¤æ¢ã€‚
 *
 * ç¤ºä¾‹ï¼š
 * è¾“å…¥ï¼šhead = [1,2,3,4,5], k = 2
 * è¾“å‡ºï¼š[2,1,4,3,5]
 *
 * è¾“å…¥ï¼šhead = [1,2,3,4,5], k = 3
 * è¾“å‡ºï¼š[3,2,1,4,5]
 */

class ListNode {
  val: number;
  next: ListNode | null;
  constructor(val?: number, next?: ListNode | null) {
    this.val = val === undefined ? 0 : val;
    this.next = next === undefined ? null : next;
  }
}

// ============================================================
// ğŸ’¡ æ€è·¯åˆ†æï¼šè¿™é“é¢˜çš„è§£æ³•æ˜¯æ€ä¹ˆæƒ³å‡ºæ¥çš„ï¼Ÿ
// ============================================================
//
// åˆ†è§£é—®é¢˜ï¼š
// 1. å¦‚ä½•ç¿»è½¬ä¸€æ®µé“¾è¡¨ï¼Ÿï¼ˆå·²çŸ¥ï¼šé“¾è¡¨åè½¬ï¼‰
// 2. å¦‚ä½•åˆ†ç»„å¤„ç†ï¼Ÿ
// 3. å¦‚ä½•è¿æ¥ç¿»è½¬åçš„ç»„ï¼Ÿ
//
// è¿­ä»£æ³•ï¼š
// - æ¯æ¬¡å¤„ç† k ä¸ªèŠ‚ç‚¹
// - å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ k ä¸ªèŠ‚ç‚¹
// - ç¿»è½¬è¿™ k ä¸ªèŠ‚ç‚¹
// - è¿æ¥åˆ°å‰ä¸€ç»„
//
// é€’å½’æ³•ï¼š
// - ç¿»è½¬å‰ k ä¸ªèŠ‚ç‚¹
// - é€’å½’å¤„ç†å‰©ä½™éƒ¨åˆ†
// - è¿æ¥èµ·æ¥

// ============================================================
// è§£æ³•ä¸€ï¼šè¿­ä»£æ³•ï¼ˆæ¨èï¼‰
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n) | ç©ºé—´å¤æ‚åº¦ï¼šO(1)

/**
 * ğŸ“Š æ‰§è¡Œè¿‡ç¨‹å›¾è§£ï¼š
 *
 * é“¾è¡¨: 1 -> 2 -> 3 -> 4 -> 5, k = 2
 *
 * Step 1: æ£€æŸ¥å‰ 2 ä¸ªèŠ‚ç‚¹ [1, 2]ï¼Œå­˜åœ¨
 *
 *   dummy -> 1 -> 2 -> 3 -> 4 -> 5
 *      â†‘    â†‘    â†‘
 *    prev start end
 *
 * Step 2: ç¿»è½¬ [1, 2]
 *
 *   dummy -> 2 -> 1 -> 3 -> 4 -> 5
 *      â†‘         â†‘
 *    prev      start (ç°åœ¨æ˜¯å°¾)
 *
 * Step 3: ç§»åŠ¨ prev åˆ° startï¼ˆå½“å‰ç»„çš„å°¾ï¼‰
 *
 *   dummy -> 2 -> 1 -> 3 -> 4 -> 5
 *                 â†‘    â†‘    â†‘
 *               prev start end
 *
 * Step 4: ç¿»è½¬ [3, 4]
 *
 *   dummy -> 2 -> 1 -> 4 -> 3 -> 5
 *                           â†‘
 *                         start
 *
 * Step 5: æ£€æŸ¥ [5]ï¼Œåªæœ‰ 1 ä¸ªï¼Œä¸è¶³ k ä¸ªï¼Œä¿æŒåŸæ ·
 *
 * ç»“æœ: 2 -> 1 -> 4 -> 3 -> 5
 *
 * ğŸ”„ æµç¨‹å›¾ (Mermaid):
 * ```mermaid
 * flowchart TD
 *     A[prev=dummy, start=head] --> B{æœ‰ k ä¸ªèŠ‚ç‚¹?}
 *     B -->|Yes| C[æ‰¾åˆ°ç¬¬ k ä¸ªèŠ‚ç‚¹ end]
 *     C --> D[ä¿å­˜ end.next]
 *     D --> E[ç¿»è½¬ start åˆ° end]
 *     E --> F[è¿æ¥: prev.next=end, start.next=ä¿å­˜çš„next]
 *     F --> G[ç§»åŠ¨: prev=start, start=start.next]
 *     G --> B
 *     B -->|No| H[è¿”å› dummy.next]
 * ```
 */
function reverseKGroup_v1(head: ListNode | null, k: number): ListNode | null {
  if (!head || k === 1) return head;

  const dummy = new ListNode(0);
  dummy.next = head;

  let prev: ListNode = dummy;
  let start: ListNode | null = head;

  while (start) {
    // æ£€æŸ¥æ˜¯å¦æœ‰ k ä¸ªèŠ‚ç‚¹
    let end: ListNode | null = prev;
    for (let i = 0; i < k; i++) {
      end = end!.next;
      if (!end) {
        // ä¸è¶³ k ä¸ªï¼Œç›´æ¥è¿”å›
        return dummy.next;
      }
    }

    // ä¿å­˜ä¸‹ä¸€ç»„çš„èµ·ç‚¹
    const nextStart = end!.next;

    // ç¿»è½¬ [start, end]
    const [newStart, newEnd] = reverse(start!, end!);

    // è¿æ¥
    prev.next = newStart;
    newEnd.next = nextStart;

    // ç§»åŠ¨åˆ°ä¸‹ä¸€ç»„
    prev = newEnd;
    start = nextStart;
  }

  return dummy.next;
}

// ç¿»è½¬ä» start åˆ° end çš„é“¾è¡¨ï¼Œè¿”å›æ–°çš„å¤´å’Œå°¾
function reverse(start: ListNode, end: ListNode): [ListNode, ListNode] {
  let prev: ListNode | null = null;
  let curr: ListNode | null = start;
  const originalStart = start;

  // ç¿»è½¬åˆ° end çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
  while (prev !== end) {
    const next = curr!.next;
    curr!.next = prev;
    prev = curr;
    curr = next;
  }

  return [end, originalStart];
}

// ============================================================
// è§£æ³•äºŒï¼šé€’å½’æ³•
// ============================================================
// â±ï¸ æ—¶é—´å¤æ‚åº¦ï¼šO(n) | ç©ºé—´å¤æ‚åº¦ï¼šO(n/k) é€’å½’æ ˆ

/**
 * ğŸ“Š é€’å½’è¿‡ç¨‹å›¾è§£ï¼š
 *
 * reverseKGroup([1,2,3,4,5], k=2)
 *   = reverse([1,2]) + reverseKGroup([3,4,5], k=2)
 *   = [2,1] + reverse([3,4]) + reverseKGroup([5], k=2)
 *   = [2,1] + [4,3] + [5]
 *   = [2,1,4,3,5]
 */
function reverseKGroup_v2(head: ListNode | null, k: number): ListNode | null {
  if (!head) return null;

  // æ£€æŸ¥æ˜¯å¦æœ‰ k ä¸ªèŠ‚ç‚¹
  let tail: ListNode | null = head;
  for (let i = 0; i < k; i++) {
    if (!tail) {
      return head; // ä¸è¶³ k ä¸ªï¼Œä¿æŒåŸæ ·
    }
    tail = tail.next;
  }

  // ç¿»è½¬å‰ k ä¸ªèŠ‚ç‚¹
  const newHead = reverseFirstK(head, k);

  // é€’å½’å¤„ç†å‰©ä½™éƒ¨åˆ†ï¼Œè¿æ¥åˆ°ç¿»è½¬åçš„å°¾éƒ¨
  head.next = reverseKGroup_v2(tail, k);

  return newHead;
}

// ç¿»è½¬å‰ k ä¸ªèŠ‚ç‚¹ï¼Œè¿”å›æ–°çš„å¤´
function reverseFirstK(head: ListNode | null, k: number): ListNode | null {
  let prev: ListNode | null = null;
  let curr = head;

  for (let i = 0; i < k && curr; i++) {
    const next = curr.next;
    curr.next = prev;
    prev = curr;
    curr = next;
  }

  return prev;
}

// ============================================================
// ğŸ”„ è§£æ³•å¯¹æ¯”
// ============================================================
/**
 * | è§£æ³•     | æ—¶é—´  | ç©ºé—´    | ç‰¹ç‚¹                     |
 * |---------|-------|---------|-------------------------|
 * | è¿­ä»£    | O(n)  | O(1)    | æ¨èï¼Œç©ºé—´æœ€ä¼˜            |
 * | é€’å½’    | O(n)  | O(n/k)  | ä»£ç ç®€æ´                 |
 */

// ============================================================
// âš ï¸ æ˜“é”™ç‚¹
// ============================================================
/**
 * 1. æ£€æŸ¥èŠ‚ç‚¹æ•°é‡ï¼š
 *    - ç¿»è½¬å‰è¦ç¡®ä¿æœ‰ k ä¸ªèŠ‚ç‚¹
 *    - ä¸è¶³ k ä¸ªæ—¶ä¿æŒåŸæ ·
 *
 * 2. è¾¹ç•Œå¤„ç†ï¼š
 *    - k = 1 æ—¶ä¸éœ€è¦ç¿»è½¬
 *    - ç©ºé“¾è¡¨å¤„ç†
 *
 * 3. è¿æ¥é€»è¾‘ï¼š
 *    - ç¿»è½¬åçš„å¤´è¿æ¥åˆ° prev
 *    - ç¿»è½¬åçš„å°¾è¿æ¥åˆ°ä¸‹ä¸€ç»„çš„å¤´
 *
 * 4. æŒ‡é’ˆç§»åŠ¨ï¼š
 *    - start ç¿»è½¬åå˜æˆå°¾éƒ¨
 *    - prev è¦ç§»åŠ¨åˆ°å½“å‰ç»„çš„å°¾éƒ¨
 */

// ============================================================
// ğŸ”— ä¸¾ä¸€åä¸‰ï¼šç›¸ä¼¼é¢˜ç›®
// ============================================================
/**
 * - åè½¬é“¾è¡¨ â†’ åŸºç¡€é—®é¢˜
 * - åè½¬é“¾è¡¨ II â†’ åè½¬æŒ‡å®šåŒºé—´
 * - ä¸¤ä¸¤äº¤æ¢é“¾è¡¨ä¸­çš„èŠ‚ç‚¹ â†’ k = 2 çš„ç‰¹ä¾‹
 */

// ============================================================
// ğŸ¢ å‰ç«¯ä¸šåŠ¡åœºæ™¯
// ============================================================
/**
 * 1. åˆ†é¡µå¤„ç†ï¼šæ¯é¡µ k æ¡æ•°æ®çš„å¤„ç†
 * 2. æ‰¹é‡æ“ä½œï¼šæ¯ k ä¸ªä¸€ç»„è¿›è¡Œå¤„ç†
 * 3. æ•°æ®é‡æ’ï¼šæŒ‰ç»„é‡æ–°æ’åˆ—æ•°æ®
 */

export { ListNode, reverseKGroup_v1, reverseKGroup_v2 };
export default reverseKGroup_v1;

